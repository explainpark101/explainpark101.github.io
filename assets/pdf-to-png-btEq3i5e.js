import{n as e}from"./chunk-dcn8tbrv.js";import{C as t,D as n,M as r,N as i,T as a,_ as o,d as s,g as c,h as l,j as u,k as d,p as f,t as p,u as m,v as h,w as g,y as _}from"./index-DH5YoFRZ.js";import{t as v}from"./_plugin-vue_export-helper-9n1O4nl6.js";var y=e({AbortException:()=>ve,AnnotationEditorLayer:()=>aa,AnnotationEditorParamsType:()=>O,AnnotationEditorType:()=>D,AnnotationEditorUIManager:()=>bt,AnnotationLayer:()=>Fi,AnnotationMode:()=>T,AnnotationType:()=>N,CSSConstants:()=>tt,ColorPicker:()=>Qr,DOMSVGFactory:()=>ii,DrawLayer:()=>oa,FeatureTest:()=>R,GlobalWorkerOptions:()=>Zn,ImageKind:()=>M,InvalidPDFException:()=>he,MathClamp:()=>B,OPS:()=>ne,OutputScale:()=>Qe,PDFDataRangeTransport:()=>Ur,PDFDateString:()=>Ke,PDFWorker:()=>Kr,PagesMapper:()=>dt,PasswordResponses:()=>ie,PermissionFlag:()=>k,PixelsPerInch:()=>Fe,RenderingCancelledException:()=>Re,ResponseException:()=>ge,SignatureExtractor:()=>ea,SupportedImageMimeTypes:()=>$e,TextLayer:()=>zr,TouchManager:()=>Ct,Util:()=>z,VerbosityLevel:()=>te,XfaLayer:()=>Ne,applyOpacity:()=>nt,build:()=>Zr,createValidAbsoluteUrl:()=>ue,fetchData:()=>Ie,findContrastColor:()=>ct,getDocument:()=>Vr,getFilenameFromUrl:()=>Ve,getPdfFilenameFromUrl:()=>He,getRGB:()=>Je,getUuid:()=>ke,getXfaPageViewport:()=>qe,isDataScheme:()=>ze,isPdfFile:()=>Be,isValidExplicitDest:()=>Ut,noContextMenu:()=>V,normalizeUnicode:()=>Oe,renderRichText:()=>lt,setLayerDimensions:()=>Ze,shadow:()=>L,stopEvent:()=>H,updateUrlHash:()=>de,version:()=>Xr}),b={};b.d=(e,t)=>{for(var n in t)b.o(t,n)&&!b.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},b.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var x=typeof process==`object`&&process+``==`[object process]`&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!==`browser`),S=[.001,0,0,.001,0,0],C=1.35;.35/C;var w={ANY:1,DISPLAY:2,PRINT:4,SAVE:8,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256},T={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},E=`pdfjs_internal_editor_`,D={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15,POPUP:16,SIGNATURE:101,COMMENT:102},O={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_THICKNESS:32,HIGHLIGHT_FREE:33,HIGHLIGHT_SHOW_ALL:34,DRAW_STEP:41},k={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},A={TRIANGLES:1,LATTICE:2,PATCH:3},j={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4},M={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},N={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26},ee={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5},te={ERRORS:0,WARNINGS:1,INFOS:5},ne={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93,rawFillPath:94},re={moveTo:0,lineTo:1,curveTo:2,quadraticCurveTo:3,closePath:4},ie={NEED_PASSWORD:1,INCORRECT_PASSWORD:2},ae=te.WARNINGS;function oe(e){Number.isInteger(e)&&(ae=e)}function se(){return ae}function ce(e){ae>=te.INFOS&&console.info(`Info: ${e}`)}function P(e){ae>=te.WARNINGS&&console.warn(`Warning: ${e}`)}function F(e){throw Error(e)}function I(e,t){e||F(t)}function le(e){switch(e?.protocol){case`http:`:case`https:`:case`ftp:`:case`mailto:`:case`tel:`:return!0;default:return!1}}function ue(e,t=null,n=null){if(!e)return null;if(n&&typeof e==`string`&&(n.addDefaultProtocol&&e.startsWith(`www.`)&&e.match(/\./g)?.length>=2&&(e=`http://${e}`),n.tryConvertEncoding))try{e=Te(e)}catch{}let r=t?URL.parse(e,t):URL.parse(e);return le(r)?r:null}function de(e,t,n=!1){let r=URL.parse(e);return r?(r.hash=t,r.href):n&&ue(e,`http://example.com`)?e.split(`#`,1)[0]+`${t?`#${t}`:``}`:``}function L(e,t,n,r=!1){return Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!0,writable:!1}),n}var fe=function(){function e(e,t){this.message=e,this.name=t}return e.prototype=Error(),e.constructor=e,e}(),pe=class extends fe{constructor(e,t){super(e,`PasswordException`),this.code=t}},me=class extends fe{constructor(e,t){super(e,`UnknownErrorException`),this.details=t}},he=class extends fe{constructor(e){super(e,`InvalidPDFException`)}},ge=class extends fe{constructor(e,t,n){super(e,`ResponseException`),this.status=t,this.missing=n}},_e=class extends fe{constructor(e){super(e,`FormatError`)}},ve=class extends fe{constructor(e){super(e,`AbortException`)}};function ye(e){(typeof e!=`object`||e?.length===void 0)&&F(`Invalid argument for bytesToString`);let t=e.length,n=8192;if(t<n)return String.fromCharCode.apply(null,e);let r=[];for(let i=0;i<t;i+=n){let a=Math.min(i+n,t),o=e.subarray(i,a);r.push(String.fromCharCode.apply(null,o))}return r.join(``)}function be(e){typeof e!=`string`&&F(`Invalid argument for stringToBytes`);let t=e.length,n=new Uint8Array(t);for(let r=0;r<t;++r)n[r]=e.charCodeAt(r)&255;return n}function xe(e){return String.fromCharCode(e>>24&255,e>>16&255,e>>8&255,e&255)}function Se(){let e=new Uint8Array(4);return e[0]=1,new Uint32Array(e.buffer,0,1)[0]===1}function Ce(){try{return Function(``),!0}catch{return!1}}var R=class{static get isLittleEndian(){return L(this,`isLittleEndian`,Se())}static get isEvalSupported(){return L(this,`isEvalSupported`,Ce())}static get isOffscreenCanvasSupported(){return L(this,`isOffscreenCanvasSupported`,typeof OffscreenCanvas<`u`)}static get isImageDecoderSupported(){return L(this,`isImageDecoderSupported`,typeof ImageDecoder<`u`)}static get isFloat16ArraySupported(){return L(this,`isFloat16ArraySupported`,typeof Float16Array<`u`)}static get isSanitizerSupported(){return L(this,`isSanitizerSupported`,typeof Sanitizer<`u`)}static get platform(){let{platform:e,userAgent:t}=navigator;return L(this,`platform`,{isAndroid:t.includes(`Android`),isLinux:e.includes(`Linux`),isMac:e.includes(`Mac`),isWindows:e.includes(`Win`),isFirefox:t.includes(`Firefox`)})}static get isCSSRoundSupported(){return L(this,`isCSSRoundSupported`,globalThis.CSS?.supports?.(`width: round(1.5px, 1px)`))}},we=Array.from(Array(256).keys(),e=>e.toString(16).padStart(2,`0`)),z=class{static makeHexColor(e,t,n){return`#${we[e]}${we[t]}${we[n]}`}static domMatrixToTransform(e){return[e.a,e.b,e.c,e.d,e.e,e.f]}static scaleMinMax(e,t){let n;e[0]?(e[0]<0&&(n=t[0],t[0]=t[2],t[2]=n),t[0]*=e[0],t[2]*=e[0],e[3]<0&&(n=t[1],t[1]=t[3],t[3]=n),t[1]*=e[3],t[3]*=e[3]):(n=t[0],t[0]=t[1],t[1]=n,n=t[2],t[2]=t[3],t[3]=n,e[1]<0&&(n=t[1],t[1]=t[3],t[3]=n),t[1]*=e[1],t[3]*=e[1],e[2]<0&&(n=t[0],t[0]=t[2],t[2]=n),t[0]*=e[2],t[2]*=e[2]),t[0]+=e[4],t[1]+=e[5],t[2]+=e[4],t[3]+=e[5]}static transform(e,t){return[e[0]*t[0]+e[2]*t[1],e[1]*t[0]+e[3]*t[1],e[0]*t[2]+e[2]*t[3],e[1]*t[2]+e[3]*t[3],e[0]*t[4]+e[2]*t[5]+e[4],e[1]*t[4]+e[3]*t[5]+e[5]]}static multiplyByDOMMatrix(e,t){return[e[0]*t.a+e[2]*t.b,e[1]*t.a+e[3]*t.b,e[0]*t.c+e[2]*t.d,e[1]*t.c+e[3]*t.d,e[0]*t.e+e[2]*t.f+e[4],e[1]*t.e+e[3]*t.f+e[5]]}static applyTransform(e,t,n=0){let r=e[n],i=e[n+1];e[n]=r*t[0]+i*t[2]+t[4],e[n+1]=r*t[1]+i*t[3]+t[5]}static applyTransformToBezier(e,t,n=0){let r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],c=t[5];for(let t=0;t<6;t+=2){let l=e[n+t],u=e[n+t+1];e[n+t]=l*r+u*a+s,e[n+t+1]=l*i+u*o+c}}static applyInverseTransform(e,t){let n=e[0],r=e[1],i=t[0]*t[3]-t[1]*t[2];e[0]=(n*t[3]-r*t[2]+t[2]*t[5]-t[4]*t[3])/i,e[1]=(-n*t[1]+r*t[0]+t[4]*t[1]-t[5]*t[0])/i}static axialAlignedBoundingBox(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],c=t[5],l=e[0],u=e[1],d=e[2],f=e[3],p=r*l+s,m=p,h=r*d+s,g=h,_=o*u+c,v=_,y=o*f+c,b=y;if(i!==0||a!==0){let e=i*l,t=i*d,n=a*u,r=a*f;p+=n,g+=n,h+=r,m+=r,_+=e,b+=e,y+=t,v+=t}n[0]=Math.min(n[0],p,h,m,g),n[1]=Math.min(n[1],_,y,v,b),n[2]=Math.max(n[2],p,h,m,g),n[3]=Math.max(n[3],_,y,v,b)}static inverseTransform(e){let t=e[0]*e[3]-e[1]*e[2];return[e[3]/t,-e[1]/t,-e[2]/t,e[0]/t,(e[2]*e[5]-e[4]*e[3])/t,(e[4]*e[1]-e[5]*e[0])/t]}static singularValueDecompose2dScale(e,t){let n=e[0],r=e[1],i=e[2],a=e[3],o=n**2+r**2,s=n*i+r*a,c=i**2+a**2,l=(o+c)/2,u=Math.sqrt(l**2-(o*c-s**2));t[0]=Math.sqrt(l+u||1),t[1]=Math.sqrt(l-u||1)}static normalizeRect(e){let t=e.slice(0);return e[0]>e[2]&&(t[0]=e[2],t[2]=e[0]),e[1]>e[3]&&(t[1]=e[3],t[3]=e[1]),t}static intersect(e,t){let n=Math.max(Math.min(e[0],e[2]),Math.min(t[0],t[2])),r=Math.min(Math.max(e[0],e[2]),Math.max(t[0],t[2]));if(n>r)return null;let i=Math.max(Math.min(e[1],e[3]),Math.min(t[1],t[3])),a=Math.min(Math.max(e[1],e[3]),Math.max(t[1],t[3]));return i>a?null:[n,i,r,a]}static pointBoundingBox(e,t,n){n[0]=Math.min(n[0],e),n[1]=Math.min(n[1],t),n[2]=Math.max(n[2],e),n[3]=Math.max(n[3],t)}static rectBoundingBox(e,t,n,r,i){i[0]=Math.min(i[0],e,n),i[1]=Math.min(i[1],t,r),i[2]=Math.max(i[2],e,n),i[3]=Math.max(i[3],t,r)}static#getExtremumOnCurve(e,t,n,r,i,a,o,s,c,l){if(c<=0||c>=1)return;let u=1-c,d=c*c,f=d*c,p=u*(u*(u*e+3*c*t)+3*d*n)+f*r,m=u*(u*(u*i+3*c*a)+3*d*o)+f*s;l[0]=Math.min(l[0],p),l[1]=Math.min(l[1],m),l[2]=Math.max(l[2],p),l[3]=Math.max(l[3],m)}static#getExtremum(e,t,n,r,i,a,o,s,c,l,u,d){if(Math.abs(c)<1e-12){Math.abs(l)>=1e-12&&this.#getExtremumOnCurve(e,t,n,r,i,a,o,s,-u/l,d);return}let f=l**2-4*u*c;if(f<0)return;let p=Math.sqrt(f),m=2*c;this.#getExtremumOnCurve(e,t,n,r,i,a,o,s,(-l+p)/m,d),this.#getExtremumOnCurve(e,t,n,r,i,a,o,s,(-l-p)/m,d)}static bezierBoundingBox(e,t,n,r,i,a,o,s,c){c[0]=Math.min(c[0],e,o),c[1]=Math.min(c[1],t,s),c[2]=Math.max(c[2],e,o),c[3]=Math.max(c[3],t,s),this.#getExtremum(e,n,i,o,t,r,a,s,3*(-e+3*(n-i)+o),6*(e-2*n+i),3*(n-e),c),this.#getExtremum(e,n,i,o,t,r,a,s,3*(-t+3*(r-a)+s),6*(t-2*r+a),3*(r-t),c)}};function Te(e){return decodeURIComponent(escape(e))}var Ee=null,De=null;function Oe(e){return Ee||(Ee=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,De=new Map([[`ﬅ`,`ſt`]])),e.replaceAll(Ee,(e,t,n)=>t?t.normalize(`NFKC`):De.get(n))}function ke(){if(typeof crypto.randomUUID==`function`)return crypto.randomUUID();let e=new Uint8Array(32);return crypto.getRandomValues(e),ye(e)}var Ae=`pdfjs_internal_id_`;function je(e,t,n){if(!Array.isArray(n)||n.length<2)return!1;let[r,i,...a]=n;if(!e(r)&&!Number.isInteger(r)||!t(i))return!1;let o=a.length,s=!0;switch(i.name){case`XYZ`:if(o<2||o>3)return!1;break;case`Fit`:case`FitB`:return o===0;case`FitH`:case`FitBH`:case`FitV`:case`FitBV`:if(o>1)return!1;break;case`FitR`:if(o!==4)return!1;s=!1;break;default:return!1}for(let e of a)if(!(typeof e==`number`||s&&e===null))return!1;return!0}function B(e,t,n){return Math.min(Math.max(e,t),n)}typeof Math.sumPrecise!=`function`&&(Math.sumPrecise=function(e){return e.reduce((e,t)=>e+t,0)});var Me=class e{static textContent(t){let n=[],r={items:n,styles:Object.create(null)};function i(t){if(!t)return;let r=null,a=t.name;if(a===`#text`)r=t.value;else if(e.shouldBuildText(a))t?.attributes?.textContent?r=t.attributes.textContent:t.value&&(r=t.value);else return;if(r!==null&&n.push({str:r}),t.children)for(let e of t.children)i(e)}return i(t),r}static shouldBuildText(e){return!(e===`textarea`||e===`input`||e===`option`||e===`select`)}},Ne=class{static setupStorage(e,t,n,r,i){let a=r.getValue(t,{value:null});switch(n.name){case`textarea`:if(a.value!==null&&(e.textContent=a.value),i===`print`)break;e.addEventListener(`input`,e=>{r.setValue(t,{value:e.target.value})});break;case`input`:if(n.attributes.type===`radio`||n.attributes.type===`checkbox`){if(a.value===n.attributes.xfaOn?e.setAttribute(`checked`,!0):a.value===n.attributes.xfaOff&&e.removeAttribute(`checked`),i===`print`)break;e.addEventListener(`change`,e=>{r.setValue(t,{value:e.target.checked?e.target.getAttribute(`xfaOn`):e.target.getAttribute(`xfaOff`)})})}else{if(a.value!==null&&e.setAttribute(`value`,a.value),i===`print`)break;e.addEventListener(`input`,e=>{r.setValue(t,{value:e.target.value})})}break;case`select`:if(a.value!==null){e.setAttribute(`value`,a.value);for(let e of n.children)e.attributes.value===a.value?e.attributes.selected=!0:e.attributes.hasOwnProperty(`selected`)&&delete e.attributes.selected}e.addEventListener(`input`,e=>{let n=e.target.options,i=n.selectedIndex===-1?``:n[n.selectedIndex].value;r.setValue(t,{value:i})});break}}static setAttributes({html:e,element:t,storage:n=null,intent:r,linkService:i}){let{attributes:a}=t,o=e instanceof HTMLAnchorElement;a.type===`radio`&&(a.name=`${a.name}-${r}`);for(let[t,n]of Object.entries(a))if(n!=null)switch(t){case`class`:n.length&&e.setAttribute(t,n.join(` `));break;case`dataId`:break;case`id`:e.setAttribute(`data-element-id`,n);break;case`style`:Object.assign(e.style,n);break;case`textContent`:e.textContent=n;break;default:(!o||t!==`href`&&t!==`newWindow`)&&e.setAttribute(t,n)}o&&i.addLinkAttributes(e,a.href,a.newWindow),n&&a.dataId&&this.setupStorage(e,a.dataId,t,n)}static render(e){let t=e.annotationStorage,n=e.linkService,r=e.xfaHtml,i=e.intent||`display`,a=document.createElement(r.name);r.attributes&&this.setAttributes({html:a,element:r,intent:i,linkService:n});let o=i!==`richText`,s=e.div;if(s.append(a),e.viewport){let t=`matrix(${e.viewport.transform.join(`,`)})`;s.style.transform=t}o&&s.setAttribute(`class`,`xfaLayer xfaFont`);let c=[];if(r.children.length===0){if(r.value){let e=document.createTextNode(r.value);a.append(e),o&&Me.shouldBuildText(r.name)&&c.push(e)}return{textDivs:c}}let l=[[r,-1,a]];for(;l.length>0;){let[e,r,a]=l.at(-1);if(r+1===e.children.length){l.pop();continue}let s=e.children[++l.at(-1)[1]];if(s===null)continue;let{name:u}=s;if(u===`#text`){let e=document.createTextNode(s.value);c.push(e),a.append(e);continue}let d=s?.attributes?.xmlns?document.createElementNS(s.attributes.xmlns,u):document.createElement(u);if(a.append(d),s.attributes&&this.setAttributes({html:d,element:s,storage:t,intent:i,linkService:n}),s.children?.length>0)l.push([s,-1,d]);else if(s.value){let e=document.createTextNode(s.value);o&&Me.shouldBuildText(u)&&c.push(e),d.append(e)}}for(let e of s.querySelectorAll(`.xfaNonInteractive input, .xfaNonInteractive textarea`))e.setAttribute(`readOnly`,!0);return{textDivs:c}}static update(e){let t=`matrix(${e.viewport.transform.join(`,`)})`;e.div.style.transform=t,e.div.hidden=!1}},Pe=`http://www.w3.org/2000/svg`,Fe=class{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF};async function Ie(e,t=`text`){if(We(e,document.baseURI)){let n=await fetch(e);if(!n.ok)throw Error(n.statusText);switch(t){case`arraybuffer`:return n.arrayBuffer();case`blob`:return n.blob();case`json`:return n.json()}return n.text()}return new Promise((n,r)=>{let i=new XMLHttpRequest;i.open(`GET`,e,!0),i.responseType=t,i.onreadystatechange=()=>{if(i.readyState===XMLHttpRequest.DONE){if(i.status===200||i.status===0){switch(t){case`arraybuffer`:case`blob`:case`json`:n(i.response);return}n(i.responseText);return}r(Error(i.statusText))}},i.send(null)})}var Le=class e{constructor({viewBox:e,userUnit:t,scale:n,rotation:r,offsetX:i=0,offsetY:a=0,dontFlip:o=!1}){this.viewBox=e,this.userUnit=t,this.scale=n,this.rotation=r,this.offsetX=i,this.offsetY=a,n*=t;let s=(e[2]+e[0])/2,c=(e[3]+e[1])/2,l,u,d,f;switch(r%=360,r<0&&(r+=360),r){case 180:l=-1,u=0,d=0,f=1;break;case 90:l=0,u=1,d=1,f=0;break;case 270:l=0,u=-1,d=-1,f=0;break;case 0:l=1,u=0,d=0,f=-1;break;default:throw Error(`PageViewport: Invalid rotation, must be a multiple of 90 degrees.`)}o&&(d=-d,f=-f);let p,m,h,g;l===0?(p=Math.abs(c-e[1])*n+i,m=Math.abs(s-e[0])*n+a,h=(e[3]-e[1])*n,g=(e[2]-e[0])*n):(p=Math.abs(s-e[0])*n+i,m=Math.abs(c-e[1])*n+a,h=(e[2]-e[0])*n,g=(e[3]-e[1])*n),this.transform=[l*n,u*n,d*n,f*n,p-l*n*s-d*n*c,m-u*n*s-f*n*c],this.width=h,this.height=g}get rawDims(){let e=this.viewBox;return L(this,`rawDims`,{pageWidth:e[2]-e[0],pageHeight:e[3]-e[1],pageX:e[0],pageY:e[1]})}clone({scale:t=this.scale,rotation:n=this.rotation,offsetX:r=this.offsetX,offsetY:i=this.offsetY,dontFlip:a=!1}={}){return new e({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:t,rotation:n,offsetX:r,offsetY:i,dontFlip:a})}convertToViewportPoint(e,t){let n=[e,t];return z.applyTransform(n,this.transform),n}convertToViewportRectangle(e){let t=[e[0],e[1]];z.applyTransform(t,this.transform);let n=[e[2],e[3]];return z.applyTransform(n,this.transform),[t[0],t[1],n[0],n[1]]}convertToPdfPoint(e,t){let n=[e,t];return z.applyInverseTransform(n,this.transform),n}},Re=class extends fe{constructor(e,t=0){super(e,`RenderingCancelledException`),this.extraDelay=t}};function ze(e){let t=e.length,n=0;for(;n<t&&e[n].trim()===``;)n++;return e.substring(n,n+5).toLowerCase()===`data:`}function Be(e){return typeof e==`string`&&/\.pdf$/i.test(e)}function Ve(e){return[e]=e.split(/[#?]/,1),e.substring(e.lastIndexOf(`/`)+1)}function He(e,t=`document.pdf`){if(typeof e!=`string`)return t;if(ze(e))return P(`getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.`),t;let n=(e=>{try{return new URL(e)}catch{try{return new URL(decodeURIComponent(e))}catch{try{return new URL(e,`https://foo.bar`)}catch{try{return new URL(decodeURIComponent(e),`https://foo.bar`)}catch{return null}}}}})(e);if(!n)return t;let r=e=>{try{let t=decodeURIComponent(e);return t.includes(`/`)?(t=t.split(`/`).at(-1),t.test(/^\.pdf$/i)?t:e):t}catch{return e}},i=/\.pdf$/i,a=n.pathname.split(`/`).at(-1);if(i.test(a))return r(a);if(n.searchParams.size>0){let e=Array.from(n.searchParams.values()).reverse();for(let t of e)if(i.test(t))return r(t);let t=Array.from(n.searchParams.keys()).reverse();for(let e of t)if(i.test(e))return r(e)}if(n.hash){let e=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i.exec(n.hash);if(e)return r(e[0])}return t}var Ue=class{started=Object.create(null);times=[];time(e){e in this.started&&P(`Timer is already running for ${e}`),this.started[e]=Date.now()}timeEnd(e){e in this.started||P(`Timer has not been started for ${e}`),this.times.push({name:e,start:this.started[e],end:Date.now()}),delete this.started[e]}toString(){let e=[],t=0;for(let{name:e}of this.times)t=Math.max(e.length,t);for(let{name:n,start:r,end:i}of this.times)e.push(`${n.padEnd(t)} ${i-r}ms\n`);return e.join(``)}};function We(e,t){let n=t?URL.parse(e,t):URL.parse(e);return n?.protocol===`http:`||n?.protocol===`https:`}function V(e){e.preventDefault()}function H(e){e.preventDefault(),e.stopPropagation()}function Ge(e){console.log(`Deprecated API usage: `+e)}var Ke=class{static#regex;static toDateObject(e){if(e instanceof Date)return e;if(!e||typeof e!=`string`)return null;this.#regex||=RegExp(`^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?`);let t=this.#regex.exec(e);if(!t)return null;let n=parseInt(t[1],10),r=parseInt(t[2],10);r=r>=1&&r<=12?r-1:0;let i=parseInt(t[3],10);i=i>=1&&i<=31?i:1;let a=parseInt(t[4],10);a=a>=0&&a<=23?a:0;let o=parseInt(t[5],10);o=o>=0&&o<=59?o:0;let s=parseInt(t[6],10);s=s>=0&&s<=59?s:0;let c=t[7]||`Z`,l=parseInt(t[8],10);l=l>=0&&l<=23?l:0;let u=parseInt(t[9],10)||0;return u=u>=0&&u<=59?u:0,c===`-`?(a+=l,o+=u):c===`+`&&(a-=l,o-=u),new Date(Date.UTC(n,r,i,a,o,s))}};function qe(e,{scale:t=1,rotation:n=0}){let{width:r,height:i}=e.attributes.style;return new Le({viewBox:[0,0,parseInt(r),parseInt(i)],userUnit:1,scale:t,rotation:n})}function Je(e){if(e.startsWith(`#`)){let t=parseInt(e.slice(1),16);return[(t&16711680)>>16,(t&65280)>>8,t&255]}return e.startsWith(`rgb(`)?e.slice(4,-1).split(`,`).map(e=>parseInt(e)):e.startsWith(`rgba(`)?e.slice(5,-1).split(`,`).map(e=>parseInt(e)).slice(0,3):(P(`Not a valid color format: "${e}"`),[0,0,0])}function Ye(e){let t=document.createElement(`span`);t.style.visibility=`hidden`,t.style.colorScheme=`only light`,document.body.append(t);for(let n of e.keys()){t.style.color=n;let r=window.getComputedStyle(t).color;e.set(n,Je(r))}t.remove()}function U(e){let{a:t,b:n,c:r,d:i,e:a,f:o}=e.getTransform();return[t,n,r,i,a,o]}function Xe(e){let{a:t,b:n,c:r,d:i,e:a,f:o}=e.getTransform().invertSelf();return[t,n,r,i,a,o]}function Ze(e,t,n=!1,r=!0){if(t instanceof Le){let{pageWidth:r,pageHeight:i}=t.rawDims,{style:a}=e,o=R.isCSSRoundSupported,s=`var(--total-scale-factor) * ${r}px`,c=`var(--total-scale-factor) * ${i}px`,l=o?`round(down, ${s}, var(--scale-round-x))`:`calc(${s})`,u=o?`round(down, ${c}, var(--scale-round-y))`:`calc(${c})`;!n||t.rotation%180==0?(a.width=l,a.height=u):(a.width=u,a.height=l)}r&&e.setAttribute(`data-main-rotation`,t.rotation)}var Qe=class e{constructor(){let{pixelRatio:t}=e;this.sx=t,this.sy=t}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}limitCanvas(t,n,r,i,a=-1){let o=1/0,s=1/0,c=1/0;r=e.capPixels(r,a),r>0&&(o=Math.sqrt(r/(t*n))),i!==-1&&(s=i/t,c=i/n);let l=Math.min(o,s,c);return this.sx>l||this.sy>l?(this.sx=l,this.sy=l,!0):!1}static get pixelRatio(){return globalThis.devicePixelRatio||1}static capPixels(e,t){if(t>=0){let n=Math.ceil(window.screen.availWidth*window.screen.availHeight*this.pixelRatio**2*(1+t/100));return e>0?Math.min(e,n):n}return e}},$e=[`image/apng`,`image/avif`,`image/bmp`,`image/gif`,`image/jpeg`,`image/png`,`image/svg+xml`,`image/webp`,`image/x-icon`],et=class{static get isDarkMode(){return L(this,`isDarkMode`,!!window?.matchMedia?.(`(prefers-color-scheme: dark)`).matches)}},tt=class{static get commentForegroundColor(){let e=document.createElement(`span`);e.classList.add(`comment`,`sidebar`);let{style:t}=e;t.width=t.height=`0`,t.display=`none`,t.color=`var(--comment-fg-color)`,document.body.append(e);let{color:n}=window.getComputedStyle(e);return e.remove(),L(this,`commentForegroundColor`,Je(n))}};function nt(e,t,n,r){r=Math.min(Math.max(r??1,0),1);let i=255*(1-r);return e=Math.round(e*r+i),t=Math.round(t*r+i),n=Math.round(n*r+i),[e,t,n]}function rt(e,t){let n=e[0]/255,r=e[1]/255,i=e[2]/255,a=Math.max(n,r,i),o=Math.min(n,r,i),s=(a+o)/2;if(a===o)t[0]=t[1]=0;else{let e=a-o;switch(t[1]=s<.5?e/(a+o):e/(2-a-o),a){case n:t[0]=((r-i)/e+(r<i?6:0))*60;break;case r:t[0]=((i-n)/e+2)*60;break;case i:t[0]=((n-r)/e+4)*60;break}}t[2]=s}function it(e,t){let n=e[0],r=e[1],i=e[2],a=(1-Math.abs(2*i-1))*r,o=a*(1-Math.abs(n/60%2-1)),s=i-a/2;switch(Math.floor(n/60)){case 0:t[0]=a+s,t[1]=o+s,t[2]=s;break;case 1:t[0]=o+s,t[1]=a+s,t[2]=s;break;case 2:t[0]=s,t[1]=a+s,t[2]=o+s;break;case 3:t[0]=s,t[1]=o+s,t[2]=a+s;break;case 4:t[0]=o+s,t[1]=s,t[2]=a+s;break;case 5:case 6:t[0]=a+s,t[1]=s,t[2]=o+s;break}}function at(e){return e<=.03928?e/12.92:((e+.055)/1.055)**2.4}function ot(e,t,n){it(e,n),n.map(at);let r=.2126*n[0]+.7152*n[1]+.0722*n[2];it(t,n),n.map(at);let i=.2126*n[0]+.7152*n[1]+.0722*n[2];return r>i?(r+.05)/(i+.05):(i+.05)/(r+.05)}var st=new Map;function ct(e,t){let n=e[0]+e[1]*256+e[2]*65536+t[0]*16777216+t[1]*4294967296+t[2]*1099511627776,r=st.get(n);if(r)return r;let i=new Float32Array(9),a=i.subarray(0,3),o=i.subarray(3,6);rt(e,o);let s=i.subarray(6,9);rt(t,s);let c=s[2]<.5,l=c?12:4.5;if(o[2]=c?Math.sqrt(o[2]):1-Math.sqrt(1-o[2]),ot(o,s,a)<l){let e,t;for(c?(e=o[2],t=1):(e=0,t=o[2]);t-e>.005;){let n=o[2]=(e+t)/2;c===ot(o,s,a)<l?e=n:t=n}o[2]=c?t:e}return it(o,a),r=z.makeHexColor(Math.round(a[0]*255),Math.round(a[1]*255),Math.round(a[2]*255)),st.set(n,r),r}function lt({html:e,dir:t,className:n},r){let i=document.createDocumentFragment();if(typeof e==`string`){let n=document.createElement(`p`);n.dir=t||`auto`;let r=e.split(/(?:\r\n?|\n)/);for(let e=0,t=r.length;e<t;++e){let i=r[e];n.append(document.createTextNode(i)),e<t-1&&n.append(document.createElement(`br`))}i.append(n)}else Ne.render({xfaHtml:e,div:i,intent:`richText`});i.firstElementChild.classList.add(`richText`,n),r.append(i)}function ut(e){let t=new Path2D;if(!e)return t;for(let n=0,r=e.length;n<r;)switch(e[n++]){case re.moveTo:t.moveTo(e[n++],e[n++]);break;case re.lineTo:t.lineTo(e[n++],e[n++]);break;case re.curveTo:t.bezierCurveTo(e[n++],e[n++],e[n++],e[n++],e[n++],e[n++]);break;case re.quadraticCurveTo:t.quadraticCurveTo(e[n++],e[n++],e[n++],e[n++]);break;case re.closePath:t.closePath();break;default:P(`Unrecognized drawing path operator: ${e[n-1]}`);break}return t}var dt=class e{static#idToPageNumber=null;static#pageNumberToId=null;static#prevIdToPageNumber=null;static#pagesNumber=0;static#listeners=[];get pagesNumber(){return e.#pagesNumber}set pagesNumber(t){e.#pagesNumber!==t&&(e.#pagesNumber=t,t===0&&(e.#pageNumberToId=null,e.#idToPageNumber=null))}addListener(t){e.#listeners.push(t)}removeListener(t){let n=e.#listeners.indexOf(t);n>=0&&e.#listeners.splice(n,1)}#updateListeners(){for(let t of e.#listeners)t()}#init(t){if(e.#pageNumberToId)return;let n=e.#pagesNumber,r=new Uint32Array(3*n),i=e.#pageNumberToId=r.subarray(0,n),a=e.#idToPageNumber=r.subarray(n,2*n);if(t)for(let e=0;e<n;e++)i[e]=a[e]=e+1;e.#prevIdToPageNumber=r.subarray(2*n)}movePages(t,n,r){this.#init(!0);let i=e.#pageNumberToId,a=e.#idToPageNumber;e.#prevIdToPageNumber.set(a);let o=n.length,s=new Uint32Array(o),c=0;for(let e=0;e<o;e++){let t=n[e]-1;s[e]=i[t],t<r&&(c+=1)}let l=e.#pagesNumber,u=r-c,d=l-o;u=B(u,0,d);for(let e=0,n=0;e<l;e++)t.has(e+1)||(i[n++]=i[e]);i.copyWithin(u+o,u,d),i.set(s,u);let f=!1;for(let e=0,t=l;e<t;e++){let t=i[e];f||=t!==e+1,a[t-1]=e+1}this.#updateListeners(),f||(this.pagesNumber=0)}hasBeenAltered(){return e.#pageNumberToId!==null}getPageMappingForSaving(){return{pageIndices:e.#idToPageNumber?e.#idToPageNumber.map(e=>e-1):null}}getPrevPageNumber(t){return e.#prevIdToPageNumber[e.#pageNumberToId[t-1]-1]}getPageNumber(t){return e.#idToPageNumber?.[t-1]??t}getPageId(t){return e.#pageNumberToId?.[t-1]??t}static get instance(){return L(this,`instance`,new e)}getMapping(){return e.#pageNumberToId.subarray(0,this.pagesNumber)}},ft=class e{#toolbar=null;#colorPicker=null;#editor;#buttons=null;#altText=null;#comment=null;#commentButtonDivider=null;#signatureDescriptionButton=null;static#l10nRemove=null;constructor(t){this.#editor=t,e.#l10nRemove||=Object.freeze({freetext:`pdfjs-editor-remove-freetext-button`,highlight:`pdfjs-editor-remove-highlight-button`,ink:`pdfjs-editor-remove-ink-button`,stamp:`pdfjs-editor-remove-stamp-button`,signature:`pdfjs-editor-remove-signature-button`})}render(){let t=this.#toolbar=document.createElement(`div`);t.classList.add(`editToolbar`,`hidden`),t.setAttribute(`role`,`toolbar`);let n=this.#editor._uiManager._signal;n instanceof AbortSignal&&!n.aborted&&(t.addEventListener(`contextmenu`,V,{signal:n}),t.addEventListener(`pointerdown`,e.#pointerDown,{signal:n}));let r=this.#buttons=document.createElement(`div`);r.className=`buttons`,t.append(r);let i=this.#editor.toolbarPosition;if(i){let{style:e}=t;e.insetInlineEnd=`${100*(this.#editor._uiManager.direction===`ltr`?1-i[0]:i[0])}%`,e.top=`calc(${100*i[1]}% + var(--editor-toolbar-vert-offset))`}return t}get div(){return this.#toolbar}static#pointerDown(e){e.stopPropagation()}#focusIn(e){this.#editor._focusEventsAllowed=!1,H(e)}#focusOut(e){this.#editor._focusEventsAllowed=!0,H(e)}#addListenersToElement(e){let t=this.#editor._uiManager._signal;return!(t instanceof AbortSignal)||t.aborted?!1:(e.addEventListener(`focusin`,this.#focusIn.bind(this),{capture:!0,signal:t}),e.addEventListener(`focusout`,this.#focusOut.bind(this),{capture:!0,signal:t}),e.addEventListener(`contextmenu`,V,{signal:t}),!0)}hide(){this.#toolbar.classList.add(`hidden`),this.#colorPicker?.hideDropdown()}show(){this.#toolbar.classList.remove(`hidden`),this.#altText?.shown(),this.#comment?.shown()}addDeleteButton(){let{editorType:t,_uiManager:n}=this.#editor,r=document.createElement(`button`);r.classList.add(`basic`,`deleteButton`),r.tabIndex=0,r.setAttribute(`data-l10n-id`,e.#l10nRemove[t]),this.#addListenersToElement(r)&&r.addEventListener(`click`,e=>{n.delete()},{signal:n._signal}),this.#buttons.append(r)}get#divider(){let e=document.createElement(`div`);return e.className=`divider`,e}async addAltText(e){let t=await e.render();this.#addListenersToElement(t),this.#buttons.append(t,this.#divider),this.#altText=e}addComment(e,t=null){if(this.#comment)return;let n=e.renderForToolbar();if(!n)return;this.#addListenersToElement(n);let r=this.#commentButtonDivider=this.#divider;t?(this.#buttons.insertBefore(n,t),this.#buttons.insertBefore(r,t)):this.#buttons.append(n,r),this.#comment=e,e.toolbar=this}addColorPicker(e){if(this.#colorPicker)return;this.#colorPicker=e;let t=e.renderButton();this.#addListenersToElement(t),this.#buttons.append(t,this.#divider)}async addEditSignatureButton(e){let t=this.#signatureDescriptionButton=await e.renderEditButton(this.#editor);this.#addListenersToElement(t),this.#buttons.append(t,this.#divider)}removeButton(e){switch(e){case`comment`:this.#comment?.removeToolbarCommentButton(),this.#comment=null,this.#commentButtonDivider?.remove(),this.#commentButtonDivider=null;break}}async addButton(e,t){switch(e){case`colorPicker`:t&&this.addColorPicker(t);break;case`altText`:t&&await this.addAltText(t);break;case`editSignature`:t&&await this.addEditSignatureButton(t);break;case`delete`:this.addDeleteButton();break;case`comment`:t&&this.addComment(t);break}}async addButtonBefore(e,t,n){if(!t&&e===`comment`)return;let r=this.#buttons.querySelector(n);r&&e===`comment`&&this.addComment(t,r)}updateEditSignatureButton(e){this.#signatureDescriptionButton&&(this.#signatureDescriptionButton.title=e)}remove(){this.#toolbar.remove(),this.#colorPicker?.destroy(),this.#colorPicker=null}},pt=class{#buttons=null;#toolbar=null;#uiManager;constructor(e){this.#uiManager=e}#render(){let e=this.#toolbar=document.createElement(`div`);e.className=`editToolbar`,e.setAttribute(`role`,`toolbar`);let t=this.#uiManager._signal;t instanceof AbortSignal&&!t.aborted&&e.addEventListener(`contextmenu`,V,{signal:t});let n=this.#buttons=document.createElement(`div`);return n.className=`buttons`,e.append(n),this.#uiManager.hasCommentManager()&&this.#makeButton(`commentButton`,`pdfjs-comment-floating-button`,`pdfjs-comment-floating-button-label`,()=>{this.#uiManager.commentSelection(`floating_button`)}),this.#makeButton(`highlightButton`,`pdfjs-highlight-floating-button1`,`pdfjs-highlight-floating-button-label`,()=>{this.#uiManager.highlightSelection(`floating_button`)}),e}#getLastPoint(e,t){let n=0,r=0;for(let i of e){let e=i.y+i.height;if(e<n)continue;let a=i.x+(t?i.width:0);if(e>n){r=a,n=e;continue}t?a>r&&(r=a):a<r&&(r=a)}return[t?1-r:r,n]}show(e,t,n){let[r,i]=this.#getLastPoint(t,n),{style:a}=this.#toolbar||=this.#render();e.append(this.#toolbar),a.insetInlineEnd=`${100*r}%`,a.top=`calc(${100*i}% + var(--editor-toolbar-vert-offset))`}hide(){this.#toolbar.remove()}#makeButton(e,t,n,r){let i=document.createElement(`button`);i.classList.add(`basic`,e),i.tabIndex=0,i.setAttribute(`data-l10n-id`,t);let a=document.createElement(`span`);i.append(a),a.className=`visuallyHidden`,a.setAttribute(`data-l10n-id`,n);let o=this.#uiManager._signal;o instanceof AbortSignal&&!o.aborted&&(i.addEventListener(`contextmenu`,V,{signal:o}),i.addEventListener(`click`,r,{signal:o})),this.#buttons.append(i)}};function mt(e,t,n){for(let r of n)t.addEventListener(r,e[r].bind(e))}var W=class e{static#pointerId=NaN;static#pointerIds=null;static#moveTimestamp=NaN;static#pointerType=null;static initializeAndAddPointerId(t){(e.#pointerIds||=new Set).add(t)}static setPointer(t,n){e.#pointerId||=n,e.#pointerType??=t}static setTimeStamp(t){e.#moveTimestamp=t}static isSamePointerId(t){return e.#pointerId===t}static isSamePointerIdOrRemove(t){return e.#pointerId===t?!0:(e.#pointerIds?.delete(t),!1)}static isSamePointerType(t){return e.#pointerType===t}static isInitializedAndDifferentPointerType(t){return e.#pointerType!==null&&!e.isSamePointerType(t)}static isSameTimeStamp(t){return e.#moveTimestamp===t}static isUsingMultiplePointers(){return e.#pointerIds?.size>=1}static clearPointerType(){e.#pointerType=null}static clearPointerIds(){e.#pointerId=NaN,e.#pointerIds=null}static clearTimeStamp(){e.#moveTimestamp=NaN}},ht=class{#id=0;get id(){return`${E}${this.#id++}`}},gt=class e{#baseId=ke();#id=0;#cache=null;static get _isSVGFittingCanvas(){let e=new OffscreenCanvas(1,3).getContext(`2d`,{willReadFrequently:!0}),t=new Image;t.src=`data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>`;let n=t.decode().then(()=>(e.drawImage(t,0,0,1,1,0,0,1,3),new Uint32Array(e.getImageData(0,0,1,1).data.buffer)[0]===0));return L(this,`_isSVGFittingCanvas`,n)}async#get(t,n){this.#cache||=new Map;let r=this.#cache.get(t);if(r===null)return null;if(r?.bitmap)return r.refCounter+=1,r;try{r||={bitmap:null,id:`image_${this.#baseId}_${this.#id++}`,refCounter:0,isSvg:!1};let t;if(typeof n==`string`?(r.url=n,t=await Ie(n,`blob`)):n instanceof File?t=r.file=n:n instanceof Blob&&(t=n),t.type===`image/svg+xml`){let n=e._isSVGFittingCanvas,i=new FileReader,a=new Image,o=new Promise((e,t)=>{a.onload=()=>{r.bitmap=a,r.isSvg=!0,e()},i.onload=async()=>{let e=r.svgUrl=i.result;a.src=await n?`${e}#svgView(preserveAspectRatio(none))`:e},a.onerror=i.onerror=t});i.readAsDataURL(t),await o}else r.bitmap=await createImageBitmap(t);r.refCounter=1}catch(e){P(e),r=null}return this.#cache.set(t,r),r&&this.#cache.set(r.id,r),r}async getFromFile(e){let{lastModified:t,name:n,size:r,type:i}=e;return this.#get(`${t}_${n}_${r}_${i}`,e)}async getFromUrl(e){return this.#get(e,e)}async getFromBlob(e,t){let n=await t;return this.#get(e,n)}async getFromId(e){this.#cache||=new Map;let t=this.#cache.get(e);if(!t)return null;if(t.bitmap)return t.refCounter+=1,t;if(t.file)return this.getFromFile(t.file);if(t.blobPromise){let{blobPromise:e}=t;return delete t.blobPromise,this.getFromBlob(t.id,e)}return this.getFromUrl(t.url)}getFromCanvas(e,t){this.#cache||=new Map;let n=this.#cache.get(e);if(n?.bitmap)return n.refCounter+=1,n;let r=new OffscreenCanvas(t.width,t.height);return r.getContext(`2d`).drawImage(t,0,0),n={bitmap:r.transferToImageBitmap(),id:`image_${this.#baseId}_${this.#id++}`,refCounter:1,isSvg:!1},this.#cache.set(e,n),this.#cache.set(n.id,n),n}getSvgUrl(e){let t=this.#cache.get(e);return t?.isSvg?t.svgUrl:null}deleteId(e){this.#cache||=new Map;let t=this.#cache.get(e);if(!t||(--t.refCounter,t.refCounter!==0))return;let{bitmap:n}=t;if(!t.url&&!t.file){let e=new OffscreenCanvas(n.width,n.height);e.getContext(`bitmaprenderer`).transferFromImageBitmap(n),t.blobPromise=e.convertToBlob()}n.close?.(),t.bitmap=null}isValidId(e){return e.startsWith(`image_${this.#baseId}_`)}},_t=class{#commands=[];#locked=!1;#maxSize;#position=-1;constructor(e=128){this.#maxSize=e}add({cmd:e,undo:t,post:n,mustExec:r,type:i=NaN,overwriteIfSameType:a=!1,keepUndo:o=!1}){if(r&&e(),this.#locked)return;let s={cmd:e,undo:t,post:n,type:i};if(this.#position===-1){this.#commands.length>0&&(this.#commands.length=0),this.#position=0,this.#commands.push(s);return}if(a&&this.#commands[this.#position].type===i){o&&(s.undo=this.#commands[this.#position].undo),this.#commands[this.#position]=s;return}let c=this.#position+1;c===this.#maxSize?this.#commands.splice(0,1):(this.#position=c,c<this.#commands.length&&this.#commands.splice(c)),this.#commands.push(s)}undo(){if(this.#position===-1)return;this.#locked=!0;let{undo:e,post:t}=this.#commands[this.#position];e(),t?.(),this.#locked=!1,--this.#position}redo(){if(this.#position<this.#commands.length-1){this.#position+=1,this.#locked=!0;let{cmd:e,post:t}=this.#commands[this.#position];e(),t?.(),this.#locked=!1}}hasSomethingToUndo(){return this.#position!==-1}hasSomethingToRedo(){return this.#position<this.#commands.length-1}cleanType(e){if(this.#position!==-1){for(let t=this.#position;t>=0;t--)if(this.#commands[t].type!==e){this.#commands.splice(t+1,this.#position-t),this.#position=t;return}this.#commands.length=0,this.#position=-1}}destroy(){this.#commands=null}},vt=class{constructor(e){this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;let{isMac:t}=R.platform;for(let[n,r,i={}]of e)for(let e of n){let n=e.startsWith(`mac+`);t&&n?(this.callbacks.set(e.slice(4),{callback:r,options:i}),this.allKeys.add(e.split(`+`).at(-1))):!t&&!n&&(this.callbacks.set(e,{callback:r,options:i}),this.allKeys.add(e.split(`+`).at(-1)))}}#serialize(e){e.altKey&&this.buffer.push(`alt`),e.ctrlKey&&this.buffer.push(`ctrl`),e.metaKey&&this.buffer.push(`meta`),e.shiftKey&&this.buffer.push(`shift`),this.buffer.push(e.key);let t=this.buffer.join(`+`);return this.buffer.length=0,t}exec(e,t){if(!this.allKeys.has(t.key))return;let n=this.callbacks.get(this.#serialize(t));if(!n)return;let{callback:r,options:{bubbles:i=!1,args:a=[],checker:o=null}}=n;o&&!o(e,t)||(r.bind(e,...a,t)(),i||H(t))}},yt=class e{static _colorsMapping=new Map([[`CanvasText`,[0,0,0]],[`Canvas`,[255,255,255]]]);get _colors(){let e=new Map([[`CanvasText`,null],[`Canvas`,null]]);return Ye(e),L(this,`_colors`,e)}convert(t){let n=Je(t);if(!window.matchMedia(`(forced-colors: active)`).matches)return n;for(let[t,r]of this._colors)if(r.every((e,t)=>e===n[t]))return e._colorsMapping.get(t);return n}getHexCode(e){let t=this._colors.get(e);return t?z.makeHexColor(...t):e}},bt=class e{#abortController=new AbortController;#activeEditor=null;#allEditableAnnotations=null;#allEditors=new Map;#allLayers=new Map;#altTextManager=null;#annotationStorage=null;#changedExistingAnnotations=null;#commandManager=new _t;#commentManager=null;#copyPasteAC=null;#currentDrawingSession=null;#currentPageIndex=0;#deletedAnnotationsElementIds=new Set;#draggingEditors=null;#editorTypes=null;#editorsToRescale=new Set;_editorUndoBar=null;#enableHighlightFloatingButton=!1;#enableUpdatedAddImage=!1;#enableNewAltTextWhenAddingImage=!1;#filterFactory=null;#focusMainContainerTimeoutId=null;#focusManagerAC=null;#highlightColors=null;#highlightWhenShiftUp=!1;#floatingToolbar=null;#idManager=new ht;#isEnabled=!1;#isPointerDown=!1;#isWaiting=!1;#keyboardManagerAC=null;#lastActiveElement=null;#mainHighlightColorPicker=null;#missingCanvases=null;#mlManager=null;#mode=D.NONE;#selectedEditors=new Set;#selectedTextNode=null;#signatureManager=null;#pageColors=null;#showAllStates=null;#pdfDocument=null;#previousStates={isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1};#translation=[0,0];#translationTimeoutId=null;#container=null;#viewer=null;#viewerAlert=null;#updateModeCapability=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){let t=e.prototype,n=e=>e.#container.contains(document.activeElement)&&document.activeElement.tagName!==`BUTTON`&&e.hasSomethingToControl(),r=(e,{target:t})=>{if(t instanceof HTMLInputElement){let{type:e}=t;return e!==`text`&&e!==`number`}return!0},i=this.TRANSLATE_SMALL,a=this.TRANSLATE_BIG;return L(this,`_keyboardManager`,new vt([[[`ctrl+a`,`mac+meta+a`],t.selectAll,{checker:r}],[[`ctrl+z`,`mac+meta+z`],t.undo,{checker:r}],[[`ctrl+y`,`ctrl+shift+z`,`mac+meta+shift+z`,`ctrl+shift+Z`,`mac+meta+shift+Z`],t.redo,{checker:r}],[[`Backspace`,`alt+Backspace`,`ctrl+Backspace`,`shift+Backspace`,`mac+Backspace`,`mac+alt+Backspace`,`mac+ctrl+Backspace`,`Delete`,`ctrl+Delete`,`shift+Delete`,`mac+Delete`],t.delete,{checker:r}],[[`Enter`,`mac+Enter`],t.addNewEditorFromKeyboard,{checker:(e,{target:t})=>!(t instanceof HTMLButtonElement)&&e.#container.contains(t)&&!e.isEnterHandled}],[[` `,`mac+ `],t.addNewEditorFromKeyboard,{checker:(e,{target:t})=>!(t instanceof HTMLButtonElement)&&e.#container.contains(document.activeElement)}],[[`Escape`,`mac+Escape`],t.unselectAll],[[`ArrowLeft`,`mac+ArrowLeft`],t.translateSelectedEditors,{args:[-i,0],checker:n}],[[`ctrl+ArrowLeft`,`mac+shift+ArrowLeft`],t.translateSelectedEditors,{args:[-a,0],checker:n}],[[`ArrowRight`,`mac+ArrowRight`],t.translateSelectedEditors,{args:[i,0],checker:n}],[[`ctrl+ArrowRight`,`mac+shift+ArrowRight`],t.translateSelectedEditors,{args:[a,0],checker:n}],[[`ArrowUp`,`mac+ArrowUp`],t.translateSelectedEditors,{args:[0,-i],checker:n}],[[`ctrl+ArrowUp`,`mac+shift+ArrowUp`],t.translateSelectedEditors,{args:[0,-a],checker:n}],[[`ArrowDown`,`mac+ArrowDown`],t.translateSelectedEditors,{args:[0,i],checker:n}],[[`ctrl+ArrowDown`,`mac+shift+ArrowDown`],t.translateSelectedEditors,{args:[0,a],checker:n}]]))}constructor(e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h){let g=this._signal=this.#abortController.signal;this.#container=e,this.#viewer=t,this.#viewerAlert=n,this.#altTextManager=r,this.#commentManager=i,this.#signatureManager=a,this.#pdfDocument=s,this._eventBus=o,o._on(`editingaction`,this.onEditingAction.bind(this),{signal:g}),o._on(`pagechanging`,this.onPageChanging.bind(this),{signal:g}),o._on(`scalechanging`,this.onScaleChanging.bind(this),{signal:g}),o._on(`rotationchanging`,this.onRotationChanging.bind(this),{signal:g}),o._on(`setpreference`,this.onSetPreference.bind(this),{signal:g}),o._on(`switchannotationeditorparams`,e=>this.updateParams(e.type,e.value),{signal:g}),o._on(`pagesedited`,this.onPagesEdited.bind(this),{signal:g}),window.addEventListener(`pointerdown`,()=>{this.#isPointerDown=!0},{capture:!0,signal:g}),window.addEventListener(`pointerup`,()=>{this.#isPointerDown=!1},{capture:!0,signal:g}),this.#addSelectionListener(),this.#addDragAndDropListeners(),this.#addKeyboardManager(),this.#annotationStorage=s.annotationStorage,this.#filterFactory=s.filterFactory,this.#pageColors=c,this.#highlightColors=l||null,this.#enableHighlightFloatingButton=u,this.#enableUpdatedAddImage=d,this.#enableNewAltTextWhenAddingImage=f,this.#mlManager=p||null,this.viewParameters={realScale:Fe.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=m||null,this._supportsPinchToZoom=h!==!1,i?.setSidebarUiManager(this)}destroy(){this.#updateModeCapability?.resolve(),this.#updateModeCapability=null,this.#abortController?.abort(),this.#abortController=null,this._signal=null;for(let e of this.#allLayers.values())e.destroy();this.#allLayers.clear(),this.#allEditors.clear(),this.#editorsToRescale.clear(),this.#missingCanvases?.clear(),this.#activeEditor=null,this.#selectedEditors.clear(),this.#commandManager.destroy(),this.#altTextManager?.destroy(),this.#commentManager?.destroy(),this.#signatureManager?.destroy(),this.#floatingToolbar?.hide(),this.#floatingToolbar=null,this.#mainHighlightColorPicker?.destroy(),this.#mainHighlightColorPicker=null,this.#allEditableAnnotations=null,this.#focusMainContainerTimeoutId&&=(clearTimeout(this.#focusMainContainerTimeoutId),null),this.#translationTimeoutId&&=(clearTimeout(this.#translationTimeoutId),null),this._editorUndoBar?.destroy(),this.#pdfDocument=null}combinedSignal(e){return AbortSignal.any([this._signal,e.signal])}get mlManager(){return this.#mlManager}get useNewAltTextFlow(){return this.#enableUpdatedAddImage}get useNewAltTextWhenAddingImage(){return this.#enableNewAltTextWhenAddingImage}get hcmFilter(){return L(this,`hcmFilter`,this.#pageColors?this.#filterFactory.addHCMFilter(this.#pageColors.foreground,this.#pageColors.background):`none`)}get direction(){return L(this,`direction`,getComputedStyle(this.#container).direction)}get _highlightColors(){return L(this,`_highlightColors`,this.#highlightColors?new Map(this.#highlightColors.split(`,`).map(e=>(e=e.split(`=`).map(e=>e.trim()),e[1]=e[1].toUpperCase(),e))):null)}get highlightColors(){let{_highlightColors:e}=this;if(!e)return L(this,`highlightColors`,null);let t=new Map,n=!!this.#pageColors;for(let[r,i]of e){let e=r.endsWith(`_HCM`);if(n&&e){t.set(r.replace(`_HCM`,``),i);continue}!n&&!e&&t.set(r,i)}return L(this,`highlightColors`,t)}get highlightColorNames(){return L(this,`highlightColorNames`,this.highlightColors?new Map(Array.from(this.highlightColors,e=>e.reverse())):null)}getNonHCMColor(e){if(!this._highlightColors)return e;let t=this.highlightColorNames.get(e);return this._highlightColors.get(t)||e}getNonHCMColorName(e){return this.highlightColorNames.get(e)||e}setCurrentDrawingSession(e){e?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),this.#currentDrawingSession=e}setMainHighlightColorPicker(e){this.#mainHighlightColorPicker=e}editAltText(e,t=!1){this.#altTextManager?.editAltText(this,e,t)}hasCommentManager(){return!!this.#commentManager}editComment(e,t,n,r){this.#commentManager?.showDialog(this,e,t,n,r)}selectComment(e,t){(this.#allLayers.get(e)?.getEditorByUID(t))?.toggleComment(!0,!0)}updateComment(e){this.#commentManager?.updateComment(e.getData())}updatePopupColor(e){this.#commentManager?.updatePopupColor(e)}removeComment(e){this.#commentManager?.removeComments([e.uid])}deleteComment(e,t){let n=()=>{e.comment=t};this.addCommands({cmd:()=>{this._editorUndoBar?.show(n,`comment`),this.toggleComment(null),e.comment=null},undo:n,mustExec:!0})}toggleComment(e,t,n=void 0){this.#commentManager?.toggleCommentPopup(e,t,n)}makeCommentColor(e,t){return e&&this.#commentManager?.makeCommentColor(e,t)||null}getCommentDialogElement(){return this.#commentManager?.dialogElement||null}async waitForEditorsRendered(e){if(this.#allLayers.has(e-1))return;let{resolve:t,promise:n}=Promise.withResolvers(),r=n=>{n.pageNumber===e&&(this._eventBus._off(`editorsrendered`,r),t())};this._eventBus.on(`editorsrendered`,r),await n}getSignature(e){this.#signatureManager?.getSignature({uiManager:this,editor:e})}get signatureManager(){return this.#signatureManager}switchToMode(e,t){this._eventBus.on(`annotationeditormodechanged`,t,{once:!0,signal:this._signal}),this._eventBus.dispatch(`showannotationeditorui`,{source:this,mode:e})}setPreference(e,t){this._eventBus.dispatch(`setpreference`,{source:this,name:e,value:t})}onSetPreference({name:e,value:t}){switch(e){case`enableNewAltTextWhenAddingImage`:this.#enableNewAltTextWhenAddingImage=t;break}}onPagesEdited({pagesMapper:e}){for(let t of this.#allEditors.values())t.updatePageIndex(e.getPrevPageNumber(t.pageIndex+1)-1);let t=this.#allLayers,n=this.#allLayers=new Map;for(let[r,i]of t){let t=e.getPrevPageNumber(r+1)-1;if(t===-1){i.destroy();continue}n.set(t,i),i.updatePageIndex(t)}}onPageChanging({pageNumber:e}){this.#currentPageIndex=e-1}focusMainContainer(){this.#container.focus()}findParent(e,t){for(let n of this.#allLayers.values()){let{x:r,y:i,width:a,height:o}=n.div.getBoundingClientRect();if(e>=r&&e<=r+a&&t>=i&&t<=i+o)return n}return null}disableUserSelect(e=!1){this.#viewer.classList.toggle(`noUserSelect`,e)}addShouldRescale(e){this.#editorsToRescale.add(e)}removeShouldRescale(e){this.#editorsToRescale.delete(e)}onScaleChanging({scale:e}){this.commitOrRemove(),this.viewParameters.realScale=e*Fe.PDF_TO_CSS_UNITS;for(let e of this.#editorsToRescale)e.onScaleChanging();this.#currentDrawingSession?.onScaleChanging()}onRotationChanging({pagesRotation:e}){this.commitOrRemove(),this.viewParameters.rotation=e}#getAnchorElementForSelection({anchorNode:e}){return e.nodeType===Node.TEXT_NODE?e.parentElement:e}#getLayerForTextLayer(e){let{currentLayer:t}=this;if(t.hasTextLayer(e))return t;for(let t of this.#allLayers.values())if(t.hasTextLayer(e))return t;return null}highlightSelection(e=``,t=!1){let n=document.getSelection();if(!n||n.isCollapsed)return;let{anchorNode:r,anchorOffset:i,focusNode:a,focusOffset:o}=n,s=n.toString(),c=this.#getAnchorElementForSelection(n).closest(`.textLayer`),l=this.getSelectionBoxes(c);if(!l)return;n.empty();let u=this.#getLayerForTextLayer(c),d=this.#mode===D.NONE,f=()=>{let n=u?.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation:e,boxes:l,anchorNode:r,anchorOffset:i,focusNode:a,focusOffset:o,text:s});d&&this.showAllEditors(`highlight`,!0,!0),t&&n?.editComment()};if(d){this.switchToMode(D.HIGHLIGHT,f);return}f()}commentSelection(e=``){this.highlightSelection(e,!0)}#displayFloatingToolbar(){let e=document.getSelection();if(!e||e.isCollapsed)return;let t=this.#getAnchorElementForSelection(e).closest(`.textLayer`),n=this.getSelectionBoxes(t);n&&(this.#floatingToolbar||=new pt(this),this.#floatingToolbar.show(t,n,this.direction===`ltr`))}getAndRemoveDataFromAnnotationStorage(e){if(!this.#annotationStorage)return null;let t=`${E}${e}`,n=this.#annotationStorage.getRawValue(t);return n&&this.#annotationStorage.remove(t),n}addToAnnotationStorage(e){!e.isEmpty()&&this.#annotationStorage&&!this.#annotationStorage.has(e.id)&&this.#annotationStorage.setValue(e.id,e)}a11yAlert(e,t=null){let n=this.#viewerAlert;n&&(n.setAttribute(`data-l10n-id`,e),t?n.setAttribute(`data-l10n-args`,JSON.stringify(t)):n.removeAttribute(`data-l10n-args`))}#selectionChange(){let e=document.getSelection();if(!e||e.isCollapsed){this.#selectedTextNode&&(this.#floatingToolbar?.hide(),this.#selectedTextNode=null,this.#dispatchUpdateStates({hasSelectedText:!1}));return}let{anchorNode:t}=e;if(t===this.#selectedTextNode)return;let n=this.#getAnchorElementForSelection(e).closest(`.textLayer`);if(!n){this.#selectedTextNode&&(this.#floatingToolbar?.hide(),this.#selectedTextNode=null,this.#dispatchUpdateStates({hasSelectedText:!1}));return}if(this.#floatingToolbar?.hide(),this.#selectedTextNode=t,this.#dispatchUpdateStates({hasSelectedText:!0}),!(this.#mode!==D.HIGHLIGHT&&this.#mode!==D.NONE)&&(this.#mode===D.HIGHLIGHT&&this.showAllEditors(`highlight`,!0,!0),this.#highlightWhenShiftUp=this.isShiftKeyDown,!this.isShiftKeyDown)){let e=this.#mode===D.HIGHLIGHT?this.#getLayerForTextLayer(n):null;if(e?.toggleDrawing(),this.#isPointerDown){let t=new AbortController,n=this.combinedSignal(t),r=n=>{n.type===`pointerup`&&n.button!==0||(t.abort(),e?.toggleDrawing(!0),n.type===`pointerup`&&this.#onSelectEnd(`main_toolbar`))};window.addEventListener(`pointerup`,r,{signal:n}),window.addEventListener(`blur`,r,{signal:n})}else e?.toggleDrawing(!0),this.#onSelectEnd(`main_toolbar`)}}#onSelectEnd(e=``){this.#mode===D.HIGHLIGHT?this.highlightSelection(e):this.#enableHighlightFloatingButton&&this.#displayFloatingToolbar()}#addSelectionListener(){document.addEventListener(`selectionchange`,this.#selectionChange.bind(this),{signal:this._signal})}#addFocusManager(){if(this.#focusManagerAC)return;this.#focusManagerAC=new AbortController;let e=this.combinedSignal(this.#focusManagerAC);window.addEventListener(`focus`,this.focus.bind(this),{signal:e}),window.addEventListener(`blur`,this.blur.bind(this),{signal:e})}#removeFocusManager(){this.#focusManagerAC?.abort(),this.#focusManagerAC=null}blur(){if(this.isShiftKeyDown=!1,this.#highlightWhenShiftUp&&(this.#highlightWhenShiftUp=!1,this.#onSelectEnd(`main_toolbar`)),!this.hasSelection)return;let{activeElement:e}=document;for(let t of this.#selectedEditors)if(t.div.contains(e)){this.#lastActiveElement=[t,e],t._focusEventsAllowed=!1;break}}focus(){if(!this.#lastActiveElement)return;let[e,t]=this.#lastActiveElement;this.#lastActiveElement=null,t.addEventListener(`focusin`,()=>{e._focusEventsAllowed=!0},{once:!0,signal:this._signal}),t.focus()}#addKeyboardManager(){if(this.#keyboardManagerAC)return;this.#keyboardManagerAC=new AbortController;let e=this.combinedSignal(this.#keyboardManagerAC);window.addEventListener(`keydown`,this.keydown.bind(this),{signal:e}),window.addEventListener(`keyup`,this.keyup.bind(this),{signal:e})}#removeKeyboardManager(){this.#keyboardManagerAC?.abort(),this.#keyboardManagerAC=null}#addCopyPasteListeners(){if(this.#copyPasteAC)return;this.#copyPasteAC=new AbortController;let e=this.combinedSignal(this.#copyPasteAC);document.addEventListener(`copy`,this.copy.bind(this),{signal:e}),document.addEventListener(`cut`,this.cut.bind(this),{signal:e}),document.addEventListener(`paste`,this.paste.bind(this),{signal:e})}#removeCopyPasteListeners(){this.#copyPasteAC?.abort(),this.#copyPasteAC=null}#addDragAndDropListeners(){let e=this._signal;document.addEventListener(`dragover`,this.dragOver.bind(this),{signal:e}),document.addEventListener(`drop`,this.drop.bind(this),{signal:e})}addEditListeners(){this.#addKeyboardManager(),this.setEditingState(!0)}removeEditListeners(){this.#removeKeyboardManager(),this.setEditingState(!1)}dragOver(e){for(let{type:t}of e.dataTransfer.items)for(let n of this.#editorTypes)if(n.isHandlingMimeForPasting(t)){e.dataTransfer.dropEffect=`copy`,e.preventDefault();return}}drop(e){for(let t of e.dataTransfer.items)for(let n of this.#editorTypes)if(n.isHandlingMimeForPasting(t.type)){n.paste(t,this.currentLayer),e.preventDefault();return}}copy(e){if(e.preventDefault(),this.#activeEditor?.commitOrRemove(),!this.hasSelection)return;let t=[];for(let e of this.#selectedEditors){let n=e.serialize(!0);n&&t.push(n)}t.length!==0&&e.clipboardData.setData(`application/pdfjs`,JSON.stringify(t))}cut(e){this.copy(e),this.delete()}async paste(e){e.preventDefault();let{clipboardData:t}=e;for(let e of t.items)for(let t of this.#editorTypes)if(t.isHandlingMimeForPasting(e.type)){t.paste(e,this.currentLayer);return}let n=t.getData(`application/pdfjs`);if(!n)return;try{n=JSON.parse(n)}catch(e){P(`paste: "${e.message}".`);return}if(!Array.isArray(n))return;this.unselectAll();let r=this.currentLayer;try{let e=[];for(let t of n){let n=await r.deserialize(t);if(!n)return;e.push(n)}this.addCommands({cmd:()=>{for(let t of e)this.#addEditorToLayer(t);this.#selectEditors(e)},undo:()=>{for(let t of e)t.remove()},mustExec:!0})}catch(e){P(`paste: "${e.message}".`)}}keydown(t){!this.isShiftKeyDown&&t.key===`Shift`&&(this.isShiftKeyDown=!0),this.#mode!==D.NONE&&!this.isEditorHandlingKeyboard&&e._keyboardManager.exec(this,t)}keyup(e){this.isShiftKeyDown&&e.key===`Shift`&&(this.isShiftKeyDown=!1,this.#highlightWhenShiftUp&&(this.#highlightWhenShiftUp=!1,this.#onSelectEnd(`main_toolbar`)))}onEditingAction({name:e}){switch(e){case`undo`:case`redo`:case`delete`:case`selectAll`:this[e]();break;case`highlightSelection`:this.highlightSelection(`context_menu`);break;case`commentSelection`:this.commentSelection(`context_menu`);break}}#dispatchUpdateStates(e){Object.entries(e).some(([e,t])=>this.#previousStates[e]!==t)&&(this._eventBus.dispatch(`annotationeditorstateschanged`,{source:this,details:Object.assign(this.#previousStates,e)}),this.#mode===D.HIGHLIGHT&&e.hasSelectedEditor===!1&&this.#dispatchUpdateUI([[O.HIGHLIGHT_FREE,!0]]))}#dispatchUpdateUI(e){this._eventBus.dispatch(`annotationeditorparamschanged`,{source:this,details:e})}setEditingState(e){e?(this.#addFocusManager(),this.#addCopyPasteListeners(),this.#dispatchUpdateStates({isEditing:this.#mode!==D.NONE,isEmpty:this.#isEmpty(),hasSomethingToUndo:this.#commandManager.hasSomethingToUndo(),hasSomethingToRedo:this.#commandManager.hasSomethingToRedo(),hasSelectedEditor:!1})):(this.#removeFocusManager(),this.#removeCopyPasteListeners(),this.#dispatchUpdateStates({isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(e){if(!this.#editorTypes){this.#editorTypes=e;for(let e of this.#editorTypes)this.#dispatchUpdateUI(e.defaultPropertiesToUpdate)}}getId(){return this.#idManager.id}get currentLayer(){return this.#allLayers.get(this.#currentPageIndex)}getLayer(e){return this.#allLayers.get(e)}get currentPageIndex(){return this.#currentPageIndex}addLayer(e){this.#allLayers.set(e.pageIndex,e),this.#isEnabled?e.enable():e.disable()}removeLayer(e){this.#allLayers.delete(e.pageIndex)}async updateMode(e,t=null,n=!1,r=!1,i=!1,a=!1){if(this.#mode!==e&&!(this.#updateModeCapability&&(await this.#updateModeCapability.promise,!this.#updateModeCapability))){if(this.#updateModeCapability=Promise.withResolvers(),this.#currentDrawingSession?.commitOrRemove(),this.#mode===D.POPUP&&this.#commentManager?.hideSidebar(),this.#commentManager?.destroyPopup(),this.#mode=e,e===D.NONE){this.setEditingState(!1),this.#disableAll();for(let e of this.#allEditors.values())e.hideStandaloneCommentButton();this._editorUndoBar?.hide(),this.toggleComment(null),this.#updateModeCapability.resolve();return}for(let e of this.#allEditors.values())e.addStandaloneCommentButton();e===D.SIGNATURE&&await this.#signatureManager?.loadSignatures(),n&&W.clearPointerType(),this.setEditingState(!0),await this.#enableAll(),this.unselectAll();for(let t of this.#allLayers.values())t.updateMode(e);if(e===D.POPUP){this.#allEditableAnnotations||=await this.#pdfDocument.getAnnotationsByType(new Set(this.#editorTypes.map(e=>e._editorType)));let e=new Set,t=[];for(let n of this.#allEditors.values()){let{annotationElementId:r,hasComment:i,deleted:a}=n;r&&e.add(r),i&&!a&&t.push(n.getData())}for(let n of this.#allEditableAnnotations){let{id:r,popupRef:i,contentsObj:a}=n;i&&a?.str&&!e.has(r)&&!this.#deletedAnnotationsElementIds.has(r)&&t.push(n)}this.#commentManager?.showSidebar(t)}if(!t){r&&this.addNewEditorFromKeyboard(),this.#updateModeCapability.resolve();return}for(let e of this.#allEditors.values())e.uid===t?(this.setSelected(e),a?e.editComment():i?e.enterInEditMode():e.focus()):e.unselect();this.#updateModeCapability.resolve()}}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(e){e.mode!==this.#mode&&this._eventBus.dispatch(`switchannotationeditormode`,{source:this,...e})}updateParams(e,t){if(this.#editorTypes){switch(e){case O.CREATE:this.currentLayer.addNewEditor(t);return;case O.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch(`reporttelemetry`,{source:this,details:{type:`editing`,data:{type:`highlight`,action:`toggle_visibility`}}}),(this.#showAllStates||=new Map).set(e,t),this.showAllEditors(`highlight`,t);break}if(this.hasSelection)for(let n of this.#selectedEditors)n.updateParams(e,t);else for(let n of this.#editorTypes)n.updateDefaultParams(e,t)}}showAllEditors(e,t,n=!1){for(let n of this.#allEditors.values())n.editorType===e&&n.show(t);(this.#showAllStates?.get(O.HIGHLIGHT_SHOW_ALL)??!0)!==t&&this.#dispatchUpdateUI([[O.HIGHLIGHT_SHOW_ALL,t]])}enableWaiting(e=!1){if(this.#isWaiting!==e){this.#isWaiting=e;for(let t of this.#allLayers.values())e?t.disableClick():t.enableClick(),t.div.classList.toggle(`waiting`,e)}}async#enableAll(){if(!this.#isEnabled){this.#isEnabled=!0;let e=[];for(let t of this.#allLayers.values())e.push(t.enable());await Promise.all(e);for(let e of this.#allEditors.values())e.enable()}}#disableAll(){if(this.unselectAll(),this.#isEnabled){this.#isEnabled=!1;for(let e of this.#allLayers.values())e.disable();for(let e of this.#allEditors.values())e.disable()}}*getEditors(e){for(let t of this.#allEditors.values())t.pageIndex===e&&(yield t)}getEditor(e){return this.#allEditors.get(e)}addEditor(e){this.#allEditors.set(e.id,e)}removeEditor(e){e.div.contains(document.activeElement)&&(this.#focusMainContainerTimeoutId&&clearTimeout(this.#focusMainContainerTimeoutId),this.#focusMainContainerTimeoutId=setTimeout(()=>{this.focusMainContainer(),this.#focusMainContainerTimeoutId=null},0)),this.#allEditors.delete(e.id),e.annotationElementId&&this.#missingCanvases?.delete(e.annotationElementId),this.unselect(e),(!e.annotationElementId||!this.#deletedAnnotationsElementIds.has(e.annotationElementId))&&this.#annotationStorage?.remove(e.id)}addDeletedAnnotationElement(e){this.#deletedAnnotationsElementIds.add(e.annotationElementId),this.addChangedExistingAnnotation(e),e.deleted=!0}isDeletedAnnotationElement(e){return this.#deletedAnnotationsElementIds.has(e)}removeDeletedAnnotationElement(e){this.#deletedAnnotationsElementIds.delete(e.annotationElementId),this.removeChangedExistingAnnotation(e),e.deleted=!1}#addEditorToLayer(e){let t=this.#allLayers.get(e.pageIndex);t?t.addOrRebuild(e):(this.addEditor(e),this.addToAnnotationStorage(e))}setActiveEditor(e){this.#activeEditor!==e&&(this.#activeEditor=e,e&&this.#dispatchUpdateUI(e.propertiesToUpdate))}get#lastSelectedEditor(){let e=null;for(e of this.#selectedEditors);return e}updateUI(e){this.#lastSelectedEditor===e&&this.#dispatchUpdateUI(e.propertiesToUpdate)}updateUIForDefaultProperties(e){this.#dispatchUpdateUI(e.defaultPropertiesToUpdate)}toggleSelected(e){if(this.#selectedEditors.has(e)){this.#selectedEditors.delete(e),e.unselect(),this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection});return}this.#selectedEditors.add(e),e.select(),this.#dispatchUpdateUI(e.propertiesToUpdate),this.#dispatchUpdateStates({hasSelectedEditor:!0})}setSelected(e){this.updateToolbar({mode:e.mode,editId:e.uid}),this.#currentDrawingSession?.commitOrRemove();for(let t of this.#selectedEditors)t!==e&&t.unselect();this.#selectedEditors.clear(),this.#selectedEditors.add(e),e.select(),this.#dispatchUpdateUI(e.propertiesToUpdate),this.#dispatchUpdateStates({hasSelectedEditor:!0})}isSelected(e){return this.#selectedEditors.has(e)}get firstSelectedEditor(){return this.#selectedEditors.values().next().value}unselect(e){e.unselect(),this.#selectedEditors.delete(e),this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#selectedEditors.size!==0}get isEnterHandled(){return this.#selectedEditors.size===1&&this.firstSelectedEditor.isEnterHandled}undo(){this.#commandManager.undo(),this.#dispatchUpdateStates({hasSomethingToUndo:this.#commandManager.hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:this.#isEmpty()}),this._editorUndoBar?.hide()}redo(){this.#commandManager.redo(),this.#dispatchUpdateStates({hasSomethingToUndo:!0,hasSomethingToRedo:this.#commandManager.hasSomethingToRedo(),isEmpty:this.#isEmpty()})}addCommands(e){this.#commandManager.add(e),this.#dispatchUpdateStates({hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:this.#isEmpty()})}cleanUndoStack(e){this.#commandManager.cleanType(e)}#isEmpty(){if(this.#allEditors.size===0)return!0;if(this.#allEditors.size===1)for(let e of this.#allEditors.values())return e.isEmpty();return!1}delete(){this.commitOrRemove();let e=this.currentLayer?.endDrawingSession(!0);if(!this.hasSelection&&!e)return;let t=e?[e]:[...this.#selectedEditors],n=()=>{this._editorUndoBar?.show(r,t.length===1?t[0].editorType:t.length);for(let e of t)e.remove()},r=()=>{for(let e of t)this.#addEditorToLayer(e)};this.addCommands({cmd:n,undo:r,mustExec:!0})}commitOrRemove(){this.#activeEditor?.commitOrRemove()}hasSomethingToControl(){return this.#activeEditor||this.hasSelection}#selectEditors(e){for(let e of this.#selectedEditors)e.unselect();this.#selectedEditors.clear();for(let t of e)t.isEmpty()||(this.#selectedEditors.add(t),t.select());this.#dispatchUpdateStates({hasSelectedEditor:this.hasSelection})}selectAll(){for(let e of this.#selectedEditors)e.commit();this.#selectEditors(this.#allEditors.values())}unselectAll(){if(!(this.#activeEditor&&(this.#activeEditor.commitOrRemove(),this.#mode!==D.NONE))&&!this.#currentDrawingSession?.commitOrRemove()&&this.hasSelection){for(let e of this.#selectedEditors)e.unselect();this.#selectedEditors.clear(),this.#dispatchUpdateStates({hasSelectedEditor:!1})}}translateSelectedEditors(e,t,n=!1){if(n||this.commitOrRemove(),!this.hasSelection)return;this.#translation[0]+=e,this.#translation[1]+=t;let[r,i]=this.#translation,a=[...this.#selectedEditors];this.#translationTimeoutId&&clearTimeout(this.#translationTimeoutId),this.#translationTimeoutId=setTimeout(()=>{this.#translationTimeoutId=null,this.#translation[0]=this.#translation[1]=0,this.addCommands({cmd:()=>{for(let e of a)this.#allEditors.has(e.id)&&(e.translateInPage(r,i),e.translationDone())},undo:()=>{for(let e of a)this.#allEditors.has(e.id)&&(e.translateInPage(-r,-i),e.translationDone())},mustExec:!1})},1e3);for(let n of a)n.translateInPage(e,t),n.translationDone()}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),this.#draggingEditors=new Map;for(let e of this.#selectedEditors)this.#draggingEditors.set(e,{savedX:e.x,savedY:e.y,savedPageIndex:e.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#draggingEditors)return!1;this.disableUserSelect(!1);let e=this.#draggingEditors;this.#draggingEditors=null;let t=!1;for(let[{x:n,y:r,pageIndex:i},a]of e)a.newX=n,a.newY=r,a.newPageIndex=i,t||=n!==a.savedX||r!==a.savedY||i!==a.savedPageIndex;if(!t)return!1;let n=(e,t,n,r)=>{if(this.#allEditors.has(e.id)){let i=this.#allLayers.get(r);i?e._setParentAndPosition(i,t,n):(e.pageIndex=r,e.x=t,e.y=n)}};return this.addCommands({cmd:()=>{for(let[t,{newX:r,newY:i,newPageIndex:a}]of e)n(t,r,i,a)},undo:()=>{for(let[t,{savedX:r,savedY:i,savedPageIndex:a}]of e)n(t,r,i,a)},mustExec:!0}),!0}dragSelectedEditors(e,t){if(this.#draggingEditors)for(let n of this.#draggingEditors.keys())n.drag(e,t)}rebuild(e){if(e.parent===null){let t=this.getLayer(e.pageIndex);t?(t.changeParent(e),t.addOrRebuild(e)):(this.addEditor(e),this.addToAnnotationStorage(e),e.rebuild())}else e.parent.addOrRebuild(e)}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||this.#selectedEditors.size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(e){return this.#activeEditor===e}getActive(){return this.#activeEditor}getMode(){return this.#mode}isEditingMode(){return this.#mode!==D.NONE}get imageManager(){return L(this,`imageManager`,new gt)}getSelectionBoxes(e){if(!e)return null;let t=document.getSelection();for(let n=0,r=t.rangeCount;n<r;n++)if(!e.contains(t.getRangeAt(n).commonAncestorContainer))return null;let{x:n,y:r,width:i,height:a}=e.getBoundingClientRect(),o;switch(e.getAttribute(`data-main-rotation`)){case`90`:o=(e,t,o,s)=>({x:(t-r)/a,y:1-(e+o-n)/i,width:s/a,height:o/i});break;case`180`:o=(e,t,o,s)=>({x:1-(e+o-n)/i,y:1-(t+s-r)/a,width:o/i,height:s/a});break;case`270`:o=(e,t,o,s)=>({x:1-(t+s-r)/a,y:(e-n)/i,width:s/a,height:o/i});break;default:o=(e,t,o,s)=>({x:(e-n)/i,y:(t-r)/a,width:o/i,height:s/a});break}let s=[];for(let e=0,n=t.rangeCount;e<n;e++){let n=t.getRangeAt(e);if(!n.collapsed)for(let{x:e,y:t,width:r,height:i}of n.getClientRects())r===0||i===0||s.push(o(e,t,r,i))}return s.length===0?null:s}addChangedExistingAnnotation({annotationElementId:e,id:t}){(this.#changedExistingAnnotations||=new Map).set(e,t)}removeChangedExistingAnnotation({annotationElementId:e}){this.#changedExistingAnnotations?.delete(e)}renderAnnotationElement(e){let t=this.#changedExistingAnnotations?.get(e.data.id);if(!t)return;let n=this.#annotationStorage.getRawValue(t);n&&(this.#mode===D.NONE&&!n.hasBeenModified||n.renderAnnotationElement(e))}setMissingCanvas(e,t,n){let r=this.#missingCanvases?.get(e);r&&(r.setCanvas(t,n),this.#missingCanvases.delete(e))}addMissingCanvas(e,t){(this.#missingCanvases||=new Map).set(e,t)}},xt=class e{#altText=null;#altTextDecorative=!1;#altTextButton=null;#altTextButtonLabel=null;#altTextTooltip=null;#altTextTooltipTimeout=null;#altTextWasFromKeyBoard=!1;#badge=null;#editor=null;#guessedText=null;#textWithDisclaimer=null;#useNewAltTextFlow=!1;static#l10nNewButton=null;static _l10n=null;constructor(t){this.#editor=t,this.#useNewAltTextFlow=t._uiManager.useNewAltTextFlow,e.#l10nNewButton||=Object.freeze({added:`pdfjs-editor-new-alt-text-added-button`,"added-label":`pdfjs-editor-new-alt-text-added-button-label`,missing:`pdfjs-editor-new-alt-text-missing-button`,"missing-label":`pdfjs-editor-new-alt-text-missing-button-label`,review:`pdfjs-editor-new-alt-text-to-review-button`,"review-label":`pdfjs-editor-new-alt-text-to-review-button-label`})}static initialize(t){e._l10n??=t}async render(){let t=this.#altTextButton=document.createElement(`button`);t.className=`altText`,t.tabIndex=`0`;let n=this.#altTextButtonLabel=document.createElement(`span`);t.append(n),this.#useNewAltTextFlow?(t.classList.add(`new`),t.setAttribute(`data-l10n-id`,e.#l10nNewButton.missing),n.setAttribute(`data-l10n-id`,e.#l10nNewButton[`missing-label`])):(t.setAttribute(`data-l10n-id`,`pdfjs-editor-alt-text-button`),n.setAttribute(`data-l10n-id`,`pdfjs-editor-alt-text-button-label`));let r=this.#editor._uiManager._signal;t.addEventListener(`contextmenu`,V,{signal:r}),t.addEventListener(`pointerdown`,e=>e.stopPropagation(),{signal:r});let i=e=>{e.preventDefault(),this.#editor._uiManager.editAltText(this.#editor),this.#useNewAltTextFlow&&this.#editor._reportTelemetry({action:`pdfjs.image.alt_text.image_status_label_clicked`,data:{label:this.#label}})};return t.addEventListener(`click`,i,{capture:!0,signal:r}),t.addEventListener(`keydown`,e=>{e.target===t&&e.key===`Enter`&&(this.#altTextWasFromKeyBoard=!0,i(e))},{signal:r}),await this.#setState(),t}get#label(){return this.#altText&&`added`||this.#altText===null&&this.guessedText&&`review`||`missing`}finish(){this.#altTextButton&&(this.#altTextButton.focus({focusVisible:this.#altTextWasFromKeyBoard}),this.#altTextWasFromKeyBoard=!1)}isEmpty(){return this.#useNewAltTextFlow?this.#altText===null:!this.#altText&&!this.#altTextDecorative}hasData(){return this.#useNewAltTextFlow?this.#altText!==null||!!this.#guessedText:this.isEmpty()}get guessedText(){return this.#guessedText}async setGuessedText(t){this.#altText===null&&(this.#guessedText=t,this.#textWithDisclaimer=await e._l10n.get(`pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer`,{generatedAltText:t}),this.#setState())}toggleAltTextBadge(e=!1){if(!this.#useNewAltTextFlow||this.#altText){this.#badge?.remove(),this.#badge=null;return}if(!this.#badge){let e=this.#badge=document.createElement(`div`);e.className=`noAltTextBadge`,this.#editor.div.append(e)}this.#badge.classList.toggle(`hidden`,!e)}serialize(e){let t=this.#altText;return!e&&this.#guessedText===t&&(t=this.#textWithDisclaimer),{altText:t,decorative:this.#altTextDecorative,guessedText:this.#guessedText,textWithDisclaimer:this.#textWithDisclaimer}}get data(){return{altText:this.#altText,decorative:this.#altTextDecorative}}set data({altText:e,decorative:t,guessedText:n,textWithDisclaimer:r,cancel:i=!1}){n&&(this.#guessedText=n,this.#textWithDisclaimer=r),!(this.#altText===e&&this.#altTextDecorative===t)&&(i||(this.#altText=e,this.#altTextDecorative=t),this.#setState())}toggle(e=!1){this.#altTextButton&&(!e&&this.#altTextTooltipTimeout&&(clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null),this.#altTextButton.disabled=!e)}shown(){this.#editor._reportTelemetry({action:`pdfjs.image.alt_text.image_status_label_displayed`,data:{label:this.#label}})}destroy(){this.#altTextButton?.remove(),this.#altTextButton=null,this.#altTextButtonLabel=null,this.#altTextTooltip=null,this.#badge?.remove(),this.#badge=null}async#setState(){let t=this.#altTextButton;if(!t)return;if(this.#useNewAltTextFlow){if(t.classList.toggle(`done`,!!this.#altText),t.setAttribute(`data-l10n-id`,e.#l10nNewButton[this.#label]),this.#altTextButtonLabel?.setAttribute(`data-l10n-id`,e.#l10nNewButton[`${this.#label}-label`]),!this.#altText){this.#altTextTooltip?.remove();return}}else{if(!this.#altText&&!this.#altTextDecorative){t.classList.remove(`done`),this.#altTextTooltip?.remove();return}t.classList.add(`done`),t.setAttribute(`data-l10n-id`,`pdfjs-editor-alt-text-edit-button`)}let n=this.#altTextTooltip;if(!n){this.#altTextTooltip=n=document.createElement(`span`),n.className=`tooltip`,n.setAttribute(`role`,`tooltip`),n.id=`alt-text-tooltip-${this.#editor.id}`;let e=this.#editor._uiManager._signal;e.addEventListener(`abort`,()=>{clearTimeout(this.#altTextTooltipTimeout),this.#altTextTooltipTimeout=null},{once:!0}),t.addEventListener(`mouseenter`,()=>{this.#altTextTooltipTimeout=setTimeout(()=>{this.#altTextTooltipTimeout=null,this.#altTextTooltip.classList.add(`show`),this.#editor._reportTelemetry({action:`alt_text_tooltip`})},100)},{signal:e}),t.addEventListener(`mouseleave`,()=>{this.#altTextTooltipTimeout&&=(clearTimeout(this.#altTextTooltipTimeout),null),this.#altTextTooltip?.classList.remove(`show`)},{signal:e})}this.#altTextDecorative?n.setAttribute(`data-l10n-id`,`pdfjs-editor-alt-text-decorative-tooltip`):(n.removeAttribute(`data-l10n-id`),n.textContent=this.#altText),n.parentNode||t.append(n),this.#editor.getElementForAltText()?.setAttribute(`aria-describedby`,n.id)}},St=class{#commentStandaloneButton=null;#commentToolbarButton=null;#commentWasFromKeyBoard=!1;#editor=null;#initialText=null;#richText=null;#text=null;#date=null;#deleted=!1;#popupPosition=null;constructor(e){this.#editor=e}renderForToolbar(){let e=this.#commentToolbarButton=document.createElement(`button`);return e.className=`comment`,this.#render(e,!1)}renderForStandalone(){let e=this.#commentStandaloneButton=document.createElement(`button`);e.className=`annotationCommentButton`;let t=this.#editor.commentButtonPosition;if(t){let{style:n}=e;n.insetInlineEnd=`calc(${100*(this.#editor._uiManager.direction===`ltr`?1-t[0]:t[0])}% - var(--comment-button-dim))`,n.top=`calc(${100*t[1]}% - var(--comment-button-dim))`;let r=this.#editor.commentButtonColor;r&&(n.backgroundColor=r)}return this.#render(e,!0)}focusButton(){setTimeout(()=>{(this.#commentStandaloneButton??this.#commentToolbarButton)?.focus()},0)}onUpdatedColor(){if(!this.#commentStandaloneButton)return;let e=this.#editor.commentButtonColor;e&&(this.#commentStandaloneButton.style.backgroundColor=e),this.#editor._uiManager.updatePopupColor(this.#editor)}get commentButtonWidth(){return(this.#commentStandaloneButton?.getBoundingClientRect().width??0)/this.#editor.parent.boundingClientRect.width}get commentPopupPositionInLayer(){if(this.#popupPosition)return this.#popupPosition;if(!this.#commentStandaloneButton)return null;let{x:e,y:t,height:n}=this.#commentStandaloneButton.getBoundingClientRect(),{x:r,y:i,width:a,height:o}=this.#editor.parent.boundingClientRect;return[(e-r)/a,(t+n-i)/o]}set commentPopupPositionInLayer(e){this.#popupPosition=e}hasDefaultPopupPosition(){return this.#popupPosition===null}removeStandaloneCommentButton(){this.#commentStandaloneButton?.remove(),this.#commentStandaloneButton=null}removeToolbarCommentButton(){this.#commentToolbarButton?.remove(),this.#commentToolbarButton=null}setCommentButtonStates({selected:e,hasPopup:t}){this.#commentStandaloneButton&&(this.#commentStandaloneButton.classList.toggle(`selected`,e),this.#commentStandaloneButton.ariaExpanded=t)}#render(e,t){if(!this.#editor._uiManager.hasCommentManager())return null;e.tabIndex=`0`,e.ariaHasPopup=`dialog`,t?(e.ariaControls=`commentPopup`,e.setAttribute(`data-l10n-id`,`pdfjs-show-comment-button`)):(e.ariaControlsElements=[this.#editor._uiManager.getCommentDialogElement()],e.setAttribute(`data-l10n-id`,`pdfjs-editor-add-comment-button`));let n=this.#editor._uiManager._signal;if(!(n instanceof AbortSignal)||n.aborted)return e;e.addEventListener(`contextmenu`,V,{signal:n}),t&&(e.addEventListener(`focusin`,e=>{this.#editor._focusEventsAllowed=!1,H(e)},{capture:!0,signal:n}),e.addEventListener(`focusout`,e=>{this.#editor._focusEventsAllowed=!0,H(e)},{capture:!0,signal:n})),e.addEventListener(`pointerdown`,e=>e.stopPropagation(),{signal:n});let r=t=>{t.preventDefault(),e===this.#commentToolbarButton?this.edit():this.#editor.toggleComment(!0)};return e.addEventListener(`click`,r,{capture:!0,signal:n}),e.addEventListener(`keydown`,t=>{t.target===e&&t.key===`Enter`&&(this.#commentWasFromKeyBoard=!0,r(t))},{signal:n}),e.addEventListener(`pointerenter`,()=>{this.#editor.toggleComment(!1,!0)},{signal:n}),e.addEventListener(`pointerleave`,()=>{this.#editor.toggleComment(!1,!1)},{signal:n}),e}edit(e){let t=this.commentPopupPositionInLayer,n,r;if(t)[n,r]=t;else{[n,r]=this.#editor.commentButtonPosition;let{width:e,height:t,x:i,y:a}=this.#editor;n=i+n*e,r=a+r*t}let i=this.#editor.parent.boundingClientRect,{x:a,y:o,width:s,height:c}=i;this.#editor._uiManager.editComment(this.#editor,a+n*s,o+r*c,{...e,parentDimensions:i})}finish(){this.#commentToolbarButton&&(this.#commentToolbarButton.focus({focusVisible:this.#commentWasFromKeyBoard}),this.#commentWasFromKeyBoard=!1)}isDeleted(){return this.#deleted||this.#text===``}isEmpty(){return this.#text===null}hasBeenEdited(){return this.isDeleted()||this.#text!==this.#initialText}serialize(){return this.data}get data(){return{text:this.#text,richText:this.#richText,date:this.#date,deleted:this.isDeleted()}}set data(e){if(e!==this.#text&&(this.#richText=null),e===null){this.#text=``,this.#deleted=!0;return}this.#text=e,this.#date=new Date,this.#deleted=!1}restoreData({text:e,richText:t,date:n}){this.#text=e,this.#richText=t,this.#date=n,this.#deleted=!1}setInitialText(e,t=null){this.#initialText=e,this.data=e,this.#date=null,this.#richText=t}shown(){}destroy(){this.#commentToolbarButton?.remove(),this.#commentToolbarButton=null,this.#commentStandaloneButton?.remove(),this.#commentStandaloneButton=null,this.#text=``,this.#richText=null,this.#date=null,this.#editor=null,this.#commentWasFromKeyBoard=!1,this.#deleted=!1}},Ct=class e{#container;#isPinching=!1;#isPinchingStopped=null;#isPinchingDisabled;#onPinchStart;#onPinching;#onPinchEnd;#pointerDownAC=null;#signal;#touchInfo=null;#touchManagerAC;#touchMoveAC=null;constructor({container:e,isPinchingDisabled:t=null,isPinchingStopped:n=null,onPinchStart:r=null,onPinching:i=null,onPinchEnd:a=null,signal:o}){this.#container=e,this.#isPinchingStopped=n,this.#isPinchingDisabled=t,this.#onPinchStart=r,this.#onPinching=i,this.#onPinchEnd=a,this.#touchManagerAC=new AbortController,this.#signal=AbortSignal.any([o,this.#touchManagerAC.signal]),e.addEventListener(`touchstart`,this.#onTouchStart.bind(this),{passive:!1,signal:this.#signal})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return 35/Qe.pixelRatio}#onTouchStart(e){if(this.#isPinchingDisabled?.())return;if(e.touches.length===1){if(this.#pointerDownAC)return;let e=this.#pointerDownAC=new AbortController,t=AbortSignal.any([this.#signal,e.signal]),n=this.#container,r={capture:!0,signal:t,passive:!1},i=e=>{e.pointerType===`touch`&&(this.#pointerDownAC?.abort(),this.#pointerDownAC=null)};n.addEventListener(`pointerdown`,e=>{e.pointerType===`touch`&&(H(e),i(e))},r),n.addEventListener(`pointerup`,i,r),n.addEventListener(`pointercancel`,i,r);return}if(!this.#touchMoveAC){this.#touchMoveAC=new AbortController;let e=AbortSignal.any([this.#signal,this.#touchMoveAC.signal]),t=this.#container,n={signal:e,capture:!1,passive:!1};t.addEventListener(`touchmove`,this.#onTouchMove.bind(this),n);let r=this.#onTouchEnd.bind(this);t.addEventListener(`touchend`,r,n),t.addEventListener(`touchcancel`,r,n),n.capture=!0,t.addEventListener(`pointerdown`,H,n),t.addEventListener(`pointermove`,H,n),t.addEventListener(`pointercancel`,H,n),t.addEventListener(`pointerup`,H,n),this.#onPinchStart?.()}if(H(e),e.touches.length!==2||this.#isPinchingStopped?.()){this.#touchInfo=null;return}let[t,n]=e.touches;t.identifier>n.identifier&&([t,n]=[n,t]),this.#touchInfo={touch0X:t.screenX,touch0Y:t.screenY,touch1X:n.screenX,touch1Y:n.screenY}}#onTouchMove(t){if(!this.#touchInfo||t.touches.length!==2)return;H(t);let[n,r]=t.touches;n.identifier>r.identifier&&([n,r]=[r,n]);let{screenX:i,screenY:a}=n,{screenX:o,screenY:s}=r,c=this.#touchInfo,{touch0X:l,touch0Y:u,touch1X:d,touch1Y:f}=c,p=d-l,m=f-u,h=o-i,g=s-a,_=Math.hypot(h,g)||1,v=Math.hypot(p,m)||1;if(!this.#isPinching&&Math.abs(v-_)<=e.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(c.touch0X=i,c.touch0Y=a,c.touch1X=o,c.touch1Y=s,!this.#isPinching){this.#isPinching=!0;return}let y=[(i+o)/2,(a+s)/2];this.#onPinching?.(y,v,_)}#onTouchEnd(e){e.touches.length>=2||(this.#touchMoveAC&&(this.#touchMoveAC.abort(),this.#touchMoveAC=null,this.#onPinchEnd?.()),this.#touchInfo&&(H(e),this.#touchInfo=null,this.#isPinching=!1))}destroy(){this.#touchManagerAC?.abort(),this.#touchManagerAC=null,this.#pointerDownAC?.abort(),this.#pointerDownAC=null}},G=class e{#accessibilityData=null;#allResizerDivs=null;#altText=null;#comment=null;#commentStandaloneButton=null;#disabled=!1;#dragPointerId=null;#dragPointerType=``;#resizersDiv=null;#lastPointerCoords=null;#savedDimensions=null;#fakeAnnotation=null;#focusAC=null;#focusedResizerName=``;#hasBeenClicked=!1;#initialRect=null;#isEditing=!1;#isInEditMode=!1;#isResizerEnabledForKeyboard=!1;#moveInDOMTimeout=null;#prevDragX=0;#prevDragY=0;#telemetryTimeouts=null;#touchManager=null;isSelected=!1;_isCopy=!1;_editToolbar=null;_initialOptions=Object.create(null);_initialData=null;_isVisible=!0;_uiManager=null;_focusEventsAllowed=!0;static _l10n=null;static _l10nResizer=null;#isDraggable=!1;#zIndex=e._zIndex++;static _borderLineWidth=-1;static _colorManager=new yt;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){let t=e.prototype._resizeWithKeyboard,n=bt.TRANSLATE_SMALL,r=bt.TRANSLATE_BIG;return L(this,`_resizerKeyboardManager`,new vt([[[`ArrowLeft`,`mac+ArrowLeft`],t,{args:[-n,0]}],[[`ctrl+ArrowLeft`,`mac+shift+ArrowLeft`],t,{args:[-r,0]}],[[`ArrowRight`,`mac+ArrowRight`],t,{args:[n,0]}],[[`ctrl+ArrowRight`,`mac+shift+ArrowRight`],t,{args:[r,0]}],[[`ArrowUp`,`mac+ArrowUp`],t,{args:[0,-n]}],[[`ctrl+ArrowUp`,`mac+shift+ArrowUp`],t,{args:[0,-r]}],[[`ArrowDown`,`mac+ArrowDown`],t,{args:[0,n]}],[[`ctrl+ArrowDown`,`mac+shift+ArrowDown`],t,{args:[0,r]}],[[`Escape`,`mac+Escape`],e.prototype._stopResizingWithKeyboard]]))}constructor(e){this.parent=e.parent,this.id=e.id,this.width=this.height=null,this.pageIndex=e.parent.pageIndex,this.name=e.name,this.div=null,this._uiManager=e.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=e.isCentered,this._structTreeParentId=null,this.annotationElementId=e.annotationElementId||null,this.creationDate=e.creationDate||new Date,this.modificationDate=e.modificationDate||null,this.canAddComment=!0;let{rotation:t,rawDims:{pageWidth:n,pageHeight:r,pageX:i,pageY:a}}=this.parent.viewport;this.rotation=t,this.pageRotation=(360+t-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[n,r],this.pageTranslation=[i,a];let[o,s]=this.parentDimensions;this.x=e.x/o,this.y=e.y/s,this.isAttachedToDOM=!1,this.deleted=!1}updatePageIndex(e){this.pageIndex=e}get editorType(){return Object.getPrototypeOf(this).constructor._type}get mode(){return Object.getPrototypeOf(this).constructor._editorType}static get isDrawer(){return!1}static get _defaultLineColor(){return L(this,`_defaultLineColor`,this._colorManager.getHexCode(`CanvasText`))}static deleteAnnotationElement(e){let t=new wt({id:e.parent.getNextId(),parent:e.parent,uiManager:e._uiManager});t.annotationElementId=e.annotationElementId,t.deleted=!0,t._uiManager.addToAnnotationStorage(t)}static initialize(t,n){if(e._l10n??=t,e._l10nResizer||=Object.freeze({topLeft:`pdfjs-editor-resizer-top-left`,topMiddle:`pdfjs-editor-resizer-top-middle`,topRight:`pdfjs-editor-resizer-top-right`,middleRight:`pdfjs-editor-resizer-middle-right`,bottomRight:`pdfjs-editor-resizer-bottom-right`,bottomMiddle:`pdfjs-editor-resizer-bottom-middle`,bottomLeft:`pdfjs-editor-resizer-bottom-left`,middleLeft:`pdfjs-editor-resizer-middle-left`}),e._borderLineWidth!==-1)return;let r=getComputedStyle(document.documentElement);e._borderLineWidth=parseFloat(r.getPropertyValue(`--outline-width`))||0}static updateDefaultParams(e,t){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(e){return!1}static paste(e,t){F(`Not implemented`)}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#isDraggable}set _isDraggable(e){this.#isDraggable=e,this.div?.classList.toggle(`draggable`,e)}get uid(){return this.annotationElementId||this.id}get isEnterHandled(){return!0}center(){let[e,t]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*t/(e*2),this.y+=this.width*e/(t*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*t/(e*2),this.y-=this.width*e/(t*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(e){this._uiManager.addCommands(e)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#zIndex}setParent(e){e===null?(this.#stopResizing(),this.#fakeAnnotation?.remove(),this.#fakeAnnotation=null):(this.pageIndex=e.pageIndex,this.pageDimensions=e.pageDimensions),this.parent=e}focusin(e){this._focusEventsAllowed&&(this.#hasBeenClicked?this.#hasBeenClicked=!1:this.parent.setSelected(this))}focusout(e){this._focusEventsAllowed&&this.isAttachedToDOM&&(e.relatedTarget?.closest(`#${this.id}`)||(e.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove()))}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.isInEditMode()&&this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(e,t,n,r){let[i,a]=this.parentDimensions;[n,r]=this.screenToPageTranslation(n,r),this.x=(e+n)/i,this.y=(t+r)/a,this.fixAndSetPosition()}_moveAfterPaste(e,t){let[n,r]=this.parentDimensions;this.setAt(e*n,t*r,this.width*n,this.height*r),this._onTranslated()}#translate([e,t],n,r){[n,r]=this.screenToPageTranslation(n,r),this.x+=n/e,this.y+=r/t,this._onTranslating(this.x,this.y),this.fixAndSetPosition()}translate(e,t){this.#translate(this.parentDimensions,e,t)}translateInPage(e,t){this.#initialRect||=[this.x,this.y,this.width,this.height],this.#translate(this.pageDimensions,e,t),this.div.scrollIntoView({block:`nearest`})}translationDone(){this._onTranslated(this.x,this.y)}drag(e,t){this.#initialRect||=[this.x,this.y,this.width,this.height];let{div:n,parentDimensions:[r,i]}=this;if(this.x+=e/r,this.y+=t/i,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){let{x:e,y:t}=this.div.getBoundingClientRect();this.parent.findNewParent(this,e,t)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:a,y:o}=this,[s,c]=this.getBaseTranslation();a+=s,o+=c;let{style:l}=n;l.left=`${(100*a).toFixed(2)}%`,l.top=`${(100*o).toFixed(2)}%`,this._onTranslating(a,o),n.scrollIntoView({block:`nearest`})}_onTranslating(e,t){}_onTranslated(e,t){}get _hasBeenMoved(){return!!this.#initialRect&&(this.#initialRect[0]!==this.x||this.#initialRect[1]!==this.y)}get _hasBeenResized(){return!!this.#initialRect&&(this.#initialRect[2]!==this.width||this.#initialRect[3]!==this.height)}getBaseTranslation(){let[t,n]=this.parentDimensions,{_borderLineWidth:r}=e,i=r/t,a=r/n;switch(this.rotation){case 90:return[-i,a];case 180:return[i,a];case 270:return[i,-a];default:return[-i,-a]}}get _mustFixPosition(){return!0}fixAndSetPosition(e=this.rotation){let{div:{style:t},pageDimensions:[n,r]}=this,{x:i,y:a,width:o,height:s}=this;if(o*=n,s*=r,i*=n,a*=r,this._mustFixPosition)switch(e){case 0:i=B(i,0,n-o),a=B(a,0,r-s);break;case 90:i=B(i,0,n-s),a=B(a,o,r);break;case 180:i=B(i,o,n),a=B(a,s,r);break;case 270:i=B(i,s,n),a=B(a,0,r-o);break}this.x=i/=n,this.y=a/=r;let[c,l]=this.getBaseTranslation();i+=c,a+=l,t.left=`${(100*i).toFixed(2)}%`,t.top=`${(100*a).toFixed(2)}%`,this.moveInDOM()}static#rotatePoint(e,t,n){switch(n){case 90:return[t,-e];case 180:return[-e,-t];case 270:return[-t,e];default:return[e,t]}}screenToPageTranslation(t,n){return e.#rotatePoint(t,n,this.parentRotation)}pageTranslationToScreen(t,n){return e.#rotatePoint(t,n,360-this.parentRotation)}#getRotationMatrix(e){switch(e){case 90:{let[e,t]=this.pageDimensions;return[0,-e/t,t/e,0]}case 180:return[-1,0,0,-1];case 270:{let[e,t]=this.pageDimensions;return[0,e/t,-t/e,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){let{parentScale:e,pageDimensions:[t,n]}=this;return[t*e,n*e]}setDims(){let{div:{style:e},width:t,height:n}=this;e.width=`${(100*t).toFixed(2)}%`,e.height=`${(100*n).toFixed(2)}%`}getInitialTranslation(){return[0,0]}#createResizers(){if(this.#resizersDiv)return;this.#resizersDiv=document.createElement(`div`),this.#resizersDiv.classList.add(`resizers`);let e=this._willKeepAspectRatio?[`topLeft`,`topRight`,`bottomRight`,`bottomLeft`]:[`topLeft`,`topMiddle`,`topRight`,`middleRight`,`bottomRight`,`bottomMiddle`,`bottomLeft`,`middleLeft`],t=this._uiManager._signal;for(let n of e){let e=document.createElement(`div`);this.#resizersDiv.append(e),e.classList.add(`resizer`,n),e.setAttribute(`data-resizer-name`,n),e.addEventListener(`pointerdown`,this.#resizerPointerdown.bind(this,n),{signal:t}),e.addEventListener(`contextmenu`,V,{signal:t}),e.tabIndex=-1}this.div.prepend(this.#resizersDiv)}#resizerPointerdown(e,t){t.preventDefault();let{isMac:n}=R.platform;if(t.button!==0||t.ctrlKey&&n)return;this.#altText?.toggle(!1);let r=this._isDraggable;this._isDraggable=!1,this.#lastPointerCoords=[t.screenX,t.screenY];let i=new AbortController,a=this._uiManager.combinedSignal(i);this.parent.togglePointerEvents(!1),window.addEventListener(`pointermove`,this.#resizerPointermove.bind(this,e),{passive:!0,capture:!0,signal:a}),window.addEventListener(`touchmove`,H,{passive:!1,signal:a}),window.addEventListener(`contextmenu`,V,{signal:a}),this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};let o=this.parent.div.style.cursor,s=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(t.target).cursor;let c=()=>{i.abort(),this.parent.togglePointerEvents(!0),this.#altText?.toggle(!0),this._isDraggable=r,this.parent.div.style.cursor=o,this.div.style.cursor=s,this.#addResizeToUndoStack()};window.addEventListener(`pointerup`,c,{signal:a}),window.addEventListener(`blur`,c,{signal:a})}#resize(e,t,n,r){this.width=n,this.height=r,this.x=e,this.y=t,this.setDims(),this.fixAndSetPosition(),this._onResized()}_onResized(){}#addResizeToUndoStack(){if(!this.#savedDimensions)return;let{savedX:e,savedY:t,savedWidth:n,savedHeight:r}=this.#savedDimensions;this.#savedDimensions=null;let i=this.x,a=this.y,o=this.width,s=this.height;i===e&&a===t&&o===n&&s===r||this.addCommands({cmd:this.#resize.bind(this,i,a,o,s),undo:this.#resize.bind(this,e,t,n,r),mustExec:!0})}static _round(e){return Math.round(e*1e4)/1e4}#resizerPointermove(t,n){let[r,i]=this.parentDimensions,a=this.x,o=this.y,s=this.width,c=this.height,l=e.MIN_SIZE/r,u=e.MIN_SIZE/i,d=this.#getRotationMatrix(this.rotation),f=(e,t)=>[d[0]*e+d[2]*t,d[1]*e+d[3]*t],p=this.#getRotationMatrix(360-this.rotation),m=(e,t)=>[p[0]*e+p[2]*t,p[1]*e+p[3]*t],h,g,_=!1,v=!1;switch(t){case`topLeft`:_=!0,h=(e,t)=>[0,0],g=(e,t)=>[e,t];break;case`topMiddle`:h=(e,t)=>[e/2,0],g=(e,t)=>[e/2,t];break;case`topRight`:_=!0,h=(e,t)=>[e,0],g=(e,t)=>[0,t];break;case`middleRight`:v=!0,h=(e,t)=>[e,t/2],g=(e,t)=>[0,t/2];break;case`bottomRight`:_=!0,h=(e,t)=>[e,t],g=(e,t)=>[0,0];break;case`bottomMiddle`:h=(e,t)=>[e/2,t],g=(e,t)=>[e/2,0];break;case`bottomLeft`:_=!0,h=(e,t)=>[0,t],g=(e,t)=>[e,0];break;case`middleLeft`:v=!0,h=(e,t)=>[0,t/2],g=(e,t)=>[e,t/2];break}let y=h(s,c),b=g(s,c),x=f(...b),S=e._round(a+x[0]),C=e._round(o+x[1]),w=1,T=1,E,D;if(n.fromKeyboard)({deltaX:E,deltaY:D}=n);else{let{screenX:e,screenY:t}=n,[r,i]=this.#lastPointerCoords;[E,D]=this.screenToPageTranslation(e-r,t-i),this.#lastPointerCoords[0]=e,this.#lastPointerCoords[1]=t}if([E,D]=m(E/r,D/i),_){let e=Math.hypot(s,c);w=T=Math.max(Math.min(Math.hypot(b[0]-y[0]-E,b[1]-y[1]-D)/e,1/s,1/c),l/s,u/c)}else v?w=B(Math.abs(b[0]-y[0]-E),l,1)/s:T=B(Math.abs(b[1]-y[1]-D),u,1)/c;let O=e._round(s*w),k=e._round(c*T);x=f(...g(O,k));let A=S-x[0],j=C-x[1];this.#initialRect||=[this.x,this.y,this.width,this.height],this.width=O,this.height=k,this.x=A,this.y=j,this.setDims(),this.fixAndSetPosition(),this._onResizing()}_onResizing(){}altTextFinish(){this.#altText?.finish()}get toolbarButtons(){return null}async addEditToolbar(){if(this._editToolbar||this.#isInEditMode)return this._editToolbar;this._editToolbar=new ft(this),this.div.append(this._editToolbar.render());let{toolbarButtons:e}=this;if(e)for(let[t,n]of e)await this._editToolbar.addButton(t,n);return this.hasComment||this._editToolbar.addButton(`comment`,this.addCommentButton()),this._editToolbar.addButton(`delete`),this._editToolbar}addCommentButtonInToolbar(){this._editToolbar?.addButtonBefore(`comment`,this.addCommentButton(),`.deleteButton`)}removeCommentButtonFromToolbar(){this._editToolbar?.removeButton(`comment`)}removeEditToolbar(){this._editToolbar?.remove(),this._editToolbar=null,this.#altText?.destroy()}addContainer(e){let t=this._editToolbar?.div;t?t.before(e):this.div.append(e)}getClientDimensions(){return this.div.getBoundingClientRect()}createAltText(){return this.#altText||(xt.initialize(e._l10n),this.#altText=new xt(this),this.#accessibilityData&&=(this.#altText.data=this.#accessibilityData,null)),this.#altText}get altTextData(){return this.#altText?.data}set altTextData(e){this.#altText&&(this.#altText.data=e)}get guessedAltText(){return this.#altText?.guessedText}async setGuessedAltText(e){await this.#altText?.setGuessedText(e)}serializeAltText(e){return this.#altText?.serialize(e)}hasAltText(){return!!this.#altText&&!this.#altText.isEmpty()}hasAltTextData(){return this.#altText?.hasData()??!1}focusCommentButton(){this.#comment?.focusButton()}addCommentButton(){return this.canAddComment?this.#comment||=new St(this):null}addStandaloneCommentButton(){if(this._uiManager.hasCommentManager()){if(this.#commentStandaloneButton){this._uiManager.isEditingMode()&&this.#commentStandaloneButton.classList.remove(`hidden`);return}this.hasComment&&(this.#commentStandaloneButton=this.#comment.renderForStandalone(),this.div.append(this.#commentStandaloneButton))}}removeStandaloneCommentButton(){this.#comment.removeStandaloneCommentButton(),this.#commentStandaloneButton=null}hideStandaloneCommentButton(){this.#commentStandaloneButton?.classList.add(`hidden`)}get comment(){if(!this.#comment)return null;let{data:{richText:e,text:t,date:n,deleted:r}}=this.#comment;return{text:t,richText:e,date:n,deleted:r,color:this.getNonHCMColor(),opacity:this.opacity??1}}set comment(e){this.#comment||=new St(this),typeof e==`object`&&e?this.#comment.restoreData(e):this.#comment.data=e,this.hasComment?(this.removeCommentButtonFromToolbar(),this.addStandaloneCommentButton(),this._uiManager.updateComment(this)):(this.addCommentButtonInToolbar(),this.removeStandaloneCommentButton(),this._uiManager.removeComment(this))}setCommentData({comment:e,popupRef:t,richText:n}){if(!t||(this.#comment||=new St(this),this.#comment.setInitialText(e,n),!this.annotationElementId))return;let r=this._uiManager.getAndRemoveDataFromAnnotationStorage(this.annotationElementId);r&&this.updateFromAnnotationLayer(r)}get hasEditedComment(){return this.#comment?.hasBeenEdited()}get hasDeletedComment(){return this.#comment?.isDeleted()}get hasComment(){return!!this.#comment&&!this.#comment.isEmpty()&&!this.#comment.isDeleted()}async editComment(e){this.#comment||=new St(this),this.#comment.edit(e)}toggleComment(e,t=void 0){this.hasComment&&this._uiManager.toggleComment(this,e,t)}setSelectedCommentButton(e){this.#comment.setSelectedButton(e)}addComment(e){if(this.hasEditedComment){let[,,,t]=e.rect,[n]=this.pageDimensions,[r]=this.pageTranslation,i=r+n+1,a=t-100,o=i+180;e.popup={contents:this.comment.text,deleted:this.comment.deleted,rect:[i,a,o,t]}}}updateFromAnnotationLayer({popup:{contents:e,deleted:t}}){this.#comment.data=t?null:e}get parentBoundingClientRect(){return this.parent.boundingClientRect}render(){let e=this.div=document.createElement(`div`);e.setAttribute(`data-editor-rotation`,(360-this.rotation)%360),e.className=this.name,e.setAttribute(`id`,this.id),e.tabIndex=this.#disabled?-1:0,e.setAttribute(`role`,`application`),this.defaultL10nId&&e.setAttribute(`data-l10n-id`,this.defaultL10nId),this._isVisible||e.classList.add(`hidden`),this.setInForeground(),this.#addFocusListeners();let[t,n]=this.parentDimensions;this.parentRotation%180!=0&&(e.style.maxWidth=`${(100*n/t).toFixed(2)}%`,e.style.maxHeight=`${(100*t/n).toFixed(2)}%`);let[r,i]=this.getInitialTranslation();return this.translate(r,i),mt(this,e,[`keydown`,`pointerdown`,`dblclick`]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(this.#touchManager||=new Ct({container:e,isPinchingDisabled:()=>!this.isSelected,onPinchStart:this.#touchPinchStartCallback.bind(this),onPinching:this.#touchPinchCallback.bind(this),onPinchEnd:this.#touchPinchEndCallback.bind(this),signal:this._uiManager._signal})),this.addStandaloneCommentButton(),this._uiManager._editorUndoBar?.hide(),e}#touchPinchStartCallback(){this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height},this.#altText?.toggle(!1),this.parent.togglePointerEvents(!1)}#touchPinchCallback(t,n,r){let i=.7,a=i*(r/n)+1-i;if(a===1)return;let o=this.#getRotationMatrix(this.rotation),s=(e,t)=>[o[0]*e+o[2]*t,o[1]*e+o[3]*t],[c,l]=this.parentDimensions,u=this.x,d=this.y,f=this.width,p=this.height,m=e.MIN_SIZE/c,h=e.MIN_SIZE/l;a=Math.max(Math.min(a,1/f,1/p),m/f,h/p);let g=e._round(f*a),_=e._round(p*a);if(g===f&&_===p)return;this.#initialRect||=[u,d,f,p];let v=s(f/2,p/2),y=e._round(u+v[0]),b=e._round(d+v[1]),x=s(g/2,_/2);this.x=y-x[0],this.y=b-x[1],this.width=g,this.height=_,this.setDims(),this.fixAndSetPosition(),this._onResizing()}#touchPinchEndCallback(){this.#altText?.toggle(!0),this.parent.togglePointerEvents(!0),this.#addResizeToUndoStack()}pointerdown(e){let{isMac:t}=R.platform;if(e.button!==0||e.ctrlKey&&t){e.preventDefault();return}if(this.#hasBeenClicked=!0,this._isDraggable){this.#setUpDragSession(e);return}this.#selectOnPointerEvent(e)}#selectOnPointerEvent(e){let{isMac:t}=R.platform;e.ctrlKey&&!t||e.shiftKey||e.metaKey&&t?this.parent.toggleSelected(this):this.parent.setSelected(this)}#setUpDragSession(e){let{isSelected:t}=this;this._uiManager.setUpDragSession();let n=!1,r=new AbortController,i=this._uiManager.combinedSignal(r),a={capture:!0,passive:!1,signal:i},o=e=>{r.abort(),this.#dragPointerId=null,this.#hasBeenClicked=!1,this._uiManager.endDragSession()||this.#selectOnPointerEvent(e),n&&this._onStopDragging()};t&&(this.#prevDragX=e.clientX,this.#prevDragY=e.clientY,this.#dragPointerId=e.pointerId,this.#dragPointerType=e.pointerType,window.addEventListener(`pointermove`,e=>{n||(n=!0,this._uiManager.toggleComment(this,!0,!1),this._onStartDragging());let{clientX:t,clientY:r,pointerId:i}=e;if(i!==this.#dragPointerId){H(e);return}let[a,o]=this.screenToPageTranslation(t-this.#prevDragX,r-this.#prevDragY);this.#prevDragX=t,this.#prevDragY=r,this._uiManager.dragSelectedEditors(a,o)},a),window.addEventListener(`touchmove`,H,a),window.addEventListener(`pointerdown`,e=>{e.pointerType===this.#dragPointerType&&(this.#touchManager||e.isPrimary)&&o(e),H(e)},a));let s=e=>{if(!this.#dragPointerId||this.#dragPointerId===e.pointerId){o(e);return}H(e)};window.addEventListener(`pointerup`,s,{signal:i}),window.addEventListener(`blur`,s,{signal:i})}_onStartDragging(){}_onStopDragging(){}moveInDOM(){this.#moveInDOMTimeout&&clearTimeout(this.#moveInDOMTimeout),this.#moveInDOMTimeout=setTimeout(()=>{this.#moveInDOMTimeout=null,this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(e,t,n){e.changeParent(this),this.x=t,this.y=n,this.fixAndSetPosition(),this._onTranslated()}getRect(e,t,n=this.rotation){let r=this.parentScale,[i,a]=this.pageDimensions,[o,s]=this.pageTranslation,c=e/r,l=t/r,u=this.x*i,d=this.y*a,f=this.width*i,p=this.height*a;switch(n){case 0:return[u+c+o,a-d-l-p+s,u+c+f+o,a-d-l+s];case 90:return[u+l+o,a-d+c+s,u+l+p+o,a-d+c+f+s];case 180:return[u-c-f+o,a-d+l+s,u-c+o,a-d+l+p+s];case 270:return[u-l-p+o,a-d-c-f+s,u-l+o,a-d-c+s];default:throw Error(`Invalid rotation`)}}getRectInCurrentCoords(e,t){let[n,r,i,a]=e,o=i-n,s=a-r;switch(this.rotation){case 0:return[n,t-a,o,s];case 90:return[n,t-r,s,o];case 180:return[i,t-r,o,s];case 270:return[i,t-a,s,o];default:throw Error(`Invalid rotation`)}}getPDFRect(){return this.getRect(0,0)}getNonHCMColor(){return this.color&&e._colorManager.convert(this._uiManager.getNonHCMColor(this.color))}onUpdatedColor(){this.#comment?.onUpdatedColor()}getData(){let{comment:{text:e,color:t,date:n,opacity:r,deleted:i,richText:a},uid:o,pageIndex:s,creationDate:c,modificationDate:l}=this;return{id:o,pageIndex:s,rect:this.getPDFRect(),richText:a,contentsObj:{str:e},creationDate:c,modificationDate:n||l,popupRef:!i,color:t,opacity:r}}onceAdded(e){}isEmpty(){return!1}enableEditMode(){return this.isInEditMode()?!1:(this.parent.setEditingState(!1),this.#isInEditMode=!0,!0)}disableEditMode(){return this.isInEditMode()?(this.parent.setEditingState(!0),this.#isInEditMode=!1,!0):!1}isInEditMode(){return this.#isInEditMode}shouldGetKeyboardEvents(){return this.#isResizerEnabledForKeyboard}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){let{top:e,left:t,bottom:n,right:r}=this.getClientDimensions(),{innerHeight:i,innerWidth:a}=window;return t<a&&r>0&&e<i&&n>0}#addFocusListeners(){if(this.#focusAC||!this.div)return;this.#focusAC=new AbortController;let e=this._uiManager.combinedSignal(this.#focusAC);this.div.addEventListener(`focusin`,this.focusin.bind(this),{signal:e}),this.div.addEventListener(`focusout`,this.focusout.bind(this),{signal:e})}rebuild(){this.#addFocusListeners()}rotate(e){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||``}}serialize(e=!1,t=null){return{annotationType:this.mode,pageIndex:this.pageIndex,rect:this.getPDFRect(),rotation:this.rotation,structTreeParentId:this._structTreeParentId,popupRef:this._initialData?.popupRef||``}}static async deserialize(e,t,n){let r=new this.prototype.constructor({parent:t,id:t.getNextId(),uiManager:n,annotationElementId:e.annotationElementId,creationDate:e.creationDate,modificationDate:e.modificationDate});r.rotation=e.rotation,r.#accessibilityData=e.accessibilityData,r._isCopy=e.isCopy||!1;let[i,a]=r.pageDimensions,[o,s,c,l]=r.getRectInCurrentCoords(e.rect,a);return r.x=o/i,r.y=s/a,r.width=c/i,r.height=l/a,r}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){if(this.#focusAC?.abort(),this.#focusAC=null,this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),this.hideCommentPopup(),this.#moveInDOMTimeout&&=(clearTimeout(this.#moveInDOMTimeout),null),this.#stopResizing(),this.removeEditToolbar(),this.#telemetryTimeouts){for(let e of this.#telemetryTimeouts.values())clearTimeout(e);this.#telemetryTimeouts=null}this.parent=null,this.#touchManager?.destroy(),this.#touchManager=null,this.#fakeAnnotation?.remove(),this.#fakeAnnotation=null}get isResizable(){return!1}makeResizable(){this.isResizable&&(this.#createResizers(),this.#resizersDiv.classList.remove(`hidden`))}get toolbarPosition(){return null}get commentButtonPosition(){return this._uiManager.direction===`ltr`?[1,0]:[0,0]}get commentButtonPositionInPage(){let{commentButtonPosition:[t,n]}=this,[r,i,a,o]=this.getPDFRect();return[e._round(r+(a-r)*t),e._round(i+(o-i)*(1-n))]}get commentButtonColor(){return this._uiManager.makeCommentColor(this.getNonHCMColor(),this.opacity)}get commentPopupPosition(){return this.#comment.commentPopupPositionInLayer}set commentPopupPosition(e){this.#comment.commentPopupPositionInLayer=e}hasDefaultPopupPosition(){return this.#comment.hasDefaultPopupPosition()}get commentButtonWidth(){return this.#comment.commentButtonWidth}get elementBeforePopup(){return this.div}setCommentButtonStates(e){this.#comment?.setCommentButtonStates(e)}keydown(t){if(!this.isResizable||t.target!==this.div||t.key!==`Enter`)return;this._uiManager.setSelected(this),this.#savedDimensions={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};let n=this.#resizersDiv.children;if(!this.#allResizerDivs){this.#allResizerDivs=Array.from(n);let t=this.#resizerKeydown.bind(this),r=this.#resizerBlur.bind(this),i=this._uiManager._signal;for(let n of this.#allResizerDivs){let a=n.getAttribute(`data-resizer-name`);n.setAttribute(`role`,`spinbutton`),n.addEventListener(`keydown`,t,{signal:i}),n.addEventListener(`blur`,r,{signal:i}),n.addEventListener(`focus`,this.#resizerFocus.bind(this,a),{signal:i}),n.setAttribute(`data-l10n-id`,e._l10nResizer[a])}}let r=this.#allResizerDivs[0],i=0;for(let e of n){if(e===r)break;i++}let a=(360-this.rotation+this.parentRotation)%360/90*(this.#allResizerDivs.length/4);if(a!==i){if(a<i)for(let e=0;e<i-a;e++)this.#resizersDiv.append(this.#resizersDiv.firstElementChild);else if(a>i)for(let e=0;e<a-i;e++)this.#resizersDiv.firstElementChild.before(this.#resizersDiv.lastElementChild);let t=0;for(let r of n){let n=this.#allResizerDivs[t++].getAttribute(`data-resizer-name`);r.setAttribute(`data-l10n-id`,e._l10nResizer[n])}}this.#setResizerTabIndex(0),this.#isResizerEnabledForKeyboard=!0,this.#resizersDiv.firstElementChild.focus({focusVisible:!0}),t.preventDefault(),t.stopImmediatePropagation()}#resizerKeydown(t){e._resizerKeyboardManager.exec(this,t)}#resizerBlur(e){this.#isResizerEnabledForKeyboard&&e.relatedTarget?.parentNode!==this.#resizersDiv&&this.#stopResizing()}#resizerFocus(e){this.#focusedResizerName=this.#isResizerEnabledForKeyboard?e:``}#setResizerTabIndex(e){if(this.#allResizerDivs)for(let t of this.#allResizerDivs)t.tabIndex=e}_resizeWithKeyboard(e,t){this.#isResizerEnabledForKeyboard&&this.#resizerPointermove(this.#focusedResizerName,{deltaX:e,deltaY:t,fromKeyboard:!0})}#stopResizing(){this.#isResizerEnabledForKeyboard=!1,this.#setResizerTabIndex(-1),this.#addResizeToUndoStack()}_stopResizingWithKeyboard(){this.#stopResizing(),this.div.focus()}select(){if(this.isSelected&&this._editToolbar){this._editToolbar.show();return}if(this.isSelected=!0,this.makeResizable(),this.div?.classList.add(`selectedEditor`),!this._editToolbar){this.addEditToolbar().then(()=>{this.div?.classList.contains(`selectedEditor`)&&this._editToolbar?.show()});return}this._editToolbar?.show(),this.#altText?.toggleAltTextBadge(!1)}focus(){this.div&&!this.div.contains(document.activeElement)&&setTimeout(()=>this.div?.focus({preventScroll:!0}),0)}unselect(){this.isSelected&&(this.isSelected=!1,this.#resizersDiv?.classList.add(`hidden`),this.div?.classList.remove(`selectedEditor`),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),this._editToolbar?.hide(),this.#altText?.toggleAltTextBadge(!0),this.hideCommentPopup())}hideCommentPopup(){this.hasComment&&this._uiManager.toggleComment(null)}updateParams(e,t){}disableEditing(){}enableEditing(){}get canChangeContent(){return!1}enterInEditMode(){this.canChangeContent&&(this.enableEditMode(),this.div.focus())}dblclick(e){e.target.nodeName!==`BUTTON`&&(this.enterInEditMode(),this.parent.updateToolbar({mode:this.constructor._editorType,editId:this.uid}))}getElementForAltText(){return this.div}get contentDiv(){return this.div}get isEditing(){return this.#isEditing}set isEditing(e){this.#isEditing=e,this.parent&&(e?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:`added`}}get telemetryFinalData(){return null}_reportTelemetry(t,n=!1){if(n){this.#telemetryTimeouts||=new Map;let{action:n}=t,r=this.#telemetryTimeouts.get(n);r&&clearTimeout(r),r=setTimeout(()=>{this._reportTelemetry(t),this.#telemetryTimeouts.delete(n),this.#telemetryTimeouts.size===0&&(this.#telemetryTimeouts=null)},e._telemetryTimeout),this.#telemetryTimeouts.set(n,r);return}t.type||=this.editorType,this._uiManager._eventBus.dispatch(`reporttelemetry`,{source:this,details:{type:`editing`,data:t}})}show(e=this._isVisible){this.div.classList.toggle(`hidden`,!e),this._isVisible=e}enable(){this.div&&(this.div.tabIndex=0),this.#disabled=!1}disable(){this.div&&(this.div.tabIndex=-1),this.#disabled=!0}updateFakeAnnotationElement(e){if(!this.#fakeAnnotation&&!this.deleted){this.#fakeAnnotation=e.addFakeAnnotation(this);return}if(this.deleted){this.#fakeAnnotation.remove(),this.#fakeAnnotation=null;return}(this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized)&&this.#fakeAnnotation.updateEdited({rect:this.getPDFRect(),popup:this.comment})}renderAnnotationElement(e){if(this.deleted)return e.hide(),null;let t=e.container.querySelector(`.annotationContent`);if(!t)t=document.createElement(`div`),t.classList.add(`annotationContent`,this.editorType),e.container.prepend(t);else if(t.nodeName===`CANVAS`){let e=t;t=document.createElement(`div`),t.classList.add(`annotationContent`,this.editorType),e.before(t)}return t}resetAnnotationElement(e){let{firstElementChild:t}=e.container;t?.nodeName===`DIV`&&t.classList.contains(`annotationContent`)&&t.remove()}},wt=class extends G{constructor(e){super(e),this.annotationElementId=e.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}},Tt=3285377520,Et=4294901760,Dt=65535,Ot=class{constructor(e){this.h1=e?e&4294967295:Tt,this.h2=e?e&4294967295:Tt}update(e){let t,n;if(typeof e==`string`){t=new Uint8Array(e.length*2),n=0;for(let r=0,i=e.length;r<i;r++){let i=e.charCodeAt(r);i<=255?t[n++]=i:(t[n++]=i>>>8,t[n++]=i&255)}}else if(ArrayBuffer.isView(e))t=e.slice(),n=t.byteLength;else throw Error(`Invalid data format, must be a string or TypedArray.`);let r=n>>2,i=n-r*4,a=new Uint32Array(t.buffer,0,r),o=0,s=0,c=this.h1,l=this.h2,u=3432918353,d=461845907,f=u&Dt,p=d&Dt;for(let e=0;e<r;e++)e&1?(o=a[e],o=o*u&Et|o*f&Dt,o=o<<15|o>>>17,o=o*d&Et|o*p&Dt,c^=o,c=c<<13|c>>>19,c=c*5+3864292196):(s=a[e],s=s*u&Et|s*f&Dt,s=s<<15|s>>>17,s=s*d&Et|s*p&Dt,l^=s,l=l<<13|l>>>19,l=l*5+3864292196);switch(o=0,i){case 3:o^=t[r*4+2]<<16;case 2:o^=t[r*4+1]<<8;case 1:o^=t[r*4],o=o*u&Et|o*f&Dt,o=o<<15|o>>>17,o=o*d&Et|o*p&Dt,r&1?c^=o:l^=o}this.h1=c,this.h2=l}hexdigest(){let e=this.h1,t=this.h2;return e^=t>>>1,e=e*3981806797&Et|e*36045&Dt,t=t*4283543511&Et|((t<<16|e>>>16)*2950163797&Et)>>>16,e^=t>>>1,e=e*444984403&Et|e*60499&Dt,t=t*3301882366&Et|((t<<16|e>>>16)*3120437893&Et)>>>16,e^=t>>>1,(e>>>0).toString(16).padStart(8,`0`)+(t>>>0).toString(16).padStart(8,`0`)}},kt=Object.freeze({map:null,hash:``,transfer:void 0}),At=class{#modified=!1;#modifiedIds=null;#editorsMap=null;#storage=new Map;constructor(){this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(e,t){let n=this.#storage.get(e);return n===void 0?t:Object.assign(t,n)}getRawValue(e){return this.#storage.get(e)}remove(e){let t=this.#storage.get(e);if(t!==void 0&&(t instanceof G&&this.#editorsMap.delete(t.annotationElementId),this.#storage.delete(e),this.#storage.size===0&&this.resetModified(),typeof this.onAnnotationEditor==`function`)){for(let e of this.#storage.values())if(e instanceof G)return;this.onAnnotationEditor(null)}}setValue(e,t){let n=this.#storage.get(e),r=!1;if(n!==void 0)for(let[e,i]of Object.entries(t))n[e]!==i&&(r=!0,n[e]=i);else r=!0,this.#storage.set(e,t);r&&this.#setModified(),t instanceof G&&((this.#editorsMap||=new Map).set(t.annotationElementId,t),typeof this.onAnnotationEditor==`function`&&this.onAnnotationEditor(t.constructor._type))}has(e){return this.#storage.has(e)}get size(){return this.#storage.size}#setModified(){this.#modified||(this.#modified=!0,typeof this.onSetModified==`function`&&this.onSetModified())}resetModified(){this.#modified&&(this.#modified=!1,typeof this.onResetModified==`function`&&this.onResetModified())}get print(){return new jt(this)}get serializable(){if(this.#storage.size===0)return kt;let e=new Map,t=new Ot,n=[],r=Object.create(null),i=!1;for(let[n,a]of this.#storage){let o=a instanceof G?a.serialize(!1,r):a;a.page&&(a.pageIndex=a.page._pageIndex,delete a.page),o&&(e.set(n,o),t.update(`${n}:${JSON.stringify(o)}`),i||=!!o.bitmap)}if(i)for(let t of e.values())t.bitmap&&n.push(t.bitmap);return e.size>0?{map:e,hash:t.hexdigest(),transfer:n}:kt}get editorStats(){let e=null,t=new Map,n=0,r=0;for(let i of this.#storage.values()){if(!(i instanceof G)){i.popup&&(i.popup.deleted?r+=1:n+=1);continue}i.isCommentDeleted?r+=1:i.hasEditedComment&&(n+=1);let a=i.telemetryFinalData;if(!a)continue;let{type:o}=a;t.has(o)||t.set(o,Object.getPrototypeOf(i).constructor),e||=Object.create(null);let s=e[o]||=new Map;for(let[e,t]of Object.entries(a)){if(e===`type`)continue;let n=s.get(e);n||(n=new Map,s.set(e,n));let r=n.get(t)??0;n.set(t,r+1)}}if((r>0||n>0)&&(e||=Object.create(null),e.comments={deleted:r,edited:n}),!e)return null;for(let[n,r]of t)e[n]=r.computeTelemetryFinalData(e[n]);return e}resetModifiedIds(){this.#modifiedIds=null}updateEditor(e,t){let n=this.#editorsMap?.get(e);return n?(n.updateFromAnnotationLayer(t),!0):!1}getEditor(e){return this.#editorsMap?.get(e)||null}get modifiedIds(){if(this.#modifiedIds)return this.#modifiedIds;let e=[];if(this.#editorsMap)for(let t of this.#editorsMap.values())t.serialize()&&e.push(t.annotationElementId);return this.#modifiedIds={ids:new Set(e),hash:e.join(`,`)}}[Symbol.iterator](){return this.#storage.entries()}},jt=class extends At{#serializable;constructor(e){super();let{map:t,hash:n,transfer:r}=e.serializable;this.#serializable={map:structuredClone(t,r?{transfer:r}:null),hash:n,transfer:r}}get print(){F(`Should not call PrintAnnotationStorage.print`)}get serializable(){return this.#serializable}get modifiedIds(){return L(this,`modifiedIds`,{ids:new Set,hash:``})}},Mt=class{#systemFonts=new Set;constructor({ownerDocument:e=globalThis.document,styleElement:t=null}){this._document=e,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(e){this.nativeFontFaces.add(e),this._document.fonts.add(e)}removeNativeFontFace(e){this.nativeFontFaces.delete(e),this._document.fonts.delete(e)}insertRule(e){this.styleElement||(this.styleElement=this._document.createElement(`style`),this._document.documentElement.getElementsByTagName(`head`)[0].append(this.styleElement));let t=this.styleElement.sheet;t.insertRule(e,t.cssRules.length)}clear(){for(let e of this.nativeFontFaces)this._document.fonts.delete(e);this.nativeFontFaces.clear(),this.#systemFonts.clear(),this.styleElement&&=(this.styleElement.remove(),null)}async loadSystemFont({systemFontInfo:e,disableFontFace:t,_inspectFont:n}){if(!(!e||this.#systemFonts.has(e.loadedName))){if(I(!t,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){let{loadedName:t,src:r,style:i}=e,a=new FontFace(t,r,i);this.addNativeFontFace(a);try{await a.load(),this.#systemFonts.add(t),n?.(e)}catch{P(`Cannot load system font: ${e.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(a)}return}F(`Not implemented: loadSystemFont without the Font Loading API.`)}}async bind(e){if(e.attached||e.missingFile&&!e.systemFontInfo)return;if(e.attached=!0,e.systemFontInfo){await this.loadSystemFont(e);return}if(this.isFontLoadingAPISupported){let t=e.createNativeFontFace();if(t){this.addNativeFontFace(t);try{await t.loaded}catch(n){throw P(`Failed to load font '${t.family}': '${n}'.`),e.disableFontFace=!0,n}}return}let t=e.createFontFaceRule();if(t){if(this.insertRule(t),this.isSyncFontLoadingSupported)return;await new Promise(t=>{let n=this._queueLoadingCallback(t);this._prepareFontLoadEvent(e,n)})}}get isFontLoadingAPISupported(){let e=!!this._document?.fonts;return L(this,`isFontLoadingAPISupported`,e)}get isSyncFontLoadingSupported(){return L(this,`isSyncFontLoadingSupported`,x||R.platform.isFirefox)}_queueLoadingCallback(e){function t(){for(I(!r.done,`completeRequest() cannot be called twice.`),r.done=!0;n.length>0&&n[0].done;){let e=n.shift();setTimeout(e.callback,0)}}let{loadingRequests:n}=this,r={done:!1,complete:t,callback:e};return n.push(r),r}get _loadTestFont(){let e=atob(`T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==`);return L(this,`_loadTestFont`,e)}_prepareFontLoadEvent(e,t){function n(e,t){return e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3)&255}function r(e,t,n,r){let i=e.substring(0,t),a=e.substring(t+n);return i+r+a}let i,a,o=this._document.createElement(`canvas`);o.width=1,o.height=1;let s=o.getContext(`2d`),c=0;function l(e,t){if(++c>30){P(`Load test font never loaded.`),t();return}if(s.font=`30px `+e,s.fillText(`.`,0,20),s.getImageData(0,0,1,1).data[3]>0){t();return}setTimeout(l.bind(null,e,t))}let u=`lt${Date.now()}${this.loadTestFontId++}`,d=this._loadTestFont;d=r(d,976,u.length,u);let f=1482184792,p=n(d,16);for(i=0,a=u.length-3;i<a;i+=4)p=p-f+n(u,i)|0;i<u.length&&(p=p-f+n(u+`XXX`,i)|0),d=r(d,16,4,xe(p));let m=`url(data:font/opentype;base64,${btoa(d)});`,h=`@font-face {font-family:"${u}";src:${m}}`;this.insertRule(h);let g=this._document.createElement(`div`);g.style.visibility=`hidden`,g.style.width=g.style.height=`10px`,g.style.position=`absolute`,g.style.top=g.style.left=`0px`;for(let t of[e.loadedName,u]){let e=this._document.createElement(`span`);e.textContent=`Hi`,e.style.fontFamily=t,g.append(e)}this._document.body.append(g),l(u,()=>{g.remove(),t.complete()})}},Nt=class{#fontData;constructor(e,t=null,n,r){this.compiledGlyphs=Object.create(null),this.#fontData=e,this._inspectFont=t,n&&Object.assign(this,n),r&&(this.charProcOperatorList=r)}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let e;if(!this.cssFontInfo)e=new FontFace(this.loadedName,this.data,{});else{let t={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(t.style=`oblique ${this.cssFontInfo.italicAngle}deg`),e=new FontFace(this.cssFontInfo.fontFamily,this.data,t)}return this._inspectFont?.(this),e}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;let e=`url(data:${this.mimetype};base64,${this.data.toBase64()});`,t;if(!this.cssFontInfo)t=`@font-face {font-family:"${this.loadedName}";src:${e}}`;else{let n=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(n+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),t=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${n}src:${e}}`}return this._inspectFont?.(this,e),t}getPathGenerator(e,t){if(this.compiledGlyphs[t]!==void 0)return this.compiledGlyphs[t];let n=this.loadedName+`_path_`+t,r;try{r=e.get(n)}catch(e){P(`getPathGenerator - ignoring character: "${e}".`)}let i=ut(r?.path);return this.fontExtraProperties||e.delete(n),this.compiledGlyphs[t]=i}get black(){return this.#fontData.black}get bold(){return this.#fontData.bold}get disableFontFace(){return this.#fontData.disableFontFace??!1}set disableFontFace(e){L(this,`disableFontFace`,!!e)}get fontExtraProperties(){return this.#fontData.fontExtraProperties??!1}get isInvalidPDFjsFont(){return this.#fontData.isInvalidPDFjsFont}get isType3Font(){return this.#fontData.isType3Font}get italic(){return this.#fontData.italic}get missingFile(){return this.#fontData.missingFile}get remeasure(){return this.#fontData.remeasure}get vertical(){return this.#fontData.vertical}get ascent(){return this.#fontData.ascent}get defaultWidth(){return this.#fontData.defaultWidth}get descent(){return this.#fontData.descent}get bbox(){return this.#fontData.bbox}set bbox(e){L(this,`bbox`,e)}get fontMatrix(){return this.#fontData.fontMatrix}get fallbackName(){return this.#fontData.fallbackName}get loadedName(){return this.#fontData.loadedName}get mimetype(){return this.#fontData.mimetype}get name(){return this.#fontData.name}get data(){return this.#fontData.data}clearData(){this.#fontData.clearData()}get cssFontInfo(){return this.#fontData.cssFontInfo}get systemFontInfo(){return this.#fontData.systemFontInfo}get defaultVMetrics(){return this.#fontData.defaultVMetrics}},Pt=class e{#buffer;#view;#decoder;static strings=[`fontFamily`,`fontWeight`,`italicAngle`];static write(t){let n=new TextEncoder,r={},i=0;for(let a of e.strings){let e=n.encode(t[a]);r[a]=e,i+=4+e.length}let a=new ArrayBuffer(i),o=new Uint8Array(a),s=new DataView(a),c=0;for(let t of e.strings){let e=r[t],n=e.length;s.setUint32(c,n),o.set(e,c+4),c+=4+n}return I(c===a.byteLength,`CssFontInfo.write: Buffer overflow`),a}constructor(e){this.#buffer=e,this.#view=new DataView(this.#buffer),this.#decoder=new TextDecoder}#readString(t){I(t<e.strings.length,`Invalid string index`);let n=0;for(let e=0;e<t;e++)n+=this.#view.getUint32(n)+4;let r=this.#view.getUint32(n);return this.#decoder.decode(new Uint8Array(this.#buffer,n+4,r))}get fontFamily(){return this.#readString(0)}get fontWeight(){return this.#readString(1)}get italicAngle(){return this.#readString(2)}},Ft=class e{#buffer;#view;#decoder;static strings=[`css`,`loadedName`,`baseFontName`,`src`];static write(t){let n=new TextEncoder,r={},i=0;for(let a of e.strings){let e=n.encode(t[a]);r[a]=e,i+=4+e.length}i+=4;let a,o,s=1+i;t.style&&(a=n.encode(t.style.style),o=n.encode(t.style.weight),s+=4+a.length+4+o.length);let c=new ArrayBuffer(s),l=new Uint8Array(c),u=new DataView(c),d=0;u.setUint8(d++,t.guessFallback?1:0),u.setUint32(d,0),d+=4,i=0;for(let t of e.strings){let e=r[t],n=e.length;i+=4+n,u.setUint32(d,n),l.set(e,d+4),d+=4+n}return u.setUint32(d-i-4,i),t.style&&(u.setUint32(d,a.length),l.set(a,d+4),d+=4+a.length,u.setUint32(d,o.length),l.set(o,d+4),d+=4+o.length),I(d<=c.byteLength,`SubstitionInfo.write: Buffer overflow`),c.transferToFixedLength(d)}constructor(e){this.#buffer=e,this.#view=new DataView(this.#buffer),this.#decoder=new TextDecoder}get guessFallback(){return this.#view.getUint8(0)!==0}#readString(t){I(t<e.strings.length,`Invalid string index`);let n=5;for(let e=0;e<t;e++)n+=this.#view.getUint32(n)+4;let r=this.#view.getUint32(n);return this.#decoder.decode(new Uint8Array(this.#buffer,n+4,r))}get css(){return this.#readString(0)}get loadedName(){return this.#readString(1)}get baseFontName(){return this.#readString(2)}get src(){return this.#readString(3)}get style(){let e=1;e+=4+this.#view.getUint32(e);let t=this.#view.getUint32(e),n=this.#decoder.decode(new Uint8Array(this.#buffer,e+4,t));e+=4+t;let r=this.#view.getUint32(e),i=this.#decoder.decode(new Uint8Array(this.#buffer,e+4,r));return{style:n,weight:i}}},It=class e{static bools=[`black`,`bold`,`disableFontFace`,`fontExtraProperties`,`isInvalidPDFjsFont`,`isType3Font`,`italic`,`missingFile`,`remeasure`,`vertical`];static numbers=[`ascent`,`defaultWidth`,`descent`];static strings=[`fallbackName`,`loadedName`,`mimetype`,`name`];static#OFFSET_NUMBERS=Math.ceil(this.bools.length*2/8);static#OFFSET_BBOX=this.#OFFSET_NUMBERS+this.numbers.length*8;static#OFFSET_FONT_MATRIX=this.#OFFSET_BBOX+1+8;static#OFFSET_DEFAULT_VMETRICS=this.#OFFSET_FONT_MATRIX+1+48;static#OFFSET_STRINGS=this.#OFFSET_DEFAULT_VMETRICS+1+6;#buffer;#decoder;#view;constructor({data:e,extra:t}){this.#buffer=e,this.#decoder=new TextDecoder,this.#view=new DataView(this.#buffer),t&&Object.assign(this,t)}#readBoolean(t){I(t<e.bools.length,`Invalid boolean index`);let n=Math.floor(t/4),r=t*2%8,i=this.#view.getUint8(n)>>r&3;return i===0?void 0:i===2}get black(){return this.#readBoolean(0)}get bold(){return this.#readBoolean(1)}get disableFontFace(){return this.#readBoolean(2)}get fontExtraProperties(){return this.#readBoolean(3)}get isInvalidPDFjsFont(){return this.#readBoolean(4)}get isType3Font(){return this.#readBoolean(5)}get italic(){return this.#readBoolean(6)}get missingFile(){return this.#readBoolean(7)}get remeasure(){return this.#readBoolean(8)}get vertical(){return this.#readBoolean(9)}#readNumber(t){return I(t<e.numbers.length,`Invalid number index`),this.#view.getFloat64(e.#OFFSET_NUMBERS+t*8)}get ascent(){return this.#readNumber(0)}get defaultWidth(){return this.#readNumber(1)}get descent(){return this.#readNumber(2)}get bbox(){let t=e.#OFFSET_BBOX;if(this.#view.getUint8(t)===0)return;t+=1;let n=[];for(let e=0;e<4;e++)n.push(this.#view.getInt16(t,!0)),t+=2;return n}get fontMatrix(){let t=e.#OFFSET_FONT_MATRIX;if(this.#view.getUint8(t)===0)return;t+=1;let n=[];for(let e=0;e<6;e++)n.push(this.#view.getFloat64(t,!0)),t+=8;return n}get defaultVMetrics(){let t=e.#OFFSET_DEFAULT_VMETRICS;if(this.#view.getUint8(t)===0)return;t+=1;let n=[];for(let e=0;e<3;e++)n.push(this.#view.getInt16(t,!0)),t+=2;return n}#readString(t){I(t<e.strings.length,`Invalid string index`);let n=e.#OFFSET_STRINGS+4;for(let e=0;e<t;e++)n+=this.#view.getUint32(n)+4;let r=this.#view.getUint32(n),i=new Uint8Array(r);return i.set(new Uint8Array(this.#buffer,n+4,r)),this.#decoder.decode(i)}get fallbackName(){return this.#readString(0)}get loadedName(){return this.#readString(1)}get mimetype(){return this.#readString(2)}get name(){return this.#readString(3)}get data(){let t=e.#OFFSET_STRINGS,n=this.#view.getUint32(t);t+=4+n;let r=this.#view.getUint32(t);t+=4+r;let i=this.#view.getUint32(t);t+=4+i;let a=this.#view.getUint32(t);if(a!==0)return new Uint8Array(this.#buffer,t+4,a)}clearData(){let t=e.#OFFSET_STRINGS,n=this.#view.getUint32(t);t+=4+n;let r=this.#view.getUint32(t);t+=4+r;let i=this.#view.getUint32(t);t+=4+i;let a=this.#view.getUint32(t);new Uint8Array(this.#buffer,t+4,a).fill(0),this.#view.setUint32(t,0)}get cssFontInfo(){let t=e.#OFFSET_STRINGS,n=this.#view.getUint32(t);t+=4+n;let r=this.#view.getUint32(t);t+=4+r;let i=this.#view.getUint32(t);if(i===0)return null;let a=new Uint8Array(i);return a.set(new Uint8Array(this.#buffer,t+4,i)),new Pt(a.buffer)}get systemFontInfo(){let t=e.#OFFSET_STRINGS,n=this.#view.getUint32(t);t+=4+n;let r=this.#view.getUint32(t);if(r===0)return null;let i=new Uint8Array(r);return i.set(new Uint8Array(this.#buffer,t+4,r)),new Ft(i.buffer)}static write(t){let n=t.systemFontInfo?Ft.write(t.systemFontInfo):null,r=t.cssFontInfo?Pt.write(t.cssFontInfo):null,i=new TextEncoder,a={},o=0;for(let n of e.strings)a[n]=i.encode(t[n]),o+=4+a[n].length;let s=e.#OFFSET_STRINGS+4+o+4+(n?n.byteLength:0)+4+(r?r.byteLength:0)+4+(t.data?t.data.length:0),c=new ArrayBuffer(s),l=new Uint8Array(c),u=new DataView(c),d=0,f=e.bools.length,p=0,m=0;for(let n=0;n<f;n++){let r=t[e.bools[n]];p|=(r===void 0?0:r?2:1)<<m,m+=2,(m===8||n===f-1)&&(u.setUint8(d++,p),p=0,m=0)}I(d===e.#OFFSET_NUMBERS,`FontInfo.write: Boolean properties offset mismatch`);for(let n of e.numbers)u.setFloat64(d,t[n]),d+=8;if(I(d===e.#OFFSET_BBOX,`FontInfo.write: Number properties offset mismatch`),t.bbox){u.setUint8(d++,4);for(let e of t.bbox)u.setInt16(d,e,!0),d+=2}else u.setUint8(d++,0),d+=8;if(I(d===e.#OFFSET_FONT_MATRIX,`FontInfo.write: BBox properties offset mismatch`),t.fontMatrix){u.setUint8(d++,6);for(let e of t.fontMatrix)u.setFloat64(d,e,!0),d+=8}else u.setUint8(d++,0),d+=48;if(I(d===e.#OFFSET_DEFAULT_VMETRICS,`FontInfo.write: FontMatrix properties offset mismatch`),t.defaultVMetrics){u.setUint8(d++,1);for(let e of t.defaultVMetrics)u.setInt16(d,e,!0),d+=2}else u.setUint8(d++,0),d+=6;I(d===e.#OFFSET_STRINGS,`FontInfo.write: DefaultVMetrics properties offset mismatch`),u.setUint32(e.#OFFSET_STRINGS,0),d+=4;for(let t of e.strings){let e=a[t],n=e.length;u.setUint32(d,n),l.set(e,d+4),d+=4+n}if(u.setUint32(e.#OFFSET_STRINGS,d-e.#OFFSET_STRINGS-4),!n)u.setUint32(d,0),d+=4;else{let e=n.byteLength;u.setUint32(d,e),I(d+4+e<=c.byteLength,`FontInfo.write: Buffer overflow at systemFontInfo`),l.set(new Uint8Array(n),d+4),d+=4+e}if(!r)u.setUint32(d,0),d+=4;else{let e=r.byteLength;u.setUint32(d,e),I(d+4+e<=c.byteLength,`FontInfo.write: Buffer overflow at cssFontInfo`),l.set(new Uint8Array(r),d+4),d+=4+e}return t.data===void 0?(u.setUint32(d,0),d+=4):(u.setUint32(d,t.data.length),l.set(t.data,d+4),d+=4+t.data.length),I(d<=c.byteLength,`FontInfo.write: Buffer overflow`),c.transferToFixedLength(d)}},Lt=class e{static#KIND=0;static#HAS_BBOX=1;static#HAS_BACKGROUND=2;static#SHADING_TYPE=3;static#N_COORD=4;static#N_COLOR=8;static#N_STOP=12;static#N_FIGURES=16;constructor(e){this.buffer=e,this.view=new DataView(e),this.data=new Uint8Array(e)}static write(t){let n,r=null,i=[],a=[],o=[],s=[],c=null,l=null;switch(t[0]){case`RadialAxial`:n=t[1]===`axial`?1:2,r=t[2],o=t[3],n===1?i.push(...t[4],...t[5]):i.push(t[4][0],t[4][1],t[6],t[5][0],t[5][1],t[7]);break;case`Mesh`:n=3,c=t[1],i=t[2],a=t[3],s=t[4]||[],r=t[6],l=t[7];break;default:throw Error(`Unsupported pattern type: ${t[0]}`)}let u=Math.floor(i.length/2),d=Math.floor(a.length/3),f=o.length,p=s.length,m=0;for(let e of s)m+=1,m=Math.ceil(m/4)*4,m+=4+e.coords.length*4,m+=4+e.colors.length*4,e.verticesPerRow!==void 0&&(m+=4);let h=20+u*8+d*3+f*8+(r?16:0)+(l?3:0)+m,g=new ArrayBuffer(h),_=new DataView(g),v=new Uint8Array(g);_.setUint8(e.#KIND,n),_.setUint8(e.#HAS_BBOX,r?1:0),_.setUint8(e.#HAS_BACKGROUND,l?1:0),_.setUint8(e.#SHADING_TYPE,c),_.setUint32(e.#N_COORD,u,!0),_.setUint32(e.#N_COLOR,d,!0),_.setUint32(e.#N_STOP,f,!0),_.setUint32(e.#N_FIGURES,p,!0);let y=20;new Float32Array(g,y,u*2).set(i),y+=u*8,v.set(a,y),y+=d*3;for(let[e,t]of o)_.setFloat32(y,e,!0),y+=4,_.setUint32(y,parseInt(t.slice(1),16),!0),y+=4;if(r)for(let e of r)_.setFloat32(y,e,!0),y+=4;l&&(v.set(l,y),y+=3);for(let e=0;e<s.length;e++){let t=s[e];_.setUint8(y,t.type),y+=1,y=Math.ceil(y/4)*4,_.setUint32(y,t.coords.length,!0),y+=4,new Int32Array(g,y,t.coords.length).set(t.coords),y+=t.coords.length*4,_.setUint32(y,t.colors.length,!0),y+=4,new Int32Array(g,y,t.colors.length).set(t.colors),y+=t.colors.length*4,t.verticesPerRow!==void 0&&(_.setUint32(y,t.verticesPerRow,!0),y+=4)}return g}getIR(){let t=this.view,n=this.data[e.#KIND],r=!!this.data[e.#HAS_BBOX],i=!!this.data[e.#HAS_BACKGROUND],a=t.getUint32(e.#N_COORD,!0),o=t.getUint32(e.#N_COLOR,!0),s=t.getUint32(e.#N_STOP,!0),c=t.getUint32(e.#N_FIGURES,!0),l=20,u=new Float32Array(this.buffer,l,a*2);l+=a*8;let d=new Uint8Array(this.buffer,l,o*3);l+=o*3;let f=[];for(let e=0;e<s;++e){let e=t.getFloat32(l,!0);l+=4;let n=t.getUint32(l,!0);l+=4,f.push([e,`#${n.toString(16).padStart(6,`0`)}`])}let p=null;if(r){p=[];for(let e=0;e<4;++e)p.push(t.getFloat32(l,!0)),l+=4}let m=null;i&&(m=new Uint8Array(this.buffer,l,3),l+=3);let h=[];for(let e=0;e<c;++e){let e=t.getUint8(l);l+=1,l=Math.ceil(l/4)*4;let n=t.getUint32(l,!0);l+=4;let r=new Int32Array(this.buffer,l,n);l+=n*4;let i=t.getUint32(l,!0);l+=4;let a=new Int32Array(this.buffer,l,i);l+=i*4;let o={type:e,coords:r,colors:a};e===A.LATTICE&&(o.verticesPerRow=t.getUint32(l,!0),l+=4),h.push(o)}if(n===1)return[`RadialAxial`,`axial`,p,f,Array.from(u.slice(0,2)),Array.from(u.slice(2,4)),null,null];if(n===2)return[`RadialAxial`,`radial`,p,f,[u[0],u[1]],[u[3],u[4]],u[2],u[5]];if(n===3){let t=this.data[e.#SHADING_TYPE],n=null;if(u.length>0){let e=u[0],t=u[0],r=u[1],i=u[1];for(let n=0;n<u.length;n+=2){let a=u[n],o=u[n+1];e=e>a?a:e,r=r>o?o:r,t=t<a?a:t,i=i<o?o:i}n=[e,r,t,i]}return[`Mesh`,t,u,d,h,n,p,m]}throw Error(`Unsupported pattern kind: ${n}`)}},Rt=class{static write(e){let t,n;return R.isFloat16ArraySupported?(n=new ArrayBuffer(e.length*2),t=new Float16Array(n)):(n=new ArrayBuffer(e.length*4),t=new Float32Array(n)),t.set(e),n}#buffer;constructor(e){this.#buffer=e}get path(){return R.isFloat16ArraySupported?new Float16Array(this.#buffer):new Float32Array(this.#buffer)}};function zt(e){if(e instanceof URL)return e.href;if(typeof e==`string`){if(x)return e;let t=URL.parse(e,window.location);if(t)return t.href}throw Error(`Invalid PDF url data: either string or URL-object is expected in the url property.`)}function Bt(e){if(x&&typeof Buffer<`u`&&e instanceof Buffer)throw Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(e instanceof Uint8Array&&e.byteLength===e.buffer.byteLength)return e;if(typeof e==`string`)return be(e);if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||typeof e==`object`&&!isNaN(e?.length))return new Uint8Array(e);throw Error(`Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.`)}function Vt(e){if(typeof e!=`string`)return null;if(e.endsWith(`/`))return e;throw Error(`Invalid factory url: "${e}" must include trailing slash.`)}var Ht=e=>typeof e==`object`&&Number.isInteger(e?.num)&&e.num>=0&&Number.isInteger(e?.gen)&&e.gen>=0,Ut=je.bind(null,Ht,e=>typeof e==`object`&&typeof e?.name==`string`),Wt=class{#listeners=new Map;#deferred=Promise.resolve();postMessage(e,t){let n={data:structuredClone(e,t?{transfer:t}:null)};this.#deferred.then(()=>{for(let[e]of this.#listeners)e.call(this,n)})}addEventListener(e,t,n=null){let r=null;if(n?.signal instanceof AbortSignal){let{signal:i}=n;if(i.aborted){P("LoopbackPort - cannot use an `aborted` signal.");return}let a=()=>this.removeEventListener(e,t);r=()=>i.removeEventListener(`abort`,a),i.addEventListener(`abort`,a)}this.#listeners.set(t,r)}removeEventListener(e,t){this.#listeners.get(t)?.(),this.#listeners.delete(t)}terminate(){for(let[,e]of this.#listeners)e?.();this.#listeners.clear()}},Gt={DATA:1,ERROR:2},K={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function Kt(){}function q(e){if(e instanceof ve||e instanceof he||e instanceof pe||e instanceof ge||e instanceof me)return e;switch(e instanceof Error||typeof e==`object`&&e||F(`wrapReason: Expected "reason" to be a (possibly cloned) Error.`),e.name){case`AbortException`:return new ve(e.message);case`InvalidPDFException`:return new he(e.message);case`PasswordException`:return new pe(e.message,e.code);case`ResponseException`:return new ge(e.message,e.status,e.missing);case`UnknownErrorException`:return new me(e.message,e.details)}return new me(e.message,e.toString())}var qt=class{#messageAC=new AbortController;constructor(e,t,n){this.sourceName=e,this.targetName=t,this.comObj=n,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),n.addEventListener(`message`,this.#onMessage.bind(this),{signal:this.#messageAC.signal})}#onMessage({data:e}){if(e.targetName!==this.sourceName)return;if(e.stream){this.#processStreamMessage(e);return}if(e.callback){let t=e.callbackId,n=this.callbackCapabilities[t];if(!n)throw Error(`Cannot resolve callback ${t}`);if(delete this.callbackCapabilities[t],e.callback===Gt.DATA)n.resolve(e.data);else if(e.callback===Gt.ERROR)n.reject(q(e.reason));else throw Error(`Unexpected callback case`);return}let t=this.actionHandler[e.action];if(!t)throw Error(`Unknown action from worker: ${e.action}`);if(e.callbackId){let n=this.sourceName,r=e.sourceName,i=this.comObj;Promise.try(t,e.data).then(function(t){i.postMessage({sourceName:n,targetName:r,callback:Gt.DATA,callbackId:e.callbackId,data:t})},function(t){i.postMessage({sourceName:n,targetName:r,callback:Gt.ERROR,callbackId:e.callbackId,reason:q(t)})});return}if(e.streamId){this.#createStreamSink(e);return}t(e.data)}on(e,t){let n=this.actionHandler;if(n[e])throw Error(`There is already an actionName called "${e}"`);n[e]=t}send(e,t,n){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,data:t},n)}sendWithPromise(e,t,n){let r=this.callbackId++,i=Promise.withResolvers();this.callbackCapabilities[r]=i;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:e,callbackId:r,data:t},n)}catch(e){i.reject(e)}return i.promise}sendWithStream(e,t,n,r){let i=this.streamId++,a=this.sourceName,o=this.targetName,s=this.comObj;return new ReadableStream({start:n=>{let c=Promise.withResolvers();return this.streamControllers[i]={controller:n,startCall:c,pullCall:null,cancelCall:null,isClosed:!1},s.postMessage({sourceName:a,targetName:o,action:e,streamId:i,data:t,desiredSize:n.desiredSize},r),c.promise},pull:e=>{let t=Promise.withResolvers();return this.streamControllers[i].pullCall=t,s.postMessage({sourceName:a,targetName:o,stream:K.PULL,streamId:i,desiredSize:e.desiredSize}),t.promise},cancel:e=>{I(e instanceof Error,`cancel must have a valid reason`);let t=Promise.withResolvers();return this.streamControllers[i].cancelCall=t,this.streamControllers[i].isClosed=!0,s.postMessage({sourceName:a,targetName:o,stream:K.CANCEL,streamId:i,reason:q(e)}),t.promise}},n)}#createStreamSink(e){let t=e.streamId,n=this.sourceName,r=e.sourceName,i=this.comObj,a=this,o=this.actionHandler[e.action],s={enqueue(e,a=1,o){if(this.isCancelled)return;let s=this.desiredSize;this.desiredSize-=a,s>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),i.postMessage({sourceName:n,targetName:r,stream:K.ENQUEUE,streamId:t,chunk:e},o)},close(){this.isCancelled||(this.isCancelled=!0,i.postMessage({sourceName:n,targetName:r,stream:K.CLOSE,streamId:t}),delete a.streamSinks[t])},error(e){I(e instanceof Error,`error must have a valid reason`),!this.isCancelled&&(this.isCancelled=!0,i.postMessage({sourceName:n,targetName:r,stream:K.ERROR,streamId:t,reason:q(e)}))},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:e.desiredSize,ready:null};s.sinkCapability.resolve(),s.ready=s.sinkCapability.promise,this.streamSinks[t]=s,Promise.try(o,e.data,s).then(function(){i.postMessage({sourceName:n,targetName:r,stream:K.START_COMPLETE,streamId:t,success:!0})},function(e){i.postMessage({sourceName:n,targetName:r,stream:K.START_COMPLETE,streamId:t,reason:q(e)})})}#processStreamMessage(e){let t=e.streamId,n=this.sourceName,r=e.sourceName,i=this.comObj,a=this.streamControllers[t],o=this.streamSinks[t];switch(e.stream){case K.START_COMPLETE:e.success?a.startCall.resolve():a.startCall.reject(q(e.reason));break;case K.PULL_COMPLETE:e.success?a.pullCall.resolve():a.pullCall.reject(q(e.reason));break;case K.PULL:if(!o){i.postMessage({sourceName:n,targetName:r,stream:K.PULL_COMPLETE,streamId:t,success:!0});break}o.desiredSize<=0&&e.desiredSize>0&&o.sinkCapability.resolve(),o.desiredSize=e.desiredSize,Promise.try(o.onPull||Kt).then(function(){i.postMessage({sourceName:n,targetName:r,stream:K.PULL_COMPLETE,streamId:t,success:!0})},function(e){i.postMessage({sourceName:n,targetName:r,stream:K.PULL_COMPLETE,streamId:t,reason:q(e)})});break;case K.ENQUEUE:if(I(a,`enqueue should have stream controller`),a.isClosed)break;a.controller.enqueue(e.chunk);break;case K.CLOSE:if(I(a,`close should have stream controller`),a.isClosed)break;a.isClosed=!0,a.controller.close(),this.#deleteStreamController(a,t);break;case K.ERROR:I(a,`error should have stream controller`),a.controller.error(q(e.reason)),this.#deleteStreamController(a,t);break;case K.CANCEL_COMPLETE:e.success?a.cancelCall.resolve():a.cancelCall.reject(q(e.reason)),this.#deleteStreamController(a,t);break;case K.CANCEL:if(!o)break;let s=q(e.reason);Promise.try(o.onCancel||Kt,s).then(function(){i.postMessage({sourceName:n,targetName:r,stream:K.CANCEL_COMPLETE,streamId:t,success:!0})},function(e){i.postMessage({sourceName:n,targetName:r,stream:K.CANCEL_COMPLETE,streamId:t,reason:q(e)})}),o.sinkCapability.reject(s),o.isCancelled=!0,delete this.streamSinks[t];break;default:throw Error(`Unexpected stream case`)}}async#deleteStreamController(e,t){await Promise.allSettled([e.startCall?.promise,e.pullCall?.promise,e.cancelCall?.promise]),delete this.streamControllers[t]}destroy(){this.#messageAC?.abort(),this.#messageAC=null}},Jt=class{#enableHWA=!1;constructor({enableHWA:e=!1}){this.#enableHWA=e}create(e,t){if(e<=0||t<=0)throw Error(`Invalid canvas size`);let n=this._createCanvas(e,t);return{canvas:n,context:n.getContext(`2d`,{willReadFrequently:!this.#enableHWA})}}reset(e,t,n){if(!e.canvas)throw Error(`Canvas is not specified`);if(t<=0||n<=0)throw Error(`Invalid canvas size`);e.canvas.width=t,e.canvas.height=n}destroy(e){if(!e.canvas)throw Error(`Canvas is not specified`);e.canvas.width=0,e.canvas.height=0,e.canvas=null,e.context=null}_createCanvas(e,t){F("Abstract method `_createCanvas` called.")}},Yt=class extends Jt{constructor({ownerDocument:e=globalThis.document,enableHWA:t=!1}){super({enableHWA:t}),this._document=e}_createCanvas(e,t){let n=this._document.createElement(`canvas`);return n.width=e,n.height=t,n}},Xt=class{constructor({baseUrl:e=null,isCompressed:t=!0}){this.baseUrl=e,this.isCompressed=t}async fetch({name:e}){if(!this.baseUrl)throw Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!e)throw Error(`CMap name must be specified.`);let t=this.baseUrl+e+(this.isCompressed?`.bcmap`:``);return this._fetch(t).then(e=>({cMapData:e,isCompressed:this.isCompressed})).catch(e=>{throw Error(`Unable to load ${this.isCompressed?`binary `:``}CMap at: ${t}`)})}async _fetch(e){F("Abstract method `_fetch` called.")}},Zt=class extends Xt{async _fetch(e){let t=await Ie(e,this.isCompressed?`arraybuffer`:`text`);return t instanceof ArrayBuffer?new Uint8Array(t):be(t)}},Qt=class{addFilter(e){return`none`}addHCMFilter(e,t){return`none`}addAlphaFilter(e){return`none`}addLuminosityFilter(e){return`none`}addHighlightHCMFilter(e,t,n,r,i){return`none`}destroy(e=!1){}},$t=class extends Qt{#baseUrl;#_cache;#_defs;#docId;#document;#_hcmCache;#id=0;constructor({docId:e,ownerDocument:t=globalThis.document}){super(),this.#docId=e,this.#document=t}get#cache(){return this.#_cache||=new Map}get#hcmCache(){return this.#_hcmCache||=new Map}get#defs(){if(!this.#_defs){let e=this.#document.createElement(`div`),{style:t}=e;t.visibility=`hidden`,t.contain=`strict`,t.width=t.height=0,t.position=`absolute`,t.top=t.left=0,t.zIndex=-1;let n=this.#document.createElementNS(Pe,`svg`);n.setAttribute(`width`,0),n.setAttribute(`height`,0),this.#_defs=this.#document.createElementNS(Pe,`defs`),e.append(n),n.append(this.#_defs),this.#document.body.append(e)}return this.#_defs}#createTables(e){if(e.length===1){let t=e[0],n=Array(256);for(let e=0;e<256;e++)n[e]=t[e]/255;let r=n.join(`,`);return[r,r,r]}let[t,n,r]=e,i=Array(256),a=Array(256),o=Array(256);for(let e=0;e<256;e++)i[e]=t[e]/255,a[e]=n[e]/255,o[e]=r[e]/255;return[i.join(`,`),a.join(`,`),o.join(`,`)]}#createUrl(e){if(this.#baseUrl===void 0){this.#baseUrl=``;let e=this.#document.URL;e!==this.#document.baseURI&&(ze(e)?P(`#createUrl: ignore "data:"-URL for performance reasons.`):this.#baseUrl=de(e,``))}return`url(${this.#baseUrl}#${e})`}addFilter(e){if(!e)return`none`;let t=this.#cache.get(e);if(t)return t;let[n,r,i]=this.#createTables(e),a=e.length===1?n:`${n}${r}${i}`;if(t=this.#cache.get(a),t)return this.#cache.set(e,t),t;let o=`g_${this.#docId}_transfer_map_${this.#id++}`,s=this.#createUrl(o);this.#cache.set(e,s),this.#cache.set(a,s);let c=this.#createFilter(o);return this.#addTransferMapConversion(n,r,i,c),s}addHCMFilter(e,t){let n=`${e}-${t}`,r=`base`,i=this.#hcmCache.get(r);if(i?.key===n||(i?(i.filter?.remove(),i.key=n,i.url=`none`,i.filter=null):(i={key:n,url:`none`,filter:null},this.#hcmCache.set(r,i)),!e||!t))return i.url;let a=this.#getRGB(e);e=z.makeHexColor(...a);let o=this.#getRGB(t);if(t=z.makeHexColor(...o),this.#defs.style.color=``,e===`#000000`&&t===`#ffffff`||e===t)return i.url;let s=Array(256);for(let e=0;e<=255;e++){let t=e/255;s[e]=t<=.03928?t/12.92:((t+.055)/1.055)**2.4}let c=s.join(`,`),l=`g_${this.#docId}_hcm_filter`,u=i.filter=this.#createFilter(l);this.#addTransferMapConversion(c,c,c,u),this.#addGrayConversion(u);let d=(e,t)=>{let n=a[e]/255,r=o[e]/255,i=Array(t+1);for(let e=0;e<=t;e++)i[e]=n+e/t*(r-n);return i.join(`,`)};return this.#addTransferMapConversion(d(0,5),d(1,5),d(2,5),u),i.url=this.#createUrl(l),i.url}addAlphaFilter(e){let t=this.#cache.get(e);if(t)return t;let[n]=this.#createTables([e]),r=`alpha_${n}`;if(t=this.#cache.get(r),t)return this.#cache.set(e,t),t;let i=`g_${this.#docId}_alpha_map_${this.#id++}`,a=this.#createUrl(i);this.#cache.set(e,a),this.#cache.set(r,a);let o=this.#createFilter(i);return this.#addTransferMapAlphaConversion(n,o),a}addLuminosityFilter(e){let t=this.#cache.get(e||`luminosity`);if(t)return t;let n,r;if(e?([n]=this.#createTables([e]),r=`luminosity_${n}`):r=`luminosity`,t=this.#cache.get(r),t)return this.#cache.set(e,t),t;let i=`g_${this.#docId}_luminosity_map_${this.#id++}`,a=this.#createUrl(i);this.#cache.set(e,a),this.#cache.set(r,a);let o=this.#createFilter(i);return this.#addLuminosityConversion(o),e&&this.#addTransferMapAlphaConversion(n,o),a}addHighlightHCMFilter(e,t,n,r,i){let a=`${t}-${n}-${r}-${i}`,o=this.#hcmCache.get(e);if(o?.key===a||(o?(o.filter?.remove(),o.key=a,o.url=`none`,o.filter=null):(o={key:a,url:`none`,filter:null},this.#hcmCache.set(e,o)),!t||!n))return o.url;let[s,c]=[t,n].map(this.#getRGB.bind(this)),l=Math.round(.2126*s[0]+.7152*s[1]+.0722*s[2]),u=Math.round(.2126*c[0]+.7152*c[1]+.0722*c[2]),[d,f]=[r,i].map(this.#getRGB.bind(this));u<l&&([l,u,d,f]=[u,l,f,d]),this.#defs.style.color=``;let p=(e,t,n)=>{let r=Array(256),i=(u-l)/n,a=e/255,o=(t-e)/(255*n),s=0;for(let e=0;e<=n;e++){let t=Math.round(l+e*i),n=a+e*o;for(let e=s;e<=t;e++)r[e]=n;s=t+1}for(let e=s;e<256;e++)r[e]=r[s-1];return r.join(`,`)},m=`g_${this.#docId}_hcm_${e}_filter`,h=o.filter=this.#createFilter(m);return this.#addGrayConversion(h),this.#addTransferMapConversion(p(d[0],f[0],5),p(d[1],f[1],5),p(d[2],f[2],5),h),o.url=this.#createUrl(m),o.url}destroy(e=!1){e&&this.#_hcmCache?.size||(this.#_defs?.parentNode.parentNode.remove(),this.#_defs=null,this.#_cache?.clear(),this.#_cache=null,this.#_hcmCache?.clear(),this.#_hcmCache=null,this.#id=0)}#addLuminosityConversion(e){let t=this.#document.createElementNS(Pe,`feColorMatrix`);t.setAttribute(`type`,`matrix`),t.setAttribute(`values`,`0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0`),e.append(t)}#addGrayConversion(e){let t=this.#document.createElementNS(Pe,`feColorMatrix`);t.setAttribute(`type`,`matrix`),t.setAttribute(`values`,`0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0`),e.append(t)}#createFilter(e){let t=this.#document.createElementNS(Pe,`filter`);return t.setAttribute(`color-interpolation-filters`,`sRGB`),t.setAttribute(`id`,e),this.#defs.append(t),t}#appendFeFunc(e,t,n){let r=this.#document.createElementNS(Pe,t);r.setAttribute(`type`,`discrete`),r.setAttribute(`tableValues`,n),e.append(r)}#addTransferMapConversion(e,t,n,r){let i=this.#document.createElementNS(Pe,`feComponentTransfer`);r.append(i),this.#appendFeFunc(i,`feFuncR`,e),this.#appendFeFunc(i,`feFuncG`,t),this.#appendFeFunc(i,`feFuncB`,n)}#addTransferMapAlphaConversion(e,t){let n=this.#document.createElementNS(Pe,`feComponentTransfer`);t.append(n),this.#appendFeFunc(n,`feFuncA`,e)}#getRGB(e){return this.#defs.style.color=e,Je(getComputedStyle(this.#defs).getPropertyValue(`color`))}},en=class{constructor({baseUrl:e=null}){this.baseUrl=e}async fetch({filename:e}){if(!this.baseUrl)throw Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!e)throw Error(`Font filename must be specified.`);let t=`${this.baseUrl}${e}`;return this._fetch(t).catch(e=>{throw Error(`Unable to load font data at: ${t}`)})}async _fetch(e){F("Abstract method `_fetch` called.")}},tn=class extends en{async _fetch(e){let t=await Ie(e,`arraybuffer`);return new Uint8Array(t)}},nn=class{constructor({baseUrl:e=null}){this.baseUrl=e}async fetch({filename:e}){if(!this.baseUrl)throw Error("Ensure that the `wasmUrl` API parameter is provided.");if(!e)throw Error(`Wasm filename must be specified.`);let t=`${this.baseUrl}${e}`;return this._fetch(t).catch(e=>{throw Error(`Unable to load wasm data at: ${t}`)})}async _fetch(e){F("Abstract method `_fetch` called.")}},rn=class extends nn{async _fetch(e){let t=await Ie(e,`arraybuffer`);return new Uint8Array(t)}};x&&P("Please use the `legacy` build in Node.js environments.");async function an(e){let t=await process.getBuiltinModule(`fs`).promises.readFile(e);return new Uint8Array(t)}var on=class extends Qt{},sn=class extends Jt{_createCanvas(e,t){return process.getBuiltinModule(`module`).createRequire(import.meta.url)(`@napi-rs/canvas`).createCanvas(e,t)}},cn=class extends Xt{async _fetch(e){return an(e)}},ln=class extends en{async _fetch(e){return an(e)}},un=class extends nn{async _fetch(e){return an(e)}},dn=`__forcedDependency`,{floor:fn,ceil:pn}=Math;function mn(e,t,n,r,i,a){e[t*4+0]=Math.min(e[t*4+0],n),e[t*4+1]=Math.min(e[t*4+1],r),e[t*4+2]=Math.max(e[t*4+2],i),e[t*4+3]=Math.max(e[t*4+3],a)}var hn=new Uint32Array(new Uint8Array([255,255,0,0]).buffer)[0],gn=class{#bboxes;#coords;constructor(e,t){this.#bboxes=e,this.#coords=t}get length(){return this.#bboxes.length}isEmpty(e){return this.#bboxes[e]===hn}minX(e){return this.#coords[e*4+0]/256}minY(e){return this.#coords[e*4+1]/256}maxX(e){return(this.#coords[e*4+2]+1)/256}maxY(e){return(this.#coords[e*4+3]+1)/256}},_n=(e,t)=>{if(!e)return;let n=e.get(t);return n||(n={dependencies:new Set,isRenderingOperation:!1},e.set(t,n)),n},vn=class{#simple={__proto__:null};#incremental={__proto__:null,transform:[],moveText:[],sameLineText:[],[dn]:[]};#namedDependencies=new Map;#savesStack=[];#markedContentStack=[];#baseTransformStack=[[1,0,0,1,0,0]];#clipBox=[-1/0,-1/0,1/0,1/0];#pendingBBox=new Float64Array([1/0,1/0,-1/0,-1/0]);#pendingBBoxIdx=-1;#pendingDependencies=new Set;#operations=new Map;#fontBBoxTrustworthy=new Map;#canvasWidth;#canvasHeight;#bboxesCoords;#bboxes;#debugMetadata;constructor(e,t,n=!1){this.#canvasWidth=e.width,this.#canvasHeight=e.height,this.#initializeBBoxes(t),n&&(this.#debugMetadata=new Map)}growOperationsCount(e){e>=this.#bboxes.length&&this.#initializeBBoxes(e,this.#bboxes)}#initializeBBoxes(e,t){let n=new ArrayBuffer(e*4);this.#bboxesCoords=new Uint8ClampedArray(n),this.#bboxes=new Uint32Array(n),t&&t.length>0?(this.#bboxes.set(t),this.#bboxes.fill(hn,t.length)):this.#bboxes.fill(hn)}save(e){return this.#simple={__proto__:this.#simple},this.#incremental={__proto__:this.#incremental,transform:{__proto__:this.#incremental.transform},moveText:{__proto__:this.#incremental.moveText},sameLineText:{__proto__:this.#incremental.sameLineText},[dn]:{__proto__:this.#incremental[dn]}},this.#clipBox={__proto__:this.#clipBox},this.#savesStack.push(e),this}restore(e){let t=Object.getPrototypeOf(this.#simple);if(t===null)return this;this.#simple=t,this.#incremental=Object.getPrototypeOf(this.#incremental),this.#clipBox=Object.getPrototypeOf(this.#clipBox);let n=this.#savesStack.pop();return n!==void 0&&(_n(this.#debugMetadata,e)?.dependencies.add(n),this.#bboxes[e]=this.#bboxes[n]),this}recordOpenMarker(e){return this.#savesStack.push(e),this}getOpenMarker(){return this.#savesStack.length===0?null:this.#savesStack.at(-1)}recordCloseMarker(e){let t=this.#savesStack.pop();return t!==void 0&&(_n(this.#debugMetadata,e)?.dependencies.add(t),this.#bboxes[e]=this.#bboxes[t]),this}beginMarkedContent(e){return this.#markedContentStack.push(e),this}endMarkedContent(e){let t=this.#markedContentStack.pop();return t!==void 0&&(_n(this.#debugMetadata,e)?.dependencies.add(t),this.#bboxes[e]=this.#bboxes[t]),this}pushBaseTransform(e){return this.#baseTransformStack.push(z.multiplyByDOMMatrix(this.#baseTransformStack.at(-1),e.getTransform())),this}popBaseTransform(){return this.#baseTransformStack.length>1&&this.#baseTransformStack.pop(),this}recordSimpleData(e,t){return this.#simple[e]=t,this}recordIncrementalData(e,t){return this.#incremental[e].push(t),this}resetIncrementalData(e,t){return this.#incremental[e].length=0,this}recordNamedData(e,t){return this.#namedDependencies.set(e,t),this}recordSimpleDataFromNamed(e,t,n){this.#simple[e]=this.#namedDependencies.get(t)??n}recordFutureForcedDependency(e,t){return this.recordIncrementalData(dn,t),this}inheritSimpleDataAsFutureForcedDependencies(e){for(let t of e)t in this.#simple&&this.recordFutureForcedDependency(t,this.#simple[t]);return this}inheritPendingDependenciesAsFutureForcedDependencies(){for(let e of this.#pendingDependencies)this.recordFutureForcedDependency(dn,e);return this}resetBBox(e){return this.#pendingBBoxIdx!==e&&(this.#pendingBBoxIdx=e,this.#pendingBBox[0]=1/0,this.#pendingBBox[1]=1/0,this.#pendingBBox[2]=-1/0,this.#pendingBBox[3]=-1/0),this}recordClipBox(e,t,n,r,i,a){let o=z.multiplyByDOMMatrix(this.#baseTransformStack.at(-1),t.getTransform()),s=[1/0,1/0,-1/0,-1/0];z.axialAlignedBoundingBox([n,i,r,a],o,s);let c=z.intersect(this.#clipBox,s);return c?(this.#clipBox[0]=c[0],this.#clipBox[1]=c[1],this.#clipBox[2]=c[2],this.#clipBox[3]=c[3]):(this.#clipBox[0]=this.#clipBox[1]=1/0,this.#clipBox[2]=this.#clipBox[3]=-1/0),this}recordBBox(e,t,n,r,i,a){let o=this.#clipBox;if(o[0]===1/0)return this;let s=z.multiplyByDOMMatrix(this.#baseTransformStack.at(-1),t.getTransform());if(o[0]===-1/0)return z.axialAlignedBoundingBox([n,i,r,a],s,this.#pendingBBox),this;let c=[1/0,1/0,-1/0,-1/0];return z.axialAlignedBoundingBox([n,i,r,a],s,c),this.#pendingBBox[0]=Math.min(this.#pendingBBox[0],Math.max(c[0],o[0])),this.#pendingBBox[1]=Math.min(this.#pendingBBox[1],Math.max(c[1],o[1])),this.#pendingBBox[2]=Math.max(this.#pendingBBox[2],Math.min(c[2],o[2])),this.#pendingBBox[3]=Math.max(this.#pendingBBox[3],Math.min(c[3],o[3])),this}recordCharacterBBox(e,t,n,r=1,i=0,a=0,o){let s=n.bbox,c,l;if(s&&(c=s[2]!==s[0]&&s[3]!==s[1]&&this.#fontBBoxTrustworthy.get(n),c!==!1&&(l=[0,0,0,0],z.axialAlignedBoundingBox(s,n.fontMatrix,l),(r!==1||i!==0||a!==0)&&z.scaleMinMax([r,0,0,-r,i,a],l),c)))return this.recordBBox(e,t,l[0],l[2],l[1],l[3]);if(!o)return this.recordFullPageBBox(e);let u=o();return s&&l&&c===void 0&&(c=l[0]<=i-u.actualBoundingBoxLeft&&l[2]>=i+u.actualBoundingBoxRight&&l[1]<=a-u.actualBoundingBoxAscent&&l[3]>=a+u.actualBoundingBoxDescent,this.#fontBBoxTrustworthy.set(n,c),c)?this.recordBBox(e,t,l[0],l[2],l[1],l[3]):this.recordBBox(e,t,i-u.actualBoundingBoxLeft,i+u.actualBoundingBoxRight,a-u.actualBoundingBoxAscent,a+u.actualBoundingBoxDescent)}recordFullPageBBox(e){return this.#pendingBBox[0]=Math.max(0,this.#clipBox[0]),this.#pendingBBox[1]=Math.max(0,this.#clipBox[1]),this.#pendingBBox[2]=Math.min(this.#canvasWidth,this.#clipBox[2]),this.#pendingBBox[3]=Math.min(this.#canvasHeight,this.#clipBox[3]),this}getSimpleIndex(e){return this.#simple[e]}recordDependencies(e,t){let n=this.#pendingDependencies,r=this.#simple,i=this.#incremental;for(let e of t)e in this.#simple?n.add(r[e]):e in i&&i[e].forEach(n.add,n);return this}recordNamedDependency(e,t){return this.#namedDependencies.has(t)&&this.#pendingDependencies.add(this.#namedDependencies.get(t)),this}recordOperation(e,t=!1){if(this.recordDependencies(e,[dn]),this.#debugMetadata){let t=_n(this.#debugMetadata,e),{dependencies:n}=t;this.#pendingDependencies.forEach(n.add,n),this.#savesStack.forEach(n.add,n),this.#markedContentStack.forEach(n.add,n),n.delete(e),t.isRenderingOperation=!0}if(this.#pendingBBoxIdx===e){let n=fn(this.#pendingBBox[0]*256/this.#canvasWidth),r=fn(this.#pendingBBox[1]*256/this.#canvasHeight),i=pn(this.#pendingBBox[2]*256/this.#canvasWidth),a=pn(this.#pendingBBox[3]*256/this.#canvasHeight);mn(this.#bboxesCoords,e,n,r,i,a);for(let t of this.#pendingDependencies)t!==e&&mn(this.#bboxesCoords,t,n,r,i,a);for(let t of this.#savesStack)t!==e&&mn(this.#bboxesCoords,t,n,r,i,a);for(let t of this.#markedContentStack)t!==e&&mn(this.#bboxesCoords,t,n,r,i,a);t||(this.#pendingDependencies.clear(),this.#pendingBBoxIdx=-1)}return this}recordShowTextOperation(e,t=!1){let n=Array.from(this.#pendingDependencies);this.recordOperation(e,t),this.recordIncrementalData(`sameLineText`,e);for(let e of n)this.recordIncrementalData(`sameLineText`,e);return this}bboxToClipBoxDropOperation(e,t=!1){return this.#pendingBBoxIdx===e&&(this.#pendingBBoxIdx=-1,this.#clipBox[0]=Math.max(this.#clipBox[0],this.#pendingBBox[0]),this.#clipBox[1]=Math.max(this.#clipBox[1],this.#pendingBBox[1]),this.#clipBox[2]=Math.min(this.#clipBox[2],this.#pendingBBox[2]),this.#clipBox[3]=Math.min(this.#clipBox[3],this.#pendingBBox[3]),t||this.#pendingDependencies.clear()),this}_takePendingDependencies(){let e=this.#pendingDependencies;return this.#pendingDependencies=new Set,e}_extractOperation(e){let t=this.#operations.get(e);return this.#operations.delete(e),t}_pushPendingDependencies(e){for(let t of e)this.#pendingDependencies.add(t)}take(){return this.#fontBBoxTrustworthy.clear(),new gn(this.#bboxes,this.#bboxesCoords)}takeDebugMetadata(){return this.#debugMetadata}},yn=class e{#dependencyTracker;#opIdx;#ignoreBBoxes;#nestingLevel=0;#savesLevel=0;constructor(t,n,r){if(t instanceof e&&t.#ignoreBBoxes===!!r)return t;this.#dependencyTracker=t,this.#opIdx=n,this.#ignoreBBoxes=!!r}growOperationsCount(){throw Error(`Unreachable`)}save(e){return this.#savesLevel++,this.#dependencyTracker.save(this.#opIdx),this}restore(e){return this.#savesLevel>0&&(this.#dependencyTracker.restore(this.#opIdx),this.#savesLevel--),this}recordOpenMarker(e){return this.#nestingLevel++,this}getOpenMarker(){return this.#nestingLevel>0?this.#opIdx:this.#dependencyTracker.getOpenMarker()}recordCloseMarker(e){return this.#nestingLevel--,this}beginMarkedContent(e){return this}endMarkedContent(e){return this}pushBaseTransform(e){return this.#dependencyTracker.pushBaseTransform(e),this}popBaseTransform(){return this.#dependencyTracker.popBaseTransform(),this}recordSimpleData(e,t){return this.#dependencyTracker.recordSimpleData(e,this.#opIdx),this}recordIncrementalData(e,t){return this.#dependencyTracker.recordIncrementalData(e,this.#opIdx),this}resetIncrementalData(e,t){return this.#dependencyTracker.resetIncrementalData(e,this.#opIdx),this}recordNamedData(e,t){return this}recordSimpleDataFromNamed(e,t,n){return this.#dependencyTracker.recordSimpleDataFromNamed(e,t,this.#opIdx),this}recordFutureForcedDependency(e,t){return this.#dependencyTracker.recordFutureForcedDependency(e,this.#opIdx),this}inheritSimpleDataAsFutureForcedDependencies(e){return this.#dependencyTracker.inheritSimpleDataAsFutureForcedDependencies(e),this}inheritPendingDependenciesAsFutureForcedDependencies(){return this.#dependencyTracker.inheritPendingDependenciesAsFutureForcedDependencies(),this}resetBBox(e){return this.#ignoreBBoxes||this.#dependencyTracker.resetBBox(this.#opIdx),this}recordClipBox(e,t,n,r,i,a){return this.#ignoreBBoxes||this.#dependencyTracker.recordClipBox(this.#opIdx,t,n,r,i,a),this}recordBBox(e,t,n,r,i,a){return this.#ignoreBBoxes||this.#dependencyTracker.recordBBox(this.#opIdx,t,n,r,i,a),this}recordCharacterBBox(e,t,n,r,i,a,o){return this.#ignoreBBoxes||this.#dependencyTracker.recordCharacterBBox(this.#opIdx,t,n,r,i,a,o),this}recordFullPageBBox(e){return this.#ignoreBBoxes||this.#dependencyTracker.recordFullPageBBox(this.#opIdx),this}getSimpleIndex(e){return this.#dependencyTracker.getSimpleIndex(e)}recordDependencies(e,t){return this.#dependencyTracker.recordDependencies(this.#opIdx,t),this}recordNamedDependency(e,t){return this.#dependencyTracker.recordNamedDependency(this.#opIdx,t),this}recordOperation(e){return this.#dependencyTracker.recordOperation(this.#opIdx,!0),this}recordShowTextOperation(e){return this.#dependencyTracker.recordShowTextOperation(this.#opIdx,!0),this}bboxToClipBoxDropOperation(e){return this.#ignoreBBoxes||this.#dependencyTracker.bboxToClipBoxDropOperation(this.#opIdx,!0),this}take(){throw Error(`Unreachable`)}takeDebugMetadata(){throw Error(`Unreachable`)}},J={stroke:[`path`,`transform`,`filter`,`strokeColor`,`strokeAlpha`,`lineWidth`,`lineCap`,`lineJoin`,`miterLimit`,`dash`],fill:[`path`,`transform`,`filter`,`fillColor`,`fillAlpha`,`globalCompositeOperation`,`SMask`],imageXObject:[`transform`,`SMask`,`filter`,`fillAlpha`,`strokeAlpha`,`globalCompositeOperation`],rawFillPath:[`filter`,`fillColor`,`fillAlpha`],showText:[`transform`,`leading`,`charSpacing`,`wordSpacing`,`hScale`,`textRise`,`moveText`,`textMatrix`,`font`,`fontObj`,`filter`,`fillColor`,`textRenderingMode`,`SMask`,`fillAlpha`,`strokeAlpha`,`globalCompositeOperation`,`sameLineText`],transform:[`transform`],transformAndFill:[`transform`,`fillColor`]},Y={FILL:`Fill`,STROKE:`Stroke`,SHADING:`Shading`};function bn(e,t){if(!t)return;let n=t[2]-t[0],r=t[3]-t[1],i=new Path2D;i.rect(t[0],t[1],n,r),e.clip(i)}var xn=class{isModifyingCurrentTransform(){return!1}getPattern(){F("Abstract method `getPattern` called.")}},Sn=class extends xn{constructor(e){super(),this._type=e[1],this._bbox=e[2],this._colorStops=e[3],this._p0=e[4],this._p1=e[5],this._r0=e[6],this._r1=e[7],this.matrix=null}isOriginBased(){return this._p0[0]===0&&this._p0[1]===0&&(!this.isRadial()||this._p1[0]===0&&this._p1[1]===0)}isRadial(){return this._type===`radial`}_createGradient(e,t=null){let n,r=this._p0,i=this._p1;if(t&&(r=r.slice(),i=i.slice(),z.applyTransform(r,t),z.applyTransform(i,t)),this._type===`axial`)n=e.createLinearGradient(r[0],r[1],i[0],i[1]);else if(this._type===`radial`){let a=this._r0,o=this._r1;if(t){let e=new Float32Array(2);z.singularValueDecompose2dScale(t,e),a*=e[0],o*=e[0]}n=e.createRadialGradient(r[0],r[1],a,i[0],i[1],o)}for(let e of this._colorStops)n.addColorStop(e[0],e[1]);return n}getPattern(e,t,n,r){let i;if(r===Y.STROKE||r===Y.FILL){if(this.isOriginBased()){let r=z.transform(n,t.baseTransform);this.matrix&&(r=z.transform(r,this.matrix));let i=.001,a=Math.hypot(r[0],r[1]),o=Math.hypot(r[2],r[3]),s=(r[0]*r[2]+r[1]*r[3])/(a*o);if(Math.abs(s)<i)if(this.isRadial()){if(Math.abs(a-o)<i)return this._createGradient(e,r)}else return this._createGradient(e,r)}let a=t.current.getClippedPathBoundingBox(r,U(e))||[0,0,0,0],o=Math.ceil(a[2]-a[0])||1,s=Math.ceil(a[3]-a[1])||1,c=t.cachedCanvases.getCanvas(`pattern`,o,s),l=c.context;l.clearRect(0,0,l.canvas.width,l.canvas.height),l.beginPath(),l.rect(0,0,l.canvas.width,l.canvas.height),l.translate(-a[0],-a[1]),n=z.transform(n,[1,0,0,1,a[0],a[1]]),l.transform(...t.baseTransform),this.matrix&&l.transform(...this.matrix),bn(l,this._bbox),l.fillStyle=this._createGradient(l),l.fill(),i=e.createPattern(c.canvas,`no-repeat`);let u=new DOMMatrix(n);i.setTransform(u)}else bn(e,this._bbox),i=this._createGradient(e);return i}};function Cn(e,t,n,r,i,a,o,s){let c=t.coords,l=t.colors,u=e.data,d=e.width*4,f;c[n+1]>c[r+1]&&(f=n,n=r,r=f,f=a,a=o,o=f),c[r+1]>c[i+1]&&(f=r,r=i,i=f,f=o,o=s,s=f),c[n+1]>c[r+1]&&(f=n,n=r,r=f,f=a,a=o,o=f);let p=(c[n]+t.offsetX)*t.scaleX,m=(c[n+1]+t.offsetY)*t.scaleY,h=(c[r]+t.offsetX)*t.scaleX,g=(c[r+1]+t.offsetY)*t.scaleY,_=(c[i]+t.offsetX)*t.scaleX,v=(c[i+1]+t.offsetY)*t.scaleY;if(m>=v)return;let y=l[a],b=l[a+1],x=l[a+2],S=l[o],C=l[o+1],w=l[o+2],T=l[s],E=l[s+1],D=l[s+2],O=Math.round(m),k=Math.round(v),A,j,M,N,ee,te,ne,re;for(let e=O;e<=k;e++){if(e<g){let t=e<m?0:(m-e)/(m-g);A=p-(p-h)*t,j=y-(y-S)*t,M=b-(b-C)*t,N=x-(x-w)*t}else{let t;t=e>v?1:g===v?0:(g-e)/(g-v),A=h-(h-_)*t,j=S-(S-T)*t,M=C-(C-E)*t,N=w-(w-D)*t}let t;t=e<m?0:e>v?1:(m-e)/(m-v),ee=p-(p-_)*t,te=y-(y-T)*t,ne=b-(b-E)*t,re=x-(x-D)*t;let n=Math.round(Math.min(A,ee)),r=Math.round(Math.max(A,ee)),i=d*e+n*4;for(let e=n;e<=r;e++)t=(A-e)/(A-ee),t<0?t=0:t>1&&(t=1),u[i++]=j-(j-te)*t|0,u[i++]=M-(M-ne)*t|0,u[i++]=N-(N-re)*t|0,u[i++]=255}}function wn(e,t,n){let r=t.coords,i=t.colors,a,o;switch(t.type){case A.LATTICE:let s=t.verticesPerRow,c=Math.floor(r.length/s)-1,l=s-1;for(a=0;a<c;a++){let t=a*s;for(let a=0;a<l;a++,t++)Cn(e,n,r[t],r[t+1],r[t+s],i[t],i[t+1],i[t+s]),Cn(e,n,r[t+s+1],r[t+1],r[t+s],i[t+s+1],i[t+1],i[t+s])}break;case A.TRIANGLES:for(a=0,o=r.length;a<o;a+=3)Cn(e,n,r[a],r[a+1],r[a+2],i[a],i[a+1],i[a+2]);break;default:throw Error(`illegal figure`)}}var Tn=class extends xn{constructor(e){super(),this._coords=e[2],this._colors=e[3],this._figures=e[4],this._bounds=e[5],this._bbox=e[6],this._background=e[7],this.matrix=null}_createMeshCanvas(e,t,n){let r=1.1,i=3e3,a=Math.floor(this._bounds[0]),o=Math.floor(this._bounds[1]),s=Math.ceil(this._bounds[2])-a,c=Math.ceil(this._bounds[3])-o,l=Math.min(Math.ceil(Math.abs(s*e[0]*r)),i),u=Math.min(Math.ceil(Math.abs(c*e[1]*r)),i),d=s/l,f=c/u,p={coords:this._coords,colors:this._colors,offsetX:-a,offsetY:-o,scaleX:1/d,scaleY:1/f},m=l+4,h=u+4,g=n.getCanvas(`mesh`,m,h),_=g.context,v=_.createImageData(l,u);if(t){let e=v.data;for(let n=0,r=e.length;n<r;n+=4)e[n]=t[0],e[n+1]=t[1],e[n+2]=t[2],e[n+3]=255}for(let e of this._figures)wn(v,e,p);return _.putImageData(v,2,2),{canvas:g.canvas,offsetX:a-2*d,offsetY:o-2*f,scaleX:d,scaleY:f}}isModifyingCurrentTransform(){return!0}getPattern(e,t,n,r){bn(e,this._bbox);let i=new Float32Array(2);if(r===Y.SHADING)z.singularValueDecompose2dScale(U(e),i);else if(this.matrix){z.singularValueDecompose2dScale(this.matrix,i);let[e,n]=i;z.singularValueDecompose2dScale(t.baseTransform,i),i[0]*=e,i[1]*=n}else z.singularValueDecompose2dScale(t.baseTransform,i);let a=this._createMeshCanvas(i,r===Y.SHADING?null:this._background,t.cachedCanvases);return r!==Y.SHADING&&(e.setTransform(...t.baseTransform),this.matrix&&e.transform(...this.matrix)),e.translate(a.offsetX,a.offsetY),e.scale(a.scaleX,a.scaleY),e.createPattern(a.canvas,`no-repeat`)}},En=class extends xn{getPattern(){return`hotpink`}};function Dn(e){switch(e[0]){case`RadialAxial`:return new Sn(e);case`Mesh`:return new Tn(e);case`Dummy`:return new En}throw Error(`Unknown IR type: ${e[0]}`)}var On={COLORED:1,UNCOLORED:2},kn=class e{static MAX_PATTERN_SIZE=3e3;constructor(e,t,n,r){this.color=e[1],this.operatorList=e[2],this.matrix=e[3],this.bbox=e[4],this.xstep=e[5],this.ystep=e[6],this.paintType=e[7],this.tilingType=e[8],this.ctx=t,this.canvasGraphicsFactory=n,this.baseTransform=r}createPatternCanvas(e,t){let{bbox:n,operatorList:r,paintType:i,tilingType:a,color:o,canvasGraphicsFactory:s}=this,{xstep:c,ystep:l}=this;c=Math.abs(c),l=Math.abs(l),ce(`TilingType: `+a);let u=n[0],d=n[1],f=n[2],p=n[3],m=f-u,h=p-d,g=new Float32Array(2);z.singularValueDecompose2dScale(this.matrix,g);let[_,v]=g;z.singularValueDecompose2dScale(this.baseTransform,g);let y=_*g[0],b=v*g[1],x=m,S=h,C=!1,w=!1,T=Math.ceil(c*y),E=Math.ceil(l*b),D=Math.ceil(m*y),O=Math.ceil(h*b);T>=D?x=c:C=!0,E>=O?S=l:w=!0;let k=this.getSizeAndScale(x,this.ctx.canvas.width,y),A=this.getSizeAndScale(S,this.ctx.canvas.height,b),j=e.cachedCanvases.getCanvas(`pattern`,k.size,A.size),M=j.context,N=s.createCanvasGraphics(M,t);if(N.groupLevel=e.groupLevel,this.setFillAndStrokeStyleToContext(N,i,o),M.translate(-k.scale*u,-A.scale*d),N.transform(0,k.scale,0,0,A.scale,0,0),M.save(),N.dependencyTracker?.save(),this.clipBbox(N,u,d,f,p),N.baseTransform=U(N.ctx),N.executeOperatorList(r),N.endDrawing(),N.dependencyTracker?.restore(),M.restore(),C||w){let t=j.canvas;C&&(x=c),w&&(S=l);let n=this.getSizeAndScale(x,this.ctx.canvas.width,y),r=this.getSizeAndScale(S,this.ctx.canvas.height,b),i=n.size,a=r.size,o=e.cachedCanvases.getCanvas(`pattern-workaround`,i,a),s=o.context,f=C?Math.floor(m/c):0,p=w?Math.floor(h/l):0;for(let e=0;e<=f;e++)for(let n=0;n<=p;n++)s.drawImage(t,i*e,a*n,i,a,0,0,i,a);return{canvas:o.canvas,scaleX:n.scale,scaleY:r.scale,offsetX:u,offsetY:d}}return{canvas:j.canvas,scaleX:k.scale,scaleY:A.scale,offsetX:u,offsetY:d}}getSizeAndScale(t,n,r){let i=Math.max(e.MAX_PATTERN_SIZE,n),a=Math.ceil(t*r);return a>=i?a=i:r=a/t,{scale:r,size:a}}clipBbox(e,t,n,r,i){let a=r-t,o=i-n;e.ctx.rect(t,n,a,o),z.axialAlignedBoundingBox([t,n,r,i],U(e.ctx),e.current.minMax),e.clip(),e.endPath()}setFillAndStrokeStyleToContext(e,t,n){let r=e.ctx,i=e.current;switch(t){case On.COLORED:let{fillStyle:e,strokeStyle:a}=this.ctx;r.fillStyle=i.fillColor=e,r.strokeStyle=i.strokeColor=a;break;case On.UNCOLORED:r.fillStyle=r.strokeStyle=n,i.fillColor=i.strokeColor=n;break;default:throw new _e(`Unsupported paint type: ${t}`)}}isModifyingCurrentTransform(){return!1}getPattern(e,t,n,r,i){let a=n;r!==Y.SHADING&&(a=z.transform(a,t.baseTransform),this.matrix&&(a=z.transform(a,this.matrix)));let o=this.createPatternCanvas(t,i),s=new DOMMatrix(a);s=s.translate(o.offsetX,o.offsetY),s=s.scale(1/o.scaleX,1/o.scaleY);let c=e.createPattern(o.canvas,`repeat`);return c.setTransform(s),c}};function An({src:e,srcPos:t=0,dest:n,width:r,height:i,nonBlackColor:a=4294967295,inverseDecode:o=!1}){let s=R.isLittleEndian?4278190080:255,[c,l]=o?[a,s]:[s,a],u=r>>3,d=r&7,f=e.length;n=new Uint32Array(n.buffer);let p=0;for(let r=0;r<i;r++){for(let r=t+u;t<r;t++){let r=t<f?e[t]:255;n[p++]=r&128?l:c,n[p++]=r&64?l:c,n[p++]=r&32?l:c,n[p++]=r&16?l:c,n[p++]=r&8?l:c,n[p++]=r&4?l:c,n[p++]=r&2?l:c,n[p++]=r&1?l:c}if(d===0)continue;let r=t<f?e[t++]:255;for(let e=0;e<d;e++)n[p++]=r&1<<7-e?l:c}return{srcPos:t,destPos:p}}var jn=16,Mn=100,Nn=15,Pn=10,X=16,Fn=new DOMMatrix,Z=new Float32Array(2),In=new Float32Array([1/0,1/0,-1/0,-1/0]);function Ln(e,t){if(e._removeMirroring)throw Error(`Context is already forwarding operations.`);e.__originalSave=e.save,e.__originalRestore=e.restore,e.__originalRotate=e.rotate,e.__originalScale=e.scale,e.__originalTranslate=e.translate,e.__originalTransform=e.transform,e.__originalSetTransform=e.setTransform,e.__originalResetTransform=e.resetTransform,e.__originalClip=e.clip,e.__originalMoveTo=e.moveTo,e.__originalLineTo=e.lineTo,e.__originalBezierCurveTo=e.bezierCurveTo,e.__originalRect=e.rect,e.__originalClosePath=e.closePath,e.__originalBeginPath=e.beginPath,e._removeMirroring=()=>{e.save=e.__originalSave,e.restore=e.__originalRestore,e.rotate=e.__originalRotate,e.scale=e.__originalScale,e.translate=e.__originalTranslate,e.transform=e.__originalTransform,e.setTransform=e.__originalSetTransform,e.resetTransform=e.__originalResetTransform,e.clip=e.__originalClip,e.moveTo=e.__originalMoveTo,e.lineTo=e.__originalLineTo,e.bezierCurveTo=e.__originalBezierCurveTo,e.rect=e.__originalRect,e.closePath=e.__originalClosePath,e.beginPath=e.__originalBeginPath,delete e._removeMirroring},e.save=function(){t.save(),this.__originalSave()},e.restore=function(){t.restore(),this.__originalRestore()},e.translate=function(e,n){t.translate(e,n),this.__originalTranslate(e,n)},e.scale=function(e,n){t.scale(e,n),this.__originalScale(e,n)},e.transform=function(e,n,r,i,a,o){t.transform(e,n,r,i,a,o),this.__originalTransform(e,n,r,i,a,o)},e.setTransform=function(e,n,r,i,a,o){t.setTransform(e,n,r,i,a,o),this.__originalSetTransform(e,n,r,i,a,o)},e.resetTransform=function(){t.resetTransform(),this.__originalResetTransform()},e.rotate=function(e){t.rotate(e),this.__originalRotate(e)},e.clip=function(e){t.clip(e),this.__originalClip(e)},e.moveTo=function(e,n){t.moveTo(e,n),this.__originalMoveTo(e,n)},e.lineTo=function(e,n){t.lineTo(e,n),this.__originalLineTo(e,n)},e.bezierCurveTo=function(e,n,r,i,a,o){t.bezierCurveTo(e,n,r,i,a,o),this.__originalBezierCurveTo(e,n,r,i,a,o)},e.rect=function(e,n,r,i){t.rect(e,n,r,i),this.__originalRect(e,n,r,i)},e.closePath=function(){t.closePath(),this.__originalClosePath()},e.beginPath=function(){t.beginPath(),this.__originalBeginPath()}}var Rn=class{constructor(e){this.canvasFactory=e,this.cache=Object.create(null)}getCanvas(e,t,n){let r;return this.cache[e]===void 0?(r=this.canvasFactory.create(t,n),this.cache[e]=r):(r=this.cache[e],this.canvasFactory.reset(r,t,n)),r}delete(e){delete this.cache[e]}clear(){for(let e in this.cache){let t=this.cache[e];this.canvasFactory.destroy(t),delete this.cache[e]}}};function zn(e,t,n,r,i,a,o,s,c,l){let[u,d,f,p,m,h]=U(e);if(d===0&&f===0){let g=o*u+m,_=Math.round(g),v=s*p+h,y=Math.round(v),b=(o+c)*u+m,x=Math.abs(Math.round(b)-_)||1,S=(s+l)*p+h,C=Math.abs(Math.round(S)-y)||1;return e.setTransform(Math.sign(u),0,0,Math.sign(p),_,y),e.drawImage(t,n,r,i,a,0,0,x,C),e.setTransform(u,d,f,p,m,h),[x,C]}if(u===0&&p===0){let g=s*f+m,_=Math.round(g),v=o*d+h,y=Math.round(v),b=(s+l)*f+m,x=Math.abs(Math.round(b)-_)||1,S=(o+c)*d+h,C=Math.abs(Math.round(S)-y)||1;return e.setTransform(0,Math.sign(d),Math.sign(f),0,_,y),e.drawImage(t,n,r,i,a,0,0,C,x),e.setTransform(u,d,f,p,m,h),[C,x]}e.drawImage(t,n,r,i,a,o,s,c,l);let g=Math.hypot(u,d),_=Math.hypot(f,p);return[g*c,_*l]}var Bn=class{alphaIsShape=!1;fontSize=0;fontSizeScale=1;textMatrix=null;textMatrixScale=1;fontMatrix=S;leading=0;x=0;y=0;lineX=0;lineY=0;charSpacing=0;wordSpacing=0;textHScale=1;textRenderingMode=j.FILL;textRise=0;fillColor=`#000000`;strokeColor=`#000000`;patternFill=!1;patternStroke=!1;fillAlpha=1;strokeAlpha=1;lineWidth=1;activeSMask=null;transferMaps=`none`;constructor(e,t,n){n?.(this),this.clipBox=new Float32Array([0,0,e,t]),this.minMax=In.slice()}clone(){let e=Object.create(this);return e.clipBox=this.clipBox.slice(),e.minMax=this.minMax.slice(),e}getPathBoundingBox(e=Y.FILL,t=null){let n=this.minMax.slice();if(e===Y.STROKE){t||F(`Stroke bounding box must include transform.`),z.singularValueDecompose2dScale(t,Z);let e=Z[0]*this.lineWidth/2,r=Z[1]*this.lineWidth/2;n[0]-=e,n[1]-=r,n[2]+=e,n[3]+=r}return n}updateClipFromPath(){let e=z.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(e||[0,0,0,0])}isEmptyClip(){return this.minMax[0]===1/0}startNewPathAndClipBox(e){this.clipBox.set(e,0),this.minMax.set(In,0)}getClippedPathBoundingBox(e=Y.FILL,t=null){return z.intersect(this.clipBox,this.getPathBoundingBox(e,t))}};function Vn(e,t){if(t instanceof ImageData){e.putImageData(t,0,0);return}let n=t.height,r=t.width,i=n%X,a=(n-i)/X,o=i===0?a:a+1,s=e.createImageData(r,X),c=0,l,u=t.data,d=s.data,f,p,m,h;if(t.kind===M.GRAYSCALE_1BPP){let t=u.byteLength,n=new Uint32Array(d.buffer,0,d.byteLength>>2),h=n.length,g=r+7>>3,_=4294967295,v=R.isLittleEndian?4278190080:255;for(f=0;f<o;f++){for(m=f<a?X:i,l=0,p=0;p<m;p++){let e=t-c,i=0,a=e>g?r:e*8-7,o=a&-8,s=0,d=0;for(;i<o;i+=8)d=u[c++],n[l++]=d&128?_:v,n[l++]=d&64?_:v,n[l++]=d&32?_:v,n[l++]=d&16?_:v,n[l++]=d&8?_:v,n[l++]=d&4?_:v,n[l++]=d&2?_:v,n[l++]=d&1?_:v;for(;i<a;i++)s===0&&(d=u[c++],s=128),n[l++]=d&s?_:v,s>>=1}for(;l<h;)n[l++]=0;e.putImageData(s,0,f*X)}}else if(t.kind===M.RGBA_32BPP){for(p=0,h=r*X*4,f=0;f<a;f++)d.set(u.subarray(c,c+h)),c+=h,e.putImageData(s,0,p),p+=X;f<o&&(h=r*i*4,d.set(u.subarray(c,c+h)),e.putImageData(s,0,p))}else if(t.kind===M.RGB_24BPP)for(m=X,h=r*m,f=0;f<o;f++){for(f>=a&&(m=i,h=r*m),l=0,p=h;p--;)d[l++]=u[c++],d[l++]=u[c++],d[l++]=u[c++],d[l++]=255;e.putImageData(s,0,f*X)}else throw Error(`bad image kind: ${t.kind}`)}function Hn(e,t){if(t.bitmap){e.drawImage(t.bitmap,0,0);return}let n=t.height,r=t.width,i=n%X,a=(n-i)/X,o=i===0?a:a+1,s=e.createImageData(r,X),c=0,l=t.data,u=s.data;for(let t=0;t<o;t++){let n=t<a?X:i;({srcPos:c}=An({src:l,srcPos:c,dest:u,width:r,height:n,nonBlackColor:0})),e.putImageData(s,0,t*X)}}function Un(e,t){for(let n of[`strokeStyle`,`fillStyle`,`fillRule`,`globalAlpha`,`lineWidth`,`lineCap`,`lineJoin`,`miterLimit`,`globalCompositeOperation`,`font`,`filter`])e[n]!==void 0&&(t[n]=e[n]);e.setLineDash!==void 0&&(t.setLineDash(e.getLineDash()),t.lineDashOffset=e.lineDashOffset)}function Wn(e){e.strokeStyle=e.fillStyle=`#000000`,e.fillRule=`nonzero`,e.globalAlpha=1,e.lineWidth=1,e.lineCap=`butt`,e.lineJoin=`miter`,e.miterLimit=10,e.globalCompositeOperation=`source-over`,e.font=`10px sans-serif`,e.setLineDash!==void 0&&(e.setLineDash([]),e.lineDashOffset=0);let{filter:t}=e;t!==`none`&&t!==``&&(e.filter=`none`)}function Gn(e,t){if(t)return!0;z.singularValueDecompose2dScale(e,Z);let n=Math.fround(Qe.pixelRatio*Fe.PDF_TO_CSS_UNITS);return Z[0]<=n&&Z[1]<=n}var Kn=[`butt`,`round`,`square`],qn=[`miter`,`round`,`bevel`],Jn={},Yn={},Xn=class e{constructor(e,t,n,r,i,{optionalContentConfig:a,markedContentStack:o=null},s,c,l){this.ctx=e,this.current=new Bn(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=t,this.objs=n,this.canvasFactory=r,this.filterFactory=i,this.groupStack=[],this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=o||[],this.optionalContentConfig=a,this.cachedCanvases=new Rn(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=s,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=c,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map,this.dependencyTracker=l??null}getObject(e,t,n=null){return typeof t==`string`?(this.dependencyTracker?.recordNamedDependency(e,t),t.startsWith(`g_`)?this.commonObjs.get(t):this.objs.get(t)):n}beginDrawing({transform:e,viewport:t,transparency:n=!1,background:r=null}){let i=this.ctx.canvas.width,a=this.ctx.canvas.height,o=this.ctx.fillStyle;if(this.ctx.fillStyle=r||`#ffffff`,this.ctx.fillRect(0,0,i,a),this.ctx.fillStyle=o,n){let e=this.cachedCanvases.getCanvas(`transparent`,i,a);this.compositeCtx=this.ctx,this.transparentCanvas=e.canvas,this.ctx=e.context,this.ctx.save(),this.ctx.transform(...U(this.compositeCtx))}this.ctx.save(),Wn(this.ctx),e&&(this.ctx.transform(...e),this.outputScaleX=e[0],this.outputScaleY=e[0]),this.ctx.transform(...t.transform),this.viewportScale=t.scale,this.baseTransform=U(this.ctx)}executeOperatorList(e,t,n,r,i){let a=e.argsArray,o=e.fnArray,s=t||0,c=a.length;if(c===s)return s;let l=c-s>Pn&&typeof n==`function`,u=l?Date.now()+Nn:0,d=0,f=this.commonObjs,p=this.objs,m,h;for(;;){if(r!==void 0&&s===r.nextBreakPoint)return r.breakIt(s,n),s;if(!i||i(s))if(m=o[s],h=a[s]??null,m!==ne.dependency)h===null?this[m](s):this[m](s,...h);else for(let e of h){this.dependencyTracker?.recordNamedData(e,s);let t=e.startsWith(`g_`)?f:p;if(!t.has(e))return t.get(e,n),s}if(s++,s===c)return s;if(l&&++d>Pn){if(Date.now()>u)return n(),s;d=0}}}#restoreInitialState(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&=(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),null)}endDrawing(){this.#restoreInitialState(),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(let e of this._cachedBitmapsMap.values()){for(let t of e.values())typeof HTMLCanvasElement<`u`&&t instanceof HTMLCanvasElement&&(t.width=t.height=0);e.clear()}this._cachedBitmapsMap.clear(),this.#drawFilter()}#drawFilter(){if(this.pageColors){let e=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(e!==`none`){let t=this.ctx.filter;this.ctx.filter=e,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=t}}}_scaleImage(e,t){let n=e.width??e.displayWidth,r=e.height??e.displayHeight,i=Math.max(Math.hypot(t[0],t[1]),1),a=Math.max(Math.hypot(t[2],t[3]),1),o=n,s=r,c=`prescale1`,l,u;for(;i>2&&o>1||a>2&&s>1;){let t=o,n=s;i>2&&o>1&&(t=o>=16384?Math.floor(o/2)-1||1:Math.ceil(o/2),i/=o/t),a>2&&s>1&&(n=s>=16384?Math.floor(s/2)-1||1:Math.ceil(s)/2,a/=s/n),l=this.cachedCanvases.getCanvas(c,t,n),u=l.context,u.clearRect(0,0,t,n),u.drawImage(e,0,0,o,s,0,0,t,n),e=l.canvas,o=t,s=n,c=c===`prescale1`?`prescale2`:`prescale1`}return{img:e,paintWidth:o,paintHeight:s}}_createMaskCanvas(e,t){let n=this.ctx,{width:r,height:i}=t,a=this.current.fillColor,o=this.current.patternFill,s=U(n),c,l,u,d;if((t.bitmap||t.data)&&t.count>1){let n=t.bitmap||t.data.buffer;l=JSON.stringify(o?s:[s.slice(0,4),a]),c=this._cachedBitmapsMap.get(n),c||(c=new Map,this._cachedBitmapsMap.set(n,c));let r=c.get(l);if(r&&!o){let t=Math.round(Math.min(s[0],s[2])+s[4]),n=Math.round(Math.min(s[1],s[3])+s[5]);return this.dependencyTracker?.recordDependencies(e,J.transformAndFill),{canvas:r,offsetX:t,offsetY:n}}u=r}u||(d=this.cachedCanvases.getCanvas(`maskCanvas`,r,i),Hn(d.context,t));let f=z.transform(s,[1/r,0,0,-1/i,0,0]);f=z.transform(f,[1,0,0,1,0,-i]);let p=In.slice();z.axialAlignedBoundingBox([0,0,r,i],f,p);let[m,h,g,_]=p,v=Math.round(g-m)||1,y=Math.round(_-h)||1,b=this.cachedCanvases.getCanvas(`fillCanvas`,v,y),x=b.context,S=m,C=h;x.translate(-S,-C),x.transform(...f),u||(u=this._scaleImage(d.canvas,Xe(x)),u=u.img,c&&o&&c.set(l,u)),x.imageSmoothingEnabled=Gn(U(x),t.interpolate),zn(x,u,0,0,u.width,u.height,0,0,r,i),x.globalCompositeOperation=`source-in`;let w=z.transform(Xe(x),[1,0,0,1,-S,-C]);return x.fillStyle=o?a.getPattern(n,this,w,Y.FILL,e):a,x.fillRect(0,0,r,i),c&&!o&&(this.cachedCanvases.delete(`fillCanvas`),c.set(l,b.canvas)),this.dependencyTracker?.recordDependencies(e,J.transformAndFill),{canvas:b.canvas,offsetX:Math.round(S),offsetY:Math.round(C)}}setLineWidth(e,t){this.dependencyTracker?.recordSimpleData(`lineWidth`,e),t!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=t,this.ctx.lineWidth=t}setLineCap(e,t){this.dependencyTracker?.recordSimpleData(`lineCap`,e),this.ctx.lineCap=Kn[t]}setLineJoin(e,t){this.dependencyTracker?.recordSimpleData(`lineJoin`,e),this.ctx.lineJoin=qn[t]}setMiterLimit(e,t){this.dependencyTracker?.recordSimpleData(`miterLimit`,e),this.ctx.miterLimit=t}setDash(e,t,n){this.dependencyTracker?.recordSimpleData(`dash`,e);let r=this.ctx;r.setLineDash!==void 0&&(r.setLineDash(t),r.lineDashOffset=n)}setRenderingIntent(e,t){}setFlatness(e,t){}setGState(e,t){for(let[n,r]of t)switch(n){case`LW`:this.setLineWidth(e,r);break;case`LC`:this.setLineCap(e,r);break;case`LJ`:this.setLineJoin(e,r);break;case`ML`:this.setMiterLimit(e,r);break;case`D`:this.setDash(e,r[0],r[1]);break;case`RI`:this.setRenderingIntent(e,r);break;case`FL`:this.setFlatness(e,r);break;case`Font`:this.setFont(e,r[0],r[1]);break;case`CA`:this.dependencyTracker?.recordSimpleData(`strokeAlpha`,e),this.current.strokeAlpha=r;break;case`ca`:this.dependencyTracker?.recordSimpleData(`fillAlpha`,e),this.ctx.globalAlpha=this.current.fillAlpha=r;break;case`BM`:this.dependencyTracker?.recordSimpleData(`globalCompositeOperation`,e),this.ctx.globalCompositeOperation=r;break;case`SMask`:this.dependencyTracker?.recordSimpleData(`SMask`,e),this.current.activeSMask=r?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case`TR`:this.dependencyTracker?.recordSimpleData(`filter`,e),this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(r);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){let e=this.inSMaskMode;this.current.activeSMask&&!e?this.beginSMaskMode():!this.current.activeSMask&&e&&this.endSMaskMode()}beginSMaskMode(e){if(this.inSMaskMode)throw Error(`beginSMaskMode called while already in smask mode`);let t=this.ctx.canvas.width,n=this.ctx.canvas.height,r=`smaskGroupAt`+this.groupLevel,i=this.cachedCanvases.getCanvas(r,t,n);this.suspendedCtx=this.ctx;let a=this.ctx=i.context;a.setTransform(this.suspendedCtx.getTransform()),Un(this.suspendedCtx,a),Ln(a,this.suspendedCtx),this.setGState(e,[[`BM`,`source-over`]])}endSMaskMode(){if(!this.inSMaskMode)throw Error(`endSMaskMode called while not in smask mode`);this.ctx._removeMirroring(),Un(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(e){if(!this.current.activeSMask)return;e?(e[0]=Math.floor(e[0]),e[1]=Math.floor(e[1]),e[2]=Math.ceil(e[2]),e[3]=Math.ceil(e[3])):e=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];let t=this.current.activeSMask,n=this.suspendedCtx;this.composeSMask(n,t,this.ctx,e),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(e,t,n,r){let i=r[0],a=r[1],o=r[2]-i,s=r[3]-a;o===0||s===0||(this.genericComposeSMask(t.context,n,o,s,t.subtype,t.backdrop,t.transferMap,i,a,t.offsetX,t.offsetY),e.save(),e.globalAlpha=1,e.globalCompositeOperation=`source-over`,e.setTransform(1,0,0,1,0,0),e.drawImage(n.canvas,0,0),e.restore())}genericComposeSMask(e,t,n,r,i,a,o,s,c,l,u){let d=e.canvas,f=s-l,p=c-u;if(a)if(f<0||p<0||f+n>d.width||p+r>d.height){let e=this.cachedCanvases.getCanvas(`maskExtension`,n,r),t=e.context;t.drawImage(d,-f,-p),t.globalCompositeOperation=`destination-atop`,t.fillStyle=a,t.fillRect(0,0,n,r),t.globalCompositeOperation=`source-over`,d=e.canvas,f=p=0}else{e.save(),e.globalAlpha=1,e.setTransform(1,0,0,1,0,0);let t=new Path2D;t.rect(f,p,n,r),e.clip(t),e.globalCompositeOperation=`destination-atop`,e.fillStyle=a,e.fillRect(f,p,n,r),e.restore()}t.save(),t.globalAlpha=1,t.setTransform(1,0,0,1,0,0),i===`Alpha`&&o?t.filter=this.filterFactory.addAlphaFilter(o):i===`Luminosity`&&(t.filter=this.filterFactory.addLuminosityFilter(o));let m=new Path2D;m.rect(s,c,n,r),t.clip(m),t.globalCompositeOperation=`destination-in`,t.drawImage(d,f,p,n,r,s,c,n,r),t.restore()}save(e){this.inSMaskMode&&Un(this.ctx,this.suspendedCtx),this.ctx.save();let t=this.current;this.stateStack.push(t),this.current=t.clone(),this.dependencyTracker?.save(e)}restore(e){if(this.dependencyTracker?.restore(e),this.stateStack.length===0){this.inSMaskMode&&this.endSMaskMode();return}this.current=this.stateStack.pop(),this.ctx.restore(),this.inSMaskMode&&Un(this.suspendedCtx,this.ctx),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}transform(e,t,n,r,i,a,o){this.dependencyTracker?.recordIncrementalData(`transform`,e),this.ctx.transform(t,n,r,i,a,o),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(e,t,n,r){let[i]=n;if(!r){i||=n[0]=new Path2D,this[t](e,i);return}if(this.dependencyTracker!==null){let n=t===ne.stroke?this.current.lineWidth/2:0;this.dependencyTracker.resetBBox(e).recordBBox(e,this.ctx,r[0]-n,r[2]+n,r[1]-n,r[3]+n).recordDependencies(e,[`transform`])}i instanceof Path2D||(i=n[0]=ut(i)),z.axialAlignedBoundingBox(r,U(this.ctx),this.current.minMax),this[t](e,i),this._pathStartIdx=e}closePath(e){this.ctx.closePath()}stroke(e,t,n=!0){let r=this.ctx,i=this.current.strokeColor;if(r.globalAlpha=this.current.strokeAlpha,this.contentVisible)if(typeof i==`object`&&i?.getPattern){let n=i.isModifyingCurrentTransform()?r.getTransform():null;if(r.save(),r.strokeStyle=i.getPattern(r,this,Xe(r),Y.STROKE,e),n){let e=new Path2D;e.addPath(t,r.getTransform().invertSelf().multiplySelf(n)),t=e}this.rescaleAndStroke(t,!1),r.restore()}else this.rescaleAndStroke(t,!0);this.dependencyTracker?.recordDependencies(e,J.stroke),n&&this.consumePath(e,t,this.current.getClippedPathBoundingBox(Y.STROKE,U(this.ctx))),r.globalAlpha=this.current.fillAlpha}closeStroke(e,t){this.stroke(e,t)}fill(e,t,n=!0){let r=this.ctx,i=this.current.fillColor,a=this.current.patternFill,o=!1;if(a){let n=i.isModifyingCurrentTransform()?r.getTransform():null;if(this.dependencyTracker?.save(e),r.save(),r.fillStyle=i.getPattern(r,this,Xe(r),Y.FILL,e),n){let e=new Path2D;e.addPath(t,r.getTransform().invertSelf().multiplySelf(n)),t=e}o=!0}let s=this.current.getClippedPathBoundingBox();this.contentVisible&&s!==null&&(this.pendingEOFill?(r.fill(t,`evenodd`),this.pendingEOFill=!1):r.fill(t)),this.dependencyTracker?.recordDependencies(e,J.fill),o&&(r.restore(),this.dependencyTracker?.restore(e)),n&&this.consumePath(e,t,s)}eoFill(e,t){this.pendingEOFill=!0,this.fill(e,t)}fillStroke(e,t){this.fill(e,t,!1),this.stroke(e,t,!1),this.consumePath(e,t)}eoFillStroke(e,t){this.pendingEOFill=!0,this.fillStroke(e,t)}closeFillStroke(e,t){this.fillStroke(e,t)}closeEOFillStroke(e,t){this.pendingEOFill=!0,this.fillStroke(e,t)}endPath(e,t){this.consumePath(e,t)}rawFillPath(e,t){this.ctx.fill(t),this.dependencyTracker?.recordDependencies(e,J.rawFillPath).recordOperation(e)}clip(e){this.dependencyTracker?.recordFutureForcedDependency(`clipMode`,e),this.pendingClip=Jn}eoClip(e){this.dependencyTracker?.recordFutureForcedDependency(`clipMode`,e),this.pendingClip=Yn}beginText(e){this.current.textMatrix=null,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0,this.dependencyTracker?.recordOpenMarker(e).resetIncrementalData(`sameLineText`).resetIncrementalData(`moveText`,e)}endText(e){let t=this.pendingTextPaths,n=this.ctx;if(this.dependencyTracker){let{dependencyTracker:n}=this;t!==void 0&&n.recordFutureForcedDependency(`textClip`,n.getOpenMarker()).recordFutureForcedDependency(`textClip`,e),n.recordCloseMarker(e)}if(t!==void 0){let e=new Path2D,r=n.getTransform().invertSelf();for(let{transform:n,x:i,y:a,fontSize:o,path:s}of t)s&&e.addPath(s,new DOMMatrix(n).preMultiplySelf(r).translate(i,a).scale(o,-o));n.clip(e)}delete this.pendingTextPaths}setCharSpacing(e,t){this.dependencyTracker?.recordSimpleData(`charSpacing`,e),this.current.charSpacing=t}setWordSpacing(e,t){this.dependencyTracker?.recordSimpleData(`wordSpacing`,e),this.current.wordSpacing=t}setHScale(e,t){this.dependencyTracker?.recordSimpleData(`hScale`,e),this.current.textHScale=t/100}setLeading(e,t){this.dependencyTracker?.recordSimpleData(`leading`,e),this.current.leading=-t}setFont(e,t,n){this.dependencyTracker?.recordSimpleData(`font`,e).recordSimpleDataFromNamed(`fontObj`,t,e);let r=this.commonObjs.get(t),i=this.current;if(!r)throw Error(`Can't find font for ${t}`);if(i.fontMatrix=r.fontMatrix||S,(i.fontMatrix[0]===0||i.fontMatrix[3]===0)&&P(`Invalid font matrix for font `+t),n<0?(n=-n,i.fontDirection=-1):i.fontDirection=1,this.current.font=r,this.current.fontSize=n,r.isType3Font)return;let a=r.loadedName||`sans-serif`,o=r.systemFontInfo?.css||`"${a}", ${r.fallbackName}`,s=`normal`;r.black?s=`900`:r.bold&&(s=`bold`);let c=r.italic?`italic`:`normal`,l=n;n<jn?l=jn:n>Mn&&(l=Mn),this.current.fontSizeScale=n/l,this.ctx.font=`${c} ${s} ${l}px ${o}`}setTextRenderingMode(e,t){this.dependencyTracker?.recordSimpleData(`textRenderingMode`,e),this.current.textRenderingMode=t}setTextRise(e,t){this.dependencyTracker?.recordSimpleData(`textRise`,e),this.current.textRise=t}moveText(e,t,n){this.dependencyTracker?.resetIncrementalData(`sameLineText`).recordIncrementalData(`moveText`,e),this.current.x=this.current.lineX+=t,this.current.y=this.current.lineY+=n}setLeadingMoveText(e,t,n){this.setLeading(e,-n),this.moveText(e,t,n)}setTextMatrix(e,t){this.dependencyTracker?.resetIncrementalData(`sameLineText`).recordSimpleData(`textMatrix`,e);let{current:n}=this;n.textMatrix=t,n.textMatrixScale=Math.hypot(t[0],t[1]),n.x=n.lineX=0,n.y=n.lineY=0}nextLine(e){this.moveText(e,0,this.current.leading),this.dependencyTracker?.recordIncrementalData(`moveText`,this.dependencyTracker.getSimpleIndex(`leading`)??e)}#getScaledPath(e,t,n){let r=new Path2D;return r.addPath(e,new DOMMatrix(n).invertSelf().multiplySelf(t)),r}paintChar(e,t,n,r,i,a){let o=this.ctx,s=this.current,c=s.font,l=s.textRenderingMode,u=s.fontSize/s.fontSizeScale,d=l&j.FILL_STROKE_MASK,f=!!(l&j.ADD_TO_PATH_FLAG),p=s.patternFill&&!c.missingFile,m=s.patternStroke&&!c.missingFile,h;if((c.disableFontFace||f||p||m)&&!c.missingFile&&(h=c.getPathGenerator(this.commonObjs,t)),h&&(c.disableFontFace||p||m)){o.save(),o.translate(n,r),o.scale(u,-u),this.dependencyTracker?.recordCharacterBBox(e,o,c);let t;if(d===j.FILL||d===j.FILL_STROKE)if(i){t=o.getTransform(),o.setTransform(...i);let e=this.#getScaledPath(h,t,i);o.fill(e)}else o.fill(h);if(d===j.STROKE||d===j.FILL_STROKE)if(a){t||=o.getTransform(),o.setTransform(...a);let{a:e,b:n,c:r,d:i}=t,s=z.inverseTransform(a),c=z.transform([e,n,r,i,0,0],s);z.singularValueDecompose2dScale(c,Z),o.lineWidth*=Math.max(Z[0],Z[1])/u,o.stroke(this.#getScaledPath(h,t,a))}else o.lineWidth/=u,o.stroke(h);o.restore()}else (d===j.FILL||d===j.FILL_STROKE)&&(o.fillText(t,n,r),this.dependencyTracker?.recordCharacterBBox(e,o,c,u,n,r,()=>o.measureText(t))),(d===j.STROKE||d===j.FILL_STROKE)&&(this.dependencyTracker&&this.dependencyTracker?.recordCharacterBBox(e,o,c,u,n,r,()=>o.measureText(t)).recordDependencies(e,J.stroke),o.strokeText(t,n,r));f&&((this.pendingTextPaths||=[]).push({transform:U(o),x:n,y:r,fontSize:u,path:h}),this.dependencyTracker?.recordCharacterBBox(e,o,c,u,n,r))}get isFontSubpixelAAEnabled(){let{context:e}=this.cachedCanvases.getCanvas(`isFontSubpixelAAEnabled`,10,10);e.scale(1.5,1),e.fillText(`I`,0,10);let t=e.getImageData(0,0,10,10).data,n=!1;for(let e=3;e<t.length;e+=4)if(t[e]>0&&t[e]<255){n=!0;break}return L(this,`isFontSubpixelAAEnabled`,n)}showText(e,t){this.dependencyTracker&&(this.dependencyTracker.recordDependencies(e,J.showText).resetBBox(e),this.current.textRenderingMode&j.ADD_TO_PATH_FLAG&&this.dependencyTracker.recordFutureForcedDependency(`textClip`,e).inheritPendingDependenciesAsFutureForcedDependencies());let n=this.current,r=n.font;if(r.isType3Font){this.showType3Text(e,t),this.dependencyTracker?.recordShowTextOperation(e);return}let i=n.fontSize;if(i===0){this.dependencyTracker?.recordOperation(e);return}let a=this.ctx,o=n.fontSizeScale,s=n.charSpacing,c=n.wordSpacing,l=n.fontDirection,u=n.textHScale*l,d=t.length,f=r.vertical,p=f?1:-1,m=r.defaultVMetrics,h=i*n.fontMatrix[0],g=n.textRenderingMode===j.FILL&&!r.disableFontFace&&!n.patternFill;a.save(),n.textMatrix&&a.transform(...n.textMatrix),a.translate(n.x,n.y+n.textRise),l>0?a.scale(u,-1):a.scale(u,1);let _,v,y=n.textRenderingMode&j.FILL_STROKE_MASK,b=y===j.FILL||y===j.FILL_STROKE,x=y===j.STROKE||y===j.FILL_STROKE;if(b&&n.patternFill){a.save();let t=n.fillColor.getPattern(a,this,Xe(a),Y.FILL,e);_=U(a),a.restore(),a.fillStyle=t}if(x&&n.patternStroke){a.save();let t=n.strokeColor.getPattern(a,this,Xe(a),Y.STROKE,e);v=U(a),a.restore(),a.strokeStyle=t}let S=n.lineWidth,C=n.textMatrixScale;if(C===0||S===0?x&&(S=this.getSinglePixelWidth()):S/=C,o!==1&&(a.scale(o,o),S/=o),a.lineWidth=S,r.isInvalidPDFjsFont){let r=[],i=0;for(let e of t)r.push(e.unicode),i+=e.width;let o=r.join(``);if(a.fillText(o,0,0),this.dependencyTracker!==null){let t=a.measureText(o);this.dependencyTracker.recordBBox(e,this.ctx,-t.actualBoundingBoxLeft,t.actualBoundingBoxRight,-t.actualBoundingBoxAscent,t.actualBoundingBoxDescent).recordShowTextOperation(e)}n.x+=i*h*u,a.restore(),this.compose();return}let w=0,T;for(T=0;T<d;++T){let n=t[T];if(typeof n==`number`){w+=p*n*i/1e3;continue}let u=!1,d=(n.isSpace?c:0)+s,y=n.fontChar,b=n.accent,x,S,C=n.width;if(f){let e=n.vmetric||m,t=-(n.vmetric?e[1]:C*.5)*h,r=e[2]*h;C=e?-e[0]:C,x=t/o,S=(w+r)/o}else x=w/o,S=0;let E;if(r.remeasure&&C>0){E=a.measureText(y);let e=E.width*1e3/i*o;if(C<e&&this.isFontSubpixelAAEnabled){let t=C/e;u=!0,a.save(),a.scale(t,1),x/=t}else C!==e&&(x+=(C-e)/2e3*i/o)}if(this.contentVisible&&(n.isInFont||r.missingFile)){if(g&&!b)a.fillText(y,x,S),this.dependencyTracker?.recordCharacterBBox(e,a,E?{bbox:null}:r,i/o,x,S,()=>E??a.measureText(y));else if(this.paintChar(e,y,x,S,_,v),b){let t=x+i*b.offset.x/o,n=S-i*b.offset.y/o;this.paintChar(e,b.fontChar,t,n,_,v)}}let D=f?C*h-d*l:C*h+d*l;w+=D,u&&a.restore()}f?n.y-=w:n.x+=w*u,a.restore(),this.compose(),this.dependencyTracker?.recordShowTextOperation(e)}showType3Text(e,t){let n=this.ctx,r=this.current,i=r.font,a=r.fontSize,o=r.fontDirection,s=i.vertical?1:-1,c=r.charSpacing,l=r.wordSpacing,u=r.textHScale*o,d=r.fontMatrix||S,f=t.length,p=r.textRenderingMode===j.INVISIBLE,m,h,g,_;if(p||a===0)return;this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,n.save(),r.textMatrix&&n.transform(...r.textMatrix),n.translate(r.x,r.y+r.textRise),n.scale(u,o);let v=this.dependencyTracker;for(this.dependencyTracker=v?new yn(v,e):null,m=0;m<f;++m){if(h=t[m],typeof h==`number`){_=s*h*a/1e3,this.ctx.translate(_,0),r.x+=_*u;continue}let e=(h.isSpace?l:0)+c,o=i.charProcOperatorList[h.operatorListId];o?this.contentVisible&&(this.save(),n.scale(a,a),n.transform(...d),this.executeOperatorList(o),this.restore()):P(`Type3 character "${h.operatorListId}" is not available.`);let f=[h.width,0];z.applyTransform(f,d),g=f[0]*a+e,n.translate(g,0),r.x+=g*u}n.restore(),v&&(this.dependencyTracker=v)}setCharWidth(e,t,n){}setCharWidthAndBounds(e,t,n,r,i,a,o){let s=new Path2D;s.rect(r,i,a-r,o-i),this.ctx.clip(s),this.dependencyTracker?.recordBBox(e,this.ctx,r,a,i,o).recordClipBox(e,this.ctx,r,a,i,o),this.endPath(e)}getColorN_Pattern(t,n){let r;if(n[0]===`TilingPattern`){let t=this.baseTransform||U(this.ctx);r=new kn(n,this.ctx,{createCanvasGraphics:(t,n)=>new e(t,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack},void 0,void 0,this.dependencyTracker?new yn(this.dependencyTracker,n,!0):null)},t)}else r=this._getPattern(t,n[1],n[2]);return r}setStrokeColorN(e,...t){this.dependencyTracker?.recordSimpleData(`strokeColor`,e),this.current.strokeColor=this.getColorN_Pattern(e,t),this.current.patternStroke=!0}setFillColorN(e,...t){this.dependencyTracker?.recordSimpleData(`fillColor`,e),this.current.fillColor=this.getColorN_Pattern(e,t),this.current.patternFill=!0}setStrokeRGBColor(e,t){this.dependencyTracker?.recordSimpleData(`strokeColor`,e),this.ctx.strokeStyle=this.current.strokeColor=t,this.current.patternStroke=!1}setStrokeTransparent(e){this.dependencyTracker?.recordSimpleData(`strokeColor`,e),this.ctx.strokeStyle=this.current.strokeColor=`transparent`,this.current.patternStroke=!1}setFillRGBColor(e,t){this.dependencyTracker?.recordSimpleData(`fillColor`,e),this.ctx.fillStyle=this.current.fillColor=t,this.current.patternFill=!1}setFillTransparent(e){this.dependencyTracker?.recordSimpleData(`fillColor`,e),this.ctx.fillStyle=this.current.fillColor=`transparent`,this.current.patternFill=!1}_getPattern(e,t,n=null){let r;return this.cachedPatterns.has(t)?r=this.cachedPatterns.get(t):(r=Dn(this.getObject(e,t)),this.cachedPatterns.set(t,r)),n&&(r.matrix=n),r}shadingFill(e,t){if(!this.contentVisible)return;let n=this.ctx;this.save(e),n.fillStyle=this._getPattern(e,t).getPattern(n,this,Xe(n),Y.SHADING,e);let r=Xe(n);if(r){let{width:e,height:t}=n.canvas,i=In.slice();z.axialAlignedBoundingBox([0,0,e,t],r,i);let[a,o,s,c]=i;this.ctx.fillRect(a,o,s-a,c-o)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.dependencyTracker?.resetBBox(e).recordFullPageBBox(e).recordDependencies(e,J.transform).recordDependencies(e,J.fill).recordOperation(e),this.compose(this.current.getClippedPathBoundingBox()),this.restore(e)}beginInlineImage(){F(`Should not call beginInlineImage`)}beginImageData(){F(`Should not call beginImageData`)}paintFormXObjectBegin(e,t,n){if(this.contentVisible&&(this.save(e),this.baseTransformStack.push(this.baseTransform),t&&this.transform(e,...t),this.baseTransform=U(this.ctx),n)){z.axialAlignedBoundingBox(n,this.baseTransform,this.current.minMax);let[t,r,i,a]=n,o=new Path2D;o.rect(t,r,i-t,a-r),this.ctx.clip(o),this.dependencyTracker?.recordClipBox(e,this.ctx,t,i,r,a),this.endPath(e)}}paintFormXObjectEnd(e){this.contentVisible&&(this.restore(e),this.baseTransform=this.baseTransformStack.pop())}beginGroup(e,t){if(!this.contentVisible)return;this.save(e),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);let n=this.ctx;t.isolated||ce(`TODO: Support non-isolated groups.`),t.knockout&&P(`Knockout groups not supported.`);let r=U(n);if(t.matrix&&n.transform(...t.matrix),!t.bbox)throw Error(`Bounding box is required.`);let i=In.slice();z.axialAlignedBoundingBox(t.bbox,U(n),i);let a=[0,0,n.canvas.width,n.canvas.height];i=z.intersect(i,a)||[0,0,0,0];let o=Math.floor(i[0]),s=Math.floor(i[1]),c=Math.max(Math.ceil(i[2])-o,1),l=Math.max(Math.ceil(i[3])-s,1);this.current.startNewPathAndClipBox([0,0,c,l]);let u=`groupAt`+this.groupLevel;t.smask&&(u+=`_smask_`+ this.smaskCounter++%2);let d=this.cachedCanvases.getCanvas(u,c,l),f=d.context;f.translate(-o,-s),f.transform(...r);let p=new Path2D,[m,h,g,_]=t.bbox;if(p.rect(m,h,g-m,_-h),t.matrix){let e=new Path2D;e.addPath(p,new DOMMatrix(t.matrix)),p=e}f.clip(p),t.smask&&this.smaskStack.push({canvas:d.canvas,context:f,offsetX:o,offsetY:s,subtype:t.smask.subtype,backdrop:t.smask.backdrop,transferMap:t.smask.transferMap||null,startTransformInverse:null}),(!t.smask||this.dependencyTracker)&&(n.setTransform(1,0,0,1,0,0),n.translate(o,s),n.save()),Un(n,f),this.ctx=f,this.dependencyTracker?.inheritSimpleDataAsFutureForcedDependencies([`fillAlpha`,`strokeAlpha`,`globalCompositeOperation`]).pushBaseTransform(n),this.setGState(e,[[`BM`,`source-over`],[`ca`,1],[`CA`,1]]),this.groupStack.push(n),this.groupLevel++}endGroup(e,t){if(!this.contentVisible)return;this.groupLevel--;let n=this.ctx;if(this.ctx=this.groupStack.pop(),this.ctx.imageSmoothingEnabled=!1,this.dependencyTracker?.popBaseTransform(),t.smask)this.tempSMask=this.smaskStack.pop(),this.restore(e),this.dependencyTracker&&this.ctx.restore();else{this.ctx.restore();let t=U(this.ctx);this.restore(e),this.ctx.save(),this.ctx.setTransform(...t);let r=In.slice();z.axialAlignedBoundingBox([0,0,n.canvas.width,n.canvas.height],t,r),this.ctx.drawImage(n.canvas,0,0),this.ctx.restore(),this.compose(r)}}beginAnnotation(e,t,n,r,i,a){if(this.#restoreInitialState(),Wn(this.ctx),this.ctx.save(),this.save(e),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),n){let i=n[2]-n[0],o=n[3]-n[1];if(a&&this.annotationCanvasMap){r=r.slice(),r[4]-=n[0],r[5]-=n[1],n=n.slice(),n[0]=n[1]=0,n[2]=i,n[3]=o,z.singularValueDecompose2dScale(U(this.ctx),Z);let{viewportScale:e}=this,a=Math.ceil(i*this.outputScaleX*e),s=Math.ceil(o*this.outputScaleY*e);this.annotationCanvas=this.canvasFactory.create(a,s);let{canvas:c,context:l}=this.annotationCanvas;this.annotationCanvasMap.set(t,c),this.annotationCanvas.savedCtx=this.ctx,this.ctx=l,this.ctx.save(),this.ctx.setTransform(Z[0],0,0,-Z[1],0,o*Z[1]),Wn(this.ctx)}else{Wn(this.ctx),this.endPath(e);let t=new Path2D;t.rect(n[0],n[1],i,o),this.ctx.clip(t)}}this.current=new Bn(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(e,...r),this.transform(e,...i)}endAnnotation(e){this.annotationCanvas&&(this.ctx.restore(),this.#drawFilter(),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(e,t){if(!this.contentVisible)return;let n=t.count;t=this.getObject(e,t.data,t),t.count=n;let r=this.ctx,i=this._createMaskCanvas(e,t),a=i.canvas;r.save(),r.setTransform(1,0,0,1,0,0),r.drawImage(a,i.offsetX,i.offsetY),this.dependencyTracker?.resetBBox(e).recordBBox(e,this.ctx,i.offsetX,i.offsetX+a.width,i.offsetY,i.offsetY+a.height).recordOperation(e),r.restore(),this.compose()}paintImageMaskXObjectRepeat(e,t,n,r=0,i=0,a,o){if(!this.contentVisible)return;t=this.getObject(e,t.data,t);let s=this.ctx;s.save();let c=U(s);s.transform(n,r,i,a,0,0);let l=this._createMaskCanvas(e,t);s.setTransform(1,0,0,1,l.offsetX-c[4],l.offsetY-c[5]),this.dependencyTracker?.resetBBox(e);for(let t=0,u=o.length;t<u;t+=2){let u=z.transform(c,[n,r,i,a,o[t],o[t+1]]);s.drawImage(l.canvas,u[4],u[5]),this.dependencyTracker?.recordBBox(e,this.ctx,u[4],u[4]+l.canvas.width,u[5],u[5]+l.canvas.height)}s.restore(),this.compose(),this.dependencyTracker?.recordOperation(e)}paintImageMaskXObjectGroup(e,t){if(!this.contentVisible)return;let n=this.ctx,r=this.current.fillColor,i=this.current.patternFill;this.dependencyTracker?.resetBBox(e).recordDependencies(e,J.transformAndFill);for(let a of t){let{data:t,width:o,height:s,transform:c}=a,l=this.cachedCanvases.getCanvas(`maskCanvas`,o,s),u=l.context;u.save();let d=this.getObject(e,t,a);Hn(u,d),u.globalCompositeOperation=`source-in`,u.fillStyle=i?r.getPattern(u,this,Xe(n),Y.FILL,e):r,u.fillRect(0,0,o,s),u.restore(),n.save(),n.transform(...c),n.scale(1,-1),zn(n,l.canvas,0,0,o,s,0,-1,1,1),this.dependencyTracker?.recordBBox(e,n,0,o,0,s),n.restore()}this.compose(),this.dependencyTracker?.recordOperation(e)}paintImageXObject(e,t){if(!this.contentVisible)return;let n=this.getObject(e,t);if(!n){P(`Dependent image isn't ready yet`);return}this.paintInlineImageXObject(e,n)}paintImageXObjectRepeat(e,t,n,r,i){if(!this.contentVisible)return;let a=this.getObject(e,t);if(!a){P(`Dependent image isn't ready yet`);return}let o=a.width,s=a.height,c=[];for(let e=0,t=i.length;e<t;e+=2)c.push({transform:[n,0,0,r,i[e],i[e+1]],x:0,y:0,w:o,h:s});this.paintInlineImageXObjectGroup(e,a,c)}applyTransferMapsToCanvas(e){return this.current.transferMaps!==`none`&&(e.filter=this.current.transferMaps,e.drawImage(e.canvas,0,0),e.filter=`none`),e.canvas}applyTransferMapsToBitmap(e){if(this.current.transferMaps===`none`)return e.bitmap;let{bitmap:t,width:n,height:r}=e,i=this.cachedCanvases.getCanvas(`inlineImage`,n,r),a=i.context;return a.filter=this.current.transferMaps,a.drawImage(t,0,0),a.filter=`none`,i.canvas}paintInlineImageXObject(e,t){if(!this.contentVisible)return;let n=t.width,r=t.height,i=this.ctx;this.save(e);let{filter:a}=i;a!==`none`&&a!==``&&(i.filter=`none`),i.scale(1/n,-1/r);let o;if(t.bitmap)o=this.applyTransferMapsToBitmap(t);else if(typeof HTMLElement==`function`&&t instanceof HTMLElement||!t.data)o=t;else{let e=this.cachedCanvases.getCanvas(`inlineImage`,n,r).context;Vn(e,t),o=this.applyTransferMapsToCanvas(e)}let s=this._scaleImage(o,Xe(i));i.imageSmoothingEnabled=Gn(U(i),t.interpolate),this.dependencyTracker?.resetBBox(e).recordBBox(e,i,0,n,-r,0).recordDependencies(e,J.imageXObject).recordOperation(e),zn(i,s.img,0,0,s.paintWidth,s.paintHeight,0,-r,n,r),this.compose(),this.restore(e)}paintInlineImageXObjectGroup(e,t,n){if(!this.contentVisible)return;let r=this.ctx,i;if(t.bitmap)i=t.bitmap;else{let e=t.width,n=t.height,r=this.cachedCanvases.getCanvas(`inlineImage`,e,n).context;Vn(r,t),i=this.applyTransferMapsToCanvas(r)}this.dependencyTracker?.resetBBox(e);for(let t of n)r.save(),r.transform(...t.transform),r.scale(1,-1),zn(r,i,t.x,t.y,t.w,t.h,0,-1,1,1),this.dependencyTracker?.recordBBox(e,r,0,1,-1,0),r.restore();this.dependencyTracker?.recordOperation(e),this.compose()}paintSolidColorImageMask(e){this.contentVisible&&(this.dependencyTracker?.resetBBox(e).recordBBox(e,this.ctx,0,1,0,1).recordDependencies(e,J.fill).recordOperation(e),this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(e,t){}markPointProps(e,t,n){}beginMarkedContent(e,t){this.dependencyTracker?.beginMarkedContent(e),this.markedContentStack.push({visible:!0})}beginMarkedContentProps(e,t,n){this.dependencyTracker?.beginMarkedContent(e),t===`OC`?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(n)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(e){this.dependencyTracker?.endMarkedContent(e),this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(e){}endCompat(e){}consumePath(e,t,n){let r=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(n);let i=this.ctx;this.pendingClip?(r||(this.pendingClip===Yn?i.clip(t,`evenodd`):i.clip(t)),this.pendingClip=null,this.dependencyTracker?.bboxToClipBoxDropOperation(e).recordFutureForcedDependency(`clipPath`,e)):this.dependencyTracker?.recordOperation(e),this.current.startNewPathAndClipBox(this.current.clipBox)}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){let e=U(this.ctx);if(e[1]===0&&e[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(e[0]),Math.abs(e[3]));else{let t=Math.abs(e[0]*e[3]-e[2]*e[1]),n=Math.hypot(e[0],e[2]),r=Math.hypot(e[1],e[3]);this._cachedGetSinglePixelWidth=Math.max(n,r)/t}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){let{lineWidth:e}=this.current,{a:t,b:n,c:r,d:i}=this.ctx.getTransform(),a,o;if(n===0&&r===0){let n=Math.abs(t),r=Math.abs(i);if(n===r)if(e===0)a=o=1/n;else{let t=n*e;a=o=t<1?1/t:1}else if(e===0)a=1/n,o=1/r;else{let t=n*e,i=r*e;a=t<1?1/t:1,o=i<1?1/i:1}}else{let s=Math.abs(t*i-n*r),c=Math.hypot(t,n),l=Math.hypot(r,i);if(e===0)a=l/s,o=c/s;else{let t=e*s;a=l>t?l/t:1,o=c>t?c/t:1}}this._cachedScaleForStroking[0]=a,this._cachedScaleForStroking[1]=o}return this._cachedScaleForStroking}rescaleAndStroke(e,t){let{ctx:n,current:{lineWidth:r}}=this,[i,a]=this.getScaleForStroking();if(i===a){n.lineWidth=(r||1)*i,n.stroke(e);return}let o=n.getLineDash();t&&n.save(),n.scale(i,a),Fn.a=1/i,Fn.d=1/a;let s=new Path2D;if(s.addPath(e,Fn),o.length>0){let e=Math.max(i,a);n.setLineDash(o.map(t=>t/e)),n.lineDashOffset/=e}n.lineWidth=r||1,n.stroke(s),t&&n.restore()}isContentVisible(){for(let e=this.markedContentStack.length-1;e>=0;e--)if(!this.markedContentStack[e].visible)return!1;return!0}};for(let e in ne)Xn.prototype[e]!==void 0&&(Xn.prototype[ne[e]]=Xn.prototype[e]);var Zn=class{static#port=null;static#src=``;static get workerPort(){return this.#port}static set workerPort(e){if(!(typeof Worker<`u`&&e instanceof Worker)&&e!==null)throw Error("Invalid `workerPort` type.");this.#port=e}static get workerSrc(){return this.#src}static set workerSrc(e){if(typeof e!=`string`)throw Error("Invalid `workerSrc` type.");this.#src=e}},Qn=class{#map;#data;constructor({parsedData:e,rawData:t}){this.#map=e,this.#data=t}getRaw(){return this.#data}get(e){return this.#map.get(e)??null}[Symbol.iterator](){return this.#map.entries()}},$n=Symbol(`INTERNAL`),er=class{#isDisplay=!1;#isPrint=!1;#userSet=!1;#visible=!0;constructor(e,{name:t,intent:n,usage:r,rbGroups:i}){this.#isDisplay=!!(e&w.DISPLAY),this.#isPrint=!!(e&w.PRINT),this.name=t,this.intent=n,this.usage=r,this.rbGroups=i}get visible(){if(this.#userSet)return this.#visible;if(!this.#visible)return!1;let{print:e,view:t}=this.usage;return this.#isDisplay?t?.viewState!==`OFF`:this.#isPrint?e?.printState!==`OFF`:!0}_setVisible(e,t,n=!1){e!==$n&&F("Internal method `_setVisible` called."),this.#userSet=n,this.#visible=t}},tr=class{#cachedGetHash=null;#groups=new Map;#initialHash=null;#order=null;constructor(e,t=w.DISPLAY){if(this.renderingIntent=t,this.name=null,this.creator=null,e!==null){this.name=e.name,this.creator=e.creator,this.#order=e.order;for(let n of e.groups)this.#groups.set(n.id,new er(t,n));if(e.baseState===`OFF`)for(let e of this.#groups.values())e._setVisible($n,!1);for(let t of e.on)this.#groups.get(t)._setVisible($n,!0);for(let t of e.off)this.#groups.get(t)._setVisible($n,!1);this.#initialHash=this.getHash()}}#evaluateVisibilityExpression(e){let t=e.length;if(t<2)return!0;let n=e[0];for(let r=1;r<t;r++){let t=e[r],i;if(Array.isArray(t))i=this.#evaluateVisibilityExpression(t);else if(this.#groups.has(t))i=this.#groups.get(t).visible;else return P(`Optional content group not found: ${t}`),!0;switch(n){case`And`:if(!i)return!1;break;case`Or`:if(i)return!0;break;case`Not`:return!i;default:return!0}}return n===`And`}isVisible(e){if(this.#groups.size===0)return!0;if(!e)return ce(`Optional content group not defined.`),!0;if(e.type===`OCG`)return this.#groups.has(e.id)?this.#groups.get(e.id).visible:(P(`Optional content group not found: ${e.id}`),!0);if(e.type===`OCMD`){if(e.expression)return this.#evaluateVisibilityExpression(e.expression);if(!e.policy||e.policy===`AnyOn`){for(let t of e.ids){if(!this.#groups.has(t))return P(`Optional content group not found: ${t}`),!0;if(this.#groups.get(t).visible)return!0}return!1}else if(e.policy===`AllOn`){for(let t of e.ids){if(!this.#groups.has(t))return P(`Optional content group not found: ${t}`),!0;if(!this.#groups.get(t).visible)return!1}return!0}else if(e.policy===`AnyOff`){for(let t of e.ids){if(!this.#groups.has(t))return P(`Optional content group not found: ${t}`),!0;if(!this.#groups.get(t).visible)return!0}return!1}else if(e.policy===`AllOff`){for(let t of e.ids){if(!this.#groups.has(t))return P(`Optional content group not found: ${t}`),!0;if(this.#groups.get(t).visible)return!1}return!0}return P(`Unknown optional content policy ${e.policy}.`),!0}return P(`Unknown group type ${e.type}.`),!0}setVisibility(e,t=!0,n=!0){let r=this.#groups.get(e);if(!r){P(`Optional content group not found: ${e}`);return}if(n&&t&&r.rbGroups.length)for(let t of r.rbGroups)for(let n of t)n!==e&&this.#groups.get(n)?._setVisible($n,!1,!0);r._setVisible($n,!!t,!0),this.#cachedGetHash=null}setOCGState({state:e,preserveRB:t}){let n;for(let r of e){switch(r){case`ON`:case`OFF`:case`Toggle`:n=r;continue}let e=this.#groups.get(r);if(e)switch(n){case`ON`:this.setVisibility(r,!0,t);break;case`OFF`:this.setVisibility(r,!1,t);break;case`Toggle`:this.setVisibility(r,!e.visible,t);break}}this.#cachedGetHash=null}get hasInitialVisibility(){return this.#initialHash===null||this.getHash()===this.#initialHash}getOrder(){return this.#groups.size?this.#order?this.#order.slice():[...this.#groups.keys()]:null}getGroup(e){return this.#groups.get(e)||null}getHash(){if(this.#cachedGetHash!==null)return this.#cachedGetHash;let e=new Ot;for(let[t,n]of this.#groups)e.update(`${t}:${n.visible}`);return this.#cachedGetHash=e.hexdigest()}[Symbol.iterator](){return this.#groups.entries()}},nr=class{#PDFStreamReader=null;#PDFStreamRangeReader=null;_fullReader=null;_rangeReaders=new Set;_source=null;constructor(e,t,n){this._source=e,this.#PDFStreamReader=t,this.#PDFStreamRangeReader=n}get _progressiveDataLength(){return this._fullReader?._loaded??0}getFullReader(){return I(!this._fullReader,`BasePDFStream.getFullReader can only be called once.`),this._fullReader=new this.#PDFStreamReader(this)}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;let n=new this.#PDFStreamRangeReader(this,e,t);return this._rangeReaders.add(n),n}cancelAllRequests(e){this._fullReader?.cancel(e);for(let t of new Set(this._rangeReaders))t.cancel(e)}},rr=class{onProgress=null;_contentLength=0;_filename=null;_headersCapability=Promise.withResolvers();_isRangeSupported=!1;_isStreamingSupported=!1;_loaded=0;_stream=null;constructor(e){this._stream=e}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){F("Abstract method `read` called")}cancel(e){F("Abstract method `cancel` called")}},ir=class{_stream=null;constructor(e,t,n){this._stream=e}async read(){F("Abstract method `read` called")}cancel(e){F("Abstract method `cancel` called")}};function ar(e){return e instanceof Uint8Array&&e.byteLength===e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer}var or=class extends nr{_progressiveDone=!1;_queuedChunks=[];constructor(e){super(e,sr,cr);let{pdfDataRangeTransport:t}=e,{initialData:n,progressiveDone:r}=t;if(n?.length>0){let e=ar(n);this._queuedChunks.push(e)}this._progressiveDone=r,t.addRangeListener((e,t)=>{this.#onReceiveData(e,t)}),t.addProgressListener((e,t)=>{t!==void 0&&this._fullReader?.onProgress?.({loaded:e,total:t})}),t.addProgressiveReadListener(e=>{this.#onReceiveData(void 0,e)}),t.addProgressiveDoneListener(()=>{this._fullReader?.progressiveDone(),this._progressiveDone=!0}),t.transportReady()}#onReceiveData(e,t){let n=ar(t);if(e===void 0)this._fullReader?this._fullReader._enqueue(n):this._queuedChunks.push(n);else{let t=this._rangeReaders.keys().find(t=>t._begin===e);I(t,"#onReceiveData - no `PDFDataTransportStreamRangeReader` instance found."),t._enqueue(n)}}getFullReader(){let e=super.getFullReader();return this._queuedChunks=null,e}getRangeReader(e,t){let n=super.getRangeReader(e,t);return n&&(n.onDone=()=>this._rangeReaders.delete(n),this._source.pdfDataRangeTransport.requestDataRange(e,t)),n}cancelAllRequests(e){super.cancelAllRequests(e),this._source.pdfDataRangeTransport.abort()}},sr=class extends rr{_done=!1;_queuedChunks=null;_requests=[];constructor(e){super(e);let{pdfDataRangeTransport:t,disableRange:n,disableStream:r}=e._source,{length:i,contentDispositionFilename:a}=t;this._queuedChunks=e._queuedChunks||[];for(let e of this._queuedChunks)this._loaded+=e.byteLength;this._done=e._progressiveDone,this._contentLength=i,this._isStreamingSupported=!r,this._isRangeSupported=!n,Be(a)&&(this._filename=a),this._headersCapability.resolve()}_enqueue(e){this._done||(this._requests.length>0?this._requests.shift().resolve({value:e,done:!1}):this._queuedChunks.push(e),this._loaded+=e.byteLength)}async read(){if(this._queuedChunks.length>0)return{value:this._queuedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||=!0}},cr=class extends ir{onDone=null;_begin=-1;_done=!1;_queuedChunk=null;_requests=[];constructor(e,t,n){super(e,t,n),this._begin=t}_enqueue(e){if(!this._done){if(this._requests.length===0)this._queuedChunk=e;else{this._requests.shift().resolve({value:e,done:!1});for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this.onDone?.()}}async read(){if(this._queuedChunk){let e=this._queuedChunk;return this._queuedChunk=null,{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this.onDone?.()}};function lr(e){let t=!0,n=r(`filename\\*`,`i`).exec(e);if(n){n=n[1];let e=s(n);return e=unescape(e),e=c(e),e=l(e),a(e)}if(n=o(e),n){let e=l(n);return a(e)}if(n=r(`filename`,`i`).exec(e),n){n=n[1];let e=s(n);return e=l(e),a(e)}function r(e,t){return RegExp(`(?:^|;)\\s*`+e+`\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)`,t)}function i(e,n){if(e){if(!/^[\x00-\xFF]+$/.test(n))return n;try{let r=new TextDecoder(e,{fatal:!0}),i=be(n);n=r.decode(i),t=!1}catch{}}return n}function a(e){return t&&/[\x80-\xff]/.test(e)&&(e=i(`utf-8`,e),t&&(e=i(`iso-8859-1`,e))),e}function o(e){let t=[],n,i=r(`filename\\*((?!0\\d)\\d+)(\\*?)`,`ig`);for(;(n=i.exec(e))!==null;){let[,e,r,i]=n;if(e=parseInt(e,10),e in t){if(e===0)break;continue}t[e]=[r,i]}let a=[];for(let e=0;e<t.length&&e in t;++e){let[n,r]=t[e];r=s(r),n&&(r=unescape(r),e===0&&(r=c(r))),a.push(r)}return a.join(``)}function s(e){if(e.startsWith(`"`)){let t=e.slice(1).split(`\\"`);for(let e=0;e<t.length;++e){let n=t[e].indexOf(`"`);n!==-1&&(t[e]=t[e].slice(0,n),t.length=e+1),t[e]=t[e].replaceAll(/\\(.)/g,`$1`)}e=t.join(`"`)}return e}function c(e){let t=e.indexOf(`'`);if(t===-1)return e;let n=e.slice(0,t),r=e.slice(t+1).replace(/^[^']*'/,``);return i(n,r)}function l(e){return!e.startsWith(`=?`)||/[\x00-\x19\x80-\xff]/.test(e)?e:e.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(e,t,n,r){if(n===`q`||n===`Q`)return r=r.replaceAll(`_`,` `),r=r.replaceAll(/=([0-9a-fA-F]{2})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}),i(t,r);try{r=atob(r)}catch{}return i(t,r)})}return``}function ur(e,t){let n=new Headers;if(!e||!t||typeof t!=`object`)return n;for(let e in t){let r=t[e];r!==void 0&&n.append(e,r)}return n}function dr(e){return URL.parse(e)?.origin??null}function fr({responseHeaders:e,isHttp:t,rangeChunkSize:n,disableRange:r}){let i={allowRangeRequests:!1,suggestedLength:void 0},a=parseInt(e.get(`Content-Length`),10);return!Number.isInteger(a)||(i.suggestedLength=a,a<=2*n)||r||!t||e.get(`Accept-Ranges`)!==`bytes`||(e.get(`Content-Encoding`)||`identity`)!==`identity`||(i.allowRangeRequests=!0),i}function pr(e){let t=e.get(`Content-Disposition`);if(t){let e=lr(t);if(e.includes(`%`))try{e=decodeURIComponent(e)}catch{}if(Be(e))return e}return null}function mr(e,t){return new ge(`Unexpected server response (${e}) while retrieving PDF "${t}".`,e,e===404||e===0&&t.startsWith(`file:`))}function hr(e,t){if(e!==t)throw Error(`Expected range response-origin "${e}" to match "${t}".`)}function gr(e,t,n,r){return fetch(e,{method:`GET`,headers:t,signal:r.signal,mode:`cors`,credentials:n?`include`:`same-origin`,redirect:`follow`})}function _r(e,t){if(e!==200&&e!==206)throw mr(e,t)}function vr(e){return e instanceof Uint8Array?e.buffer:e instanceof ArrayBuffer?e:(P(`getArrayBuffer - unexpected data format: ${e}`),new Uint8Array(e).buffer)}var yr=class extends nr{_responseOrigin=null;constructor(e){super(e,br,xr),this.isHttp=/^https?:/i.test(e.url),this.headers=ur(this.isHttp,e.httpHeaders)}},br=class extends rr{_abortController=new AbortController;_reader=null;constructor(e){super(e);let{disableRange:t,disableStream:n,length:r,rangeChunkSize:i,url:a,withCredentials:o}=e._source;this._contentLength=r,this._isStreamingSupported=!n,this._isRangeSupported=!t;let s=new Headers(e.headers);gr(a,s,o,this._abortController).then(n=>{e._responseOrigin=dr(n.url),_r(n.status,a),this._reader=n.body.getReader();let r=n.headers,{allowRangeRequests:o,suggestedLength:s}=fr({responseHeaders:r,isHttp:e.isHttp,rangeChunkSize:i,disableRange:t});this._isRangeSupported=o,this._contentLength=s||this._contentLength,this._filename=pr(r),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new ve(`Streaming is disabled.`)),this._headersCapability.resolve()}).catch(this._headersCapability.reject)}async read(){await this._headersCapability.promise;let{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:vr(e),done:!1})}cancel(e){this._reader?.cancel(e),this._abortController.abort()}},xr=class extends ir{_abortController=new AbortController;_readCapability=Promise.withResolvers();_reader=null;constructor(e,t,n){super(e,t,n);let{url:r,withCredentials:i}=e._source,a=new Headers(e.headers);a.append(`Range`,`bytes=${t}-${n-1}`),gr(r,a,i,this._abortController).then(t=>{let n=dr(t.url);hr(n,e._responseOrigin),_r(t.status,r),this._reader=t.body.getReader(),this._readCapability.resolve()}).catch(this._readCapability.reject)}async read(){await this._readCapability.promise;let{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:{value:vr(e),done:!1}}cancel(e){this._reader?.cancel(e),this._abortController.abort()}},Sr=200,Cr=206;function wr(e){return typeof e==`string`?be(e).buffer:e}var Tr=class extends nr{#pendingRequests=new WeakMap;_responseOrigin=null;constructor(e){super(e,Er,Dr),this.url=e.url,this.isHttp=/^https?:/i.test(this.url),this.headers=ur(this.isHttp,e.httpHeaders)}_request(e){let t=new XMLHttpRequest,n={validateStatus:null,onHeadersReceived:e.onHeadersReceived,onDone:e.onDone,onError:e.onError,onProgress:e.onProgress};this.#pendingRequests.set(t,n),t.open(`GET`,this.url),t.withCredentials=this._source.withCredentials;for(let[e,n]of this.headers)t.setRequestHeader(e,n);return this.isHttp&&`begin`in e&&`end`in e?(t.setRequestHeader(`Range`,`bytes=${e.begin}-${e.end-1}`),n.validateStatus=e=>e===Cr||e===Sr):n.validateStatus=e=>e===Sr,t.responseType=`arraybuffer`,I(e.onError,"Expected `onError` callback to be provided."),t.onerror=()=>e.onError(t.status),t.onreadystatechange=this.#onStateChange.bind(this,t),t.onprogress=this.#onProgress.bind(this,t),t.send(null),t}#onProgress(e,t){this.#pendingRequests.get(e)?.onProgress?.(t)}#onStateChange(e,t){let n=this.#pendingRequests.get(e);if(!n||(e.readyState>=2&&n.onHeadersReceived&&(n.onHeadersReceived(),delete n.onHeadersReceived),e.readyState!==4)||!this.#pendingRequests.has(e))return;if(this.#pendingRequests.delete(e),e.status===0&&this.isHttp){n.onError(e.status);return}let r=e.status||Sr;if(!n.validateStatus(r)){n.onError(e.status);return}let i=wr(e.response);if(r===Cr){let t=e.getResponseHeader(`Content-Range`);/bytes (\d+)-(\d+)\/(\d+)/.test(t)?n.onDone(i):(P(`Missing or invalid "Content-Range" header.`),n.onError(0))}else i?n.onDone(i):n.onError(e.status)}_abortRequest(e){this.#pendingRequests.has(e)&&(this.#pendingRequests.delete(e),e.abort())}getRangeReader(e,t){let n=super.getRangeReader(e,t);return n&&(n.onClosed=()=>this._rangeReaders.delete(n)),n}},Er=class extends rr{_cachedChunks=[];_done=!1;_requests=[];_storedError=null;constructor(e){super(e);let{length:t}=e._source;this._contentLength=t,this._fullRequestXhr=e._request({onHeadersReceived:this.#onHeadersReceived.bind(this),onDone:this.#onDone.bind(this),onError:this.#onError.bind(this),onProgress:this.#onProgress.bind(this)})}#onHeadersReceived(){let e=this._stream,{disableRange:t,rangeChunkSize:n}=e._source,r=this._fullRequestXhr;e._responseOrigin=dr(r.responseURL);let i=r.getAllResponseHeaders(),a=new Headers(i?i.trimStart().replace(/[^\S ]+$/,``).split(/[\r\n]+/).map(e=>{let[t,...n]=e.split(`: `);return[t,n.join(`: `)]}):[]),{allowRangeRequests:o,suggestedLength:s}=fr({responseHeaders:a,isHttp:e.isHttp,rangeChunkSize:n,disableRange:t});o&&(this._isRangeSupported=!0),this._contentLength=s||this._contentLength,this._filename=pr(a),this._isRangeSupported&&e._abortRequest(r),this._headersCapability.resolve()}#onDone(e){if(this._requests.length>0?this._requests.shift().resolve({value:e,done:!1}):this._cachedChunks.push(e),this._done=!0,!(this._cachedChunks.length>0)){for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}}#onError(e){this._storedError=mr(e,this._stream.url),this._headersCapability.reject(this._storedError);for(let e of this._requests)e.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}#onProgress(e){this.onProgress?.({loaded:e.loaded,total:e.lengthComputable?e.total:this._contentLength})}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0)return{value:this._cachedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0,this._headersCapability.reject(e);for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._abortRequest(this._fullRequestXhr),this._fullRequestXhr=null}},Dr=class extends ir{onClosed=null;_done=!1;_queuedChunk=null;_requests=[];_storedError=null;constructor(e,t,n){super(e,t,n),this._requestXhr=e._request({begin:t,end:n,onHeadersReceived:this.#onHeadersReceived.bind(this),onDone:this.#onDone.bind(this),onError:this.#onError.bind(this),onProgress:null})}#onHeadersReceived(){let e=dr(this._requestXhr?.responseURL);try{hr(e,this._stream._responseOrigin)}catch(e){this._storedError=e,this.#onError(0)}}#onDone(e){this._requests.length>0?this._requests.shift().resolve({value:e,done:!1}):this._queuedChunk=e,this._done=!0;for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this.onClosed?.()}#onError(e){this._storedError??=mr(e,this._stream.url);for(let e of this._requests)e.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){let e=this._queuedChunk;return this._queuedChunk=null,{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};let e=Promise.withResolvers();return this._requests.push(e),e.promise}cancel(e){this._done=!0;for(let e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._abortRequest(this._requestXhr),this.onClosed?.()}},Or=/^[a-z][a-z0-9\-+.]+:/i;function kr(e){if(Or.test(e))return new URL(e);let t=process.getBuiltinModule(`url`);return new URL(t.pathToFileURL(e))}function Ar(e){let{Readable:t}=process.getBuiltinModule(`stream`);return typeof t.toWeb==`function`?t.toWeb(e):process.getBuiltinModule(`module`).createRequire(import.meta.url)(`node-readable-to-web-readable-stream`).makeDefaultReadableStreamFromNodeReadable(e)}function jr(e){return e instanceof Uint8Array?e.buffer:e instanceof ArrayBuffer?e:(P(`getArrayBuffer - unexpected data format: ${e}`),new Uint8Array(e).buffer)}var Mr=class extends nr{constructor(e){super(e,Nr,Pr),this.url=kr(e.url),I(this.url.protocol===`file:`,`PDFNodeStream only supports file:// URLs.`)}},Nr=class extends rr{_reader=null;constructor(e){super(e);let{disableRange:t,disableStream:n,length:r,rangeChunkSize:i}=e._source;this._contentLength=r,this._isStreamingSupported=!n,this._isRangeSupported=!t;let a=e.url,o=process.getBuiltinModule(`fs`);o.promises.lstat(a).then(e=>{let t=o.createReadStream(a);this._reader=Ar(t).getReader();let{size:n}=e;n<=2*i&&(this._isRangeSupported=!1),this._contentLength=n,!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new ve(`Streaming is disabled.`)),this._headersCapability.resolve()}).catch(e=>{e.code===`ENOENT`&&(e=mr(0,a.href)),this._headersCapability.reject(e)})}async read(){await this._headersCapability.promise;let{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:(this._loaded+=e.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:jr(e),done:!1})}cancel(e){this._reader?.cancel(e)}},Pr=class extends ir{_readCapability=Promise.withResolvers();_reader=null;constructor(e,t,n){super(e,t,n);let r=e.url,i=process.getBuiltinModule(`fs`);try{let e=i.createReadStream(r,{start:t,end:n-1});this._reader=Ar(e).getReader(),this._readCapability.resolve()}catch(e){this._readCapability.reject(e)}}async read(){await this._readCapability.promise;let{value:e,done:t}=await this._reader.read();return t?{value:e,done:t}:{value:jr(e),done:!1}}cancel(e){this._reader?.cancel(e)}},Fr=Symbol(`INITIAL_DATA`),Ir=class{#objs=Object.create(null);#ensureObj(e){return this.#objs[e]||={...Promise.withResolvers(),data:Fr}}get(e,t=null){if(t){let n=this.#ensureObj(e);return n.promise.then(()=>t(n.data)),null}let n=this.#objs[e];if(!n||n.data===Fr)throw Error(`Requesting object that isn't resolved yet ${e}.`);return n.data}has(e){let t=this.#objs[e];return!!t&&t.data!==Fr}delete(e){let t=this.#objs[e];return!t||t.data===Fr?!1:(delete this.#objs[e],!0)}resolve(e,t=null){let n=this.#ensureObj(e);n.data=t,n.resolve()}clear(){for(let e in this.#objs){let{data:t}=this.#objs[e];t?.bitmap?.close()}this.#objs=Object.create(null)}*[Symbol.iterator](){for(let e in this.#objs){let{data:t}=this.#objs[e];t!==Fr&&(yield[e,t])}}},Lr=1e5,Rr=30,zr=class e{#capability=Promise.withResolvers();#container=null;#disableProcessItems=!1;#fontInspectorEnabled=!!globalThis.FontInspector?.enabled;#lang=null;#layoutTextParams=null;#pageHeight=0;#pageWidth=0;#reader=null;#rootContainer=null;#rotation=0;#scale=0;#styleCache=Object.create(null);#textContentItemsStr=[];#textContentSource=null;#textDivs=[];#textDivProperties=new WeakMap;#transform=null;static#ascentCache=new Map;static#canvasContexts=new Map;static#canvasCtxFonts=new WeakMap;static#minFontSize=null;static#pendingTextLayers=new Set;constructor({textContentSource:t,container:n,viewport:r}){if(t instanceof ReadableStream)this.#textContentSource=t;else if(typeof t==`object`)this.#textContentSource=new ReadableStream({start(e){e.enqueue(t),e.close()}});else throw Error(`No "textContentSource" parameter specified.`);this.#container=this.#rootContainer=n,this.#scale=r.scale*Qe.pixelRatio,this.#rotation=r.rotation,this.#layoutTextParams={div:null,properties:null,ctx:null};let{pageWidth:i,pageHeight:a,pageX:o,pageY:s}=r.rawDims;this.#transform=[1,0,0,-1,-o,s+a],this.#pageWidth=i,this.#pageHeight=a,e.#ensureMinFontSizeComputed(),n.style.setProperty(`--min-font-size`,e.#minFontSize),Ze(n,r),this.#capability.promise.finally(()=>{e.#pendingTextLayers.delete(this),this.#layoutTextParams=null,this.#styleCache=null}).catch(()=>{})}static get fontFamilyMap(){let{isWindows:e,isFirefox:t}=R.platform;return L(this,`fontFamilyMap`,new Map([[`sans-serif`,`${e&&t?`Calibri, `:``}sans-serif`],[`monospace`,`${e&&t?`Lucida Console, `:``}monospace`]]))}render(){let t=()=>{this.#reader.read().then(({value:e,done:n})=>{if(n){this.#capability.resolve();return}this.#lang??=e.lang,Object.assign(this.#styleCache,e.styles),this.#processItems(e.items),t()},this.#capability.reject)};return this.#reader=this.#textContentSource.getReader(),e.#pendingTextLayers.add(this),t(),this.#capability.promise}update({viewport:t,onBefore:n=null}){let r=t.scale*Qe.pixelRatio,i=t.rotation;if(i!==this.#rotation&&(n?.(),this.#rotation=i,Ze(this.#rootContainer,{rotation:i})),r!==this.#scale){n?.(),this.#scale=r;let t={div:null,properties:null,ctx:e.#getCtx(this.#lang)};for(let e of this.#textDivs)t.properties=this.#textDivProperties.get(e),t.div=e,this.#layout(t)}}cancel(){let e=new ve(`TextLayer task cancelled.`);this.#reader?.cancel(e).catch(()=>{}),this.#reader=null,this.#capability.reject(e)}get textDivs(){return this.#textDivs}get textContentItemsStr(){return this.#textContentItemsStr}#processItems(t){if(this.#disableProcessItems)return;this.#layoutTextParams.ctx??=e.#getCtx(this.#lang);let n=this.#textDivs,r=this.#textContentItemsStr;for(let e of t){if(n.length>Lr){P(`Ignoring additional textDivs for performance reasons.`),this.#disableProcessItems=!0;return}if(e.str===void 0){if(e.type===`beginMarkedContentProps`||e.type===`beginMarkedContent`){let t=this.#container;this.#container=document.createElement(`span`),this.#container.classList.add(`markedContent`),e.id&&this.#container.setAttribute(`id`,`${e.id}`),e.tag===`Artifact`&&(this.#container.ariaHidden=!0),t.append(this.#container)}else e.type===`endMarkedContent`&&(this.#container=this.#container.parentNode);continue}r.push(e.str),this.#appendText(e)}}#appendText(t){let n=document.createElement(`span`),r={angle:0,canvasWidth:0,hasText:t.str!==``,hasEOL:t.hasEOL,fontSize:0};this.#textDivs.push(n);let i=z.transform(this.#transform,t.transform),a=Math.atan2(i[1],i[0]),o=this.#styleCache[t.fontName];o.vertical&&(a+=Math.PI/2);let s=this.#fontInspectorEnabled&&o.fontSubstitution||o.fontFamily;s=e.fontFamilyMap.get(s)||s;let c=Math.hypot(i[2],i[3]),l=c*e.#getAscent(s,o,this.#lang),u,d;a===0?(u=i[4],d=i[5]-l):(u=i[4]+l*Math.sin(a),d=i[5]-l*Math.cos(a));let f=n.style;f.left=`${(100*u/this.#pageWidth).toFixed(2)}%`,f.top=`${(100*d/this.#pageHeight).toFixed(2)}%`,f.setProperty(`--font-height`,`${c.toFixed(2)}px`),f.fontFamily=s,r.fontSize=c,n.setAttribute(`role`,`presentation`),n.textContent=t.str,n.dir=t.dir,this.#fontInspectorEnabled&&(n.dataset.fontName=o.fontSubstitutionLoadedName||t.fontName),a!==0&&(r.angle=a*(180/Math.PI));let p=!1;if(t.str.length>1)p=!0;else if(t.str!==` `&&t.transform[0]!==t.transform[3]){let e=Math.abs(t.transform[0]),n=Math.abs(t.transform[3]);e!==n&&Math.max(e,n)/Math.min(e,n)>1.5&&(p=!0)}if(p&&(r.canvasWidth=o.vertical?t.height:t.width),this.#textDivProperties.set(n,r),this.#layoutTextParams.div=n,this.#layoutTextParams.properties=r,this.#layout(this.#layoutTextParams),r.hasText&&this.#container.append(n),r.hasEOL){let e=document.createElement(`br`);e.setAttribute(`role`,`presentation`),this.#container.append(e)}}#layout(t){let{div:n,properties:r,ctx:i}=t,{style:a}=n;if(r.canvasWidth!==0&&r.hasText){let{fontFamily:t}=a,{canvasWidth:o,fontSize:s}=r;e.#ensureCtxFont(i,s*this.#scale,t);let{width:c}=i.measureText(n.textContent);c>0&&a.setProperty(`--scale-x`,o*this.#scale/c)}r.angle!==0&&a.setProperty(`--rotate`,`${r.angle}deg`)}static cleanup(){if(!(this.#pendingTextLayers.size>0)){this.#ascentCache.clear();for(let{canvas:e}of this.#canvasContexts.values())e.remove();this.#canvasContexts.clear()}}static#getCtx(e=null){let t=this.#canvasContexts.get(e||=``);if(!t){let n=document.createElement(`canvas`);n.className=`hiddenCanvasElement`,n.lang=e,document.body.append(n),t=n.getContext(`2d`,{alpha:!1,willReadFrequently:!0}),this.#canvasContexts.set(e,t),this.#canvasCtxFonts.set(t,{size:0,family:``})}return t}static#ensureCtxFont(e,t,n){let r=this.#canvasCtxFonts.get(e);t===r.size&&n===r.family||(e.font=`${t}px ${n}`,r.size=t,r.family=n)}static#ensureMinFontSizeComputed(){if(this.#minFontSize!==null)return;let e=document.createElement(`div`);e.style.opacity=0,e.style.lineHeight=1,e.style.fontSize=`1px`,e.style.position=`absolute`,e.textContent=`X`,document.body.append(e),this.#minFontSize=e.getBoundingClientRect().height,e.remove()}static#getAscent(e,t,n){let r=this.#ascentCache.get(e);if(r)return r;let i=this.#getCtx(n);i.canvas.width=i.canvas.height=Rr,this.#ensureCtxFont(i,Rr,e);let a=i.measureText(``),o=a.fontBoundingBoxAscent,s=Math.abs(a.fontBoundingBoxDescent);i.canvas.width=i.canvas.height=0;let c=.8;return o?c=o/(o+s):(R.platform.isFirefox&&P("Enable the `dom.textMetrics.fontBoundingBox.enabled` preference in `about:config` to improve TextLayer rendering."),t.ascent?c=t.ascent:t.descent&&(c=1+t.descent)),this.#ascentCache.set(e,c),c}},Br=100;function Vr(e={}){typeof e==`string`||e instanceof URL?e={url:e}:(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});let t=new Hr,{docId:n}=t,r=e.url?zt(e.url):null,i=e.data?Bt(e.data):null,a=e.httpHeaders||null,o=e.withCredentials===!0,s=e.password??null,c=e.range instanceof Ur?e.range:null,l=Number.isInteger(e.rangeChunkSize)&&e.rangeChunkSize>0?e.rangeChunkSize:2**16,u=e.worker instanceof Kr?e.worker:null,d=e.verbosity,f=typeof e.docBaseUrl==`string`&&!ze(e.docBaseUrl)?e.docBaseUrl:null,p=Vt(e.cMapUrl),m=e.cMapPacked!==!1,h=e.CMapReaderFactory||(x?cn:Zt),g=Vt(e.iccUrl),_=Vt(e.standardFontDataUrl),v=e.StandardFontDataFactory||(x?ln:tn),y=Vt(e.wasmUrl),b=e.WasmFactory||(x?un:rn),S=e.stopAtErrors!==!0,C=Number.isInteger(e.maxImageSize)&&e.maxImageSize>-1?e.maxImageSize:-1,w=e.isEvalSupported!==!1,T=typeof e.isOffscreenCanvasSupported==`boolean`?e.isOffscreenCanvasSupported:!x,E=typeof e.isImageDecoderSupported==`boolean`?e.isImageDecoderSupported:!x&&(R.platform.isFirefox||!globalThis.chrome),D=Number.isInteger(e.canvasMaxAreaInBytes)?e.canvasMaxAreaInBytes:-1,O=typeof e.disableFontFace==`boolean`?e.disableFontFace:x,k=e.fontExtraProperties===!0,A=e.enableXfa===!0,j=e.ownerDocument||globalThis.document,M=e.disableRange===!0,N=e.disableStream===!0,ee=e.disableAutoFetch===!0,te=e.pdfBug===!0,ne=e.CanvasFactory||(x?sn:Yt),re=e.FilterFactory||(x?on:$t),ie=e.enableHWA===!0,ae=e.useWasm!==!1,se=c?c.length:e.length??NaN,ce=typeof e.useSystemFonts==`boolean`?e.useSystemFonts:!x&&!O,P=typeof e.useWorkerFetch==`boolean`?e.useWorkerFetch:!!(h===Zt&&v===tn&&b===rn&&p&&_&&y&&We(p,document.baseURI)&&We(_,document.baseURI)&&We(y,document.baseURI));oe(d);let F={canvasFactory:new ne({ownerDocument:j,enableHWA:ie}),filterFactory:new re({docId:n,ownerDocument:j}),cMapReaderFactory:P?null:new h({baseUrl:p,isCompressed:m}),standardFontDataFactory:P?null:new v({baseUrl:_}),wasmFactory:P?null:new b({baseUrl:y})};u||(u=Kr.create({verbosity:d,port:Zn.workerPort}),t._worker=u);let I={docId:n,apiVersion:`5.4.624`,data:i,password:s,disableAutoFetch:ee,rangeChunkSize:l,length:se,docBaseUrl:f,enableXfa:A,evaluatorOptions:{maxImageSize:C,disableFontFace:O,ignoreErrors:S,isEvalSupported:w,isOffscreenCanvasSupported:T,isImageDecoderSupported:E,canvasMaxAreaInBytes:D,fontExtraProperties:k,useSystemFonts:ce,useWasm:ae,useWorkerFetch:P,cMapUrl:p,iccUrl:g,standardFontDataUrl:_,wasmUrl:y}},le={ownerDocument:j,pdfBug:te,styleElement:null,enableHWA:ie,loadingParams:{disableAutoFetch:ee,enableXfa:A}};return u.promise.then(function(){if(t.destroyed)throw Error(`Loading aborted`);if(u.destroyed)throw Error(`Worker was destroyed`);let e=u.messageHandler.sendWithPromise(`GetDocRequest`,I,i?[i.buffer]:null),s;if(c)s=new or({pdfDataRangeTransport:c,disableRange:M,disableStream:N});else if(!i){if(!r)throw Error("getDocument - no `url` parameter provided.");s=new(We(r)?yr:x?Mr:Tr)({url:r,length:se,httpHeaders:a,withCredentials:o,rangeChunkSize:l,disableRange:M,disableStream:N})}return e.then(e=>{if(t.destroyed)throw Error(`Loading aborted`);if(u.destroyed)throw Error(`Worker was destroyed`);let r=new qt(n,e,u.port);t._transport=new qr(r,t,s,le,F),r.send(`Ready`,null)})}).catch(t._capability.reject),t}var Hr=class e{static#docId=0;_capability=Promise.withResolvers();_transport=null;_worker=null;docId=`d${e.#docId++}`;destroyed=!1;onPassword=null;onProgress=null;get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await this._transport?.destroy()}catch(e){throw this._worker?.port&&delete this._worker._pendingDestroy,e}this._transport=null,this._worker?.destroy(),this._worker=null}async getData(){return this._transport.getData()}},Ur=class{#capability=Promise.withResolvers();#progressiveDoneListeners=[];#progressiveReadListeners=[];#progressListeners=[];#rangeListeners=[];constructor(e,t,n=!1,r=null){this.length=e,this.initialData=t,this.progressiveDone=n,this.contentDispositionFilename=r}addRangeListener(e){this.#rangeListeners.push(e)}addProgressListener(e){this.#progressListeners.push(e)}addProgressiveReadListener(e){this.#progressiveReadListeners.push(e)}addProgressiveDoneListener(e){this.#progressiveDoneListeners.push(e)}onDataRange(e,t){for(let n of this.#rangeListeners)n(e,t)}onDataProgress(e,t){this.#capability.promise.then(()=>{for(let n of this.#progressListeners)n(e,t)})}onDataProgressiveRead(e){this.#capability.promise.then(()=>{for(let t of this.#progressiveReadListeners)t(e)})}onDataProgressiveDone(){this.#capability.promise.then(()=>{for(let e of this.#progressiveDoneListeners)e()})}transportReady(){this.#capability.resolve()}requestDataRange(e,t){F(`Abstract method PDFDataRangeTransport.requestDataRange`)}abort(){}},Wr=class{constructor(e,t){this._pdfInfo=e,this._transport=t}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return L(this,`isPureXfa`,!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(e){return this._transport.getPage(e)}getPageIndex(e){return this._transport.getPageIndex(e)}getDestinations(){return this._transport.getDestinations()}getDestination(e){return this._transport.getDestination(e)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getAnnotationsByType(e,t){return this._transport.getAnnotationsByType(e,t)}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:e=`display`}={}){let{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getOptionalContentConfig(t)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}extractPages(e){return this._transport.extractPages(e)}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(e=!1){return this._transport.startCleanup(e||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(e){return this._transport.cachedPageNumber(e)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}},Gr=class{#pendingCleanup=!1;#pagesMapper=dt.instance;constructor(e,t,n,r=!1){this._pageIndex=e,this._pageInfo=t,this._transport=n,this._stats=r?new Ue:null,this._pdfBug=r,this.commonObjs=n.commonObjs,this.objs=new Ir,this._intentStates=new Map,this.destroyed=!1,this.recordedBBoxes=null}get pageNumber(){return this._pageIndex+1}set pageNumber(e){this._pageIndex=e-1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:e,rotation:t=this.rotate,offsetX:n=0,offsetY:r=0,dontFlip:i=!1}={}){return new Le({viewBox:this.view,userUnit:this.userUnit,scale:e,rotation:t,offsetX:n,offsetY:r,dontFlip:i})}getAnnotations({intent:e=`display`}={}){let{renderingIntent:t}=this._transport.getRenderingIntent(e);return this._transport.getAnnotations(this._pageIndex,t)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return L(this,`isPureXfa`,!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:e,canvas:t=e.canvas,viewport:n,intent:r=`display`,annotationMode:i=T.ENABLE,transform:a=null,background:o=null,optionalContentConfigPromise:s=null,annotationCanvasMap:c=null,pageColors:l=null,printAnnotationStorage:u=null,isEditing:d=!1,recordOperations:f=!1,operationsFilter:p=null}){this._stats?.time(`Overall`);let m=this._transport.getRenderingIntent(r,i,u,d),{renderingIntent:h,cacheKey:g}=m;this.#pendingCleanup=!1,s||=this._transport.getOptionalContentConfig(h);let _=this._intentStates.get(g);_||(_=Object.create(null),this._intentStates.set(g,_)),_.streamReaderCancelTimeout&&=(clearTimeout(_.streamReaderCancelTimeout),null);let v=!!(h&w.PRINT);_.displayReadyCapability||(_.displayReadyCapability=Promise.withResolvers(),_.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time(`Page Request`),this._pumpOperatorList(m));let y=!!(this._pdfBug&&globalThis.StepperManager?.enabled),b=!this.recordedBBoxes&&(f||y),x=e=>{if(_.renderTasks.delete(S),b){let e=S.gfx?.dependencyTracker.take();e&&(S.stepper&&S.stepper.setOperatorBBoxes(e,S.gfx.dependencyTracker.takeDebugMetadata()),f&&(this.recordedBBoxes=e))}v&&(this.#pendingCleanup=!0),this.#tryCleanup(),e?(S.capability.reject(e),this._abortOperatorList({intentState:_,reason:e instanceof Error?e:Error(e)})):S.capability.resolve(),this._stats&&(this._stats.timeEnd(`Rendering`),this._stats.timeEnd(`Overall`),globalThis.Stats?.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},S=new Yr({callback:x,params:{canvas:t,canvasContext:e,dependencyTracker:b?new vn(t,_.operatorList.length,y):null,viewport:n,transform:a,background:o},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:c,operatorList:_.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!v,pdfBug:this._pdfBug,pageColors:l,enableHWA:this._transport.enableHWA,operationsFilter:p});(_.renderTasks||=new Set).add(S);let C=S.task;return Promise.all([_.displayReadyCapability.promise,s]).then(([e,t])=>{if(this.destroyed){x();return}if(this._stats?.time(`Rendering`),!(t.renderingIntent&h))throw Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");S.initializeGraphics({transparency:e,optionalContentConfig:t}),S.operatorListChanged()}).catch(x),C}getOperatorList({intent:e=`display`,annotationMode:t=T.ENABLE,printAnnotationStorage:n=null,isEditing:r=!1}={}){function i(){o.operatorList.lastChunk&&(o.opListReadCapability.resolve(o.operatorList),o.renderTasks.delete(s))}let a=this._transport.getRenderingIntent(e,t,n,r,!0),o=this._intentStates.get(a.cacheKey);o||(o=Object.create(null),this._intentStates.set(a.cacheKey,o));let s;return o.opListReadCapability||(s=Object.create(null),s.operatorListChanged=i,o.opListReadCapability=Promise.withResolvers(),(o.renderTasks||=new Set).add(s),o.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time(`Page Request`),this._pumpOperatorList(a)),o.opListReadCapability.promise}streamTextContent({includeMarkedContent:e=!1,disableNormalization:t=!1}={}){return this._transport.messageHandler.sendWithStream(`GetTextContent`,{pageId:this.#pagesMapper.getPageId(this._pageIndex+1)-1,pageIndex:this._pageIndex,includeMarkedContent:e===!0,disableNormalization:t===!0},{highWaterMark:100,size(e){return e.items.length}})}getTextContent(e={}){if(this._transport._htmlForXfa)return this.getXfa().then(e=>Me.textContent(e));let t=this.streamTextContent(e);return new Promise(function(e,n){function r(){i.read().then(function({value:t,done:n}){if(n){e(a);return}a.lang??=t.lang,Object.assign(a.styles,t.styles),a.items.push(...t.items),r()},n)}let i=t.getReader(),a={items:[],styles:Object.create(null),lang:null};r()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;let e=[];for(let t of this._intentStates.values())if(this._abortOperatorList({intentState:t,reason:Error(`Page was destroyed.`),force:!0}),!t.opListReadCapability)for(let n of t.renderTasks)e.push(n.completed),n.cancel();return this.objs.clear(),this.#pendingCleanup=!1,Promise.all(e)}cleanup(e=!1){this.#pendingCleanup=!0;let t=this.#tryCleanup();return e&&t&&(this._stats&&=new Ue),t}#tryCleanup(){if(!this.#pendingCleanup||this.destroyed)return!1;for(let{renderTasks:e,operatorList:t}of this._intentStates.values())if(e.size>0||!t.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),this.#pendingCleanup=!1,!0}_startRenderPage(e,t){let n=this._intentStates.get(t);n&&(this._stats?.timeEnd(`Page Request`),n.displayReadyCapability?.resolve(e))}_renderPageChunk(e,t){for(let n=0,r=e.length;n<r;n++)t.operatorList.fnArray.push(e.fnArray[n]),t.operatorList.argsArray.push(e.argsArray[n]);t.operatorList.lastChunk=e.lastChunk,t.operatorList.separateAnnots=e.separateAnnots;for(let e of t.renderTasks)e.operatorListChanged();e.lastChunk&&this.#tryCleanup()}_pumpOperatorList({renderingIntent:e,cacheKey:t,annotationStorageSerializable:n,modifiedIds:r}){let{map:i,transfer:a}=n,o=this._transport.messageHandler.sendWithStream(`GetOperatorList`,{pageId:this.#pagesMapper.getPageId(this._pageIndex+1)-1,pageIndex:this._pageIndex,intent:e,cacheKey:t,annotationStorage:i,modifiedIds:r},a).getReader(),s=this._intentStates.get(t);s.streamReader=o;let c=()=>{o.read().then(({value:e,done:t})=>{if(t){s.streamReader=null;return}this._transport.destroyed||(this._renderPageChunk(e,s),c())},e=>{if(s.streamReader=null,!this._transport.destroyed){if(s.operatorList){s.operatorList.lastChunk=!0;for(let e of s.renderTasks)e.operatorListChanged();this.#tryCleanup()}if(s.displayReadyCapability)s.displayReadyCapability.reject(e);else if(s.opListReadCapability)s.opListReadCapability.reject(e);else throw e}})};c()}_abortOperatorList({intentState:e,reason:t,force:n=!1}){if(e.streamReader){if(e.streamReaderCancelTimeout&&=(clearTimeout(e.streamReaderCancelTimeout),null),!n){if(e.renderTasks.size>0)return;if(t instanceof Re){let n=Br;t.extraDelay>0&&t.extraDelay<1e3&&(n+=t.extraDelay),e.streamReaderCancelTimeout=setTimeout(()=>{e.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:e,reason:t,force:!0})},n);return}}if(e.streamReader.cancel(new ve(t.message)).catch(()=>{}),e.streamReader=null,!this._transport.destroyed){for(let[t,n]of this._intentStates)if(n===e){this._intentStates.delete(t);break}this.cleanup()}}}get stats(){return this._stats}},Kr=class e{#capability=Promise.withResolvers();#messageHandler=null;#port=null;#webWorker=null;static#fakeWorkerId=0;static#isWorkerDisabled=!1;static#workerPorts=new WeakMap;static{x&&(this.#isWorkerDisabled=!0,Zn.workerSrc||=`./pdf.worker.mjs`),this._isSameOrigin=(e,t)=>{let n=URL.parse(e);if(!n?.origin||n.origin===`null`)return!1;let r=new URL(t,n);return n.origin===r.origin},this._createCDNWrapper=e=>{let t=`await import("${e}");`;return URL.createObjectURL(new Blob([t],{type:`text/javascript`}))},this.fromPort=e=>{if(Ge("`PDFWorker.fromPort` - please use `PDFWorker.create` instead."),!e?.port)throw Error(`PDFWorker.fromPort - invalid method signature.`);return this.create(e)}}constructor({name:t=null,port:n=null,verbosity:r=se()}={}){if(this.name=t,this.destroyed=!1,this.verbosity=r,n){if(e.#workerPorts.has(n))throw Error(`Cannot use more than one PDFWorker per port.`);e.#workerPorts.set(n,this),this.#initializeFromPort(n)}else this.#initialize()}get promise(){return this.#capability.promise}#resolve(){this.#capability.resolve(),this.#messageHandler.send(`configure`,{verbosity:this.verbosity})}get port(){return this.#port}get messageHandler(){return this.#messageHandler}#initializeFromPort(e){this.#port=e,this.#messageHandler=new qt(`main`,`worker`,e),this.#messageHandler.on(`ready`,()=>{}),this.#resolve()}#initialize(){if(e.#isWorkerDisabled||e.#mainThreadWorkerMessageHandler){this.#setupFakeWorker();return}let{workerSrc:t}=e;try{e._isSameOrigin(window.location,t)||(t=e._createCDNWrapper(new URL(t,window.location).href));let n=new Worker(t,{type:`module`}),r=new qt(`main`,`worker`,n),i=()=>{a.abort(),r.destroy(),n.terminate(),this.destroyed?this.#capability.reject(Error(`Worker was destroyed`)):this.#setupFakeWorker()},a=new AbortController;n.addEventListener(`error`,()=>{this.#webWorker||i()},{signal:a.signal}),r.on(`test`,e=>{if(a.abort(),this.destroyed||!e){i();return}this.#messageHandler=r,this.#port=n,this.#webWorker=n,this.#resolve()}),r.on(`ready`,e=>{if(a.abort(),this.destroyed){i();return}try{o()}catch{this.#setupFakeWorker()}});let o=()=>{let e=new Uint8Array;r.send(`test`,e,[e.buffer])};o();return}catch{ce(`The worker has been disabled.`)}this.#setupFakeWorker()}#setupFakeWorker(){e.#isWorkerDisabled||=(P(`Setting up fake worker.`),!0),e._setupFakeWorkerGlobal.then(t=>{if(this.destroyed){this.#capability.reject(Error(`Worker was destroyed`));return}let n=new Wt;this.#port=n;let r=`fake${e.#fakeWorkerId++}`,i=new qt(r+`_worker`,r,n);t.setup(i,n),this.#messageHandler=new qt(r,r+`_worker`,n),this.#resolve()}).catch(e=>{this.#capability.reject(Error(`Setting up fake worker failed: "${e.message}".`))})}destroy(){this.destroyed=!0,this.#webWorker?.terminate(),this.#webWorker=null,e.#workerPorts.delete(this.#port),this.#port=null,this.#messageHandler?.destroy(),this.#messageHandler=null}static create(t){let n=this.#workerPorts.get(t?.port);if(n){if(n._pendingDestroy)throw Error("PDFWorker.create - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return n}return new e(t)}static get workerSrc(){if(Zn.workerSrc)return Zn.workerSrc;throw Error(`No "GlobalWorkerOptions.workerSrc" specified.`)}static get#mainThreadWorkerMessageHandler(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}}static get _setupFakeWorkerGlobal(){return L(this,`_setupFakeWorkerGlobal`,(async()=>this.#mainThreadWorkerMessageHandler?this.#mainThreadWorkerMessageHandler:(await p(()=>import(this.workerSrc),[])).WorkerMessageHandler)())}},qr=class{downloadInfoCapability=Promise.withResolvers();#fullReader=null;#methodPromises=new Map;#networkStream=null;#pageCache=new Map;#pagePromises=new Map;#pageRefCache=new Map;#passwordCapability=null;#pagesMapper=dt.instance;constructor(e,t,n,r,i){this.messageHandler=e,this.loadingTask=t,this.#networkStream=n,this.commonObjs=new Ir,this.fontLoader=new Mt({ownerDocument:r.ownerDocument,styleElement:r.styleElement}),this.enableHWA=r.enableHWA,this.loadingParams=r.loadingParams,this._params=r,this.canvasFactory=i.canvasFactory,this.filterFactory=i.filterFactory,this.cMapReaderFactory=i.cMapReaderFactory,this.standardFontDataFactory=i.standardFontDataFactory,this.wasmFactory=i.wasmFactory,this.destroyed=!1,this.destroyCapability=null,this.setupMessageHandler(),this.#pagesMapper.addListener(this.#updateCaches.bind(this))}#updateCaches(){let e=new Map,t=new Map;for(let n=0,r=this.#pagesMapper.pagesNumber;n<r;n++){let r=this.#pagesMapper.getPrevPageNumber(n+1)-1,i=this.#pageCache.get(r);i&&e.set(n,i);let a=this.#pagePromises.get(r);a&&t.set(n,a)}this.#pageCache=e,this.#pagePromises=t}#cacheSimpleMethod(e,t=null){let n=this.#methodPromises.get(e);if(n)return n;let r=this.messageHandler.sendWithPromise(e,t);return this.#methodPromises.set(e,r),r}#onProgress({loaded:e,total:t}){this.loadingTask.onProgress?.({loaded:e,total:t,percent:B(Math.round(e/t*100),0,100)})}get annotationStorage(){return L(this,`annotationStorage`,new At)}getRenderingIntent(e,t=T.ENABLE,n=null,r=!1,i=!1){let a=w.DISPLAY,o=kt;switch(e){case`any`:a=w.ANY;break;case`display`:break;case`print`:a=w.PRINT;break;default:P(`getRenderingIntent - invalid intent: ${e}`)}let s=a&w.PRINT&&n instanceof jt?n:this.annotationStorage;switch(t){case T.DISABLE:a+=w.ANNOTATIONS_DISABLE;break;case T.ENABLE:break;case T.ENABLE_FORMS:a+=w.ANNOTATIONS_FORMS;break;case T.ENABLE_STORAGE:a+=w.ANNOTATIONS_STORAGE,o=s.serializable;break;default:P(`getRenderingIntent - invalid annotationMode: ${t}`)}r&&(a+=w.IS_EDITING),i&&(a+=w.OPLIST);let{ids:c,hash:l}=s.modifiedIds,u=[a,o.hash,l];return{renderingIntent:a,cacheKey:u.join(`_`),annotationStorageSerializable:o,modifiedIds:c}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),this.#passwordCapability?.reject(Error(`Worker was destroyed during onPassword callback`));let e=[];for(let t of this.#pageCache.values())e.push(t._destroy());this.#pageCache.clear(),this.#pagePromises.clear(),this.#pageRefCache.clear(),this.hasOwnProperty(`annotationStorage`)&&this.annotationStorage.resetModified();let t=this.messageHandler.sendWithPromise(`Terminate`,null);return e.push(t),Promise.all(e).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),this.#methodPromises.clear(),this.filterFactory.destroy(),zr.cleanup(),this.#networkStream?.cancelAllRequests(new ve(`Worker was terminated.`)),this.messageHandler?.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){let{messageHandler:e,loadingTask:t}=this;e.on(`GetReader`,(e,t)=>{I(this.#networkStream,"GetReader - no `BasePDFStream` instance available."),this.#fullReader=this.#networkStream.getFullReader(),this.#fullReader.onProgress=e=>this.#onProgress(e),t.onPull=()=>{this.#fullReader.read().then(function({value:e,done:n}){if(n){t.close();return}I(e instanceof ArrayBuffer,`GetReader - expected an ArrayBuffer.`),t.enqueue(new Uint8Array(e),1,[e])}).catch(e=>{t.error(e)})},t.onCancel=e=>{this.#fullReader.cancel(e),t.ready.catch(e=>{if(!this.destroyed)throw e})}}),e.on(`ReaderHeadersReady`,async e=>{await this.#fullReader.headersReady;let{isStreamingSupported:t,isRangeSupported:n,contentLength:r}=this.#fullReader;return t&&n&&(this.#fullReader.onProgress=null),{isStreamingSupported:t,isRangeSupported:n,contentLength:r}}),e.on(`GetRangeReader`,(e,t)=>{I(this.#networkStream,"GetRangeReader - no `BasePDFStream` instance available.");let n=this.#networkStream.getRangeReader(e.begin,e.end);if(!n){t.close();return}t.onPull=()=>{n.read().then(function({value:e,done:n}){if(n){t.close();return}I(e instanceof ArrayBuffer,`GetRangeReader - expected an ArrayBuffer.`),t.enqueue(new Uint8Array(e),1,[e])}).catch(e=>{t.error(e)})},t.onCancel=e=>{n.cancel(e),t.ready.catch(e=>{if(!this.destroyed)throw e})}}),e.on(`GetDoc`,({pdfInfo:e})=>{this.#pagesMapper.pagesNumber=e.numPages,this._numPages=e.numPages,this._htmlForXfa=e.htmlForXfa,delete e.htmlForXfa,t._capability.resolve(new Wr(e,this))}),e.on(`DocException`,e=>{t._capability.reject(q(e))}),e.on(`PasswordRequest`,e=>{this.#passwordCapability=Promise.withResolvers();try{if(!t.onPassword)throw q(e);t.onPassword(e=>{e instanceof Error?this.#passwordCapability.reject(e):this.#passwordCapability.resolve({password:e})},e.code)}catch(e){this.#passwordCapability.reject(e)}return this.#passwordCapability.promise}),e.on(`DataLoaded`,e=>{this.#onProgress({loaded:e.length,total:e.length}),this.downloadInfoCapability.resolve(e)}),e.on(`StartRenderPage`,e=>{this.destroyed||this.#pageCache.get(e.pageIndex)._startRenderPage(e.transparency,e.cacheKey)}),e.on(`commonobj`,([t,n,r])=>{if(this.destroyed||this.commonObjs.has(t))return null;switch(n){case`Font`:if(`error`in r){let e=r.error;P(`Error during font loading: ${e}`),this.commonObjs.resolve(t,e);break}let i=new It(r),a=this._params.pdfBug&&globalThis.FontInspector?.enabled?(e,t)=>globalThis.FontInspector.fontAdded(e,t):null,o=new Nt(i,a,r.extra,r.charProcOperatorList);this.fontLoader.bind(o).catch(()=>e.sendWithPromise(`FontFallback`,{id:t})).finally(()=>{!o.fontExtraProperties&&o.data&&o.clearData(),this.commonObjs.resolve(t,o)});break;case`CopyLocalImage`:let{imageRef:s}=r;I(s,`The imageRef must be defined.`);for(let e of this.#pageCache.values())for(let[,n]of e.objs)if(n?.ref===s)return n.dataLen?(this.commonObjs.resolve(t,structuredClone(n)),n.dataLen):null;break;case`FontPath`:this.commonObjs.resolve(t,new Rt(r));break;case`Image`:this.commonObjs.resolve(t,r);break;case`Pattern`:let c=new Lt(r);this.commonObjs.resolve(t,c.getIR());break;default:throw Error(`Got unknown common object type ${n}`)}return null}),e.on(`obj`,([e,t,n,r])=>{if(this.destroyed)return;let i=this.#pageCache.get(t);if(!i.objs.has(e)){if(i._intentStates.size===0){r?.bitmap?.close();return}switch(n){case`Image`:case`Pattern`:i.objs.resolve(e,r);break;default:throw Error(`Got unknown object type ${n}`)}}}),e.on(`DocProgress`,e=>{this.destroyed||this.#onProgress(e)}),e.on(`FetchBinaryData`,async e=>{if(this.destroyed)throw Error(`Worker was destroyed.`);let t=this[e.type];if(!t)throw Error(`${e.type} not initialized, see the \`useWorkerFetch\` parameter.`);return t.fetch(e)})}getData(){return this.messageHandler.sendWithPromise(`GetData`,null)}saveDocument(){this.annotationStorage.size<=0&&P("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");let{map:e,transfer:t}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise(`SaveDocument`,{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:e,filename:this.#fullReader?.filename??null},t).finally(()=>{this.annotationStorage.resetModified()})}extractPages(e){return this.messageHandler.sendWithPromise(`ExtractPages`,{pageInfos:e})}getPage(e){if(!Number.isInteger(e)||e<=0||e>this.#pagesMapper.pagesNumber)return Promise.reject(Error(`Invalid page request.`));let t=e-1,n=this.#pagesMapper.getPageId(e)-1,r=this.#pagePromises.get(t);if(r)return r;let i=this.messageHandler.sendWithPromise(`GetPage`,{pageIndex:n}).then(e=>{if(this.destroyed)throw Error(`Transport destroyed`);e.refStr&&this.#pageRefCache.set(e.refStr,n);let r=new Gr(t,e,this,this._params.pdfBug);return this.#pageCache.set(t,r),r});return this.#pagePromises.set(t,i),i}async getPageIndex(e){if(!Ht(e))throw Error(`Invalid pageIndex request.`);let t=await this.messageHandler.sendWithPromise(`GetPageIndex`,{num:e.num,gen:e.gen});return this.#pagesMapper.getPageNumber(t+1)-1}getAnnotations(e,t){return this.messageHandler.sendWithPromise(`GetAnnotations`,{pageIndex:this.#pagesMapper.getPageId(e+1)-1,intent:t})}getFieldObjects(){return this.#cacheSimpleMethod(`GetFieldObjects`)}hasJSActions(){return this.#cacheSimpleMethod(`HasJSActions`)}getCalculationOrderIds(){return this.messageHandler.sendWithPromise(`GetCalculationOrderIds`,null)}getDestinations(){return this.messageHandler.sendWithPromise(`GetDestinations`,null)}getDestination(e){return typeof e==`string`?this.messageHandler.sendWithPromise(`GetDestination`,{id:e}):Promise.reject(Error(`Invalid destination request.`))}getPageLabels(){return this.messageHandler.sendWithPromise(`GetPageLabels`,null)}getPageLayout(){return this.messageHandler.sendWithPromise(`GetPageLayout`,null)}getPageMode(){return this.messageHandler.sendWithPromise(`GetPageMode`,null)}getViewerPreferences(){return this.messageHandler.sendWithPromise(`GetViewerPreferences`,null)}getOpenAction(){return this.messageHandler.sendWithPromise(`GetOpenAction`,null)}getAttachments(){return this.messageHandler.sendWithPromise(`GetAttachments`,null)}getAnnotationsByType(e,t){return this.messageHandler.sendWithPromise(`GetAnnotationsByType`,{types:e,pageIndexesToSkip:t})}getDocJSActions(){return this.#cacheSimpleMethod(`GetDocJSActions`)}getPageJSActions(e){return this.messageHandler.sendWithPromise(`GetPageJSActions`,{pageIndex:this.#pagesMapper.getPageId(e+1)-1})}getStructTree(e){return this.messageHandler.sendWithPromise(`GetStructTree`,{pageIndex:this.#pagesMapper.getPageId(e+1)-1})}getOutline(){return this.messageHandler.sendWithPromise(`GetOutline`,null)}getOptionalContentConfig(e){return this.#cacheSimpleMethod(`GetOptionalContentConfig`).then(t=>new tr(t,e))}getPermissions(){return this.messageHandler.sendWithPromise(`GetPermissions`,null)}getMetadata(){let e=`GetMetadata`,t=this.#methodPromises.get(e);if(t)return t;let n=this.messageHandler.sendWithPromise(e,null).then(e=>({info:e[0],metadata:e[1]?new Qn(e[1]):null,contentDispositionFilename:this.#fullReader?.filename??null,contentLength:this.#fullReader?.contentLength??null,hasStructTree:e[2]}));return this.#methodPromises.set(e,n),n}getMarkInfo(){return this.messageHandler.sendWithPromise(`GetMarkInfo`,null)}async startCleanup(e=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise(`Cleanup`,null);for(let e of this.#pageCache.values())if(!e.cleanup())throw Error(`startCleanup: Page ${e.pageNumber} is currently rendering.`);this.commonObjs.clear(),e||this.fontLoader.clear(),this.#methodPromises.clear(),this.filterFactory.destroy(!0),zr.cleanup()}}cachedPageNumber(e){if(!Ht(e))return null;let t=e.gen===0?`${e.num}R`:`${e.num}R${e.gen}`,n=this.#pageRefCache.get(t);return n>=0?this.#pagesMapper.getPageNumber(n+1):null}},Jr=class{_internalRenderTask=null;onContinue=null;onError=null;constructor(e){this._internalRenderTask=e}get promise(){return this._internalRenderTask.capability.promise}cancel(e=0){this._internalRenderTask.cancel(null,e)}get separateAnnots(){let{separateAnnots:e}=this._internalRenderTask.operatorList;if(!e)return!1;let{annotationCanvasMap:t}=this._internalRenderTask;return e.form||e.canvas&&t?.size>0}},Yr=class e{#rAF=null;static#canvasInUse=new WeakSet;constructor({callback:e,params:t,objs:n,commonObjs:r,annotationCanvasMap:i,operatorList:a,pageIndex:o,canvasFactory:s,filterFactory:c,useRequestAnimationFrame:l=!1,pdfBug:u=!1,pageColors:d=null,enableHWA:f=!1,operationsFilter:p=null}){this.callback=e,this.params=t,this.objs=n,this.commonObjs=r,this.annotationCanvasMap=i,this.operatorListIdx=null,this.operatorList=a,this._pageIndex=o,this.canvasFactory=s,this.filterFactory=c,this._pdfBug=u,this.pageColors=d,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=l===!0&&typeof window<`u`,this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new Jr(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=t.canvas,this._canvasContext=t.canvas?null:t.canvasContext,this._enableHWA=f,this._dependencyTracker=t.dependencyTracker,this._operationsFilter=p}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:t=!1,optionalContentConfig:n}){if(this.cancelled)return;if(this._canvas){if(e.#canvasInUse.has(this._canvas))throw Error(`Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.`);e.#canvasInUse.add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());let{viewport:r,transform:i,background:a,dependencyTracker:o}=this.params,s=this._canvasContext||this._canvas.getContext(`2d`,{alpha:!1,willReadFrequently:!this._enableHWA});this.gfx=new Xn(s,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:n},this.annotationCanvasMap,this.pageColors,o),this.gfx.beginDrawing({transform:i,viewport:r,transparency:t,background:a}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(t=null,n=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),this.#rAF&&=(window.cancelAnimationFrame(this.#rAF),null),e.#canvasInUse.delete(this._canvas),t||=new Re(`Rendering cancelled, page ${this._pageIndex+1}`,n),this.callback(t),this.task.onError?.(t)}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}this.gfx.dependencyTracker?.growOperationsCount(this.operatorList.fnArray.length),this.stepper?.updateOperatorList(this.operatorList),!this.running&&this._continue()}_continue(){this.running=!0,!this.cancelled&&(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?this.#rAF=window.requestAnimationFrame(()=>{this.#rAF=null,this._nextBound().catch(this._cancelBound)}):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper,this._operationsFilter),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),e.#canvasInUse.delete(this._canvas),this.callback())))}},Xr=`5.4.624`,Zr=`384c6208b`,Qr=class e{#button=null;#buttonSwatch=null;#defaultColor;#dropdown=null;#dropdownWasFromKeyboard=!1;#isMainColorPicker=!1;#editor=null;#eventBus;#openDropdownAC=null;#uiManager=null;static#l10nColor=null;static get _keyboardManager(){return L(this,`_keyboardManager`,new vt([[[`Escape`,`mac+Escape`],e.prototype._hideDropdownFromKeyboard],[[` `,`mac+ `],e.prototype._colorSelectFromKeyboard],[[`ArrowDown`,`ArrowRight`,`mac+ArrowDown`,`mac+ArrowRight`],e.prototype._moveToNext],[[`ArrowUp`,`ArrowLeft`,`mac+ArrowUp`,`mac+ArrowLeft`],e.prototype._moveToPrevious],[[`Home`,`mac+Home`],e.prototype._moveToBeginning],[[`End`,`mac+End`],e.prototype._moveToEnd]]))}constructor({editor:t=null,uiManager:n=null}){t?(this.#isMainColorPicker=!1,this.#editor=t):this.#isMainColorPicker=!0,this.#uiManager=t?._uiManager||n,this.#eventBus=this.#uiManager._eventBus,this.#defaultColor=t?.color?.toUpperCase()||this.#uiManager?.highlightColors.values().next().value||`#FFFF98`,e.#l10nColor||=Object.freeze({blue:`pdfjs-editor-colorpicker-blue`,green:`pdfjs-editor-colorpicker-green`,pink:`pdfjs-editor-colorpicker-pink`,red:`pdfjs-editor-colorpicker-red`,yellow:`pdfjs-editor-colorpicker-yellow`})}renderButton(){let e=this.#button=document.createElement(`button`);e.className=`colorPicker`,e.tabIndex=`0`,e.setAttribute(`data-l10n-id`,`pdfjs-editor-colorpicker-button`),e.ariaHasPopup=`true`,this.#editor&&(e.ariaControls=`${this.#editor.id}_colorpicker_dropdown`);let t=this.#uiManager._signal;e.addEventListener(`click`,this.#openDropdown.bind(this),{signal:t}),e.addEventListener(`keydown`,this.#keyDown.bind(this),{signal:t});let n=this.#buttonSwatch=document.createElement(`span`);return n.className=`swatch`,n.ariaHidden=`true`,n.style.backgroundColor=this.#defaultColor,e.append(n),e}renderMainDropdown(){let e=this.#dropdown=this.#getDropdownRoot();return e.ariaOrientation=`horizontal`,e.ariaLabelledBy=`highlightColorPickerLabel`,e}#getDropdownRoot(){let t=document.createElement(`div`),n=this.#uiManager._signal;t.addEventListener(`contextmenu`,V,{signal:n}),t.className=`dropdown`,t.role=`listbox`,t.ariaMultiSelectable=`false`,t.ariaOrientation=`vertical`,t.setAttribute(`data-l10n-id`,`pdfjs-editor-colorpicker-dropdown`),this.#editor&&(t.id=`${this.#editor.id}_colorpicker_dropdown`);for(let[r,i]of this.#uiManager.highlightColors){let a=document.createElement(`button`);a.tabIndex=`0`,a.role=`option`,a.setAttribute(`data-color`,i),a.title=r,a.setAttribute(`data-l10n-id`,e.#l10nColor[r]);let o=document.createElement(`span`);a.append(o),o.className=`swatch`,o.style.backgroundColor=i,a.ariaSelected=i===this.#defaultColor,a.addEventListener(`click`,this.#colorSelect.bind(this,i),{signal:n}),t.append(a)}return t.addEventListener(`keydown`,this.#keyDown.bind(this),{signal:n}),t}#colorSelect(e,t){t.stopPropagation(),this.#eventBus.dispatch(`switchannotationeditorparams`,{source:this,type:O.HIGHLIGHT_COLOR,value:e}),this.updateColor(e)}_colorSelectFromKeyboard(e){if(e.target===this.#button){this.#openDropdown(e);return}let t=e.target.getAttribute(`data-color`);t&&this.#colorSelect(t,e)}_moveToNext(e){if(!this.#isDropdownVisible){this.#openDropdown(e);return}if(e.target===this.#button){this.#dropdown.firstElementChild?.focus();return}e.target.nextSibling?.focus()}_moveToPrevious(e){if(e.target===this.#dropdown?.firstElementChild||e.target===this.#button){this.#isDropdownVisible&&this._hideDropdownFromKeyboard();return}this.#isDropdownVisible||this.#openDropdown(e),e.target.previousSibling?.focus()}_moveToBeginning(e){if(!this.#isDropdownVisible){this.#openDropdown(e);return}this.#dropdown.firstElementChild?.focus()}_moveToEnd(e){if(!this.#isDropdownVisible){this.#openDropdown(e);return}this.#dropdown.lastElementChild?.focus()}#keyDown(t){e._keyboardManager.exec(this,t)}#openDropdown(e){if(this.#isDropdownVisible){this.hideDropdown();return}if(this.#dropdownWasFromKeyboard=e.detail===0,this.#openDropdownAC||(this.#openDropdownAC=new AbortController,window.addEventListener(`pointerdown`,this.#pointerDown.bind(this),{signal:this.#uiManager.combinedSignal(this.#openDropdownAC)})),this.#button.ariaExpanded=`true`,this.#dropdown){this.#dropdown.classList.remove(`hidden`);return}let t=this.#dropdown=this.#getDropdownRoot();this.#button.append(t)}#pointerDown(e){this.#dropdown?.contains(e.target)||this.hideDropdown()}hideDropdown(){this.#dropdown?.classList.add(`hidden`),this.#button.ariaExpanded=`false`,this.#openDropdownAC?.abort(),this.#openDropdownAC=null}get#isDropdownVisible(){return this.#dropdown&&!this.#dropdown.classList.contains(`hidden`)}_hideDropdownFromKeyboard(){if(!this.#isMainColorPicker){if(!this.#isDropdownVisible){this.#editor?.unselect();return}this.hideDropdown(),this.#button.focus({preventScroll:!0,focusVisible:this.#dropdownWasFromKeyboard})}}updateColor(e){if(this.#buttonSwatch&&(this.#buttonSwatch.style.backgroundColor=e),!this.#dropdown)return;let t=this.#uiManager.highlightColors.values();for(let n of this.#dropdown.children)n.ariaSelected=t.next().value===e.toUpperCase()}destroy(){this.#button?.remove(),this.#button=null,this.#buttonSwatch=null,this.#dropdown?.remove(),this.#dropdown=null}},$r=class e{#input=null;#editor=null;#uiManager=null;static#l10nColor=null;constructor(t){this.#editor=t,this.#uiManager=t._uiManager,e.#l10nColor||=Object.freeze({freetext:`pdfjs-editor-color-picker-free-text-input`,ink:`pdfjs-editor-color-picker-ink-input`})}renderButton(){if(this.#input)return this.#input;let{editorType:t,colorType:n,color:r}=this.#editor,i=this.#input=document.createElement(`input`);return i.type=`color`,i.value=r||`#000000`,i.className=`basicColorPicker`,i.tabIndex=0,i.setAttribute(`data-l10n-id`,e.#l10nColor[t]),i.addEventListener(`input`,()=>{this.#uiManager.updateParams(n,i.value)},{signal:this.#uiManager._signal}),i}update(e){this.#input&&(this.#input.value=e)}destroy(){this.#input?.remove(),this.#input=null}hideDropdown(){}};function ei(e){return Math.floor(Math.max(0,Math.min(1,e))*255).toString(16).padStart(2,`0`)}function ti(e){return Math.max(0,Math.min(255,255*e))}var ni=class{static CMYK_G([e,t,n,r]){return[`G`,1-Math.min(1,.3*e+.59*n+.11*t+r)]}static G_CMYK([e]){return[`CMYK`,0,0,0,1-e]}static G_RGB([e]){return[`RGB`,e,e,e]}static G_rgb([e]){return e=ti(e),[e,e,e]}static G_HTML([e]){let t=ei(e);return`#${t}${t}${t}`}static RGB_G([e,t,n]){return[`G`,.3*e+.59*t+.11*n]}static RGB_rgb(e){return e.map(ti)}static RGB_HTML(e){return`#${e.map(ei).join(``)}`}static T_HTML(){return`#00000000`}static T_rgb(){return[null]}static CMYK_RGB([e,t,n,r]){return[`RGB`,1-Math.min(1,e+r),1-Math.min(1,n+r),1-Math.min(1,t+r)]}static CMYK_rgb([e,t,n,r]){return[ti(1-Math.min(1,e+r)),ti(1-Math.min(1,n+r)),ti(1-Math.min(1,t+r))]}static CMYK_HTML(e){let t=this.CMYK_RGB(e).slice(1);return this.RGB_HTML(t)}static RGB_CMYK([e,t,n]){let r=1-e,i=1-t,a=1-n;return[`CMYK`,r,i,a,Math.min(r,i,a)]}},ri=class{create(e,t,n=!1){if(e<=0||t<=0)throw Error(`Invalid SVG dimensions`);let r=this._createSVG(`svg:svg`);return r.setAttribute(`version`,`1.1`),n||(r.setAttribute(`width`,`${e}px`),r.setAttribute(`height`,`${t}px`)),r.setAttribute(`preserveAspectRatio`,`none`),r.setAttribute(`viewBox`,`0 0 ${e} ${t}`),r}createElement(e){if(typeof e!=`string`)throw Error(`Invalid SVG element type`);return this._createSVG(e)}_createSVG(e){F("Abstract method `_createSVG` called.")}},ii=class extends ri{_createSVG(e){return document.createElementNS(Pe,e)}},ai=9,oi=new WeakSet,si=new Date().getTimezoneOffset()*60*1e3,ci=class{static create(e){switch(e.data.annotationType){case N.LINK:return new ui(e);case N.TEXT:return new di(e);case N.WIDGET:switch(e.data.fieldType){case`Tx`:return new pi(e);case`Btn`:return e.data.radioButton?new gi(e):e.data.checkBox?new hi(e):new _i(e);case`Ch`:return new vi(e);case`Sig`:return new mi(e)}return new fi(e);case N.POPUP:return new yi(e);case N.FREETEXT:return new xi(e);case N.LINE:return new Si(e);case N.SQUARE:return new Ci(e);case N.CIRCLE:return new wi(e);case N.POLYLINE:return new Ti(e);case N.CARET:return new Di(e);case N.INK:return new Oi(e);case N.POLYGON:return new Ei(e);case N.HIGHLIGHT:return new ki(e);case N.UNDERLINE:return new Ai(e);case N.SQUIGGLY:return new ji(e);case N.STRIKEOUT:return new Mi(e);case N.STAMP:return new Ni(e);case N.FILEATTACHMENT:return new Pi(e);default:return new Q(e)}}},Q=class e{#updates=null;#hasBorder=!1;#popupElement=null;constructor(e,{isRenderable:t=!1,ignoreBorder:n=!1,createQuadrilaterals:r=!1}={}){this.isRenderable=t,this.data=e.data,this.layer=e.layer,this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.imageResourcesPath=e.imageResourcesPath,this.renderForms=e.renderForms,this.svgFactory=e.svgFactory,this.annotationStorage=e.annotationStorage,this.enableComment=e.enableComment,this.enableScripting=e.enableScripting,this.hasJSActions=e.hasJSActions,this._fieldObjects=e.fieldObjects,this.parent=e.parent,this.hasOwnCommentButton=!1,t&&(this.contentElement=this.container=this._createContainer(n)),r&&this._createQuadrilaterals()}static _hasPopupData({contentsObj:e,richText:t}){return!!(e?.str||t?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return e._hasPopupData(this.data)||this.enableComment&&!!this.commentText}get commentData(){let{data:e}=this,t=this.annotationStorage?.getEditor(e.id);return t?t.getData():e}get hasCommentButton(){return this.enableComment&&this.hasPopupElement}get commentButtonPosition(){let e=this.annotationStorage?.getEditor(this.data.id);if(e)return e.commentButtonPositionInPage;let{quadPoints:t,inkLists:n,rect:r}=this.data,i=-1/0,a=-1/0;if(t?.length>=8){for(let e=0;e<t.length;e+=8)t[e+1]>a?(a=t[e+1],i=t[e+2]):t[e+1]===a&&(i=Math.max(i,t[e+2]));return[i,a]}if(n?.length>=1){for(let e of n)for(let t=0,n=e.length;t<n;t+=2)e[t+1]>a?(a=e[t+1],i=e[t]):e[t+1]===a&&(i=Math.max(i,e[t]));if(i!==1/0)return[i,a]}return r?[r[2],r[3]]:null}_normalizePoint(e){let{page:{view:t},viewport:{rawDims:{pageWidth:n,pageHeight:r,pageX:i,pageY:a}}}=this.parent;return e[1]=t[3]-e[1]+t[1],e[0]=100*(e[0]-i)/n,e[1]=100*(e[1]-a)/r,e}get commentText(){let{data:e}=this;return this.annotationStorage.getRawValue(`${E}${e.id}`)?.popup?.contents||e.contentsObj?.str||``}set commentText(e){let{data:t}=this,n={deleted:!e,contents:e||``};this.annotationStorage.updateEditor(t.id,{popup:n})||this.annotationStorage.setValue(`${E}${t.id}`,{id:t.id,annotationType:t.annotationType,page:this.parent.page,popup:n,popupRef:t.popupRef,modificationDate:new Date}),e||this.removePopup()}removePopup(){(this.#popupElement?.popup||this.popup)?.remove(),this.#popupElement=this.popup=null}updateEdited(e){if(!this.container)return;e.rect&&(this.#updates||={rect:this.data.rect.slice(0)});let{rect:t,popup:n}=e;t&&this.#setRectEdited(t);let r=this.#popupElement?.popup||this.popup;!r&&n?.text&&(this._createPopup(n),r=this.#popupElement.popup),r&&(r.updateEdited(e),n?.deleted&&(r.remove(),this.#popupElement=null,this.popup=null))}resetEdited(){this.#updates&&=(this.#setRectEdited(this.#updates.rect),this.#popupElement?.popup.resetEdited(),null)}#setRectEdited(e){let{container:{style:t},data:{rect:n,rotation:r},parent:{viewport:{rawDims:{pageWidth:i,pageHeight:a,pageX:o,pageY:s}}}}=this;n?.splice(0,4,...e),t.left=`${100*(e[0]-o)/i}%`,t.top=`${100*(a-e[3]+s)/a}%`,r===0?(t.width=`${100*(e[2]-e[0])/i}%`,t.height=`${100*(e[3]-e[1])/a}%`):this.setRotation(r)}_createContainer(e){let{data:t,parent:{page:n,viewport:r}}=this,i=document.createElement(`section`);i.setAttribute(`data-annotation-id`,t.id),!(this instanceof fi)&&!(this instanceof ui)&&(i.tabIndex=0);let{style:a}=i;if(a.zIndex=this.parent.zIndex,this.parent.zIndex+=2,t.alternativeText&&(i.title=t.alternativeText),t.noRotate&&i.classList.add(`norotate`),!t.rect||this instanceof yi){let{rotation:e}=t;return!t.hasOwnCanvas&&e!==0&&this.setRotation(e,i),i}let{width:o,height:s}=this;if(!e&&t.borderStyle.width>0){a.borderWidth=`${t.borderStyle.width}px`;let e=t.borderStyle.horizontalCornerRadius,n=t.borderStyle.verticalCornerRadius;switch(e>0||n>0?a.borderRadius=`calc(${e}px * var(--total-scale-factor)) / calc(${n}px * var(--total-scale-factor))`:this instanceof gi&&(a.borderRadius=`calc(${o}px * var(--total-scale-factor)) / calc(${s}px * var(--total-scale-factor))`),t.borderStyle.style){case ee.SOLID:a.borderStyle=`solid`;break;case ee.DASHED:a.borderStyle=`dashed`;break;case ee.BEVELED:P(`Unimplemented border style: beveled`);break;case ee.INSET:P(`Unimplemented border style: inset`);break;case ee.UNDERLINE:a.borderBottomStyle=`solid`;break;default:break}let r=t.borderColor||null;r?(this.#hasBorder=!0,a.borderColor=z.makeHexColor(r[0]|0,r[1]|0,r[2]|0)):a.borderWidth=0}let c=z.normalizeRect([t.rect[0],n.view[3]-t.rect[1]+n.view[1],t.rect[2],n.view[3]-t.rect[3]+n.view[1]]),{pageWidth:l,pageHeight:u,pageX:d,pageY:f}=r.rawDims;a.left=`${100*(c[0]-d)/l}%`,a.top=`${100*(c[1]-f)/u}%`;let{rotation:p}=t;return t.hasOwnCanvas||p===0?(a.width=`${100*o/l}%`,a.height=`${100*s/u}%`):this.setRotation(p,i),i}setRotation(e,t=this.container){if(!this.data.rect)return;let{pageWidth:n,pageHeight:r}=this.parent.viewport.rawDims,{width:i,height:a}=this;e%180!=0&&([i,a]=[a,i]),t.style.width=`${100*i/n}%`,t.style.height=`${100*a/r}%`,t.setAttribute(`data-main-rotation`,(360-e)%360)}get _commonActions(){let e=(e,t,n)=>{let r=n.detail[e],i=r[0],a=r.slice(1);n.target.style[t]=ni[`${i}_HTML`](a),this.annotationStorage.setValue(this.data.id,{[t]:ni[`${i}_rgb`](a)})};return L(this,`_commonActions`,{display:e=>{let{display:t}=e.detail,n=t%2==1;this.container.style.visibility=n?`hidden`:`visible`,this.annotationStorage.setValue(this.data.id,{noView:n,noPrint:t===1||t===2})},print:e=>{this.annotationStorage.setValue(this.data.id,{noPrint:!e.detail.print})},hidden:e=>{let{hidden:t}=e.detail;this.container.style.visibility=t?`hidden`:`visible`,this.annotationStorage.setValue(this.data.id,{noPrint:t,noView:t})},focus:e=>{setTimeout(()=>e.target.focus({preventScroll:!1}),0)},userName:e=>{e.target.title=e.detail.userName},readonly:e=>{e.target.disabled=e.detail.readonly},required:e=>{this._setRequired(e.target,e.detail.required)},bgColor:t=>{e(`bgColor`,`backgroundColor`,t)},fillColor:t=>{e(`fillColor`,`backgroundColor`,t)},fgColor:t=>{e(`fgColor`,`color`,t)},textColor:t=>{e(`textColor`,`color`,t)},borderColor:t=>{e(`borderColor`,`borderColor`,t)},strokeColor:t=>{e(`strokeColor`,`borderColor`,t)},rotation:e=>{let t=e.detail.rotation;this.setRotation(t),this.annotationStorage.setValue(this.data.id,{rotation:t})}})}_dispatchEventFromSandbox(e,t){let n=this._commonActions;for(let r of Object.keys(t.detail))(e[r]||n[r])?.(t)}_setDefaultPropertiesFromJS(e){if(!this.enableScripting)return;let t=this.annotationStorage.getRawValue(this.data.id);if(!t)return;let n=this._commonActions;for(let[r,i]of Object.entries(t)){let a=n[r];a&&(a({detail:{[r]:i},target:e}),delete t[r])}}_createQuadrilaterals(){if(!this.container)return;let{quadPoints:e}=this.data;if(!e)return;let[t,n,r,i]=this.data.rect.map(e=>Math.fround(e));if(e.length===8){let[a,o,s,c]=e.subarray(2,6);if(r===a&&i===o&&t===s&&n===c)return}let{style:a}=this.container,o;if(this.#hasBorder){let{borderColor:e,borderWidth:t}=a;a.borderWidth=0,o=[`url('data:image/svg+xml;utf8,`,`<svg xmlns="http://www.w3.org/2000/svg"`,` preserveAspectRatio="none" viewBox="0 0 1 1">`,`<g fill="transparent" stroke="${e}" stroke-width="${t}">`],this.container.classList.add(`hasBorder`)}let s=r-t,c=i-n,{svgFactory:l}=this,u=l.createElement(`svg`);u.classList.add(`quadrilateralsContainer`),u.setAttribute(`width`,0),u.setAttribute(`height`,0),u.role=`none`;let d=l.createElement(`defs`);u.append(d);let f=l.createElement(`clipPath`),p=`clippath_${this.data.id}`;f.setAttribute(`id`,p),f.setAttribute(`clipPathUnits`,`objectBoundingBox`),d.append(f);for(let n=2,r=e.length;n<r;n+=8){let r=e[n],a=e[n+1],u=e[n+2],d=e[n+3],p=l.createElement(`rect`),m=(u-t)/s,h=(i-a)/c,g=(r-u)/s,_=(a-d)/c;p.setAttribute(`x`,m),p.setAttribute(`y`,h),p.setAttribute(`width`,g),p.setAttribute(`height`,_),f.append(p),o?.push(`<rect vector-effect="non-scaling-stroke" x="${m}" y="${h}" width="${g}" height="${_}"/>`)}this.#hasBorder&&(o.push(`</g></svg>')`),a.backgroundImage=o.join(``)),this.container.append(u),this.container.style.clipPath=`url(#${p})`}_createPopup(e=null){let{data:t}=this,n,r;e?(n={str:e.text},r=e.date):(n=t.contentsObj,r=t.modificationDate),this.#popupElement=new yi({data:{color:t.color,titleObj:t.titleObj,modificationDate:r,contentsObj:n,richText:t.richText,parentRect:t.rect,borderStyle:0,id:`popup_${t.id}`,rotation:t.rotation,noRotate:!0},linkService:this.linkService,parent:this.parent,elements:[this]})}get hasPopupElement(){return!!(this.#popupElement||this.popup||this.data.popupRef)}get extraPopupElement(){return this.#popupElement}render(){F("Abstract method `AnnotationElement.render` called")}_getElementsByName(e,t=null){let n=[];if(this._fieldObjects){let r=this._fieldObjects[e];if(r)for(let{page:e,id:i,exportValues:a}of r){if(e===-1||i===t)continue;let r=typeof a==`string`?a:null,o=document.querySelector(`[data-element-id="${i}"]`);if(o&&!oi.has(o)){P(`_getElementsByName - element not allowed: ${i}`);continue}n.push({id:i,exportValue:r,domElement:o})}return n}for(let r of document.getElementsByName(e)){let{exportValue:e}=r,i=r.getAttribute(`data-element-id`);i!==t&&oi.has(r)&&n.push({id:i,exportValue:e,domElement:r})}return n}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){let e=this.getElementsToTriggerPopup();if(Array.isArray(e))for(let t of e)t.classList.add(`highlightArea`);else e.classList.add(`highlightArea`)}_editOnDoubleClick(){if(!this._isEditable)return;let{annotationEditorType:e,data:{id:t}}=this;this.container.addEventListener(`dblclick`,()=>{this.linkService.eventBus?.dispatch(`switchannotationeditormode`,{source:this,mode:e,editId:t,mustEnterInEditMode:!0})})}get width(){return this.data.rect[2]-this.data.rect[0]}get height(){return this.data.rect[3]-this.data.rect[1]}},li=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.editor=e.editor}render(){return this.container.className=`editorAnnotation`,this.container}createOrUpdatePopup(){let{editor:e}=this;e.hasComment&&this._createPopup(e.comment)}get hasCommentButton(){return this.enableComment&&this.editor.hasComment}get commentButtonPosition(){return this.editor.commentButtonPositionInPage}get commentText(){return this.editor.comment.text}set commentText(e){this.editor.comment=e,e||this.removePopup()}get commentData(){return this.editor.getData()}remove(){this.parent.removeAnnotation(this.data.id),this.container.remove(),this.container=null,this.removePopup()}},ui=class extends Q{constructor(e,t=null){super(e,{isRenderable:!0,ignoreBorder:!!t?.ignoreBorder,createQuadrilaterals:!0}),this.isTooltipOnly=e.data.isTooltipOnly}render(){let{data:e,linkService:t}=this,n=document.createElement(`a`);n.setAttribute(`data-element-id`,e.id);let r=!1;return e.url?(t.addLinkAttributes(n,e.url,e.newWindow),r=!0):e.action?(this._bindNamedAction(n,e.action,e.overlaidText),r=!0):e.attachment?(this.#bindAttachment(n,e.attachment,e.overlaidText,e.attachmentDest),r=!0):e.setOCGState?(this.#bindSetOCGState(n,e.setOCGState,e.overlaidText),r=!0):e.dest?(this._bindLink(n,e.dest,e.overlaidText),r=!0):(e.actions&&(e.actions.Action||e.actions[`Mouse Up`]||e.actions[`Mouse Down`])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(n,e),r=!0),e.resetForm?(this._bindResetFormAction(n,e.resetForm),r=!0):this.isTooltipOnly&&!r&&(this._bindLink(n,``),r=!0)),this.container.classList.add(`linkAnnotation`),r&&(this.contentElement=n,this.container.append(n)),this.container}#setInternalLink(){this.container.setAttribute(`data-internal-link`,``)}_bindLink(e,t,n=``){e.href=this.linkService.getDestinationHash(t),e.onclick=()=>(t&&this.linkService.goToDestination(t),!1),(t||t===``)&&this.#setInternalLink(),n&&(e.title=n)}_bindNamedAction(e,t,n=``){e.href=this.linkService.getAnchorUrl(``),e.onclick=()=>(this.linkService.executeNamedAction(t),!1),n&&(e.title=n),this.#setInternalLink()}#bindAttachment(e,t,n=``,r=null){e.href=this.linkService.getAnchorUrl(``),t.description?e.title=t.description:n&&(e.title=n),e.onclick=()=>(this.downloadManager?.openOrDownloadData(t.content,t.filename,r),!1),this.#setInternalLink()}#bindSetOCGState(e,t,n=``){e.href=this.linkService.getAnchorUrl(``),e.onclick=()=>(this.linkService.executeSetOCGState(t),!1),n&&(e.title=n),this.#setInternalLink()}_bindJSAction(e,t){e.href=this.linkService.getAnchorUrl(``);let n=new Map([[`Action`,`onclick`],[`Mouse Up`,`onmouseup`],[`Mouse Down`,`onmousedown`]]);for(let r of Object.keys(t.actions)){let i=n.get(r);i&&(e[i]=()=>(this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:t.id,name:r}}),!1))}t.overlaidText&&(e.title=t.overlaidText),e.onclick||=()=>!1,this.#setInternalLink()}_bindResetFormAction(e,t){let n=e.onclick;if(n||(e.href=this.linkService.getAnchorUrl(``)),this.#setInternalLink(),!this._fieldObjects){P('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),n||(e.onclick=()=>!1);return}e.onclick=()=>{n?.();let{fields:e,refs:r,include:i}=t,a=[];if(e.length!==0||r.length!==0){let t=new Set(r);for(let n of e){let e=this._fieldObjects[n]||[];for(let{id:n}of e)t.add(n)}for(let e of Object.values(this._fieldObjects))for(let n of e)t.has(n.id)===i&&a.push(n)}else for(let e of Object.values(this._fieldObjects))a.push(...e);let o=this.annotationStorage,s=[];for(let e of a){let{id:t}=e;switch(s.push(t),e.type){case`text`:{let n=e.defaultValue||``;o.setValue(t,{value:n});break}case`checkbox`:case`radiobutton`:{let n=e.defaultValue===e.exportValues;o.setValue(t,{value:n});break}case`combobox`:case`listbox`:{let n=e.defaultValue||``;o.setValue(t,{value:n});break}default:continue}let n=document.querySelector(`[data-element-id="${t}"]`);if(n){if(!oi.has(n)){P(`_bindResetFormAction - element not allowed: ${t}`);continue}}else continue;n.dispatchEvent(new Event(`resetform`))}return this.enableScripting&&this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:`app`,ids:s,name:`ResetForm`}}),!1}}},di=class extends Q{constructor(e){super(e,{isRenderable:!0})}render(){this.container.classList.add(`textAnnotation`);let e=document.createElement(`img`);return e.src=this.imageResourcesPath+`annotation-`+this.data.name.toLowerCase()+`.svg`,e.setAttribute(`data-l10n-id`,`pdfjs-text-annotation-type`),e.setAttribute(`data-l10n-args`,JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.append(e),this.container}},fi=class extends Q{render(){return this.container}showElementAndHideCanvas(e){this.data.hasOwnCanvas&&(e.previousSibling?.nodeName===`CANVAS`&&(e.previousSibling.hidden=!0),e.hidden=!1)}_getKeyModifier(e){return R.platform.isMac?e.metaKey:e.ctrlKey}_setEventListener(e,t,n,r,i){n.includes(`mouse`)?e.addEventListener(n,e=>{this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:this.data.id,name:r,value:i(e),shift:e.shiftKey,modifier:this._getKeyModifier(e)}})}):e.addEventListener(n,e=>{if(n===`blur`){if(!t.focused||!e.relatedTarget)return;t.focused=!1}else if(n===`focus`){if(t.focused)return;t.focused=!0}i&&this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:this.data.id,name:r,value:i(e)}})})}_setEventListeners(e,t,n,r){for(let[i,a]of n)(a===`Action`||this.data.actions?.[a])&&((a===`Focus`||a===`Blur`)&&(t||={focused:!1}),this._setEventListener(e,t,i,a,r),a===`Focus`&&!this.data.actions?.Blur?this._setEventListener(e,t,`blur`,`Blur`,null):a===`Blur`&&!this.data.actions?.Focus&&this._setEventListener(e,t,`focus`,`Focus`,null))}_setBackgroundColor(e){let t=this.data.backgroundColor||null;e.style.backgroundColor=t===null?`transparent`:z.makeHexColor(t[0],t[1],t[2])}_setTextStyle(e){let t=[`left`,`center`,`right`],{fontColor:n}=this.data.defaultAppearanceData,r=this.data.defaultAppearanceData.fontSize||ai,i=e.style,a,o=e=>Math.round(10*e)/10;if(this.data.multiLine){let e=Math.abs(this.data.rect[3]-this.data.rect[1]-2),t=Math.round(e/(C*r))||1,n=e/t;a=Math.min(r,o(n/C))}else{let e=Math.abs(this.data.rect[3]-this.data.rect[1]-2);a=Math.min(r,o(e/C))}i.fontSize=`calc(${a}px * var(--total-scale-factor))`,i.color=z.makeHexColor(n[0],n[1],n[2]),this.data.textAlignment!==null&&(i.textAlign=t[this.data.textAlignment])}_setRequired(e,t){t?e.setAttribute(`required`,!0):e.removeAttribute(`required`),e.setAttribute(`aria-required`,t)}},pi=class extends fi{constructor(e){let t=e.renderForms||e.data.hasOwnCanvas||!e.data.hasAppearance&&!!e.data.fieldValue;super(e,{isRenderable:t})}setPropertyOnSiblings(e,t,n,r){let i=this.annotationStorage;for(let a of this._getElementsByName(e.name,e.id))a.domElement&&(a.domElement[t]=n),i.setValue(a.id,{[r]:n})}render(){let e=this.annotationStorage,t=this.data.id;this.container.classList.add(`textWidgetAnnotation`);let n=null;if(this.renderForms){let r=e.getValue(t,{value:this.data.fieldValue}),i=r.value||``,a=e.getValue(t,{charLimit:this.data.maxLen}).charLimit;a&&i.length>a&&(i=i.slice(0,a));let o=r.formattedValue||this.data.textContent?.join(`
`)||null;o&&this.data.comb&&(o=o.replaceAll(/\s+/g,``));let s={userValue:i,formattedValue:o,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(n=document.createElement(`textarea`),n.textContent=o??i,this.data.doNotScroll&&(n.style.overflowY=`hidden`)):(n=document.createElement(`input`),n.type=this.data.password?`password`:`text`,n.setAttribute(`value`,o??i),this.data.doNotScroll&&(n.style.overflowX=`hidden`)),this.data.hasOwnCanvas&&(n.hidden=!0),oi.add(n),this.contentElement=n,n.setAttribute(`data-element-id`,t),n.disabled=this.data.readOnly,n.name=this.data.fieldName,n.tabIndex=0;let{datetimeFormat:c,datetimeType:l,timeStep:u}=this.data,d=!!l&&this.enableScripting;c&&(n.title=c),this._setRequired(n,this.data.required),a&&(n.maxLength=a),n.addEventListener(`input`,r=>{e.setValue(t,{value:r.target.value}),this.setPropertyOnSiblings(n,`value`,r.target.value,`value`),s.formattedValue=null}),n.addEventListener(`resetform`,e=>{n.value=s.userValue=this.data.defaultFieldValue??``,s.formattedValue=null});let f=e=>{let{formattedValue:t}=s;t!=null&&(e.target.value=t),e.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){n.addEventListener(`focus`,e=>{if(s.focused)return;let{target:t}=e;if(d&&(t.type=l,u&&(t.step=u)),s.userValue){let e=s.userValue;if(d)if(l===`time`){let n=new Date(e);t.value=[n.getHours(),n.getMinutes(),n.getSeconds()].map(e=>e.toString().padStart(2,`0`)).join(`:`)}else t.value=new Date(e-si).toISOString().split(l===`date`?`T`:`.`,1)[0];else t.value=e}s.lastCommittedValue=t.value,s.commitKey=1,this.data.actions?.Focus||(s.focused=!0)}),n.addEventListener(`updatefromsandbox`,n=>{this.showElementAndHideCanvas(n.target),this._dispatchEventFromSandbox({value(n){s.userValue=n.detail.value??``,d||e.setValue(t,{value:s.userValue.toString()}),n.target.value=s.userValue},formattedValue(n){let{formattedValue:r}=n.detail;s.formattedValue=r,r!=null&&n.target!==document.activeElement&&(n.target.value=r);let i={formattedValue:r};d&&(i.value=r),e.setValue(t,i)},selRange(e){e.target.setSelectionRange(...e.detail.selRange)},charLimit:n=>{let{charLimit:r}=n.detail,{target:i}=n;if(r===0){i.removeAttribute(`maxLength`);return}i.setAttribute(`maxLength`,r);let a=s.userValue;!a||a.length<=r||(a=a.slice(0,r),i.value=s.userValue=a,e.setValue(t,{value:a}),this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:t,name:`Keystroke`,value:a,willCommit:!0,commitKey:1,selStart:i.selectionStart,selEnd:i.selectionEnd}}))}},n)}),n.addEventListener(`keydown`,e=>{s.commitKey=1;let n=-1;if(e.key===`Escape`?n=0:e.key===`Enter`&&!this.data.multiLine?n=2:e.key===`Tab`&&(s.commitKey=3),n===-1)return;let{value:r}=e.target;s.lastCommittedValue!==r&&(s.lastCommittedValue=r,s.userValue=r,this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:t,name:`Keystroke`,value:r,willCommit:!0,commitKey:n,selStart:e.target.selectionStart,selEnd:e.target.selectionEnd}}))});let r=f;f=null,n.addEventListener(`blur`,e=>{if(!s.focused||!e.relatedTarget)return;this.data.actions?.Blur||(s.focused=!1);let{target:n}=e,{value:i}=n;if(d){if(i&&l===`time`){let e=i.split(`:`).map(e=>parseInt(e,10));i=new Date(2e3,0,1,e[0],e[1],e[2]||0).valueOf(),n.step=``}else i.includes(`T`)||(i=`${i}T00:00`),i=new Date(i).valueOf();n.type=`text`}s.userValue=i,s.lastCommittedValue!==i&&this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:t,name:`Keystroke`,value:i,willCommit:!0,commitKey:s.commitKey,selStart:e.target.selectionStart,selEnd:e.target.selectionEnd}}),r(e)}),this.data.actions?.Keystroke&&n.addEventListener(`beforeinput`,e=>{s.lastCommittedValue=null;let{data:n,target:r}=e,{value:i,selectionStart:a,selectionEnd:o}=r,c=a,l=o;switch(e.inputType){case`deleteWordBackward`:{let e=i.substring(0,a).match(/\w*[^\w]*$/);e&&(c-=e[0].length);break}case`deleteWordForward`:{let e=i.substring(a).match(/^[^\w]*\w*/);e&&(l+=e[0].length);break}case`deleteContentBackward`:a===o&&--c;break;case`deleteContentForward`:a===o&&(l+=1);break}e.preventDefault(),this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:t,name:`Keystroke`,value:i,change:n||``,willCommit:!1,selStart:c,selEnd:l}})}),this._setEventListeners(n,s,[[`focus`,`Focus`],[`blur`,`Blur`],[`mousedown`,`Mouse Down`],[`mouseenter`,`Mouse Enter`],[`mouseleave`,`Mouse Exit`],[`mouseup`,`Mouse Up`]],e=>e.target.value)}if(f&&n.addEventListener(`blur`,f),this.data.comb){let e=(this.data.rect[2]-this.data.rect[0])/a;n.classList.add(`comb`),n.style.letterSpacing=`calc(${e}px * var(--total-scale-factor) - 1ch)`}}else n=document.createElement(`div`),n.textContent=this.data.fieldValue,n.style.verticalAlign=`middle`,n.style.display=`table-cell`,this.data.hasOwnCanvas&&(n.hidden=!0);return this._setTextStyle(n),this._setBackgroundColor(n),this._setDefaultPropertiesFromJS(n),this.container.append(n),this.container}},mi=class extends fi{constructor(e){super(e,{isRenderable:!!e.data.hasOwnCanvas})}},hi=class extends fi{constructor(e){super(e,{isRenderable:e.renderForms})}render(){let e=this.annotationStorage,t=this.data,n=t.id,r=e.getValue(n,{value:t.exportValue===t.fieldValue}).value;typeof r==`string`&&(r=r!==`Off`,e.setValue(n,{value:r})),this.container.classList.add(`buttonWidgetAnnotation`,`checkBox`);let i=document.createElement(`input`);return oi.add(i),i.setAttribute(`data-element-id`,n),i.disabled=t.readOnly,this._setRequired(i,this.data.required),i.type=`checkbox`,i.name=t.fieldName,r&&i.setAttribute(`checked`,!0),i.setAttribute(`exportValue`,t.exportValue),i.tabIndex=0,i.addEventListener(`change`,r=>{let{name:i,checked:a}=r.target;for(let r of this._getElementsByName(i,n)){let n=a&&r.exportValue===t.exportValue;r.domElement&&(r.domElement.checked=n),e.setValue(r.id,{value:n})}e.setValue(n,{value:a})}),i.addEventListener(`resetform`,e=>{let n=t.defaultFieldValue||`Off`;e.target.checked=n===t.exportValue}),this.enableScripting&&this.hasJSActions&&(i.addEventListener(`updatefromsandbox`,t=>{this._dispatchEventFromSandbox({value(t){t.target.checked=t.detail.value!==`Off`,e.setValue(n,{value:t.target.checked})}},t)}),this._setEventListeners(i,null,[[`change`,`Validate`],[`change`,`Action`],[`focus`,`Focus`],[`blur`,`Blur`],[`mousedown`,`Mouse Down`],[`mouseenter`,`Mouse Enter`],[`mouseleave`,`Mouse Exit`],[`mouseup`,`Mouse Up`]],e=>e.target.checked)),this._setBackgroundColor(i),this._setDefaultPropertiesFromJS(i),this.container.append(i),this.container}},gi=class extends fi{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add(`buttonWidgetAnnotation`,`radioButton`);let e=this.annotationStorage,t=this.data,n=t.id,r=e.getValue(n,{value:t.fieldValue===t.buttonValue}).value;if(typeof r==`string`&&(r=r!==t.buttonValue,e.setValue(n,{value:r})),r)for(let r of this._getElementsByName(t.fieldName,n))e.setValue(r.id,{value:!1});let i=document.createElement(`input`);if(oi.add(i),i.setAttribute(`data-element-id`,n),i.disabled=t.readOnly,this._setRequired(i,this.data.required),i.type=`radio`,i.name=t.fieldName,r&&i.setAttribute(`checked`,!0),i.tabIndex=0,i.addEventListener(`change`,t=>{let{name:r,checked:i}=t.target;for(let t of this._getElementsByName(r,n))e.setValue(t.id,{value:!1});e.setValue(n,{value:i})}),i.addEventListener(`resetform`,e=>{let n=t.defaultFieldValue;e.target.checked=n!=null&&n===t.buttonValue}),this.enableScripting&&this.hasJSActions){let r=t.buttonValue;i.addEventListener(`updatefromsandbox`,t=>{this._dispatchEventFromSandbox({value:t=>{let i=r===t.detail.value;for(let r of this._getElementsByName(t.target.name)){let t=i&&r.id===n;r.domElement&&(r.domElement.checked=t),e.setValue(r.id,{value:t})}}},t)}),this._setEventListeners(i,null,[[`change`,`Validate`],[`change`,`Action`],[`focus`,`Focus`],[`blur`,`Blur`],[`mousedown`,`Mouse Down`],[`mouseenter`,`Mouse Enter`],[`mouseleave`,`Mouse Exit`],[`mouseup`,`Mouse Up`]],e=>e.target.checked)}return this._setBackgroundColor(i),this._setDefaultPropertiesFromJS(i),this.container.append(i),this.container}},_i=class extends ui{constructor(e){super(e,{ignoreBorder:e.data.hasAppearance})}render(){let e=super.render();e.classList.add(`buttonWidgetAnnotation`,`pushButton`);let t=e.lastChild;return this.enableScripting&&this.hasJSActions&&t&&(this._setDefaultPropertiesFromJS(t),t.addEventListener(`updatefromsandbox`,e=>{this._dispatchEventFromSandbox({},e)})),e}},vi=class extends fi{constructor(e){super(e,{isRenderable:e.renderForms})}render(){this.container.classList.add(`choiceWidgetAnnotation`);let e=this.annotationStorage,t=this.data.id,n=e.getValue(t,{value:this.data.fieldValue}),r=document.createElement(`select`);oi.add(r),r.setAttribute(`data-element-id`,t),r.disabled=this.data.readOnly,this._setRequired(r,this.data.required),r.name=this.data.fieldName,r.tabIndex=0;let i=this.data.combo&&this.data.options.length>0;this.data.combo||(r.size=this.data.options.length,this.data.multiSelect&&(r.multiple=!0)),r.addEventListener(`resetform`,e=>{let t=this.data.defaultFieldValue;for(let e of r.options)e.selected=e.value===t});for(let e of this.data.options){let t=document.createElement(`option`);t.textContent=e.displayValue,t.value=e.exportValue,n.value.includes(e.exportValue)&&(t.setAttribute(`selected`,!0),i=!1),r.append(t)}let a=null;if(i){let e=document.createElement(`option`);e.value=` `,e.setAttribute(`hidden`,!0),e.setAttribute(`selected`,!0),r.prepend(e),a=()=>{e.remove(),r.removeEventListener(`input`,a),a=null},r.addEventListener(`input`,a)}let o=e=>{let t=e?`value`:`textContent`,{options:n,multiple:i}=r;return i?Array.prototype.filter.call(n,e=>e.selected).map(e=>e[t]):n.selectedIndex===-1?null:n[n.selectedIndex][t]},s=o(!1),c=e=>{let t=e.target.options;return Array.prototype.map.call(t,e=>({displayValue:e.textContent,exportValue:e.value}))};return this.enableScripting&&this.hasJSActions?(r.addEventListener(`updatefromsandbox`,n=>{this._dispatchEventFromSandbox({value(n){a?.();let i=n.detail.value,c=new Set(Array.isArray(i)?i:[i]);for(let e of r.options)e.selected=c.has(e.value);e.setValue(t,{value:o(!0)}),s=o(!1)},multipleSelection(e){r.multiple=!0},remove(n){let i=r.options,a=n.detail.remove;i[a].selected=!1,r.remove(a),i.length>0&&Array.prototype.findIndex.call(i,e=>e.selected)===-1&&(i[0].selected=!0),e.setValue(t,{value:o(!0),items:c(n)}),s=o(!1)},clear(n){for(;r.length!==0;)r.remove(0);e.setValue(t,{value:null,items:[]}),s=o(!1)},insert(n){let{index:i,displayValue:a,exportValue:l}=n.detail.insert,u=r.children[i],d=document.createElement(`option`);d.textContent=a,d.value=l,u?u.before(d):r.append(d),e.setValue(t,{value:o(!0),items:c(n)}),s=o(!1)},items(n){let{items:i}=n.detail;for(;r.length!==0;)r.remove(0);for(let e of i){let{displayValue:t,exportValue:n}=e,i=document.createElement(`option`);i.textContent=t,i.value=n,r.append(i)}r.options.length>0&&(r.options[0].selected=!0),e.setValue(t,{value:o(!0),items:c(n)}),s=o(!1)},indices(n){let r=new Set(n.detail.indices);for(let e of n.target.options)e.selected=r.has(e.index);e.setValue(t,{value:o(!0)}),s=o(!1)},editable(e){e.target.disabled=!e.detail.editable}},n)}),r.addEventListener(`input`,n=>{let r=o(!0),i=o(!1);e.setValue(t,{value:r}),n.preventDefault(),this.linkService.eventBus?.dispatch(`dispatcheventinsandbox`,{source:this,detail:{id:t,name:`Keystroke`,value:s,change:i,changeEx:r,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(r,null,[[`focus`,`Focus`],[`blur`,`Blur`],[`mousedown`,`Mouse Down`],[`mouseenter`,`Mouse Enter`],[`mouseleave`,`Mouse Exit`],[`mouseup`,`Mouse Up`],[`input`,`Action`],[`input`,`Validate`]],e=>e.target.value)):r.addEventListener(`input`,function(n){e.setValue(t,{value:o(!0)})}),this.data.combo&&this._setTextStyle(r),this._setBackgroundColor(r),this._setDefaultPropertiesFromJS(r),this.container.append(r),this.container}},yi=class extends Q{constructor(e){let{data:t,elements:n,parent:r}=e,i=!!r._commentManager;if(super(e,{isRenderable:!i&&Q._hasPopupData(t)}),this.elements=n,i&&Q._hasPopupData(t)){let e=this.popup=this.#createPopup();for(let t of n)t.popup=e}else this.popup=null}#createPopup(){return new bi({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate||this.data.creationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open,commentManager:this.parent._commentManager})}render(){let{container:e}=this;e.classList.add(`popupAnnotation`),e.role=`comment`;let t=this.popup=this.#createPopup(),n=[];for(let e of this.elements)e.popup=t,e.container.ariaHasPopup=`dialog`,n.push(e.data.id),e.addHighlightArea();return this.container.setAttribute(`aria-controls`,n.map(e=>`${Ae}${e}`).join(`,`)),this.container}},bi=class{#commentManager=null;#boundKeyDown=this.#keyDown.bind(this);#boundHide=this.#hide.bind(this);#boundShow=this.#show.bind(this);#boundToggle=this.#toggle.bind(this);#color=null;#container=null;#contentsObj=null;#dateObj=null;#elements=null;#parent=null;#parentRect=null;#pinned=!1;#popup=null;#popupAbortController=null;#position=null;#commentButton=null;#commentButtonPosition=null;#popupPosition=null;#rect=null;#richText=null;#titleObj=null;#updates=null;#wasVisible=!1;#firstElement=null;#commentText=null;constructor({container:e,color:t,elements:n,titleObj:r,modificationDate:i,contentsObj:a,richText:o,parent:s,rect:c,parentRect:l,open:u,commentManager:d=null}){this.#container=e,this.#titleObj=r,this.#contentsObj=a,this.#richText=o,this.#parent=s,this.#color=t,this.#rect=c,this.#parentRect=l,this.#elements=n,this.#commentManager=d,this.#firstElement=n[0],this.#dateObj=Ke.toDateObject(i),this.trigger=n.flatMap(e=>e.getElementsToTriggerPopup()),d||(this.#addEventListeners(),this.#container.hidden=!0,u&&this.#toggle())}#addEventListeners(){if(this.#popupAbortController)return;this.#popupAbortController=new AbortController;let{signal:e}=this.#popupAbortController;for(let t of this.trigger)t.addEventListener(`click`,this.#boundToggle,{signal:e}),t.addEventListener(`pointerenter`,this.#boundShow,{signal:e}),t.addEventListener(`pointerleave`,this.#boundHide,{signal:e}),t.classList.add(`popupTriggerArea`);for(let t of this.#elements)t.container?.addEventListener(`keydown`,this.#boundKeyDown,{signal:e})}#setCommentButtonPosition(){let e=this.#elements.find(e=>e.hasCommentButton);e&&(this.#commentButtonPosition=e._normalizePoint(e.commentButtonPosition))}renderCommentButton(){if(this.#commentButton){this.#commentButton.parentNode||this.#firstElement.container.after(this.#commentButton);return}if(this.#commentButtonPosition||this.#setCommentButtonPosition(),!this.#commentButtonPosition)return;let{signal:e}=this.#popupAbortController=new AbortController,t=this.#firstElement.hasOwnCommentButton,n=()=>{this.#commentManager.toggleCommentPopup(this,!0,void 0,!t)},r=()=>{this.#commentManager.toggleCommentPopup(this,!1,!0,!t)},i=()=>{this.#commentManager.toggleCommentPopup(this,!1,!1)};if(t){this.#commentButton=this.#firstElement.container;for(let t of this.trigger)t.ariaHasPopup=`dialog`,t.ariaControls=`commentPopup`,t.addEventListener(`keydown`,this.#boundKeyDown,{signal:e}),t.addEventListener(`click`,n,{signal:e}),t.addEventListener(`pointerenter`,r,{signal:e}),t.addEventListener(`pointerleave`,i,{signal:e}),t.classList.add(`popupTriggerArea`)}else{let t=this.#commentButton=document.createElement(`button`);t.className=`annotationCommentButton`;let a=this.#firstElement.container;t.style.zIndex=a.style.zIndex+1,t.tabIndex=0,t.ariaHasPopup=`dialog`,t.ariaControls=`commentPopup`,t.setAttribute(`data-l10n-id`,`pdfjs-show-comment-button`),this.#updateColor(),this.#updateCommentButtonPosition(),t.addEventListener(`keydown`,this.#boundKeyDown,{signal:e}),t.addEventListener(`click`,n,{signal:e}),t.addEventListener(`pointerenter`,r,{signal:e}),t.addEventListener(`pointerleave`,i,{signal:e}),a.after(t)}}#updateCommentButtonPosition(){if(this.#firstElement.extraPopupElement&&!this.#firstElement.editor)return;this.#commentButton||this.renderCommentButton();let[e,t]=this.#commentButtonPosition,{style:n}=this.#commentButton;n.left=`calc(${e}%)`,n.top=`calc(${t}% - var(--comment-button-dim))`}#updateColor(){this.#firstElement.extraPopupElement||(this.#commentButton||this.renderCommentButton(),this.#commentButton.style.backgroundColor=this.commentButtonColor||``)}get commentButtonColor(){let{color:e,opacity:t}=this.#firstElement.commentData;return e?this.#parent._commentManager.makeCommentColor(e,t):null}focusCommentButton(){setTimeout(()=>{this.#commentButton?.focus()},0)}getData(){let{richText:e,color:t,opacity:n,creationDate:r,modificationDate:i}=this.#firstElement.commentData;return{contentsObj:{str:this.comment},richText:e,color:t,opacity:n,creationDate:r,modificationDate:i}}get elementBeforePopup(){return this.#commentButton}get comment(){return this.#commentText||=this.#firstElement.commentText,this.#commentText}set comment(e){e!==this.comment&&(this.#firstElement.commentText=this.#commentText=e)}focus(){this.#firstElement.container?.focus()}get parentBoundingClientRect(){return this.#firstElement.layer.getBoundingClientRect()}setCommentButtonStates({selected:e,hasPopup:t}){this.#commentButton&&(this.#commentButton.classList.toggle(`selected`,e),this.#commentButton.ariaExpanded=t)}setSelectedCommentButton(e){this.#commentButton.classList.toggle(`selected`,e)}get commentPopupPosition(){if(this.#popupPosition)return this.#popupPosition;let{x:e,y:t,height:n}=this.#commentButton.getBoundingClientRect(),{x:r,y:i,width:a,height:o}=this.#firstElement.layer.getBoundingClientRect();return[(e-r)/a,(t+n-i)/o]}set commentPopupPosition(e){this.#popupPosition=e}hasDefaultPopupPosition(){return this.#popupPosition===null}get commentButtonPosition(){return this.#commentButtonPosition}get commentButtonWidth(){return this.#commentButton.getBoundingClientRect().width/this.parentBoundingClientRect.width}editComment(e){let[t,n]=this.#popupPosition||this.commentButtonPosition.map(e=>e/100),r=this.parentBoundingClientRect,{x:i,y:a,width:o,height:s}=r;this.#commentManager.showDialog(null,this,i+t*o,a+n*s,{...e,parentDimensions:r})}render(){if(this.#popup)return;let e=this.#popup=document.createElement(`div`);if(e.className=`popup`,this.#color){let t=e.style.outlineColor=z.makeHexColor(...this.#color);e.style.backgroundColor=`color-mix(in srgb, ${t} 30%, white)`}let t=document.createElement(`span`);if(t.className=`header`,this.#titleObj?.str){let e=document.createElement(`span`);e.className=`title`,t.append(e),{dir:e.dir,str:e.textContent}=this.#titleObj}if(e.append(t),this.#dateObj){let e=document.createElement(`time`);e.className=`popupDate`,e.setAttribute(`data-l10n-id`,`pdfjs-annotation-date-time-string`),e.setAttribute(`data-l10n-args`,JSON.stringify({dateObj:this.#dateObj.valueOf()})),e.dateTime=this.#dateObj.toISOString(),t.append(e)}lt({html:this.#html||this.#contentsObj.str,dir:this.#contentsObj?.dir,className:`popupContent`},e),this.#container.append(e)}get#html(){let e=this.#richText,t=this.#contentsObj;return e?.str&&(!t?.str||t.str===e.str)&&this.#richText.html||null}get#fontSize(){return this.#html?.attributes?.style?.fontSize||0}get#fontColor(){return this.#html?.attributes?.style?.color||null}#makePopupContent(e){let t=[],n={str:e,html:{name:`div`,attributes:{dir:`auto`},children:[{name:`p`,children:t}]}},r={style:{color:this.#fontColor,fontSize:this.#fontSize?`calc(${this.#fontSize}px * var(--total-scale-factor))`:``}};for(let n of e.split(`
`))t.push({name:`span`,value:n,attributes:r});return n}#keyDown(e){e.altKey||e.shiftKey||e.ctrlKey||e.metaKey||(e.key===`Enter`||e.key===`Escape`&&this.#pinned)&&this.#toggle()}updateEdited({rect:e,popup:t,deleted:n}){if(this.#commentManager){n?(this.remove(),this.#commentText=null):t&&(t.deleted?this.remove():(this.#updateColor(),this.#commentText=t.text)),e&&(this.#commentButtonPosition=null,this.#setCommentButtonPosition(),this.#updateCommentButtonPosition());return}if(n||t?.deleted){this.remove();return}this.#addEventListeners(),this.#updates||={contentsObj:this.#contentsObj,richText:this.#richText},e&&(this.#position=null),t&&t.text&&(this.#richText=this.#makePopupContent(t.text),this.#dateObj=Ke.toDateObject(t.date),this.#contentsObj=null),this.#popup?.remove(),this.#popup=null}resetEdited(){this.#updates&&({contentsObj:this.#contentsObj,richText:this.#richText}=this.#updates,this.#updates=null,this.#popup?.remove(),this.#popup=null,this.#position=null)}remove(){if(this.#popupAbortController?.abort(),this.#popupAbortController=null,this.#popup?.remove(),this.#popup=null,this.#wasVisible=!1,this.#pinned=!1,this.#commentButton?.remove(),this.#commentButton=null,this.trigger)for(let e of this.trigger)e.classList.remove(`popupTriggerArea`)}#setPosition(){if(this.#position!==null)return;let{page:{view:e},viewport:{rawDims:{pageWidth:t,pageHeight:n,pageX:r,pageY:i}}}=this.#parent,a=!!this.#parentRect,o=a?this.#parentRect:this.#rect;for(let e of this.#elements)if(!o||z.intersect(e.data.rect,o)!==null){o=e.data.rect,a=!0;break}let s=z.normalizeRect([o[0],e[3]-o[1]+e[1],o[2],e[3]-o[3]+e[1]]),c=a?o[2]-o[0]+5:0,l=s[0]+c,u=s[1];this.#position=[100*(l-r)/t,100*(u-i)/n];let{style:d}=this.#container;d.left=`${this.#position[0]}%`,d.top=`${this.#position[1]}%`}#toggle(){if(this.#commentManager){this.#commentManager.toggleCommentPopup(this,!1);return}this.#pinned=!this.#pinned,this.#pinned?(this.#show(),this.#container.addEventListener(`click`,this.#boundToggle),this.#container.addEventListener(`keydown`,this.#boundKeyDown)):(this.#hide(),this.#container.removeEventListener(`click`,this.#boundToggle),this.#container.removeEventListener(`keydown`,this.#boundKeyDown))}#show(){this.#popup||this.render(),this.isVisible?this.#pinned&&this.#container.classList.add(`focused`):(this.#setPosition(),this.#container.hidden=!1,this.#container.style.zIndex=parseInt(this.#container.style.zIndex)+1e3)}#hide(){this.#container.classList.remove(`focused`),!(this.#pinned||!this.isVisible)&&(this.#container.hidden=!0,this.#container.style.zIndex=parseInt(this.#container.style.zIndex)-1e3)}forceHide(){this.#wasVisible=this.isVisible,this.#wasVisible&&(this.#container.hidden=!0)}maybeShow(){this.#commentManager||(this.#addEventListeners(),this.#wasVisible&&(this.#popup||this.#show(),this.#wasVisible=!1,this.#container.hidden=!1))}get isVisible(){return this.#commentManager?!1:this.#container.hidden===!1}},xi=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.textContent=e.data.textContent,this.textPosition=e.data.textPosition,this.annotationEditorType=D.FREETEXT}render(){if(this.container.classList.add(`freeTextAnnotation`),this.textContent){let e=this.contentElement=document.createElement(`div`);e.classList.add(`annotationTextContent`),e.setAttribute(`role`,`comment`);for(let t of this.textContent){let n=document.createElement(`span`);n.textContent=t,e.append(n)}this.container.append(e)}return!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this._editOnDoubleClick(),this.container}},Si=class extends Q{#line=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add(`lineAnnotation`);let{data:e,width:t,height:n}=this,r=this.svgFactory.create(t,n,!0),i=this.#line=this.svgFactory.createElement(`svg:line`);return i.setAttribute(`x1`,e.rect[2]-e.lineCoordinates[0]),i.setAttribute(`y1`,e.rect[3]-e.lineCoordinates[1]),i.setAttribute(`x2`,e.rect[2]-e.lineCoordinates[2]),i.setAttribute(`y2`,e.rect[3]-e.lineCoordinates[3]),i.setAttribute(`stroke-width`,e.borderStyle.width||1),i.setAttribute(`stroke`,`transparent`),i.setAttribute(`fill`,`transparent`),r.append(i),this.container.append(r),!e.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#line}addHighlightArea(){this.container.classList.add(`highlightArea`)}},Ci=class extends Q{#square=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add(`squareAnnotation`);let{data:e,width:t,height:n}=this,r=this.svgFactory.create(t,n,!0),i=e.borderStyle.width,a=this.#square=this.svgFactory.createElement(`svg:rect`);return a.setAttribute(`x`,i/2),a.setAttribute(`y`,i/2),a.setAttribute(`width`,t-i),a.setAttribute(`height`,n-i),a.setAttribute(`stroke-width`,i||1),a.setAttribute(`stroke`,`transparent`),a.setAttribute(`fill`,`transparent`),r.append(a),this.container.append(r),!e.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#square}addHighlightArea(){this.container.classList.add(`highlightArea`)}},wi=class extends Q{#circle=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add(`circleAnnotation`);let{data:e,width:t,height:n}=this,r=this.svgFactory.create(t,n,!0),i=e.borderStyle.width,a=this.#circle=this.svgFactory.createElement(`svg:ellipse`);return a.setAttribute(`cx`,t/2),a.setAttribute(`cy`,n/2),a.setAttribute(`rx`,t/2-i/2),a.setAttribute(`ry`,n/2-i/2),a.setAttribute(`stroke-width`,i||1),a.setAttribute(`stroke`,`transparent`),a.setAttribute(`fill`,`transparent`),r.append(a),this.container.append(r),!e.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#circle}addHighlightArea(){this.container.classList.add(`highlightArea`)}},Ti=class extends Q{#polyline=null;constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName=`polylineAnnotation`,this.svgElementName=`svg:polyline`}render(){this.container.classList.add(this.containerClassName);let{data:{rect:e,vertices:t,borderStyle:n,popupRef:r},width:i,height:a}=this;if(!t)return this.container;let o=this.svgFactory.create(i,a,!0),s=[];for(let n=0,r=t.length;n<r;n+=2){let r=t[n]-e[0],i=e[3]-t[n+1];s.push(`${r},${i}`)}s=s.join(` `);let c=this.#polyline=this.svgFactory.createElement(this.svgElementName);return c.setAttribute(`points`,s),c.setAttribute(`stroke-width`,n.width||1),c.setAttribute(`stroke`,`transparent`),c.setAttribute(`fill`,`transparent`),o.append(c),this.container.append(o),!r&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#polyline}addHighlightArea(){this.container.classList.add(`highlightArea`)}},Ei=class extends Ti{constructor(e){super(e),this.containerClassName=`polygonAnnotation`,this.svgElementName=`svg:polygon`}},Di=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add(`caretAnnotation`),!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}},Oi=class extends Q{#polylinesGroupElement=null;#polylines=[];constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName=`inkAnnotation`,this.svgElementName=`svg:polyline`,this.annotationEditorType=this.data.it===`InkHighlight`?D.HIGHLIGHT:D.INK}#getTransform(e,t){switch(e){case 90:return{transform:`rotate(90) translate(${-t[0]},${t[1]}) scale(1,-1)`,width:t[3]-t[1],height:t[2]-t[0]};case 180:return{transform:`rotate(180) translate(${-t[2]},${t[1]}) scale(1,-1)`,width:t[2]-t[0],height:t[3]-t[1]};case 270:return{transform:`rotate(270) translate(${-t[2]},${t[3]}) scale(1,-1)`,width:t[3]-t[1],height:t[2]-t[0]};default:return{transform:`translate(${-t[0]},${t[3]}) scale(1,-1)`,width:t[2]-t[0],height:t[3]-t[1]}}}render(){this.container.classList.add(this.containerClassName);let{data:{rect:e,rotation:t,inkLists:n,borderStyle:r,popupRef:i}}=this,{transform:a,width:o,height:s}=this.#getTransform(t,e),c=this.svgFactory.create(o,s,!0),l=this.#polylinesGroupElement=this.svgFactory.createElement(`svg:g`);c.append(l),l.setAttribute(`stroke-width`,r.width||1),l.setAttribute(`stroke-linecap`,`round`),l.setAttribute(`stroke-linejoin`,`round`),l.setAttribute(`stroke-miterlimit`,10),l.setAttribute(`stroke`,`transparent`),l.setAttribute(`fill`,`transparent`),l.setAttribute(`transform`,a);for(let e=0,t=n.length;e<t;e++){let t=this.svgFactory.createElement(this.svgElementName);this.#polylines.push(t),t.setAttribute(`points`,n[e].join(`,`)),l.append(t)}return!i&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.append(c),this._editOnDoubleClick(),this.container}updateEdited(e){super.updateEdited(e);let{thickness:t,points:n,rect:r}=e,i=this.#polylinesGroupElement;if(t>=0&&i.setAttribute(`stroke-width`,t||1),n)for(let e=0,t=this.#polylines.length;e<t;e++)this.#polylines[e].setAttribute(`points`,n[e].join(`,`));if(r){let{transform:e,width:t,height:n}=this.#getTransform(this.data.rotation,r);i.parentElement.setAttribute(`viewBox`,`0 0 ${t} ${n}`),i.setAttribute(`transform`,e)}}getElementsToTriggerPopup(){return this.#polylines}addHighlightArea(){this.container.classList.add(`highlightArea`)}},ki=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=D.HIGHLIGHT}render(){let{data:{overlaidText:e,popupRef:t}}=this;if(!t&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add(`highlightAnnotation`),this._editOnDoubleClick(),e){let t=document.createElement(`mark`);t.classList.add(`overlaidText`),t.textContent=e,this.container.append(t)}return this.container}},Ai=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){let{data:{overlaidText:e,popupRef:t}}=this;if(!t&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add(`underlineAnnotation`),e){let t=document.createElement(`u`);t.classList.add(`overlaidText`),t.textContent=e,this.container.append(t)}return this.container}},ji=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){let{data:{overlaidText:e,popupRef:t}}=this;if(!t&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add(`squigglyAnnotation`),e){let t=document.createElement(`u`);t.classList.add(`overlaidText`),t.textContent=e,this.container.append(t)}return this.container}},Mi=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){let{data:{overlaidText:e,popupRef:t}}=this;if(!t&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add(`strikeoutAnnotation`),e){let t=document.createElement(`s`);t.classList.add(`overlaidText`),t.textContent=e,this.container.append(t)}return this.container}},Ni=class extends Q{constructor(e){super(e,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=D.STAMP}render(){return this.container.classList.add(`stampAnnotation`),this.container.setAttribute(`role`,`img`),!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this._editOnDoubleClick(),this.container}},Pi=class extends Q{#trigger=null;constructor(e){super(e,{isRenderable:!0});let{file:t}=this.data;this.filename=t.filename,this.content=t.content,this.linkService.eventBus?.dispatch(`fileattachmentannotation`,{source:this,...t})}render(){this.container.classList.add(`fileAttachmentAnnotation`);let{container:e,data:t}=this,n;t.hasAppearance||t.fillAlpha===0?n=document.createElement(`div`):(n=document.createElement(`img`),n.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(t.name)?`paperclip`:`pushpin`}.svg`,t.fillAlpha&&t.fillAlpha<1&&(n.style=`filter: opacity(${Math.round(t.fillAlpha*100)}%);`)),n.addEventListener(`dblclick`,this.#download.bind(this)),this.#trigger=n;let{isMac:r}=R.platform;return e.addEventListener(`keydown`,e=>{e.key===`Enter`&&(r?e.metaKey:e.ctrlKey)&&this.#download()}),!t.popupRef&&this.hasPopupData?(this.hasOwnCommentButton=!0,this._createPopup()):n.classList.add(`popupTriggerArea`),e.append(n),e}getElementsToTriggerPopup(){return this.#trigger}addHighlightArea(){this.container.classList.add(`highlightArea`)}#download(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}},Fi=class e{#accessibilityManager=null;#annotationCanvasMap=null;#annotationStorage=null;#editableAnnotations=new Map;#structTreeLayer=null;#linkService=null;#elements=[];#hasAriaAttributesFromStructTree=!1;constructor({div:e,accessibilityManager:t,annotationCanvasMap:n,annotationEditorUIManager:r,page:i,viewport:a,structTreeLayer:o,commentManager:s,linkService:c,annotationStorage:l}){this.div=e,this.#accessibilityManager=t,this.#annotationCanvasMap=n,this.#structTreeLayer=o||null,this.#linkService=c||null,this.#annotationStorage=l||new At,this.page=i,this.viewport=a,this.zIndex=0,this._annotationEditorUIManager=r,this._commentManager=s||null}hasEditableAnnotations(){return this.#editableAnnotations.size>0}async render(e){let{annotations:t}=e,n=this.div;Ze(n,this.viewport);let r=new Map,i=[],a={data:null,layer:n,linkService:this.#linkService,downloadManager:e.downloadManager,imageResourcesPath:e.imageResourcesPath||``,renderForms:e.renderForms!==!1,svgFactory:new ii,annotationStorage:this.#annotationStorage,enableComment:e.enableComment===!0,enableScripting:e.enableScripting===!0,hasJSActions:e.hasJSActions,fieldObjects:e.fieldObjects,parent:this,elements:null};for(let e of t){if(e.noHTML)continue;let t=e.annotationType===N.POPUP;if(t){let t=r.get(e.id);if(!t)continue;if(!this._commentManager){i.push(e);continue}a.elements=t}else if(e.rect[2]===e.rect[0]||e.rect[3]===e.rect[1])continue;a.data=e;let n=ci.create(a);if(!n.isRenderable)continue;if(!t&&(this.#elements.push(n),e.popupRef)){let t=r.get(e.popupRef);t?t.push(n):r.set(e.popupRef,[n])}let o=n.render();e.hidden&&(o.style.visibility=`hidden`),n._isEditable&&(this.#editableAnnotations.set(n.data.id,n),this._annotationEditorUIManager?.renderAnnotationElement(n))}await this.#addElementsToDOM();for(let e of i){let t=a.elements=r.get(e.id);a.data=e;let n=ci.create(a);if(!n.isRenderable)continue;let i=n.render();n.contentElement.id=`${Ae}${e.id}`,e.hidden&&(i.style.visibility=`hidden`),t.at(-1).container.after(i)}this.#setAnnotationCanvasMap()}async#addElementsToDOM(){if(this.#elements.length===0)return;this.div.replaceChildren();let e=[];if(!this.#hasAriaAttributesFromStructTree){this.#hasAriaAttributesFromStructTree=!0;for(let{contentElement:t,data:{id:n}}of this.#elements){let r=t.id=`${Ae}${n}`;e.push(this.#structTreeLayer?.getAriaAttributes(r).then(e=>{if(e)for(let[n,r]of e)t.setAttribute(n,r)}))}}this.#elements.sort(({data:{rect:[e,t,n,r]}},{data:{rect:[i,a,o,s]}})=>{if(e===n&&t===r)return 1;if(i===o&&a===s)return-1;let c=r,l=t,u=(t+r)/2,d=s,f=a,p=(a+s)/2;if(u>=d&&p<=l)return-1;if(p>=c&&u<=f)return 1;let m=(e+n)/2,h=(i+o)/2;return m-h});let t=document.createDocumentFragment();for(let e of this.#elements)t.append(e.container),this._commentManager?(e.extraPopupElement?.popup||e.popup)?.renderCommentButton():e.extraPopupElement&&t.append(e.extraPopupElement.render());if(this.div.append(t),await Promise.all(e),this.#accessibilityManager)for(let e of this.#elements)this.#accessibilityManager.addPointerInTextLayer(e.contentElement,!1)}async addLinkAnnotations(t){let n={data:null,layer:this.div,linkService:this.#linkService,svgFactory:new ii,parent:this};for(let r of t){r.borderStyle||=e._defaultBorderStyle,n.data=r;let t=ci.create(n);t.isRenderable&&(t.render(),t.contentElement.id=`${Ae}${r.id}`,this.#elements.push(t))}await this.#addElementsToDOM()}update({viewport:e}){let t=this.div;this.viewport=e,Ze(t,{rotation:e.rotation}),this.#setAnnotationCanvasMap(),t.hidden=!1}#setAnnotationCanvasMap(){if(!this.#annotationCanvasMap)return;let e=this.div;for(let[t,n]of this.#annotationCanvasMap){let r=e.querySelector(`[data-annotation-id="${t}"]`);if(!r)continue;n.className=`annotationContent`;let{firstChild:i}=r;i?i.nodeName===`CANVAS`?i.replaceWith(n):i.classList.contains(`annotationContent`)?i.after(n):i.before(n):r.append(n);let a=this.#editableAnnotations.get(t);a&&(a._hasNoCanvas?(this._annotationEditorUIManager?.setMissingCanvas(t,r.id,n),a._hasNoCanvas=!1):a.canvas=n)}this.#annotationCanvasMap.clear()}getEditableAnnotations(){return Array.from(this.#editableAnnotations.values())}getEditableAnnotation(e){return this.#editableAnnotations.get(e)}addFakeAnnotation(e){let{div:t}=this,{id:n,rotation:r}=e,i=new li({data:{id:n,rect:e.getPDFRect(),rotation:r},editor:e,layer:t,parent:this,enableComment:!!this._commentManager,linkService:this.#linkService,annotationStorage:this.#annotationStorage});return i.render(),i.contentElement.id=`${Ae}${n}`,i.createOrUpdatePopup(),this.#elements.push(i),i}removeAnnotation(e){let t=this.#elements.findIndex(t=>t.data.id===e);if(t<0)return;let[n]=this.#elements.splice(t,1);this.#accessibilityManager?.removePointerInTextLayer(n.contentElement)}updateFakeAnnotations(e){if(e.length!==0){for(let t of e)t.updateFakeAnnotationElement(this);this.#addElementsToDOM()}}togglePointerEvents(e=!1){this.div.classList.toggle(`disabled`,!e)}static get _defaultBorderStyle(){return L(this,`_defaultBorderStyle`,Object.freeze({width:1,rawWidth:1,style:ee.SOLID,dashArray:[3],horizontalCornerRadius:0,verticalCornerRadius:0}))}},Ii=/\r\n?|\n/g,Li=class e extends G{#content=``;#editorDivId=`${this.id}-editor`;#editModeAC=null;#fontSize;_colorPicker=null;static _freeTextDefaultContent=``;static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){let t=e.prototype,n=e=>e.isEmpty(),r=bt.TRANSLATE_SMALL,i=bt.TRANSLATE_BIG;return L(this,`_keyboardManager`,new vt([[[`ctrl+s`,`mac+meta+s`,`ctrl+p`,`mac+meta+p`],t.commitOrRemove,{bubbles:!0}],[[`ctrl+Enter`,`mac+meta+Enter`,`Escape`,`mac+Escape`],t.commitOrRemove],[[`ArrowLeft`,`mac+ArrowLeft`],t._translateEmpty,{args:[-r,0],checker:n}],[[`ctrl+ArrowLeft`,`mac+shift+ArrowLeft`],t._translateEmpty,{args:[-i,0],checker:n}],[[`ArrowRight`,`mac+ArrowRight`],t._translateEmpty,{args:[r,0],checker:n}],[[`ctrl+ArrowRight`,`mac+shift+ArrowRight`],t._translateEmpty,{args:[i,0],checker:n}],[[`ArrowUp`,`mac+ArrowUp`],t._translateEmpty,{args:[0,-r],checker:n}],[[`ctrl+ArrowUp`,`mac+shift+ArrowUp`],t._translateEmpty,{args:[0,-i],checker:n}],[[`ArrowDown`,`mac+ArrowDown`],t._translateEmpty,{args:[0,r],checker:n}],[[`ctrl+ArrowDown`,`mac+shift+ArrowDown`],t._translateEmpty,{args:[0,i],checker:n}]]))}static _type=`freetext`;static _editorType=D.FREETEXT;constructor(t){super({...t,name:`freeTextEditor`}),this.color=t.color||e._defaultColor||G._defaultLineColor,this.#fontSize=t.fontSize||e._defaultFontSize,this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-freetext-added-alert`),this.canAddComment=!1}static initialize(e,t){G.initialize(e,t);let n=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(n.getPropertyValue(`--freetext-padding`))}static updateDefaultParams(t,n){switch(t){case O.FREETEXT_SIZE:e._defaultFontSize=n;break;case O.FREETEXT_COLOR:e._defaultColor=n;break}}updateParams(e,t){switch(e){case O.FREETEXT_SIZE:this.#updateFontSize(t);break;case O.FREETEXT_COLOR:this.#updateColor(t);break}}static get defaultPropertiesToUpdate(){return[[O.FREETEXT_SIZE,e._defaultFontSize],[O.FREETEXT_COLOR,e._defaultColor||G._defaultLineColor]]}get propertiesToUpdate(){return[[O.FREETEXT_SIZE,this.#fontSize],[O.FREETEXT_COLOR,this.color]]}get toolbarButtons(){return this._colorPicker||=new $r(this),[[`colorPicker`,this._colorPicker]]}get colorType(){return O.FREETEXT_COLOR}#updateFontSize(e){let t=e=>{this.editorDiv.style.fontSize=`calc(${e}px * var(--total-scale-factor))`,this.translate(0,-(e-this.#fontSize)*this.parentScale),this.#fontSize=e,this.#setEditorDimensions()},n=this.#fontSize;this.addCommands({cmd:t.bind(this,e),undo:t.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:O.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})}onUpdatedColor(){this.editorDiv.style.color=this.color,this._colorPicker?.update(this.color),super.onUpdatedColor()}#updateColor(e){let t=e=>{this.color=e,this.onUpdatedColor()},n=this.color;this.addCommands({cmd:t.bind(this,e),undo:t.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:O.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})}_translateEmpty(e,t){this._uiManager.translateSelectedEditors(e,t,!0)}getInitialTranslation(){let t=this.parentScale;return[-e._internalPadding*t,-(e._internalPadding+this.#fontSize)*t]}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){if(!super.enableEditMode())return!1;this.overlayDiv.classList.remove(`enabled`),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute(`aria-activedescendant`),this.#editModeAC=new AbortController;let e=this._uiManager.combinedSignal(this.#editModeAC);return this.editorDiv.addEventListener(`keydown`,this.editorDivKeydown.bind(this),{signal:e}),this.editorDiv.addEventListener(`focus`,this.editorDivFocus.bind(this),{signal:e}),this.editorDiv.addEventListener(`blur`,this.editorDivBlur.bind(this),{signal:e}),this.editorDiv.addEventListener(`input`,this.editorDivInput.bind(this),{signal:e}),this.editorDiv.addEventListener(`paste`,this.editorDivPaste.bind(this),{signal:e}),!0}disableEditMode(){return super.disableEditMode()?(this.overlayDiv.classList.add(`enabled`),this.editorDiv.contentEditable=!1,this.div.setAttribute(`aria-activedescendant`,this.#editorDivId),this._isDraggable=!0,this.#editModeAC?.abort(),this.#editModeAC=null,this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add(`freetextEditing`),!0):!1}focusin(e){this._focusEventsAllowed&&(super.focusin(e),e.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(e){this.width||(this.enableEditMode(),e&&this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null)}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===``}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add(`freetextEditing`)),super.remove()}#extractText(){let t=[];this.editorDiv.normalize();let n=null;for(let r of this.editorDiv.childNodes)n?.nodeType===Node.TEXT_NODE&&r.nodeName===`BR`||(t.push(e.#getNodeContent(r)),n=r);return t.join(`
`)}#setEditorDimensions(){let[e,t]=this.parentDimensions,n;if(this.isAttachedToDOM)n=this.div.getBoundingClientRect();else{let{currentLayer:e,div:t}=this,r=t.style.display,i=t.classList.contains(`hidden`);t.classList.remove(`hidden`),t.style.display=`hidden`,e.div.append(this.div),n=t.getBoundingClientRect(),t.remove(),t.style.display=r,t.classList.toggle(`hidden`,i)}this.rotation%180==this.parentRotation%180?(this.width=n.width/e,this.height=n.height/t):(this.width=n.height/e,this.height=n.width/t),this.fixAndSetPosition()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();let e=this.#content,t=this.#content=this.#extractText().trimEnd();if(e===t)return;let n=e=>{if(this.#content=e,!e){this.remove();return}this.#setContent(),this._uiManager.rebuild(this),this.#setEditorDimensions()};this.addCommands({cmd:()=>{n(t)},undo:()=>{n(e)},mustExec:!1}),this.#setEditorDimensions()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}keydown(e){e.target===this.div&&e.key===`Enter`&&(this.enterInEditMode(),e.preventDefault())}editorDivKeydown(t){e._keyboardManager.exec(this,t)}editorDivFocus(e){this.isEditing=!0}editorDivBlur(e){this.isEditing=!1}editorDivInput(e){this.parent.div.classList.toggle(`freetextEditing`,this.isEmpty())}disableEditing(){this.editorDiv.setAttribute(`role`,`comment`),this.editorDiv.removeAttribute(`aria-multiline`)}enableEditing(){this.editorDiv.setAttribute(`role`,`textbox`),this.editorDiv.setAttribute(`aria-multiline`,!0)}get canChangeContent(){return!0}render(){if(this.div)return this.div;let e,t;(this._isCopy||this.annotationElementId)&&(e=this.x,t=this.y),super.render(),this.editorDiv=document.createElement(`div`),this.editorDiv.className=`internal`,this.editorDiv.setAttribute(`id`,this.#editorDivId),this.editorDiv.setAttribute(`data-l10n-id`,`pdfjs-free-text2`),this.editorDiv.setAttribute(`data-l10n-attrs`,`default-content`),this.enableEditing(),this.editorDiv.contentEditable=!0;let{style:n}=this.editorDiv;if(n.fontSize=`calc(${this.#fontSize}px * var(--total-scale-factor))`,n.color=this.color,this.div.append(this.editorDiv),this.overlayDiv=document.createElement(`div`),this.overlayDiv.classList.add(`overlay`,`enabled`),this.div.append(this.overlayDiv),this._isCopy||this.annotationElementId){let[n,r]=this.parentDimensions;if(this.annotationElementId){let{position:i}=this._initialData,[a,o]=this.getInitialTranslation();[a,o]=this.pageTranslationToScreen(a,o);let[s,c]=this.pageDimensions,[l,u]=this.pageTranslation,d,f;switch(this.rotation){case 0:d=e+(i[0]-l)/s,f=t+this.height-(i[1]-u)/c;break;case 90:d=e+(i[0]-l)/s,f=t-(i[1]-u)/c,[a,o]=[o,-a];break;case 180:d=e-this.width+(i[0]-l)/s,f=t-(i[1]-u)/c,[a,o]=[-a,-o];break;case 270:d=e+(i[0]-l-this.height*c)/s,f=t+(i[1]-u-this.width*s)/c,[a,o]=[-o,a];break}this.setAt(d*n,f*r,a,o)}else this._moveAfterPaste(e,t);this.#setContent(),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}static#getNodeContent(e){return(e.nodeType===Node.TEXT_NODE?e.nodeValue:e.innerText).replaceAll(Ii,``)}editorDivPaste(t){let n=t.clipboardData||window.clipboardData,{types:r}=n;if(r.length===1&&r[0]===`text/plain`)return;t.preventDefault();let i=e.#deserializeContent(n.getData(`text`)||``).replaceAll(Ii,`
`);if(!i)return;let a=window.getSelection();if(!a.rangeCount)return;this.editorDiv.normalize(),a.deleteFromDocument();let o=a.getRangeAt(0);if(!i.includes(`
`)){o.insertNode(document.createTextNode(i)),this.editorDiv.normalize(),a.collapseToStart();return}let{startContainer:s,startOffset:c}=o,l=[],u=[];if(s.nodeType===Node.TEXT_NODE){let t=s.parentElement;if(u.push(s.nodeValue.slice(c).replaceAll(Ii,``)),t!==this.editorDiv){let n=l;for(let r of this.editorDiv.childNodes){if(r===t){n=u;continue}n.push(e.#getNodeContent(r))}}l.push(s.nodeValue.slice(0,c).replaceAll(Ii,``))}else if(s===this.editorDiv){let t=l,n=0;for(let r of this.editorDiv.childNodes)n++===c&&(t=u),t.push(e.#getNodeContent(r))}this.#content=`${l.join(`
`)}${i}${u.join(`
`)}`,this.#setContent();let d=new Range,f=Math.sumPrecise(l.map(e=>e.length));for(let{firstChild:e}of this.editorDiv.childNodes)if(e.nodeType===Node.TEXT_NODE){let t=e.nodeValue.length;if(f<=t){d.setStart(e,f),d.setEnd(e,f);break}f-=t}a.removeAllRanges(),a.addRange(d)}#setContent(){if(this.editorDiv.replaceChildren(),this.#content)for(let e of this.#content.split(`
`)){let t=document.createElement(`div`);t.append(e?document.createTextNode(e):document.createElement(`br`)),this.editorDiv.append(t)}}#serializeContent(){return this.#content.replaceAll(`\xA0`,` `)}static#deserializeContent(e){return e.replaceAll(` `,`\xA0`)}get contentDiv(){return this.editorDiv}getPDFRect(){let t=e._internalPadding*this.parentScale;return this.getRect(t,t)}static async deserialize(t,n,r){let i=null;if(t instanceof xi){let{data:{defaultAppearanceData:{fontSize:e,fontColor:n},rect:r,rotation:a,id:o,popupRef:s,richText:c,contentsObj:l,creationDate:u,modificationDate:d},textContent:f,textPosition:p,parent:{page:{pageNumber:m}}}=t;if(!f||f.length===0)return null;i=t={annotationType:D.FREETEXT,color:Array.from(n),fontSize:e,value:f.join(`
`),position:p,pageIndex:m-1,rect:r.slice(0),rotation:a,annotationElementId:o,id:o,deleted:!1,popupRef:s,comment:l?.str||null,richText:c,creationDate:u,modificationDate:d}}let a=await super.deserialize(t,n,r);return a.#fontSize=t.fontSize,a.color=z.makeHexColor(...t.color),a.#content=e.#deserializeContent(t.value),a._initialData=i,t.comment&&a.setCommentData(t),a}serialize(e=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();let t=G._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.color),n=Object.assign(super.serialize(e),{color:t,fontSize:this.#fontSize,value:this.#serializeContent()});return this.addComment(n),e?(n.isCopy=!0,n):this.annotationElementId&&!this.#hasElementChanged(n)?null:(n.id=this.annotationElementId,n)}#hasElementChanged(e){let{value:t,fontSize:n,color:r,pageIndex:i}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||e.value!==t||e.fontSize!==n||e.color.some((e,t)=>e!==r[t])||e.pageIndex!==i}renderAnnotationElement(e){let t=super.renderAnnotationElement(e);if(!t)return null;let{style:n}=t;n.fontSize=`calc(${this.#fontSize}px * var(--total-scale-factor))`,n.color=this.color,t.replaceChildren();for(let e of this.#content.split(`
`)){let n=document.createElement(`div`);n.append(e?document.createTextNode(e):document.createElement(`br`)),t.append(n)}return e.updateEdited({rect:this.getPDFRect(),popup:this._uiManager.hasCommentManager()||this.hasEditedComment?this.comment:{text:this.#content}}),t}resetAnnotationElement(e){super.resetAnnotationElement(e),e.resetEdited()}},$=class{static PRECISION=1e-4;toSVGPath(){F("Abstract method `toSVGPath` must be implemented.")}get box(){F("Abstract getter `box` must be implemented.")}serialize(e,t){F("Abstract method `serialize` must be implemented.")}static _rescale(e,t,n,r,i,a){a||=new Float32Array(e.length);for(let o=0,s=e.length;o<s;o+=2)a[o]=t+e[o]*r,a[o+1]=n+e[o+1]*i;return a}static _rescaleAndSwap(e,t,n,r,i,a){a||=new Float32Array(e.length);for(let o=0,s=e.length;o<s;o+=2)a[o]=t+e[o+1]*r,a[o+1]=n+e[o]*i;return a}static _translate(e,t,n,r){r||=new Float32Array(e.length);for(let i=0,a=e.length;i<a;i+=2)r[i]=t+e[i],r[i+1]=n+e[i+1];return r}static svgRound(e){return Math.round(e*1e4)}static _normalizePoint(e,t,n,r,i){switch(i){case 90:return[1-t/n,e/r];case 180:return[1-e/n,1-t/r];case 270:return[t/n,1-e/r];default:return[e/n,t/r]}}static _normalizePagePoint(e,t,n){switch(n){case 90:return[1-t,e];case 180:return[1-e,1-t];case 270:return[t,1-e];default:return[e,t]}}static createBezierPoints(e,t,n,r,i,a){return[(e+5*n)/6,(t+5*r)/6,(5*n+i)/6,(5*r+a)/6,(n+i)/2,(r+a)/2]}},Ri=class e{#box;#bottom=[];#innerMargin;#isLTR;#top=[];#last=new Float32Array(18);#lastX;#lastY;#min;#min_dist;#scaleFactor;#thickness;#points=[];static#MIN_DIST=8;static#MIN_DIFF=2;static#MIN=e.#MIN_DIST+e.#MIN_DIFF;constructor({x:t,y:n},r,i,a,o,s=0){this.#box=r,this.#thickness=a*i,this.#isLTR=o,this.#last.set([NaN,NaN,NaN,NaN,t,n],6),this.#innerMargin=s,this.#min_dist=e.#MIN_DIST*i,this.#min=e.#MIN*i,this.#scaleFactor=i,this.#points.push(t,n)}isEmpty(){return isNaN(this.#last[8])}#getLastCoords(){let e=this.#last.subarray(4,6),t=this.#last.subarray(16,18),[n,r,i,a]=this.#box;return[(this.#lastX+(e[0]-t[0])/2-n)/i,(this.#lastY+(e[1]-t[1])/2-r)/a,(this.#lastX+(t[0]-e[0])/2-n)/i,(this.#lastY+(t[1]-e[1])/2-r)/a]}add({x:e,y:t}){this.#lastX=e,this.#lastY=t;let[n,r,i,a]=this.#box,[o,s,c,l]=this.#last.subarray(8,12),u=e-c,d=t-l,f=Math.hypot(u,d);if(f<this.#min)return!1;let p=f-this.#min_dist,m=p/f,h=m*u,g=m*d,_=o,v=s;o=c,s=l,c+=h,l+=g,this.#points?.push(e,t);let y=-g/p,b=h/p,x=y*this.#thickness,S=b*this.#thickness;return this.#last.set(this.#last.subarray(2,8),0),this.#last.set([c+x,l+S],4),this.#last.set(this.#last.subarray(14,18),12),this.#last.set([c-x,l-S],16),isNaN(this.#last[6])?(this.#top.length===0&&(this.#last.set([o+x,s+S],2),this.#top.push(NaN,NaN,NaN,NaN,(o+x-n)/i,(s+S-r)/a),this.#last.set([o-x,s-S],14),this.#bottom.push(NaN,NaN,NaN,NaN,(o-x-n)/i,(s-S-r)/a)),this.#last.set([_,v,o,s,c,l],6),!this.isEmpty()):(this.#last.set([_,v,o,s,c,l],6),Math.abs(Math.atan2(v-s,_-o)-Math.atan2(g,h))<Math.PI/2?([o,s,c,l]=this.#last.subarray(2,6),this.#top.push(NaN,NaN,NaN,NaN,((o+c)/2-n)/i,((s+l)/2-r)/a),[o,s,_,v]=this.#last.subarray(14,18),this.#bottom.push(NaN,NaN,NaN,NaN,((_+o)/2-n)/i,((v+s)/2-r)/a),!0):([_,v,o,s,c,l]=this.#last.subarray(0,6),this.#top.push(((_+5*o)/6-n)/i,((v+5*s)/6-r)/a,((5*o+c)/6-n)/i,((5*s+l)/6-r)/a,((o+c)/2-n)/i,((s+l)/2-r)/a),[c,l,o,s,_,v]=this.#last.subarray(12,18),this.#bottom.push(((_+5*o)/6-n)/i,((v+5*s)/6-r)/a,((5*o+c)/6-n)/i,((5*s+l)/6-r)/a,((o+c)/2-n)/i,((s+l)/2-r)/a),!0))}toSVGPath(){if(this.isEmpty())return``;let e=this.#top,t=this.#bottom;if(isNaN(this.#last[6])&&!this.isEmpty())return this.#toSVGPathTwoPoints();let n=[];n.push(`M${e[4]} ${e[5]}`);for(let t=6;t<e.length;t+=6)isNaN(e[t])?n.push(`L${e[t+4]} ${e[t+5]}`):n.push(`C${e[t]} ${e[t+1]} ${e[t+2]} ${e[t+3]} ${e[t+4]} ${e[t+5]}`);this.#toSVGPathEnd(n);for(let e=t.length-6;e>=6;e-=6)isNaN(t[e])?n.push(`L${t[e+4]} ${t[e+5]}`):n.push(`C${t[e]} ${t[e+1]} ${t[e+2]} ${t[e+3]} ${t[e+4]} ${t[e+5]}`);return this.#toSVGPathStart(n),n.join(` `)}#toSVGPathTwoPoints(){let[e,t,n,r]=this.#box,[i,a,o,s]=this.#getLastCoords();return`M${(this.#last[2]-e)/n} ${(this.#last[3]-t)/r} L${(this.#last[4]-e)/n} ${(this.#last[5]-t)/r} L${i} ${a} L${o} ${s} L${(this.#last[16]-e)/n} ${(this.#last[17]-t)/r} L${(this.#last[14]-e)/n} ${(this.#last[15]-t)/r} Z`}#toSVGPathStart(e){let t=this.#bottom;e.push(`L${t[4]} ${t[5]} Z`)}#toSVGPathEnd(e){let[t,n,r,i]=this.#box,a=this.#last.subarray(4,6),o=this.#last.subarray(16,18),[s,c,l,u]=this.#getLastCoords();e.push(`L${(a[0]-t)/r} ${(a[1]-n)/i} L${s} ${c} L${l} ${u} L${(o[0]-t)/r} ${(o[1]-n)/i}`)}newFreeDrawOutline(e,t,n,r,i,a){return new zi(e,t,n,r,i,a)}getOutlines(){let e=this.#top,t=this.#bottom,n=this.#last,[r,i,a,o]=this.#box,s=new Float32Array((this.#points?.length??0)+2);for(let e=0,t=s.length-2;e<t;e+=2)s[e]=(this.#points[e]-r)/a,s[e+1]=(this.#points[e+1]-i)/o;if(s[s.length-2]=(this.#lastX-r)/a,s[s.length-1]=(this.#lastY-i)/o,isNaN(n[6])&&!this.isEmpty())return this.#getOutlineTwoPoints(s);let c=new Float32Array(this.#top.length+24+this.#bottom.length),l=e.length;for(let t=0;t<l;t+=2){if(isNaN(e[t])){c[t]=c[t+1]=NaN;continue}c[t]=e[t],c[t+1]=e[t+1]}l=this.#getOutlineEnd(c,l);for(let e=t.length-6;e>=6;e-=6)for(let n=0;n<6;n+=2){if(isNaN(t[e+n])){c[l]=c[l+1]=NaN,l+=2;continue}c[l]=t[e+n],c[l+1]=t[e+n+1],l+=2}return this.#getOutlineStart(c,l),this.newFreeDrawOutline(c,s,this.#box,this.#scaleFactor,this.#innerMargin,this.#isLTR)}#getOutlineTwoPoints(e){let t=this.#last,[n,r,i,a]=this.#box,[o,s,c,l]=this.#getLastCoords(),u=new Float32Array(36);return u.set([NaN,NaN,NaN,NaN,(t[2]-n)/i,(t[3]-r)/a,NaN,NaN,NaN,NaN,(t[4]-n)/i,(t[5]-r)/a,NaN,NaN,NaN,NaN,o,s,NaN,NaN,NaN,NaN,c,l,NaN,NaN,NaN,NaN,(t[16]-n)/i,(t[17]-r)/a,NaN,NaN,NaN,NaN,(t[14]-n)/i,(t[15]-r)/a],0),this.newFreeDrawOutline(u,e,this.#box,this.#scaleFactor,this.#innerMargin,this.#isLTR)}#getOutlineStart(e,t){let n=this.#bottom;return e.set([NaN,NaN,NaN,NaN,n[4],n[5]],t),t+=6}#getOutlineEnd(e,t){let n=this.#last.subarray(4,6),r=this.#last.subarray(16,18),[i,a,o,s]=this.#box,[c,l,u,d]=this.#getLastCoords();return e.set([NaN,NaN,NaN,NaN,(n[0]-i)/o,(n[1]-a)/s,NaN,NaN,NaN,NaN,c,l,NaN,NaN,NaN,NaN,u,d,NaN,NaN,NaN,NaN,(r[0]-i)/o,(r[1]-a)/s],t),t+=24}},zi=class extends ${#box;#bbox=new Float32Array(4);#innerMargin;#isLTR;#points;#scaleFactor;#outline;constructor(e,t,n,r,i,a){super(),this.#outline=e,this.#points=t,this.#box=n,this.#scaleFactor=r,this.#innerMargin=i,this.#isLTR=a,this.firstPoint=[NaN,NaN],this.lastPoint=[NaN,NaN],this.#computeMinMax(a);let[o,s,c,l]=this.#bbox;for(let t=0,n=e.length;t<n;t+=2)e[t]=(e[t]-o)/c,e[t+1]=(e[t+1]-s)/l;for(let e=0,n=t.length;e<n;e+=2)t[e]=(t[e]-o)/c,t[e+1]=(t[e+1]-s)/l}toSVGPath(){let e=[`M${this.#outline[4]} ${this.#outline[5]}`];for(let t=6,n=this.#outline.length;t<n;t+=6){if(isNaN(this.#outline[t])){e.push(`L${this.#outline[t+4]} ${this.#outline[t+5]}`);continue}e.push(`C${this.#outline[t]} ${this.#outline[t+1]} ${this.#outline[t+2]} ${this.#outline[t+3]} ${this.#outline[t+4]} ${this.#outline[t+5]}`)}return e.push(`Z`),e.join(` `)}serialize([e,t,n,r],i){let a=n-e,o=r-t,s,c;switch(i){case 0:s=$._rescale(this.#outline,e,r,a,-o),c=$._rescale(this.#points,e,r,a,-o);break;case 90:s=$._rescaleAndSwap(this.#outline,e,t,a,o),c=$._rescaleAndSwap(this.#points,e,t,a,o);break;case 180:s=$._rescale(this.#outline,n,t,-a,o),c=$._rescale(this.#points,n,t,-a,o);break;case 270:s=$._rescaleAndSwap(this.#outline,n,r,-a,-o),c=$._rescaleAndSwap(this.#points,n,r,-a,-o);break}return{outline:Array.from(s),points:[Array.from(c)]}}#computeMinMax(e){let t=this.#outline,n=t[4],r=t[5],i=[n,r,n,r],a=n,o=r,s=n,c=r,l=e?Math.max:Math.min,u=new Float32Array(4);for(let e=6,d=t.length;e<d;e+=6){let d=t[e+4],f=t[e+5];isNaN(t[e])?(z.pointBoundingBox(d,f,i),o>f?(a=d,o=f):o===f&&(a=l(a,d)),c<f?(s=d,c=f):c===f&&(s=l(s,d))):(u[0]=u[1]=1/0,u[2]=u[3]=-1/0,z.bezierBoundingBox(n,r,...t.slice(e,e+6),u),z.rectBoundingBox(u[0],u[1],u[2],u[3],i),o>u[1]?(a=u[0],o=u[1]):o===u[1]&&(a=l(a,u[0])),c<u[3]?(s=u[2],c=u[3]):c===u[3]&&(s=l(s,u[2]))),n=d,r=f}let d=this.#bbox;d[0]=i[0]-this.#innerMargin,d[1]=i[1]-this.#innerMargin,d[2]=i[2]-i[0]+2*this.#innerMargin,d[3]=i[3]-i[1]+2*this.#innerMargin,this.firstPoint=[a,o],this.lastPoint=[s,c]}get box(){return this.#bbox}newOutliner(e,t,n,r,i,a=0){return new Ri(e,t,n,r,i,a)}getNewOutline(e,t){let[n,r,i,a]=this.#bbox,[o,s,c,l]=this.#box,u=i*c,d=a*l,f=n*c+o,p=r*l+s,m=this.newOutliner({x:this.#points[0]*u+f,y:this.#points[1]*d+p},this.#box,this.#scaleFactor,e,this.#isLTR,t??this.#innerMargin);for(let e=2;e<this.#points.length;e+=2)m.add({x:this.#points[e]*u+f,y:this.#points[e+1]*d+p});return m.getOutlines()}},Bi=class{#box;#firstPoint;#lastPoint;#verticalEdges=[];#intervals=[];constructor(e,t=0,n=0,r=!0){let i=[1/0,1/0,-1/0,-1/0],a=10**-4;for(let{x:n,y:r,width:o,height:s}of e){let e=Math.floor((n-t)/a)*a,c=Math.ceil((n+o+t)/a)*a,l=Math.floor((r-t)/a)*a,u=Math.ceil((r+s+t)/a)*a,d=[e,l,u,!0],f=[c,l,u,!1];this.#verticalEdges.push(d,f),z.rectBoundingBox(e,l,c,u,i)}let o=i[2]-i[0]+2*n,s=i[3]-i[1]+2*n,c=i[0]-n,l=i[1]-n,u=r?-1/0:1/0,d=1/0,f=this.#verticalEdges.at(r?-1:-2),p=[f[0],f[2]];for(let e of this.#verticalEdges){let[t,n,i,a]=e;!a&&r?n<d?(d=n,u=t):n===d&&(u=Math.max(u,t)):a&&!r&&(n<d?(d=n,u=t):n===d&&(u=Math.min(u,t))),e[0]=(t-c)/o,e[1]=(n-l)/s,e[2]=(i-l)/s}this.#box=new Float32Array([c,l,o,s]),this.#firstPoint=[u,d],this.#lastPoint=p}getOutlines(){this.#verticalEdges.sort((e,t)=>e[0]-t[0]||e[1]-t[1]||e[2]-t[2]);let e=[];for(let t of this.#verticalEdges)t[3]?(e.push(...this.#breakEdge(t)),this.#insert(t)):(this.#remove(t),e.push(...this.#breakEdge(t)));return this.#getOutlines(e)}#getOutlines(e){let t=[],n=new Set;for(let n of e){let[e,r,i]=n;t.push([e,r,n],[e,i,n])}t.sort((e,t)=>e[1]-t[1]||e[0]-t[0]);for(let e=0,r=t.length;e<r;e+=2){let r=t[e][2],i=t[e+1][2];r.push(i),i.push(r),n.add(r),n.add(i)}let r=[],i;for(;n.size>0;){let e=n.values().next().value,[t,a,o,s,c]=e;n.delete(e);let l=t,u=a;for(i=[t,o],r.push(i);;){let e;if(n.has(s))e=s;else if(n.has(c))e=c;else break;n.delete(e),[t,a,o,s,c]=e,l!==t&&(i.push(l,u,t,u===a?a:o),l=t),u=u===a?o:a}i.push(l,u)}return new Vi(r,this.#box,this.#firstPoint,this.#lastPoint)}#binarySearch(e){let t=this.#intervals,n=0,r=t.length-1;for(;n<=r;){let i=n+r>>1,a=t[i][0];if(a===e)return i;a<e?n=i+1:r=i-1}return r+1}#insert([,e,t]){let n=this.#binarySearch(e);this.#intervals.splice(n,0,[e,t])}#remove([,e,t]){let n=this.#binarySearch(e);for(let r=n;r<this.#intervals.length;r++){let[n,i]=this.#intervals[r];if(n!==e)break;if(n===e&&i===t){this.#intervals.splice(r,1);return}}for(let r=n-1;r>=0;r--){let[n,i]=this.#intervals[r];if(n!==e)break;if(n===e&&i===t){this.#intervals.splice(r,1);return}}}#breakEdge(e){let[t,n,r]=e,i=[[t,n,r]],a=this.#binarySearch(r);for(let e=0;e<a;e++){let[n,r]=this.#intervals[e];for(let e=0,a=i.length;e<a;e++){let[,o,s]=i[e];if(!(r<=o||s<=n)){if(o>=n){if(s>r)i[e][1]=r;else{if(a===1)return[];i.splice(e,1),e--,a--}continue}i[e][2]=n,s>r&&i.push([t,r,s])}}}return i}},Vi=class extends ${#box;#outlines;constructor(e,t,n,r){super(),this.#outlines=e,this.#box=t,this.firstPoint=n,this.lastPoint=r}toSVGPath(){let e=[];for(let t of this.#outlines){let[n,r]=t;e.push(`M${n} ${r}`);for(let i=2;i<t.length;i+=2){let a=t[i],o=t[i+1];a===n?(e.push(`V${o}`),r=o):o===r&&(e.push(`H${a}`),n=a)}e.push(`Z`)}return e.join(` `)}serialize([e,t,n,r],i){let a=[],o=n-e,s=r-t;for(let t of this.#outlines){let n=Array(t.length);for(let i=0;i<t.length;i+=2)n[i]=e+t[i]*o,n[i+1]=r-t[i+1]*s;a.push(n)}return a}get box(){return this.#box}get classNamesForOutlining(){return[`highlightOutline`]}},Hi=class extends Ri{newFreeDrawOutline(e,t,n,r,i,a){return new Ui(e,t,n,r,i,a)}},Ui=class extends zi{newOutliner(e,t,n,r,i,a=0){return new Hi(e,t,n,r,i,a)}},Wi=class e extends G{#anchorNode=null;#anchorOffset=0;#boxes;#clipPathId=null;#colorPicker=null;#focusOutlines=null;#focusNode=null;#focusOffset=0;#highlightDiv=null;#highlightOutlines=null;#id=null;#isFreeHighlight=!1;#firstPoint=null;#lastPoint=null;#outlineId=null;#text=``;#thickness;#methodOfCreation=``;static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _type=`highlight`;static _editorType=D.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId=``;static get _keyboardManager(){let t=e.prototype;return L(this,`_keyboardManager`,new vt([[[`ArrowLeft`,`mac+ArrowLeft`],t._moveCaret,{args:[0]}],[[`ArrowRight`,`mac+ArrowRight`],t._moveCaret,{args:[1]}],[[`ArrowUp`,`mac+ArrowUp`],t._moveCaret,{args:[2]}],[[`ArrowDown`,`mac+ArrowDown`],t._moveCaret,{args:[3]}]]))}constructor(t){super({...t,name:`highlightEditor`}),this.color=t.color||e._defaultColor,this.#thickness=t.thickness||e._defaultThickness,this.opacity=t.opacity||e._defaultOpacity,this.#boxes=t.boxes||null,this.#methodOfCreation=t.methodOfCreation||``,this.#text=t.text||``,this._isDraggable=!1,this.defaultL10nId=`pdfjs-editor-highlight-editor`,t.highlightId>-1?(this.#isFreeHighlight=!0,this.#createFreeOutlines(t),this.#addToDrawLayer()):this.#boxes&&(this.#anchorNode=t.anchorNode,this.#anchorOffset=t.anchorOffset,this.#focusNode=t.focusNode,this.#focusOffset=t.focusOffset,this.#createOutlines(),this.#addToDrawLayer(),this.rotate(this.rotation)),this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-highlight-added-alert`)}get telemetryInitialData(){return{action:`added`,type:this.#isFreeHighlight?`free_highlight`:`highlight`,color:this._uiManager.getNonHCMColorName(this.color),thickness:this.#thickness,methodOfCreation:this.#methodOfCreation}}get telemetryFinalData(){return{type:`highlight`,color:this._uiManager.getNonHCMColorName(this.color)}}static computeTelemetryFinalData(e){return{numberOfColors:e.get(`color`).size}}#createOutlines(){this.#highlightOutlines=new Bi(this.#boxes,.001).getOutlines(),[this.x,this.y,this.width,this.height]=this.#highlightOutlines.box,this.#focusOutlines=new Bi(this.#boxes,.0025,.001,this._uiManager.direction===`ltr`).getOutlines();let{firstPoint:e}=this.#highlightOutlines;this.#firstPoint=[(e[0]-this.x)/this.width,(e[1]-this.y)/this.height];let{lastPoint:t}=this.#focusOutlines;this.#lastPoint=[(t[0]-this.x)/this.width,(t[1]-this.y)/this.height]}#createFreeOutlines({highlightOutlines:t,highlightId:n,clipPathId:r}){if(this.#highlightOutlines=t,this.#focusOutlines=t.getNewOutline(this.#thickness/2+1.5,.0025),n>=0)this.#id=n,this.#clipPathId=r,this.parent.drawLayer.finalizeDraw(n,{bbox:t.box,path:{d:t.toSVGPath()}}),this.#outlineId=this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:this.#focusOutlines.box,path:{d:this.#focusOutlines.toSVGPath()}},!0);else if(this.parent){let n=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(this.#id,{bbox:e.#rotateBbox(this.#highlightOutlines.box,(n-this.rotation+360)%360),path:{d:t.toSVGPath()}}),this.parent.drawLayer.updateProperties(this.#outlineId,{bbox:e.#rotateBbox(this.#focusOutlines.box,n),path:{d:this.#focusOutlines.toSVGPath()}})}let[i,a,o,s]=t.box;switch(this.rotation){case 0:this.x=i,this.y=a,this.width=o,this.height=s;break;case 90:{let[e,t]=this.parentDimensions;this.x=a,this.y=1-i,this.width=o*t/e,this.height=s*e/t;break}case 180:this.x=1-i,this.y=1-a,this.width=o,this.height=s;break;case 270:{let[e,t]=this.parentDimensions;this.x=1-a,this.y=i,this.width=o*t/e,this.height=s*e/t;break}}let{firstPoint:c}=t;this.#firstPoint=[(c[0]-i)/o,(c[1]-a)/s];let{lastPoint:l}=this.#focusOutlines;this.#lastPoint=[(l[0]-i)/o,(l[1]-a)/s]}static initialize(t,n){G.initialize(t,n),e._defaultColor||=n.highlightColors?.values().next().value||`#fff066`}static updateDefaultParams(t,n){switch(t){case O.HIGHLIGHT_COLOR:e._defaultColor=n;break;case O.HIGHLIGHT_THICKNESS:e._defaultThickness=n;break}}translateInPage(e,t){}get toolbarPosition(){return this.#lastPoint}get commentButtonPosition(){return this.#firstPoint}updateParams(e,t){switch(e){case O.HIGHLIGHT_COLOR:this.#updateColor(t);break;case O.HIGHLIGHT_THICKNESS:this.#updateThickness(t);break}}static get defaultPropertiesToUpdate(){return[[O.HIGHLIGHT_COLOR,e._defaultColor],[O.HIGHLIGHT_THICKNESS,e._defaultThickness]]}get propertiesToUpdate(){return[[O.HIGHLIGHT_COLOR,this.color||e._defaultColor],[O.HIGHLIGHT_THICKNESS,this.#thickness||e._defaultThickness],[O.HIGHLIGHT_FREE,this.#isFreeHighlight]]}onUpdatedColor(){this.parent?.drawLayer.updateProperties(this.#id,{root:{fill:this.color,"fill-opacity":this.opacity}}),this.#colorPicker?.updateColor(this.color),super.onUpdatedColor()}#updateColor(t){let n=(e,t)=>{this.color=e,this.opacity=t,this.onUpdatedColor()},r=this.color,i=this.opacity;this.addCommands({cmd:n.bind(this,t,e._defaultOpacity),undo:n.bind(this,r,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:O.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:`color_changed`,color:this._uiManager.getNonHCMColorName(t)},!0)}#updateThickness(e){let t=this.#thickness,n=e=>{this.#thickness=e,this.#changeThickness(e)};this.addCommands({cmd:n.bind(this,e),undo:n.bind(this,t),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:O.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:`thickness_changed`,thickness:e},!0)}get toolbarButtons(){return this._uiManager.highlightColors?[[`colorPicker`,this.#colorPicker=new Qr({editor:this})]]:super.toolbarButtons}disableEditing(){super.disableEditing(),this.div.classList.toggle(`disabled`,!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle(`disabled`,!1)}fixAndSetPosition(){return super.fixAndSetPosition(this.#getRotation())}getBaseTranslation(){return[0,0]}getRect(e,t){return super.getRect(e,t,this.#getRotation())}onceAdded(e){this.annotationElementId||this.parent.addUndoableEditor(this),e&&this.div.focus()}remove(){this.#cleanDrawLayer(),this._reportTelemetry({action:`deleted`}),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.#addToDrawLayer(),this.isAttachedToDOM||this.parent.add(this)))}setParent(e){let t=!1;this.parent&&!e?this.#cleanDrawLayer():e&&(this.#addToDrawLayer(e),t=!this.parent&&this.div?.classList.contains(`selectedEditor`)),super.setParent(e),this.show(this._isVisible),t&&this.select()}#changeThickness(e){this.#isFreeHighlight&&(this.#createFreeOutlines({highlightOutlines:this.#highlightOutlines.getNewOutline(e/2)}),this.fixAndSetPosition(),this.setDims())}#cleanDrawLayer(){this.#id===null||!this.parent||(this.parent.drawLayer.remove(this.#id),this.#id=null,this.parent.drawLayer.remove(this.#outlineId),this.#outlineId=null)}#addToDrawLayer(e=this.parent){this.#id===null&&({id:this.#id,clipPathId:this.#clipPathId}=e.drawLayer.draw({bbox:this.#highlightOutlines.box,root:{viewBox:`0 0 1 1`,fill:this.color,"fill-opacity":this.opacity},rootClass:{highlight:!0,free:this.#isFreeHighlight},path:{d:this.#highlightOutlines.toSVGPath()}},!1,!0),this.#outlineId=e.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:this.#isFreeHighlight},bbox:this.#focusOutlines.box,path:{d:this.#focusOutlines.toSVGPath()}},this.#isFreeHighlight),this.#highlightDiv&&(this.#highlightDiv.style.clipPath=this.#clipPathId))}static#rotateBbox([e,t,n,r],i){switch(i){case 90:return[1-t-r,e,r,n];case 180:return[1-e-n,1-t-r,n,r];case 270:return[t,1-e-n,r,n]}return[e,t,n,r]}rotate(t){let{drawLayer:n}=this.parent,r;this.#isFreeHighlight?(t=(t-this.rotation+360)%360,r=e.#rotateBbox(this.#highlightOutlines.box,t)):r=e.#rotateBbox([this.x,this.y,this.width,this.height],t),n.updateProperties(this.#id,{bbox:r,root:{"data-main-rotation":t}}),n.updateProperties(this.#outlineId,{bbox:e.#rotateBbox(this.#focusOutlines.box,t),root:{"data-main-rotation":t}})}render(){if(this.div)return this.div;let e=super.render();this.#text&&(e.setAttribute(`aria-label`,this.#text),e.setAttribute(`role`,`mark`)),this.#isFreeHighlight?e.classList.add(`free`):this.div.addEventListener(`keydown`,this.#keydown.bind(this),{signal:this._uiManager._signal});let t=this.#highlightDiv=document.createElement(`div`);return e.append(t),t.setAttribute(`aria-hidden`,`true`),t.className=`internal`,t.style.clipPath=this.#clipPathId,this.setDims(),mt(this,this.#highlightDiv,[`pointerover`,`pointerleave`]),this.enableEditing(),e}pointerover(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!0}})}pointerleave(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!1}})}#keydown(t){e._keyboardManager.exec(this,t)}_moveCaret(e){switch(this.parent.unselect(this),e){case 0:case 2:this.#setCaret(!0);break;case 1:case 3:this.#setCaret(!1);break}}#setCaret(e){if(!this.#anchorNode)return;let t=window.getSelection();e?t.setPosition(this.#anchorNode,this.#anchorOffset):t.setPosition(this.#focusNode,this.#focusOffset)}select(){super.select(),this.#outlineId&&this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{hovered:!1,selected:!0}})}unselect(){super.unselect(),this.#outlineId&&(this.parent?.drawLayer.updateProperties(this.#outlineId,{rootClass:{selected:!1}}),this.#isFreeHighlight||this.#setCaret(!1))}get _mustFixPosition(){return!this.#isFreeHighlight}show(e=this._isVisible){super.show(e),this.parent&&(this.parent.drawLayer.updateProperties(this.#id,{rootClass:{hidden:!e}}),this.parent.drawLayer.updateProperties(this.#outlineId,{rootClass:{hidden:!e}}))}#getRotation(){return this.#isFreeHighlight?this.rotation:0}#serializeBoxes(){if(this.#isFreeHighlight)return null;let[e,t]=this.pageDimensions,[n,r]=this.pageTranslation,i=this.#boxes,a=new Float32Array(i.length*8),o=0;for(let{x:s,y:c,width:l,height:u}of i){let i=s*e+n,d=(1-c)*t+r;a[o]=a[o+4]=i,a[o+1]=a[o+3]=d,a[o+2]=a[o+6]=i+l*e,a[o+5]=a[o+7]=d-u*t,o+=8}return a}#serializeOutlines(e){return this.#highlightOutlines.serialize(e,this.#getRotation())}static startHighlighting(e,t,{target:n,x:r,y:i}){let{x:a,y:o,width:s,height:c}=n.getBoundingClientRect(),l=new AbortController,u=e.combinedSignal(l),d=t=>{l.abort(),this.#endHighlight(e,t)};window.addEventListener(`blur`,d,{signal:u}),window.addEventListener(`pointerup`,d,{signal:u}),window.addEventListener(`pointerdown`,H,{capture:!0,passive:!1,signal:u}),window.addEventListener(`contextmenu`,V,{signal:u}),n.addEventListener(`pointermove`,this.#highlightMove.bind(this,e),{signal:u}),this._freeHighlight=new Hi({x:r,y:i},[a,o,s,c],e.scale,this._defaultThickness/2,t,.001),{id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=e.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:`0 0 1 1`,fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0)}static#highlightMove(e,t){this._freeHighlight.add(t)&&e.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})}static#endHighlight(e,t){this._freeHighlight.isEmpty()?e.drawLayer.remove(this._freeHighlightId):e.createAndAddNewEditor(t,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:`main_toolbar`}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=``}static async deserialize(e,t,n){let r=null;if(e instanceof ki){let{data:{quadPoints:t,rect:n,rotation:i,id:a,color:o,opacity:s,popupRef:c,richText:l,contentsObj:u,creationDate:d,modificationDate:f},parent:{page:{pageNumber:p}}}=e;r=e={annotationType:D.HIGHLIGHT,color:Array.from(o),opacity:s,quadPoints:t,boxes:null,pageIndex:p-1,rect:n.slice(0),rotation:i,annotationElementId:a,id:a,deleted:!1,popupRef:c,richText:l,comment:u?.str||null,creationDate:d,modificationDate:f}}else if(e instanceof Oi){let{data:{inkLists:t,rect:n,rotation:i,id:a,color:o,borderStyle:{rawWidth:s},popupRef:c,richText:l,contentsObj:u,creationDate:d,modificationDate:f},parent:{page:{pageNumber:p}}}=e;r=e={annotationType:D.HIGHLIGHT,color:Array.from(o),thickness:s,inkLists:t,boxes:null,pageIndex:p-1,rect:n.slice(0),rotation:i,annotationElementId:a,id:a,deleted:!1,popupRef:c,richText:l,comment:u?.str||null,creationDate:d,modificationDate:f}}let{color:i,quadPoints:a,inkLists:o,opacity:s}=e,c=await super.deserialize(e,t,n);c.color=z.makeHexColor(...i),c.opacity=s||1,o&&(c.#thickness=e.thickness),c._initialData=r,e.comment&&c.setCommentData(e);let[l,u]=c.pageDimensions,[d,f]=c.pageTranslation;if(a){let e=c.#boxes=[];for(let t=0;t<a.length;t+=8)e.push({x:(a[t]-d)/l,y:1-(a[t+1]-f)/u,width:(a[t+2]-a[t])/l,height:(a[t+1]-a[t+5])/u});c.#createOutlines(),c.#addToDrawLayer(),c.rotate(c.rotation)}else if(o){c.#isFreeHighlight=!0;let e=o[0],n={x:e[0]-d,y:u-(e[1]-f)},r=new Hi(n,[0,0,l,u],1,c.#thickness/2,!0,.001);for(let t=0,i=e.length;t<i;t+=2)n.x=e[t]-d,n.y=u-(e[t+1]-f),r.add(n);let{id:i,clipPathId:a}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:`0 0 1 1`,fill:c.color,"fill-opacity":c._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:r.toSVGPath()}},!0,!0);c.#createFreeOutlines({highlightOutlines:r.getOutlines(),highlightId:i,clipPathId:a}),c.#addToDrawLayer(),c.rotate(c.parentRotation)}return c}serialize(e=!1){if(this.isEmpty()||e)return null;if(this.deleted)return this.serializeDeleted();let t=G._colorManager.convert(this._uiManager.getNonHCMColor(this.color)),n=super.serialize(e);return Object.assign(n,{color:t,opacity:this.opacity,thickness:this.#thickness,quadPoints:this.#serializeBoxes(),outlines:this.#serializeOutlines(n.rect)}),this.addComment(n),this.annotationElementId&&!this.#hasElementChanged(n)?null:(n.id=this.annotationElementId,n)}#hasElementChanged(e){let{color:t}=this._initialData;return this.hasEditedComment||e.color.some((e,n)=>e!==t[n])}renderAnnotationElement(e){return this.deleted?(e.hide(),null):(e.updateEdited({rect:this.getPDFRect(),popup:this.comment}),null)}static canCreateNewEmptyEditor(){return!1}},Gi=class{#svgProperties=Object.create(null);updateProperty(e,t){this[e]=t,this.updateSVGProperty(e,t)}updateProperties(e){if(e)for(let[t,n]of Object.entries(e))t.startsWith(`_`)||this.updateProperty(t,n)}updateSVGProperty(e,t){this.#svgProperties[e]=t}toSVGProperties(){let e=this.#svgProperties;return this.#svgProperties=Object.create(null),{root:e}}reset(){this.#svgProperties=Object.create(null)}updateAll(e=this){this.updateProperties(e)}clone(){F(`Not implemented`)}},Ki=class e extends G{#drawOutlines=null;#mustBeCommitted;_colorPicker=null;_drawId=null;static _currentDrawId=-1;static _currentParent=null;static#currentDraw=null;static#currentDrawingAC=null;static#currentDrawingOptions=null;static _INNER_MARGIN=3;constructor(e){super(e),this.#mustBeCommitted=e.mustBeCommitted||!1,this._addOutlines(e)}onUpdatedColor(){this._colorPicker?.update(this.color),super.onUpdatedColor()}_addOutlines(e){e.drawOutlines&&(this.#createDrawOutlines(e),this.#addToDrawLayer())}#createDrawOutlines({drawOutlines:e,drawId:t,drawingOptions:n}){this.#drawOutlines=e,this._drawingOptions||=n,this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-${this.editorType}-added-alert`),t>=0?(this._drawId=t,this.parent.drawLayer.finalizeDraw(t,e.defaultProperties)):this._drawId=this.#createDrawing(e,this.parent),this.#updateBbox(e.box)}#createDrawing(t,n){let{id:r}=n.drawLayer.draw(e._mergeSVGProperties(this._drawingOptions.toSVGProperties(),t.defaultSVGProperties),!1,!1);return r}static _mergeSVGProperties(e,t){let n=new Set(Object.keys(e));for(let[r,i]of Object.entries(t))n.has(r)?Object.assign(e[r],i):e[r]=i;return e}static getDefaultDrawingOptions(e){F(`Not implemented`)}static get typesMap(){F(`Not implemented`)}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(t,n){let r=this.typesMap.get(t);r&&this._defaultDrawingOptions.updateProperty(r,n),this._currentParent&&(e.#currentDraw.updateProperty(r,n),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(e,t){let n=this.constructor.typesMap.get(e);n&&this._updateProperty(e,n,t)}static get defaultPropertiesToUpdate(){let e=[],t=this._defaultDrawingOptions;for(let[n,r]of this.typesMap)e.push([n,t[r]]);return e}get propertiesToUpdate(){let e=[],{_drawingOptions:t}=this;for(let[n,r]of this.constructor.typesMap)e.push([n,t[r]]);return e}_updateProperty(e,t,n){let r=this._drawingOptions,i=r[t],a=n=>{r.updateProperty(t,n);let i=this.#drawOutlines.updateProperty(t,n);i&&this.#updateBbox(i),this.parent?.drawLayer.updateProperties(this._drawId,r.toSVGProperties()),e===this.colorType&&this.onUpdatedColor()};this.addCommands({cmd:a.bind(this,n),undo:a.bind(this,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:e,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,e._mergeSVGProperties(this.#drawOutlines.getPathResizingSVGProperties(this.#convertToDrawSpace()),{bbox:this.#rotateBox()}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,e._mergeSVGProperties(this.#drawOutlines.getPathResizedSVGProperties(this.#convertToDrawSpace()),{bbox:this.#rotateBox()}))}_onTranslating(e,t){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:this.#rotateBox()})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,e._mergeSVGProperties(this.#drawOutlines.getPathTranslatedSVGProperties(this.#convertToDrawSpace(),this.parentDimensions),{bbox:this.#rotateBox()}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle(`disabled`,!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle(`disabled`,!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(e){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,this.#mustBeCommitted&&(this.#mustBeCommitted=!1,this.commit(),this.parent.setSelected(this),e&&this.isOnScreen&&this.div.focus())}remove(){this.#cleanDrawLayer(),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.#addToDrawLayer(),this.#updateBbox(this.#drawOutlines.box),this.isAttachedToDOM||this.parent.add(this)))}setParent(e){let t=!1;this.parent&&!e?(this._uiManager.removeShouldRescale(this),this.#cleanDrawLayer()):e&&(this._uiManager.addShouldRescale(this),this.#addToDrawLayer(e),t=!this.parent&&this.div?.classList.contains(`selectedEditor`)),super.setParent(e),t&&this.select()}#cleanDrawLayer(){this._drawId===null||!this.parent||(this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset())}#addToDrawLayer(e=this.parent){if(!(this._drawId!==null&&this.parent===e)){if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,e.drawLayer);return}this._drawingOptions.updateAll(),this._drawId=this.#createDrawing(this.#drawOutlines,e)}}#convertToParentSpace([e,t,n,r]){let{parentDimensions:[i,a],rotation:o}=this;switch(o){case 90:return[t,1-e,n*(a/i),r*(i/a)];case 180:return[1-e,1-t,n,r];case 270:return[1-t,e,n*(a/i),r*(i/a)];default:return[e,t,n,r]}}#convertToDrawSpace(){let{x:e,y:t,width:n,height:r,parentDimensions:[i,a],rotation:o}=this;switch(o){case 90:return[1-t,e,n*(i/a),r*(a/i)];case 180:return[1-e,1-t,n,r];case 270:return[t,1-e,n*(i/a),r*(a/i)];default:return[e,t,n,r]}}#updateBbox(e){[this.x,this.y,this.width,this.height]=this.#convertToParentSpace(e),this.div&&(this.fixAndSetPosition(),this.setDims()),this._onResized()}#rotateBox(){let{x:e,y:t,width:n,height:r,rotation:i,parentRotation:a,parentDimensions:[o,s]}=this;switch((i*4+a)/90){case 1:return[1-t-r,e,r,n];case 2:return[1-e-n,1-t-r,n,r];case 3:return[t,1-e-n,r,n];case 4:return[e,t-n*(o/s),r*(s/o),n*(o/s)];case 5:return[1-t,e,n*(o/s),r*(s/o)];case 6:return[1-e-r*(s/o),1-t,r*(s/o),n*(o/s)];case 7:return[t-n*(o/s),1-e-r*(s/o),n*(o/s),r*(s/o)];case 8:return[e-n,t-r,n,r];case 9:return[1-t,e-n,r,n];case 10:return[1-e,1-t,n,r];case 11:return[t-r,1-e,r,n];case 12:return[e-r*(s/o),t,r*(s/o),n*(o/s)];case 13:return[1-t-n*(o/s),e-r*(s/o),n*(o/s),r*(s/o)];case 14:return[1-e,1-t-n*(o/s),r*(s/o),n*(o/s)];case 15:return[t,1-e,n*(o/s),r*(s/o)];default:return[e,t,n,r]}}rotate(){this.parent&&this.parent.drawLayer.updateProperties(this._drawId,e._mergeSVGProperties({bbox:this.#rotateBox()},this.#drawOutlines.updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){this.parent&&this.#updateBbox(this.#drawOutlines.updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;let e,t;this._isCopy&&(e=this.x,t=this.y);let n=super.render();n.classList.add(`draw`);let r=document.createElement(`div`);return n.append(r),r.setAttribute(`aria-hidden`,`true`),r.className=`internal`,this.setDims(),this._uiManager.addShouldRescale(this),this.disableEditing(),this._isCopy&&this._moveAfterPaste(e,t),n}static createDrawerInstance(e,t,n,r,i){F(`Not implemented`)}static startDrawing(t,n,r,i){let{target:a,offsetX:o,offsetY:s,pointerId:c,pointerType:l}=i;if(W.isInitializedAndDifferentPointerType(l))return;let{viewport:{rotation:u}}=t,{width:d,height:f}=a.getBoundingClientRect(),p=e.#currentDrawingAC=new AbortController,m=t.combinedSignal(p);if(W.setPointer(l,c),window.addEventListener(`pointerup`,e=>{W.isSamePointerIdOrRemove(e.pointerId)&&this._endDraw(e)},{signal:m}),window.addEventListener(`pointercancel`,e=>{W.isSamePointerIdOrRemove(e.pointerId)&&this._currentParent.endDrawingSession()},{signal:m}),window.addEventListener(`pointerdown`,t=>{W.isSamePointerType(t.pointerType)&&(W.initializeAndAddPointerId(t.pointerId),e.#currentDraw.isCancellable()&&(e.#currentDraw.removeLastElement(),e.#currentDraw.isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null)))},{capture:!0,passive:!1,signal:m}),window.addEventListener(`contextmenu`,V,{signal:m}),a.addEventListener(`pointermove`,this._drawMove.bind(this),{signal:m}),a.addEventListener(`touchmove`,e=>{W.isSameTimeStamp(e.timeStamp)&&H(e)},{signal:m}),t.toggleDrawing(),n._editorUndoBar?.hide(),e.#currentDraw){t.drawLayer.updateProperties(this._currentDrawId,e.#currentDraw.startNew(o,s,d,f,u));return}n.updateUIForDefaultProperties(this),e.#currentDraw=this.createDrawerInstance(o,s,d,f,u),e.#currentDrawingOptions=this.getDefaultDrawingOptions(),this._currentParent=t,{id:this._currentDrawId}=t.drawLayer.draw(this._mergeSVGProperties(e.#currentDrawingOptions.toSVGProperties(),e.#currentDraw.defaultSVGProperties),!0,!1)}static _drawMove(t){if(W.isSameTimeStamp(t.timeStamp),!e.#currentDraw)return;let{offsetX:n,offsetY:r,pointerId:i}=t;if(W.isSamePointerId(i)){if(W.isUsingMultiplePointers()){this._endDraw(t);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,e.#currentDraw.add(n,r)),W.setTimeStamp(t.timeStamp),H(t)}}static _cleanup(t){t&&(this._currentDrawId=-1,this._currentParent=null,e.#currentDraw=null,e.#currentDrawingOptions=null,W.clearTimeStamp()),e.#currentDrawingAC&&(e.#currentDrawingAC.abort(),e.#currentDrawingAC=null,W.clearPointerIds())}static _endDraw(t){let n=this._currentParent;if(n){if(n.toggleDrawing(!0),this._cleanup(!1),t?.target===n.div&&n.drawLayer.updateProperties(this._currentDrawId,e.#currentDraw.end(t.offsetX,t.offsetY)),this.supportMultipleDrawings){let t=e.#currentDraw,r=this._currentDrawId,i=t.getLastElement();n.addCommands({cmd:()=>{n.drawLayer.updateProperties(r,t.setLastElement(i))},undo:()=>{n.drawLayer.updateProperties(r,t.removeLastElement())},mustExec:!1,type:O.DRAW_STEP});return}this.endDrawing(!1)}}static endDrawing(t){let n=this._currentParent;if(!n)return null;if(n.toggleDrawing(!0),n.cleanUndoStack(O.DRAW_STEP),!e.#currentDraw.isEmpty()){let{pageDimensions:[r,i],scale:a}=n,o=n.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:e.#currentDraw.getOutlines(r*a,i*a,a,this._INNER_MARGIN),drawingOptions:e.#currentDrawingOptions,mustBeCommitted:!t});return this._cleanup(!0),o}return n.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(e){}static deserializeDraw(e,t,n,r,i,a){F(`Not implemented`)}static async deserialize(e,t,n){let{rawDims:{pageWidth:r,pageHeight:i,pageX:a,pageY:o}}=t.viewport,s=this.deserializeDraw(a,o,r,i,this._INNER_MARGIN,e),c=await super.deserialize(e,t,n);return c.createDrawingOptions(e),c.#createDrawOutlines({drawOutlines:s}),c.#addToDrawLayer(),c.onScaleChanging(),c.rotate(),c}serializeDraw(e){let[t,n]=this.pageTranslation,[r,i]=this.pageDimensions;return this.#drawOutlines.serialize([t,n,r,i],e)}renderAnnotationElement(e){return e.updateEdited({rect:this.getPDFRect()}),null}static canCreateNewEmptyEditor(){return!1}},qi=class{#last=new Float64Array(6);#line;#lines;#rotation;#thickness;#points;#lastSVGPath=``;#lastIndex=0;#outlines=new Ji;#parentWidth;#parentHeight;constructor(e,t,n,r,i,a){this.#parentWidth=n,this.#parentHeight=r,this.#rotation=i,this.#thickness=a,[e,t]=this.#normalizePoint(e,t);let o=this.#line=[NaN,NaN,NaN,NaN,e,t];this.#points=[e,t],this.#lines=[{line:o,points:this.#points}],this.#last.set(o,0)}updateProperty(e,t){e===`stroke-width`&&(this.#thickness=t)}#normalizePoint(e,t){return $._normalizePoint(e,t,this.#parentWidth,this.#parentHeight,this.#rotation)}isEmpty(){return!this.#lines||this.#lines.length===0}isCancellable(){return this.#points.length<=10}add(e,t){[e,t]=this.#normalizePoint(e,t);let[n,r,i,a]=this.#last.subarray(2,6),o=e-i,s=t-a;return Math.hypot(this.#parentWidth*o,this.#parentHeight*s)<=2?null:(this.#points.push(e,t),isNaN(n)?(this.#last.set([i,a,e,t],2),this.#line.push(NaN,NaN,NaN,NaN,e,t),{path:{d:this.toSVGPath()}}):(isNaN(this.#last[0])&&this.#line.splice(6,6),this.#last.set([n,r,i,a,e,t],0),this.#line.push(...$.createBezierPoints(n,r,i,a,e,t)),{path:{d:this.toSVGPath()}}))}end(e,t){return this.add(e,t)||(this.#points.length===2?{path:{d:this.toSVGPath()}}:null)}startNew(e,t,n,r,i){this.#parentWidth=n,this.#parentHeight=r,this.#rotation=i,[e,t]=this.#normalizePoint(e,t);let a=this.#line=[NaN,NaN,NaN,NaN,e,t];this.#points=[e,t];let o=this.#lines.at(-1);return o&&(o.line=new Float32Array(o.line),o.points=new Float32Array(o.points)),this.#lines.push({line:a,points:this.#points}),this.#last.set(a,0),this.#lastIndex=0,this.toSVGPath(),null}getLastElement(){return this.#lines.at(-1)}setLastElement(e){return this.#lines?(this.#lines.push(e),this.#line=e.line,this.#points=e.points,this.#lastIndex=0,{path:{d:this.toSVGPath()}}):this.#outlines.setLastElement(e)}removeLastElement(){if(!this.#lines)return this.#outlines.removeLastElement();this.#lines.pop(),this.#lastSVGPath=``;for(let e=0,t=this.#lines.length;e<t;e++){let{line:t,points:n}=this.#lines[e];this.#line=t,this.#points=n,this.#lastIndex=0,this.toSVGPath()}return{path:{d:this.#lastSVGPath}}}toSVGPath(){let e=$.svgRound(this.#line[4]),t=$.svgRound(this.#line[5]);if(this.#points.length===2)return this.#lastSVGPath=`${this.#lastSVGPath} M ${e} ${t} Z`,this.#lastSVGPath;if(this.#points.length<=6){let n=this.#lastSVGPath.lastIndexOf(`M`);this.#lastSVGPath=`${this.#lastSVGPath.slice(0,n)} M ${e} ${t}`,this.#lastIndex=6}if(this.#points.length===4){let e=$.svgRound(this.#line[10]),t=$.svgRound(this.#line[11]);return this.#lastSVGPath=`${this.#lastSVGPath} L ${e} ${t}`,this.#lastIndex=12,this.#lastSVGPath}let n=[];this.#lastIndex===0&&(n.push(`M ${e} ${t}`),this.#lastIndex=6);for(let e=this.#lastIndex,t=this.#line.length;e<t;e+=6){let[t,r,i,a,o,s]=this.#line.slice(e,e+6).map($.svgRound);n.push(`C${t} ${r} ${i} ${a} ${o} ${s}`)}return this.#lastSVGPath+=n.join(` `),this.#lastIndex=this.#line.length,this.#lastSVGPath}getOutlines(e,t,n,r){let i=this.#lines.at(-1);return i.line=new Float32Array(i.line),i.points=new Float32Array(i.points),this.#outlines.build(this.#lines,e,t,n,this.#rotation,this.#thickness,r),this.#last=null,this.#line=null,this.#lines=null,this.#lastSVGPath=null,this.#outlines}get defaultSVGProperties(){return{root:{viewBox:`0 0 10000 10000`},rootClass:{draw:!0},bbox:[0,0,1,1]}}},Ji=class extends ${#bbox;#currentRotation=0;#innerMargin;#lines;#parentWidth;#parentHeight;#parentScale;#rotation;#thickness;build(e,t,n,r,i,a,o){this.#parentWidth=t,this.#parentHeight=n,this.#parentScale=r,this.#rotation=i,this.#thickness=a,this.#innerMargin=o??0,this.#lines=e,this.#computeBbox()}get thickness(){return this.#thickness}setLastElement(e){return this.#lines.push(e),{path:{d:this.toSVGPath()}}}removeLastElement(){return this.#lines.pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){let e=[];for(let{line:t}of this.#lines){if(e.push(`M${$.svgRound(t[4])} ${$.svgRound(t[5])}`),t.length===6){e.push(`Z`);continue}if(t.length===12&&isNaN(t[6])){e.push(`L${$.svgRound(t[10])} ${$.svgRound(t[11])}`);continue}for(let n=6,r=t.length;n<r;n+=6){let[r,i,a,o,s,c]=t.subarray(n,n+6).map($.svgRound);e.push(`C${r} ${i} ${a} ${o} ${s} ${c}`)}}return e.join(``)}serialize([e,t,n,r],i){let a=[],o=[],[s,c,l,u]=this.#getBBoxWithNoMargin(),d,f,p,m,h,g,_,v,y;switch(this.#rotation){case 0:y=$._rescale,d=e,f=t+r,p=n,m=-r,h=e+s*n,g=t+(1-c-u)*r,_=e+(s+l)*n,v=t+(1-c)*r;break;case 90:y=$._rescaleAndSwap,d=e,f=t,p=n,m=r,h=e+c*n,g=t+s*r,_=e+(c+u)*n,v=t+(s+l)*r;break;case 180:y=$._rescale,d=e+n,f=t,p=-n,m=r,h=e+(1-s-l)*n,g=t+c*r,_=e+(1-s)*n,v=t+(c+u)*r;break;case 270:y=$._rescaleAndSwap,d=e+n,f=t+r,p=-n,m=-r,h=e+(1-c-u)*n,g=t+(1-s-l)*r,_=e+(1-c)*n,v=t+(1-s)*r;break}for(let{line:e,points:t}of this.#lines)a.push(y(e,d,f,p,m,i?Array(e.length):null)),o.push(y(t,d,f,p,m,i?Array(t.length):null));return{lines:a,points:o,rect:[h,g,_,v]}}static deserialize(e,t,n,r,i,{paths:{lines:a,points:o},rotation:s,thickness:c}){let l=[],u,d,f,p,m;switch(s){case 0:m=$._rescale,u=-e/n,d=t/r+1,f=1/n,p=-1/r;break;case 90:m=$._rescaleAndSwap,u=-t/r,d=-e/n,f=1/r,p=1/n;break;case 180:m=$._rescale,u=e/n+1,d=-t/r,f=-1/n,p=1/r;break;case 270:m=$._rescaleAndSwap,u=t/r+1,d=e/n+1,f=-1/r,p=-1/n;break}if(!a){a=[];for(let e of o){let t=e.length;if(t===2){a.push(new Float32Array([NaN,NaN,NaN,NaN,e[0],e[1]]));continue}if(t===4){a.push(new Float32Array([NaN,NaN,NaN,NaN,e[0],e[1],NaN,NaN,NaN,NaN,e[2],e[3]]));continue}let n=new Float32Array(3*(t-2));a.push(n);let[r,i,o,s]=e.subarray(0,4);n.set([NaN,NaN,NaN,NaN,r,i],0);for(let a=4;a<t;a+=2){let t=e[a],c=e[a+1];n.set($.createBezierPoints(r,i,o,s,t,c),(a-2)*3),[r,i,o,s]=[o,s,t,c]}}}for(let e=0,t=a.length;e<t;e++)l.push({line:m(a[e].map(e=>e??NaN),u,d,f,p),points:m(o[e].map(e=>e??NaN),u,d,f,p)});let h=new this.prototype.constructor;return h.build(l,n,r,1,s,c,i),h}#getMarginComponents(e=this.#thickness){let t=this.#innerMargin+e/2*this.#parentScale;return this.#rotation%180==0?[t/this.#parentWidth,t/this.#parentHeight]:[t/this.#parentHeight,t/this.#parentWidth]}#getBBoxWithNoMargin(){let[e,t,n,r]=this.#bbox,[i,a]=this.#getMarginComponents(0);return[e+i,t+a,n-2*i,r-2*a]}#computeBbox(){let e=this.#bbox=new Float32Array([1/0,1/0,-1/0,-1/0]);for(let{line:t}of this.#lines){if(t.length<=12){for(let n=4,r=t.length;n<r;n+=6)z.pointBoundingBox(t[n],t[n+1],e);continue}let n=t[4],r=t[5];for(let i=6,a=t.length;i<a;i+=6){let[a,o,s,c,l,u]=t.subarray(i,i+6);z.bezierBoundingBox(n,r,a,o,s,c,l,u,e),n=l,r=u}}let[t,n]=this.#getMarginComponents();e[0]=B(e[0]-t,0,1),e[1]=B(e[1]-n,0,1),e[2]=B(e[2]+t,0,1),e[3]=B(e[3]+n,0,1),e[2]-=e[0],e[3]-=e[1]}get box(){return this.#bbox}updateProperty(e,t){return e===`stroke-width`?this.#updateThickness(t):null}#updateThickness(e){let[t,n]=this.#getMarginComponents();this.#thickness=e;let[r,i]=this.#getMarginComponents(),[a,o]=[r-t,i-n],s=this.#bbox;return s[0]-=a,s[1]-=o,s[2]+=2*a,s[3]+=2*o,s}updateParentDimensions([e,t],n){let[r,i]=this.#getMarginComponents();this.#parentWidth=e,this.#parentHeight=t,this.#parentScale=n;let[a,o]=this.#getMarginComponents(),s=a-r,c=o-i,l=this.#bbox;return l[0]-=s,l[1]-=c,l[2]+=2*s,l[3]+=2*c,l}updateRotation(e){return this.#currentRotation=e,{path:{transform:this.rotationTransform}}}get viewBox(){return this.#bbox.map($.svgRound).join(` `)}get defaultProperties(){let[e,t]=this.#bbox;return{root:{viewBox:this.viewBox},path:{"transform-origin":`${$.svgRound(e)} ${$.svgRound(t)}`}}}get rotationTransform(){let[,,e,t]=this.#bbox,n=0,r=0,i=0,a=0,o=0,s=0;switch(this.#currentRotation){case 90:r=t/e,i=-e/t,o=e;break;case 180:n=-1,a=-1,o=e,s=t;break;case 270:r=-t/e,i=e/t,s=t;break;default:return``}return`matrix(${n} ${r} ${i} ${a} ${$.svgRound(o)} ${$.svgRound(s)})`}getPathResizingSVGProperties([e,t,n,r]){let[i,a]=this.#getMarginComponents(),[o,s,c,l]=this.#bbox;if(Math.abs(c-i)<=$.PRECISION||Math.abs(l-a)<=$.PRECISION){let i=e+n/2-(o+c/2),a=t+r/2-(s+l/2);return{path:{"transform-origin":`${$.svgRound(e)} ${$.svgRound(t)}`,transform:`${this.rotationTransform} translate(${i} ${a})`}}}let u=(n-2*i)/(c-2*i),d=(r-2*a)/(l-2*a),f=c/n,p=l/r;return{path:{"transform-origin":`${$.svgRound(o)} ${$.svgRound(s)}`,transform:`${this.rotationTransform} scale(${f} ${p}) translate(${$.svgRound(i)} ${$.svgRound(a)}) scale(${u} ${d}) translate(${$.svgRound(-i)} ${$.svgRound(-a)})`}}}getPathResizedSVGProperties([e,t,n,r]){let[i,a]=this.#getMarginComponents(),o=this.#bbox,[s,c,l,u]=o;if(o[0]=e,o[1]=t,o[2]=n,o[3]=r,Math.abs(l-i)<=$.PRECISION||Math.abs(u-a)<=$.PRECISION){let i=e+n/2-(s+l/2),a=t+r/2-(c+u/2);for(let{line:e,points:t}of this.#lines)$._translate(e,i,a,e),$._translate(t,i,a,t);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${$.svgRound(e)} ${$.svgRound(t)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}let d=(n-2*i)/(l-2*i),f=(r-2*a)/(u-2*a),p=-d*(s+i)+e+i,m=-f*(c+a)+t+a;if(d!==1||f!==1||p!==0||m!==0)for(let{line:e,points:t}of this.#lines)$._rescale(e,p,m,d,f,e),$._rescale(t,p,m,d,f,t);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${$.svgRound(e)} ${$.svgRound(t)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([e,t],n){let[r,i]=n,a=this.#bbox,o=e-a[0],s=t-a[1];if(this.#parentWidth===r&&this.#parentHeight===i)for(let{line:e,points:t}of this.#lines)$._translate(e,o,s,e),$._translate(t,o,s,t);else{let e=this.#parentWidth/r,t=this.#parentHeight/i;this.#parentWidth=r,this.#parentHeight=i;for(let{line:n,points:r}of this.#lines)$._rescale(n,o,s,e,t,n),$._rescale(r,o,s,e,t,r);a[2]*=e,a[3]*=t}return a[0]=e,a[1]=t,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${$.svgRound(e)} ${$.svgRound(t)}`}}}get defaultSVGProperties(){let e=this.#bbox;return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${$.svgRound(e[0])} ${$.svgRound(e[1])}`,transform:this.rotationTransform||null},bbox:e}}},Yi=class e extends Gi{constructor(e){super(),this._viewParameters=e,super.updateProperties({fill:`none`,stroke:G._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":`round`,"stroke-linejoin":`round`,"stroke-miterlimit":10})}updateSVGProperty(e,t){e===`stroke-width`&&(t??=this[`stroke-width`],t*=this._viewParameters.realScale),super.updateSVGProperty(e,t)}clone(){let t=new e(this._viewParameters);return t.updateAll(this),t}},Xi=class e extends Ki{static _type=`ink`;static _editorType=D.INK;static _defaultDrawingOptions=null;constructor(e){super({...e,name:`inkEditor`}),this._willKeepAspectRatio=!0,this.defaultL10nId=`pdfjs-editor-ink-editor`}static initialize(e,t){G.initialize(e,t),this._defaultDrawingOptions=new Yi(t.viewParameters)}static getDefaultDrawingOptions(e){let t=this._defaultDrawingOptions.clone();return t.updateProperties(e),t}static get supportMultipleDrawings(){return!0}static get typesMap(){return L(this,`typesMap`,new Map([[O.INK_THICKNESS,`stroke-width`],[O.INK_COLOR,`stroke`],[O.INK_OPACITY,`stroke-opacity`]]))}static createDrawerInstance(e,t,n,r,i){return new qi(e,t,n,r,i,this._defaultDrawingOptions[`stroke-width`])}static deserializeDraw(e,t,n,r,i,a){return Ji.deserialize(e,t,n,r,i,a)}static async deserialize(e,t,n){let r=null;if(e instanceof Oi){let{data:{inkLists:t,rect:n,rotation:i,id:a,color:o,opacity:s,borderStyle:{rawWidth:c},popupRef:l,richText:u,contentsObj:d,creationDate:f,modificationDate:p},parent:{page:{pageNumber:m}}}=e;r=e={annotationType:D.INK,color:Array.from(o),thickness:c,opacity:s,paths:{points:t},boxes:null,pageIndex:m-1,rect:n.slice(0),rotation:i,annotationElementId:a,id:a,deleted:!1,popupRef:l,richText:u,comment:d?.str||null,creationDate:f,modificationDate:p}}let i=await super.deserialize(e,t,n);return i._initialData=r,e.comment&&i.setCommentData(e),i}get toolbarButtons(){return this._colorPicker||=new $r(this),[[`colorPicker`,this._colorPicker]]}get colorType(){return O.INK_COLOR}get color(){return this._drawingOptions.stroke}get opacity(){return this._drawingOptions[`stroke-opacity`]}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();let{_drawId:e,_drawingOptions:t,parent:n}=this;t.updateSVGProperty(`stroke-width`),n.drawLayer.updateProperties(e,t.toSVGProperties())}static onScaleChangingWhenDrawing(){let e=this._currentParent;e&&(super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty(`stroke-width`),e.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}createDrawingOptions({color:t,thickness:n,opacity:r}){this._drawingOptions=e.getDefaultDrawingOptions({stroke:z.makeHexColor(...t),"stroke-width":n,"stroke-opacity":r})}serialize(e=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();let{lines:t,points:n}=this.serializeDraw(e),{_drawingOptions:{stroke:r,"stroke-opacity":i,"stroke-width":a}}=this,o=Object.assign(super.serialize(e),{color:G._colorManager.convert(r),opacity:i,thickness:a,paths:{lines:t,points:n}});return this.addComment(o),e?(o.isCopy=!0,o):this.annotationElementId&&!this.#hasElementChanged(o)?null:(o.id=this.annotationElementId,o)}#hasElementChanged(e){let{color:t,thickness:n,opacity:r,pageIndex:i}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized||e.color.some((e,n)=>e!==t[n])||e.thickness!==n||e.opacity!==r||e.pageIndex!==i}renderAnnotationElement(e){if(this.deleted)return e.hide(),null;let{points:t,rect:n}=this.serializeDraw(!1);return e.updateEdited({rect:n,thickness:this._drawingOptions[`stroke-width`],points:t,popup:this.comment}),null}},Zi=class extends Ji{toSVGPath(){let e=super.toSVGPath();return e.endsWith(`Z`)||(e+=`Z`),e}},Qi=8,$i=3,ea=class{static#PARAMETERS={maxDim:512,sigmaSFactor:.02,sigmaR:25,kernelSize:16};static#neighborIndexToId(e,t,n,r){return n-=e,r-=t,n===0?r>0?0:4:n===1?r+6:2-r}static#neighborIdToIndex=new Int32Array([0,1,-1,1,-1,0,-1,-1,0,-1,1,-1,1,0,1,1]);static#clockwiseNonZero(e,t,n,r,i,a,o){let s=this.#neighborIndexToId(n,r,i,a);for(let i=0;i<8;i++){let a=(-i+s-o+16)%8,c=this.#neighborIdToIndex[2*a],l=this.#neighborIdToIndex[2*a+1];if(e[(n+c)*t+(r+l)]!==0)return a}return-1}static#counterClockwiseNonZero(e,t,n,r,i,a,o){let s=this.#neighborIndexToId(n,r,i,a);for(let i=0;i<8;i++){let a=(i+s+o+16)%8,c=this.#neighborIdToIndex[2*a],l=this.#neighborIdToIndex[2*a+1];if(e[(n+c)*t+(r+l)]!==0)return a}return-1}static#findContours(e,t,n,r){let i=e.length,a=new Int32Array(i);for(let t=0;t<i;t++)a[t]=e[t]<=r?1:0;for(let e=1;e<n-1;e++)a[e*t]=a[e*t+t-1]=0;for(let e=0;e<t;e++)a[e]=a[t*n-1-e]=0;let o=1,s,c=[];for(let e=1;e<n-1;e++){s=1;for(let n=1;n<t-1;n++){let r=e*t+n,i=a[r];if(i===0)continue;let l=e,u=n;if(i===1&&a[r-1]===0)o+=1,--u;else if(i>=1&&a[r+1]===0)o+=1,u+=1,i>1&&(s=i);else{i!==1&&(s=Math.abs(i));continue}let d=[n,e],f=u===n+1,p={isHole:f,points:d,id:o,parent:0};c.push(p);let m;for(let e of c)if(e.id===s){m=e;break}m?m.isHole?p.parent=f?m.parent:s:p.parent=f?s:m.parent:p.parent=f?s:0;let h=this.#clockwiseNonZero(a,t,e,n,l,u,0);if(h===-1){a[r]=-o,a[r]!==1&&(s=Math.abs(a[r]));continue}let g=this.#neighborIdToIndex[2*h],_=this.#neighborIdToIndex[2*h+1],v=e+g,y=n+_;l=v,u=y;let b=e,x=n;for(;;){let i=this.#counterClockwiseNonZero(a,t,b,x,l,u,1);g=this.#neighborIdToIndex[2*i],_=this.#neighborIdToIndex[2*i+1];let c=b+g,f=x+_;d.push(f,c);let p=b*t+x;if(a[p+1]===0?a[p]=-o:a[p]===1&&(a[p]=o),c===e&&f===n&&b===v&&x===y){a[r]!==1&&(s=Math.abs(a[r]));break}else l=b,u=x,b=c,x=f}}}return c}static#douglasPeuckerHelper(e,t,n,r){if(n-t<=4){for(let i=t;i<n-2;i+=2)r.push(e[i],e[i+1]);return}let i=e[t],a=e[t+1],o=e[n-4]-i,s=e[n-3]-a,c=Math.hypot(o,s),l=o/c,u=s/c,d=l*a-u*i,f=s/o,p=1/c,m=Math.atan(f),h=Math.cos(m),g=Math.sin(m),_=p*(Math.abs(h)+Math.abs(g)),v=p*(1-_+_**2),y=Math.max(Math.atan(Math.abs(g+h)*v),Math.atan(Math.abs(g-h)*v)),b=0,x=t;for(let r=t+2;r<n-2;r+=2){let t=Math.abs(d-l*e[r+1]+u*e[r]);t>b&&(x=r,b=t)}b>(c*y)**2?(this.#douglasPeuckerHelper(e,t,x+2,r),this.#douglasPeuckerHelper(e,x,n,r)):r.push(i,a)}static#douglasPeucker(e){let t=[],n=e.length;return this.#douglasPeuckerHelper(e,0,n,t),t.push(e[n-2],e[n-1]),t.length<=4?null:t}static#bilateralFilter(e,t,n,r,i,a){let o=new Float32Array(a**2),s=-2*r**2,c=a>>1;for(let e=0;e<a;e++){let t=(e-c)**2;for(let n=0;n<a;n++)o[e*a+n]=Math.exp((t+(n-c)**2)/s)}let l=new Float32Array(256),u=-2*i**2;for(let e=0;e<256;e++)l[e]=Math.exp(e**2/u);let d=e.length,f=new Uint8Array(d),p=new Uint32Array(256);for(let r=0;r<n;r++)for(let i=0;i<t;i++){let s=r*t+i,u=e[s],d=0,m=0;for(let s=0;s<a;s++){let f=r+s-c;if(!(f<0||f>=n))for(let n=0;n<a;n++){let r=i+n-c;if(r<0||r>=t)continue;let p=e[f*t+r],h=o[s*a+n]*l[Math.abs(p-u)];d+=p*h,m+=h}}let h=f[s]=Math.round(d/m);p[h]++}return[f,p]}static#getHistogram(e){let t=new Uint32Array(256);for(let n of e)t[n]++;return t}static#toUint8(e){let t=e.length,n=new Uint8ClampedArray(t>>2),r=-1/0,i=1/0;for(let t=0,a=n.length;t<a;t++){let a=n[t]=e[t<<2];r=Math.max(r,a),i=Math.min(i,a)}let a=255/(r-i);for(let e=0,t=n.length;e<t;e++)n[e]=(n[e]-i)*a;return n}static#guessThreshold(e){let t,n=-1/0,r=-1/0,i=e.findIndex(e=>e!==0),a=i,o=i;for(t=i;t<256;t++){let i=e[t];i>n&&(t-a>r&&(r=t-a,o=t-1),n=i,a=t)}for(t=o-1;t>=0&&!(e[t]>e[t+1]);t--);return t}static#getGrayPixels(e){let t=e,{width:n,height:r}=e,{maxDim:i}=this.#PARAMETERS,a=n,o=r;if(n>i||r>i){let s=n,c=r,l=Math.log2(Math.max(n,r)/i),u=Math.floor(l);l=l===u?u-1:u;for(let n=0;n<l;n++){a=Math.ceil(s/2),o=Math.ceil(c/2);let n=new OffscreenCanvas(a,o);n.getContext(`2d`).drawImage(e,0,0,s,c,0,0,a,o),s=a,c=o,e!==t&&e.close(),e=n.transferToImageBitmap()}let d=Math.min(i/a,i/o);a=Math.round(a*d),o=Math.round(o*d)}let s=new OffscreenCanvas(a,o).getContext(`2d`,{willReadFrequently:!0});s.fillStyle=`white`,s.fillRect(0,0,a,o),s.filter=`grayscale(1)`,s.drawImage(e,0,0,e.width,e.height,0,0,a,o);let c=s.getImageData(0,0,a,o).data;return[this.#toUint8(c),a,o]}static extractContoursFromText(e,{fontFamily:t,fontStyle:n,fontWeight:r},i,a,o,s){let c=new OffscreenCanvas(1,1),l=c.getContext(`2d`,{alpha:!1}),u=l.font=`${n} ${r} 200px ${t}`,{actualBoundingBoxLeft:d,actualBoundingBoxRight:f,actualBoundingBoxAscent:p,actualBoundingBoxDescent:m,fontBoundingBoxAscent:h,fontBoundingBoxDescent:g,width:_}=l.measureText(e),v=1.5,y=Math.ceil(Math.max(Math.abs(d)+Math.abs(f)||0,_)*v),b=Math.ceil(Math.max(Math.abs(p)+Math.abs(m)||200,Math.abs(h)+Math.abs(g)||200)*v);c=new OffscreenCanvas(y,b),l=c.getContext(`2d`,{alpha:!0,willReadFrequently:!0}),l.font=u,l.filter=`grayscale(1)`,l.fillStyle=`white`,l.fillRect(0,0,y,b),l.fillStyle=`black`,l.fillText(e,y*(v-1)/2,b*(3-v)/2);let x=this.#toUint8(l.getImageData(0,0,y,b).data),S=this.#getHistogram(x),C=this.#guessThreshold(S),w=this.#findContours(x,y,b,C);return this.processDrawnLines({lines:{curves:w,width:y,height:b},pageWidth:i,pageHeight:a,rotation:o,innerMargin:s,mustSmooth:!0,areContours:!0})}static process(e,t,n,r,i){let[a,o,s]=this.#getGrayPixels(e),[c,l]=this.#bilateralFilter(a,o,s,Math.hypot(o,s)*this.#PARAMETERS.sigmaSFactor,this.#PARAMETERS.sigmaR,this.#PARAMETERS.kernelSize),u=this.#guessThreshold(l),d=this.#findContours(c,o,s,u);return this.processDrawnLines({lines:{curves:d,width:o,height:s},pageWidth:t,pageHeight:n,rotation:r,innerMargin:i,mustSmooth:!0,areContours:!0})}static processDrawnLines({lines:e,pageWidth:t,pageHeight:n,rotation:r,innerMargin:i,mustSmooth:a,areContours:o}){r%180!=0&&([t,n]=[n,t]);let{curves:s,width:c,height:l}=e,u=e.thickness??0,d=[],f=Math.min(t/c,n/l),p=f/t,m=f/n,h=[];for(let{points:e}of s){let t=a?this.#douglasPeucker(e):e;if(!t)continue;h.push(t);let n=t.length,r=new Float32Array(n),i=new Float32Array(3*(n===2?2:n-2));if(d.push({line:i,points:r}),n===2){r[0]=t[0]*p,r[1]=t[1]*m,i.set([NaN,NaN,NaN,NaN,r[0],r[1]],0);continue}let[o,s,c,l]=t;o*=p,s*=m,c*=p,l*=m,r.set([o,s,c,l],0),i.set([NaN,NaN,NaN,NaN,o,s],0);for(let e=4;e<n;e+=2){let n=r[e]=t[e]*p,a=r[e+1]=t[e+1]*m;i.set($.createBezierPoints(o,s,c,l,n,a),(e-2)*3),[o,s,c,l]=[c,l,n,a]}}if(d.length===0)return null;let g=o?new Zi:new Ji;return g.build(d,t,n,1,r,o?0:u,i),{outline:g,newCurves:h,areContours:o,thickness:u,width:c,height:l}}static async compressSignature({outlines:e,areContours:t,thickness:n,width:r,height:i}){let a=1/0,o=-1/0,s=0;for(let t of e){s+=t.length;for(let e=2,n=t.length;e<n;e++){let n=t[e]-t[e-2];a=Math.min(a,n),o=Math.max(o,n)}}let c;c=a>=-128&&o<=127?Int8Array:a>=-32768&&o<=32767?Int16Array:Int32Array;let l=e.length,u=Qi+$i*l,d=new Uint32Array(u),f=0;d[f++]=u*Uint32Array.BYTES_PER_ELEMENT+(s-2*l)*c.BYTES_PER_ELEMENT,d[f++]=0,d[f++]=r,d[f++]=i,d[f++]=t?0:1,d[f++]=Math.max(0,Math.floor(n??0)),d[f++]=l,d[f++]=c.BYTES_PER_ELEMENT;for(let t of e)d[f++]=t.length-2,d[f++]=t[0],d[f++]=t[1];let p=new CompressionStream(`deflate-raw`),m=p.writable.getWriter();await m.ready,m.write(d);let h=c.prototype.constructor;for(let t of e){let e=new h(t.length-2);for(let n=2,r=t.length;n<r;n++)e[n-2]=t[n]-t[n-2];m.write(e)}m.close();let g=await new Response(p.readable).arrayBuffer();return new Uint8Array(g).toBase64()}static async decompressSignature(e){try{let t=Uint8Array.fromBase64(e),{readable:n,writable:r}=new DecompressionStream(`deflate-raw`),i=r.getWriter();await i.ready,i.write(t).then(async()=>{await i.ready,await i.close()}).catch(()=>{});let a=null,o=0;for await(let e of n)a||=new Uint8Array(new Uint32Array(e.buffer,0,4)[0]),a.set(e,o),o+=e.length;let s=new Uint32Array(a.buffer,0,a.length>>2),c=s[1];if(c!==0)throw Error(`Invalid version: ${c}`);let l=s[2],u=s[3],d=s[4]===0,f=s[5],p=s[6],m=s[7],h=[],g=(Qi+$i*p)*Uint32Array.BYTES_PER_ELEMENT,_;switch(m){case Int8Array.BYTES_PER_ELEMENT:_=new Int8Array(a.buffer,g);break;case Int16Array.BYTES_PER_ELEMENT:_=new Int16Array(a.buffer,g);break;case Int32Array.BYTES_PER_ELEMENT:_=new Int32Array(a.buffer,g);break}o=0;for(let e=0;e<p;e++){let t=s[$i*e+Qi],n=new Float32Array(t+2);h.push(n);for(let t=0;t<$i-1;t++)n[t]=s[$i*e+Qi+t+1];for(let e=0;e<t;e++)n[e+2]=n[e]+_[o++]}return{areContours:d,thickness:f,outlines:h,width:l,height:u}}catch(e){return P(`decompressSignature: ${e}`),null}}},ta=class e extends Gi{constructor(){super(),super.updateProperties({fill:G._defaultLineColor,"stroke-width":0})}clone(){let t=new e;return t.updateAll(this),t}},na=class e extends Yi{constructor(e){super(e),super.updateProperties({stroke:G._defaultLineColor,"stroke-width":1})}clone(){let t=new e(this._viewParameters);return t.updateAll(this),t}},ra=class e extends Ki{#isExtracted=!1;#description=null;#signatureData=null;#signatureUUID=null;static _type=`signature`;static _editorType=D.SIGNATURE;static _defaultDrawingOptions=null;constructor(e){super({...e,mustBeCommitted:!0,name:`signatureEditor`}),this._willKeepAspectRatio=!0,this.#signatureData=e.signatureData||null,this.#description=null,this.defaultL10nId=`pdfjs-editor-signature-editor1`}static initialize(e,t){G.initialize(e,t),this._defaultDrawingOptions=new ta,this._defaultDrawnSignatureOptions=new na(t.viewParameters)}static getDefaultDrawingOptions(e){let t=this._defaultDrawingOptions.clone();return t.updateProperties(e),t}static get supportMultipleDrawings(){return!1}static get typesMap(){return L(this,`typesMap`,new Map)}static get isDrawer(){return!1}get telemetryFinalData(){return{type:`signature`,hasDescription:!!this.#description}}static computeTelemetryFinalData(e){let t=e.get(`hasDescription`);return{hasAltText:t.get(!0)??0,hasNoAltText:t.get(!1)??0}}get isResizable(){return!0}onScaleChanging(){this._drawId!==null&&super.onScaleChanging()}render(){if(this.div)return this.div;let t,n,{_isCopy:r}=this;if(r&&(this._isCopy=!1,t=this.x,n=this.y),super.render(),this._drawId===null)if(this.#signatureData){let{lines:t,mustSmooth:n,areContours:r,description:i,uuid:a,heightInPage:o}=this.#signatureData,{rawDims:{pageWidth:s,pageHeight:c},rotation:l}=this.parent.viewport,u=ea.processDrawnLines({lines:t,pageWidth:s,pageHeight:c,rotation:l,innerMargin:e._INNER_MARGIN,mustSmooth:n,areContours:r});this.addSignature(u,o,i,a)}else this.div.setAttribute(`data-l10n-args`,JSON.stringify({description:``})),this.div.hidden=!0,this._uiManager.getSignature(this);else this.div.setAttribute(`data-l10n-args`,JSON.stringify({description:this.#description||``}));return r&&(this._isCopy=!0,this._moveAfterPaste(t,n)),this.div}setUuid(e){this.#signatureUUID=e,this.addEditToolbar()}getUuid(){return this.#signatureUUID}get description(){return this.#description}set description(e){this.#description=e,this.div&&(this.div.setAttribute(`data-l10n-args`,JSON.stringify({description:e})),super.addEditToolbar().then(t=>{t?.updateEditSignatureButton(e)}))}getSignaturePreview(){let{newCurves:e,areContours:t,thickness:n,width:r,height:i}=this.#signatureData,a=Math.max(r,i),o=ea.processDrawnLines({lines:{curves:e.map(e=>({points:e})),thickness:n,width:r,height:i},pageWidth:a,pageHeight:a,rotation:0,innerMargin:0,mustSmooth:!1,areContours:t});return{areContours:t,outline:o.outline}}get toolbarButtons(){return this._uiManager.signatureManager?[[`editSignature`,this._uiManager.signatureManager]]:super.toolbarButtons}addSignature(t,n,r,i){let{x:a,y:o}=this,{outline:s}=this.#signatureData=t;this.#isExtracted=s instanceof Zi,this.description=r;let c;this.#isExtracted?c=e.getDefaultDrawingOptions():(c=e._defaultDrawnSignatureOptions.clone(),c.updateProperties({"stroke-width":s.thickness})),this._addOutlines({drawOutlines:s,drawingOptions:c});let[,l]=this.pageDimensions,u=n/l;u=u>=1?.5:u,this.width*=u/this.height,this.width>=1&&(u*=.9/this.width,this.width=.9),this.height=u,this.setDims(),this.x=a,this.y=o,this.center(),this._onResized(),this.onScaleChanging(),this.rotate(),this._uiManager.addToAnnotationStorage(this),this.setUuid(i),this._reportTelemetry({action:`pdfjs.signature.inserted`,data:{hasBeenSaved:!!i,hasDescription:!!r}}),this.div.hidden=!1}getFromImage(t){let{rawDims:{pageWidth:n,pageHeight:r},rotation:i}=this.parent.viewport;return ea.process(t,n,r,i,e._INNER_MARGIN)}getFromText(t,n){let{rawDims:{pageWidth:r,pageHeight:i},rotation:a}=this.parent.viewport;return ea.extractContoursFromText(t,n,r,i,a,e._INNER_MARGIN)}getDrawnSignature(t){let{rawDims:{pageWidth:n,pageHeight:r},rotation:i}=this.parent.viewport;return ea.processDrawnLines({lines:t,pageWidth:n,pageHeight:r,rotation:i,innerMargin:e._INNER_MARGIN,mustSmooth:!1,areContours:!1})}createDrawingOptions({areContours:t,thickness:n}){t?this._drawingOptions=e.getDefaultDrawingOptions():(this._drawingOptions=e._defaultDrawnSignatureOptions.clone(),this._drawingOptions.updateProperties({"stroke-width":n}))}serialize(e=!1){if(this.isEmpty())return null;let{lines:t,points:n}=this.serializeDraw(e),{_drawingOptions:{"stroke-width":r}}=this,i=Object.assign(super.serialize(e),{isSignature:!0,areContours:this.#isExtracted,color:[0,0,0],thickness:this.#isExtracted?0:r});return this.addComment(i),e?(i.paths={lines:t,points:n},i.uuid=this.#signatureUUID,i.isCopy=!0):i.lines=t,this.#description&&(i.accessibilityData={type:`Figure`,alt:this.#description}),i}static deserializeDraw(e,t,n,r,i,a){return a.areContours?Zi.deserialize(e,t,n,r,i,a):Ji.deserialize(e,t,n,r,i,a)}static async deserialize(e,t,n){let r=await super.deserialize(e,t,n);return r.#isExtracted=e.areContours,r.description=e.accessibilityData?.alt||``,r.#signatureUUID=e.uuid,r}},ia=class extends G{#bitmap=null;#bitmapId=null;#bitmapPromise=null;#bitmapUrl=null;#bitmapFile=null;#bitmapFileName=``;#canvas=null;#missingCanvas=!1;#resizeTimeoutId=null;#isSvg=!1;#hasBeenAddedInUndoStack=!1;static _type=`stamp`;static _editorType=D.STAMP;constructor(e){super({...e,name:`stampEditor`}),this.#bitmapUrl=e.bitmapUrl,this.#bitmapFile=e.bitmapFile,this.defaultL10nId=`pdfjs-editor-stamp-editor`}static initialize(e,t){G.initialize(e,t)}static isHandlingMimeForPasting(e){return $e.includes(e)}static paste(e,t){t.pasteEditor({mode:D.STAMP},{bitmapFile:e.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){return{type:`stamp`,hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(e){let t=e.get(`hasAltText`);return{hasAltText:t.get(!0)??0,hasNoAltText:t.get(!1)??0}}#getBitmapFetched(e,t=!1){if(!e){this.remove();return}this.#bitmap=e.bitmap,t||(this.#bitmapId=e.id,this.#isSvg=e.isSvg),e.file&&(this.#bitmapFileName=e.file.name),this.#createCanvas()}#getBitmapDone(){if(this.#bitmapPromise=null,this._uiManager.enableWaiting(!1),this.#canvas){if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#bitmap){this.addEditToolbar().then(()=>{this._editToolbar.hide(),this._uiManager.editAltText(this,!0)});return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#bitmap){this._reportTelemetry({action:`pdfjs.image.image_added`,data:{alt_text_modal:!1,alt_text_type:`empty`}});try{this.mlGuessAltText()}catch{}}this.div.focus()}}async mlGuessAltText(e=null,t=!0){if(this.hasAltTextData())return null;let{mlManager:n}=this._uiManager;if(!n)throw Error(`No ML.`);if(!await n.isEnabledFor(`altText`))throw Error(`ML isn't enabled for alt text.`);let{data:r,width:i,height:a}=e||this.copyCanvas(null,null,!0).imageData,o=await n.guess({name:`altText`,request:{data:r,width:i,height:a,channels:r.length/(i*a)}});if(!o)throw Error(`No response from the AI service.`);if(o.error)throw Error(`Error from the AI service.`);if(o.cancel)return null;if(!o.output)throw Error(`No valid response from the AI service.`);let s=o.output;return await this.setGuessedAltText(s),t&&!this.hasAltTextData()&&(this.altTextData={alt:s,decorative:!1}),s}#getBitmap(){if(this.#bitmapId){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(this.#bitmapId).then(e=>this.#getBitmapFetched(e,!0)).finally(()=>this.#getBitmapDone());return}if(this.#bitmapUrl){let e=this.#bitmapUrl;this.#bitmapUrl=null,this._uiManager.enableWaiting(!0),this.#bitmapPromise=this._uiManager.imageManager.getFromUrl(e).then(e=>this.#getBitmapFetched(e)).finally(()=>this.#getBitmapDone());return}if(this.#bitmapFile){let e=this.#bitmapFile;this.#bitmapFile=null,this._uiManager.enableWaiting(!0),this.#bitmapPromise=this._uiManager.imageManager.getFromFile(e).then(e=>this.#getBitmapFetched(e)).finally(()=>this.#getBitmapDone());return}let e=document.createElement(`input`);e.type=`file`,e.accept=$e.join(`,`);let t=this._uiManager._signal;this.#bitmapPromise=new Promise(n=>{e.addEventListener(`change`,async()=>{if(!e.files||e.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);let t=await this._uiManager.imageManager.getFromFile(e.files[0]);this._reportTelemetry({action:`pdfjs.image.image_selected`,data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),this.#getBitmapFetched(t)}n()},{signal:t}),e.addEventListener(`cancel`,()=>{this.remove(),n()},{signal:t})}).finally(()=>this.#getBitmapDone()),e.click()}remove(){this.#bitmapId&&(this.#bitmap=null,this._uiManager.imageManager.deleteId(this.#bitmapId),this.#canvas?.remove(),this.#canvas=null,this.#resizeTimeoutId&&=(clearTimeout(this.#resizeTimeoutId),null)),super.remove()}rebuild(){if(!this.parent){this.#bitmapId&&this.#getBitmap();return}super.rebuild(),this.div!==null&&(this.#bitmapId&&this.#canvas===null&&this.#getBitmap(),this.isAttachedToDOM||this.parent.add(this))}onceAdded(e){this._isDraggable=!0,e&&this.div.focus()}isEmpty(){return!(this.#bitmapPromise||this.#bitmap||this.#bitmapUrl||this.#bitmapFile||this.#bitmapId||this.#missingCanvas)}get toolbarButtons(){return[[`altText`,this.createAltText()]]}get isResizable(){return!0}render(){if(this.div)return this.div;let e,t;return this._isCopy&&(e=this.x,t=this.y),super.render(),this.div.hidden=!0,this.createAltText(),this.#missingCanvas||(this.#bitmap?this.#createCanvas():this.#getBitmap()),this._isCopy&&this._moveAfterPaste(e,t),this._uiManager.addShouldRescale(this),this.div}setCanvas(e,t){let{id:n,bitmap:r}=this._uiManager.imageManager.getFromCanvas(e,t);t.remove(),n&&this._uiManager.imageManager.isValidId(n)&&(this.#bitmapId=n,r&&(this.#bitmap=r),this.#missingCanvas=!1,this.#createCanvas())}_onResized(){this.onScaleChanging()}onScaleChanging(){this.parent&&(this.#resizeTimeoutId!==null&&clearTimeout(this.#resizeTimeoutId),this.#resizeTimeoutId=setTimeout(()=>{this.#resizeTimeoutId=null,this.#drawBitmap()},200))}#createCanvas(){let{div:e}=this,{width:t,height:n}=this.#bitmap,[r,i]=this.pageDimensions,a=.75;if(this.width)t=this.width*r,n=this.height*i;else if(t>a*r||n>a*i){let e=Math.min(a*r/t,a*i/n);t*=e,n*=e}this._uiManager.enableWaiting(!1);let o=this.#canvas=document.createElement(`canvas`);o.setAttribute(`role`,`img`),this.addContainer(o),this.width=t/r,this.height=n/i,this.setDims(),this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId)&&(e.hidden=!1),this.#drawBitmap(),this.#hasBeenAddedInUndoStack||=(this.parent.addUndoableEditor(this),!0),this._reportTelemetry({action:`inserted_image`}),this.#bitmapFileName&&this.div.setAttribute(`aria-description`,this.#bitmapFileName),this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-stamp-added-alert`)}copyCanvas(e,t,n=!1){e||=224;let{width:r,height:i}=this.#bitmap,a=new Qe,o=this.#bitmap,s=r,c=i,l=null;if(t){if(r>t||i>t){let e=Math.min(t/r,t/i);s=Math.floor(r*e),c=Math.floor(i*e)}l=document.createElement(`canvas`);let e=l.width=Math.ceil(s*a.sx),n=l.height=Math.ceil(c*a.sy);this.#isSvg||(o=this.#scaleBitmap(e,n));let u=l.getContext(`2d`);u.filter=this._uiManager.hcmFilter;let d=`white`,f=`#cfcfd8`;this._uiManager.hcmFilter===`none`?et.isDarkMode&&(d=`#8f8f9d`,f=`#42414d`):f=`black`;let p=15*a.sx,m=15*a.sy,h=new OffscreenCanvas(p*2,m*2),g=h.getContext(`2d`);g.fillStyle=d,g.fillRect(0,0,p*2,m*2),g.fillStyle=f,g.fillRect(0,0,p,m),g.fillRect(p,m,p,m),u.fillStyle=u.createPattern(h,`repeat`),u.fillRect(0,0,e,n),u.drawImage(o,0,0,o.width,o.height,0,0,e,n)}let u=null;if(n){let t,n;if(a.symmetric&&o.width<e&&o.height<e)t=o.width,n=o.height;else if(o=this.#bitmap,r>e||i>e){let a=Math.min(e/r,e/i);t=Math.floor(r*a),n=Math.floor(i*a),this.#isSvg||(o=this.#scaleBitmap(t,n))}let s=new OffscreenCanvas(t,n).getContext(`2d`,{willReadFrequently:!0});s.drawImage(o,0,0,o.width,o.height,0,0,t,n),u={width:t,height:n,data:s.getImageData(0,0,t,n).data}}return{canvas:l,width:s,height:c,imageData:u}}#scaleBitmap(e,t){let{width:n,height:r}=this.#bitmap,i=n,a=r,o=this.#bitmap;for(;i>2*e||a>2*t;){let n=i,r=a;i>2*e&&(i=i>=16384?Math.floor(i/2)-1:Math.ceil(i/2)),a>2*t&&(a=a>=16384?Math.floor(a/2)-1:Math.ceil(a/2));let s=new OffscreenCanvas(i,a);s.getContext(`2d`).drawImage(o,0,0,n,r,0,0,i,a),o=s.transferToImageBitmap()}return o}#drawBitmap(){let[e,t]=this.parentDimensions,{width:n,height:r}=this,i=new Qe,a=Math.ceil(n*e*i.sx),o=Math.ceil(r*t*i.sy),s=this.#canvas;if(!s||s.width===a&&s.height===o)return;s.width=a,s.height=o;let c=this.#isSvg?this.#bitmap:this.#scaleBitmap(a,o),l=s.getContext(`2d`);l.filter=this._uiManager.hcmFilter,l.drawImage(c,0,0,c.width,c.height,0,0,a,o)}#serializeBitmap(e){if(e){if(this.#isSvg){let e=this._uiManager.imageManager.getSvgUrl(this.#bitmapId);if(e)return e}let e=document.createElement(`canvas`);return{width:e.width,height:e.height}=this.#bitmap,e.getContext(`2d`).drawImage(this.#bitmap,0,0),e.toDataURL()}if(this.#isSvg){let[e,t]=this.pageDimensions,n=Math.round(this.width*e*Fe.PDF_TO_CSS_UNITS),r=Math.round(this.height*t*Fe.PDF_TO_CSS_UNITS),i=new OffscreenCanvas(n,r);return i.getContext(`2d`).drawImage(this.#bitmap,0,0,this.#bitmap.width,this.#bitmap.height,0,0,n,r),i.transferToImageBitmap()}return structuredClone(this.#bitmap)}static async deserialize(e,t,n){let r=null,i=!1;if(e instanceof Ni){let{data:{rect:a,rotation:o,id:s,structParent:c,popupRef:l,richText:u,contentsObj:d,creationDate:f,modificationDate:p},container:m,parent:{page:{pageNumber:h}},canvas:g}=e,_,v;g?(delete e.canvas,{id:_,bitmap:v}=n.imageManager.getFromCanvas(m.id,g),g.remove()):(i=!0,e._hasNoCanvas=!0);let y=(await t._structTree.getAriaAttributes(`${Ae}${s}`))?.get(`aria-label`)||``;r=e={annotationType:D.STAMP,bitmapId:_,bitmap:v,pageIndex:h-1,rect:a.slice(0),rotation:o,annotationElementId:s,id:s,deleted:!1,accessibilityData:{decorative:!1,altText:y},isSvg:!1,structParent:c,popupRef:l,richText:u,comment:d?.str||null,creationDate:f,modificationDate:p}}let a=await super.deserialize(e,t,n),{rect:o,bitmap:s,bitmapUrl:c,bitmapId:l,isSvg:u,accessibilityData:d}=e;i?(n.addMissingCanvas(e.id,a),a.#missingCanvas=!0):l&&n.imageManager.isValidId(l)?(a.#bitmapId=l,s&&(a.#bitmap=s)):a.#bitmapUrl=c,a.#isSvg=u;let[f,p]=a.pageDimensions;return a.width=(o[2]-o[0])/f,a.height=(o[3]-o[1])/p,d&&(a.altTextData=d),a._initialData=r,e.comment&&a.setCommentData(e),a.#hasBeenAddedInUndoStack=!!r,a}serialize(e=!1,t=null){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();let n=Object.assign(super.serialize(e),{bitmapId:this.#bitmapId,isSvg:this.#isSvg});if(this.addComment(n),e)return n.bitmapUrl=this.#serializeBitmap(!0),n.accessibilityData=this.serializeAltText(!0),n.isCopy=!0,n;let{decorative:r,altText:i}=this.serializeAltText(!1);if(!r&&i&&(n.accessibilityData={type:`Figure`,alt:i}),this.annotationElementId){let e=this.#hasElementChanged(n);return e.isSame?null:(e.isSameAltText?delete n.accessibilityData:n.accessibilityData.structParent=this._initialData.structParent??-1,n.id=this.annotationElementId,delete n.bitmapId,n)}if(t===null)return n;t.stamps||=new Map;let a=this.#isSvg?(n.rect[2]-n.rect[0])*(n.rect[3]-n.rect[1]):null;if(!t.stamps.has(this.#bitmapId))t.stamps.set(this.#bitmapId,{area:a,serialized:n}),n.bitmap=this.#serializeBitmap(!1);else if(this.#isSvg){let e=t.stamps.get(this.#bitmapId);a>e.area&&(e.area=a,e.serialized.bitmap.close(),e.serialized.bitmap=this.#serializeBitmap(!1))}return n}#hasElementChanged(e){let{pageIndex:t,accessibilityData:{altText:n}}=this._initialData,r=e.pageIndex===t,i=(e.accessibilityData?.alt||``)===n;return{isSame:!this.hasEditedComment&&!this._hasBeenMoved&&!this._hasBeenResized&&r&&i,isSameAltText:i}}renderAnnotationElement(e){return this.deleted?(e.hide(),null):(e.updateEdited({rect:this.getPDFRect(),popup:this.comment}),null)}},aa=class e{#accessibilityManager;#allowClick=!1;#annotationLayer=null;#clickAC=null;#editorFocusTimeoutId=null;#editors=new Map;#hadPointerDown=!1;#isDisabling=!1;#isEnabling=!1;#drawingAC=null;#focusedElement=null;#textLayer=null;#textSelectionAC=null;#textLayerDblClickAC=null;#lastPointerDownTimestamp=-1;#uiManager;static _initialized=!1;static#editorTypes=new Map([Li,Xi,ia,Wi,ra].map(e=>[e._editorType,e]));constructor({uiManager:t,pageIndex:n,div:r,structTreeLayer:i,accessibilityManager:a,annotationLayer:o,drawLayer:s,textLayer:c,viewport:l,l10n:u}){let d=[...e.#editorTypes.values()];if(!e._initialized){e._initialized=!0;for(let e of d)e.initialize(u,t)}t.registerEditorTypes(d),this.#uiManager=t,this.pageIndex=n,this.div=r,this.#accessibilityManager=a,this.#annotationLayer=o,this.viewport=l,this.#textLayer=c,this.drawLayer=s,this._structTree=i,this.#uiManager.addLayer(this)}updatePageIndex(e){this.pageIndex=e}get isEmpty(){return this.#editors.size===0}get isInvisible(){return this.isEmpty&&this.#uiManager.getMode()===D.NONE}updateToolbar(e){this.#uiManager.updateToolbar(e)}updateMode(t=this.#uiManager.getMode()){switch(this.#cleanup(),t){case D.NONE:this.div.classList.toggle(`nonEditing`,!0),this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),this.disableClick();return;case D.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case D.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);let{classList:n}=this.div;if(n.toggle(`nonEditing`,!1),t===D.POPUP)n.toggle(`commentEditing`,!0);else{n.toggle(`commentEditing`,!1);for(let r of e.#editorTypes.values())n.toggle(`${r._type}Editing`,t===r._editorType)}this.div.hidden=!1}hasTextLayer(e){return e===this.#textLayer?.div}setEditingState(e){this.#uiManager.setEditingState(e)}addCommands(e){this.#uiManager.addCommands(e)}cleanUndoStack(e){this.#uiManager.cleanUndoStack(e)}toggleDrawing(e=!1){this.div.classList.toggle(`drawing`,!e)}togglePointerEvents(e=!1){this.div.classList.toggle(`disabled`,!e)}toggleAnnotationLayerPointerEvents(e=!1){this.#annotationLayer?.togglePointerEvents(e)}get#allEditorsIterator(){return this.#editors.size===0?this.#uiManager.getEditors(this.pageIndex):this.#editors.values()}async enable(){this.#isEnabling=!0,this.div.tabIndex=0,this.togglePointerEvents(!0),this.div.classList.toggle(`nonEditing`,!1),this.#textLayerDblClickAC?.abort(),this.#textLayerDblClickAC=null;let e=new Set;for(let t of this.#allEditorsIterator)t.enableEditing(),t.show(!0),t.annotationElementId&&(this.#uiManager.removeChangedExistingAnnotation(t),e.add(t.annotationElementId));let t=this.#annotationLayer;if(t)for(let n of t.getEditableAnnotations()){if(n.hide(),this.#uiManager.isDeletedAnnotationElement(n.data.id)||e.has(n.data.id))continue;let t=await this.deserialize(n);t&&(this.addOrRebuild(t),t.enableEditing())}this.#isEnabling=!1,this.#uiManager._eventBus.dispatch(`editorsrendered`,{source:this,pageNumber:this.pageIndex+1})}disable(){if(this.#isDisabling=!0,this.div.tabIndex=-1,this.togglePointerEvents(!1),this.div.classList.toggle(`nonEditing`,!0),this.#textLayer&&!this.#textLayerDblClickAC){this.#textLayerDblClickAC=new AbortController;let e=this.#uiManager.combinedSignal(this.#textLayerDblClickAC);this.#textLayer.div.addEventListener(`pointerdown`,e=>{let{clientX:t,clientY:n,timeStamp:r}=e,i=this.#lastPointerDownTimestamp;if(r-i>500){this.#lastPointerDownTimestamp=r;return}this.#lastPointerDownTimestamp=-1;let{classList:a}=this.div;a.toggle(`getElements`,!0);let o=document.elementsFromPoint(t,n);if(a.toggle(`getElements`,!1),!this.div.contains(o[0]))return;let s,c=RegExp(`^${E}[0-9]+$`);for(let e of o)if(c.test(e.id)){s=e.id;break}if(!s)return;let l=this.#editors.get(s);l?.annotationElementId===null&&(e.stopPropagation(),e.preventDefault(),l.dblclick(e))},{signal:e,capture:!0})}let t=this.#annotationLayer,n=[];if(t){let e=new Map,r=new Map;for(let t of this.#allEditorsIterator){if(t.disableEditing(),!t.annotationElementId){n.push(t);continue}if(t.serialize()!==null){e.set(t.annotationElementId,t);continue}else r.set(t.annotationElementId,t);this.getEditableAnnotation(t.annotationElementId)?.show(),t.remove()}let i=t.getEditableAnnotations();for(let t of i){let{id:n}=t.data;if(this.#uiManager.isDeletedAnnotationElement(n)){t.updateEdited({deleted:!0});continue}let i=r.get(n);if(i){i.resetAnnotationElement(t),i.show(!1),t.show();continue}i=e.get(n),i&&(this.#uiManager.addChangedExistingAnnotation(i),i.renderAnnotationElement(t)&&i.show(!1)),t.show()}}this.#cleanup(),this.isEmpty&&(this.div.hidden=!0);let{classList:r}=this.div;for(let t of e.#editorTypes.values())r.remove(`${t._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),t?.updateFakeAnnotations(n),this.#isDisabling=!1}getEditableAnnotation(e){return this.#annotationLayer?.getEditableAnnotation(e)||null}setActiveEditor(e){this.#uiManager.getActive()!==e&&this.#uiManager.setActiveEditor(e)}enableTextSelection(){if(this.div.tabIndex=-1,this.#textLayer?.div&&!this.#textSelectionAC){this.#textSelectionAC=new AbortController;let e=this.#uiManager.combinedSignal(this.#textSelectionAC);this.#textLayer.div.addEventListener(`pointerdown`,this.#textLayerPointerDown.bind(this),{signal:e}),this.#textLayer.div.classList.add(`highlighting`)}}disableTextSelection(){this.div.tabIndex=0,this.#textLayer?.div&&this.#textSelectionAC&&(this.#textSelectionAC.abort(),this.#textSelectionAC=null,this.#textLayer.div.classList.remove(`highlighting`))}#textLayerPointerDown(e){this.#uiManager.unselectAll();let{target:t}=e;if(t===this.#textLayer.div||(t.getAttribute(`role`)===`img`||t.classList.contains(`endOfContent`))&&this.#textLayer.div.contains(t)){let{isMac:t}=R.platform;if(e.button!==0||e.ctrlKey&&t)return;this.#uiManager.showAllEditors(`highlight`,!0,!0),this.#textLayer.div.classList.add(`free`),this.toggleDrawing(),Wi.startHighlighting(this,this.#uiManager.direction===`ltr`,{target:this.#textLayer.div,x:e.x,y:e.y}),this.#textLayer.div.addEventListener(`pointerup`,()=>{this.#textLayer.div.classList.remove(`free`),this.toggleDrawing(!0)},{once:!0,signal:this.#uiManager._signal}),e.preventDefault()}}enableClick(){if(this.#clickAC)return;this.#clickAC=new AbortController;let e=this.#uiManager.combinedSignal(this.#clickAC);this.div.addEventListener(`pointerdown`,this.pointerdown.bind(this),{signal:e});let t=this.pointerup.bind(this);this.div.addEventListener(`pointerup`,t,{signal:e}),this.div.addEventListener(`pointercancel`,t,{signal:e})}disableClick(){this.#clickAC?.abort(),this.#clickAC=null}attach(e){this.#editors.set(e.id,e);let{annotationElementId:t}=e;t&&this.#uiManager.isDeletedAnnotationElement(t)&&this.#uiManager.removeDeletedAnnotationElement(e)}detach(e){this.#editors.delete(e.id),this.#accessibilityManager?.removePointerInTextLayer(e.contentDiv),!this.#isDisabling&&e.annotationElementId&&this.#uiManager.addDeletedAnnotationElement(e)}remove(e){this.detach(e),this.#uiManager.removeEditor(e),e.div.remove(),e.isAttachedToDOM=!1}changeParent(e){e.parent!==this&&(e.parent&&e.annotationElementId&&(this.#uiManager.addDeletedAnnotationElement(e),G.deleteAnnotationElement(e),e.annotationElementId=null),this.attach(e),e.parent?.detach(e),e.setParent(this),e.div&&e.isAttachedToDOM&&(e.div.remove(),this.div.append(e.div)))}add(e){if(!(e.parent===this&&e.isAttachedToDOM)){if(this.changeParent(e),this.#uiManager.addEditor(e),this.attach(e),!e.isAttachedToDOM){let t=e.render();this.div.append(t),e.isAttachedToDOM=!0}e.fixAndSetPosition(),e.onceAdded(!this.#isEnabling),this.#uiManager.addToAnnotationStorage(e),e._reportTelemetry(e.telemetryInitialData)}}moveEditorInDOM(e){if(!e.isAttachedToDOM)return;let{activeElement:t}=document;e.div.contains(t)&&!this.#editorFocusTimeoutId&&(e._focusEventsAllowed=!1,this.#editorFocusTimeoutId=setTimeout(()=>{this.#editorFocusTimeoutId=null,e.div.contains(document.activeElement)?e._focusEventsAllowed=!0:(e.div.addEventListener(`focusin`,()=>{e._focusEventsAllowed=!0},{once:!0,signal:this.#uiManager._signal}),t.focus())},0)),e._structTreeParentId=this.#accessibilityManager?.moveElementInDOM(this.div,e.div,e.contentDiv,!0)}addOrRebuild(e){e.needsToBeRebuilt()?(e.parent||=this,e.rebuild(),e.show()):this.add(e)}addUndoableEditor(e){this.addCommands({cmd:()=>e._uiManager.rebuild(e),undo:()=>{e.remove()},mustExec:!1})}getEditorByUID(e){for(let t of this.#editors.values())if(t.uid===e)return t;return null}getNextId(){return this.#uiManager.getId()}get#currentEditorType(){return e.#editorTypes.get(this.#uiManager.getMode())}combinedSignal(e){return this.#uiManager.combinedSignal(e)}#createNewEditor(e){let t=this.#currentEditorType;return t?new t.prototype.constructor(e):null}canCreateNewEmptyEditor(){return this.#currentEditorType?.canCreateNewEmptyEditor()}async pasteEditor(e,t){this.updateToolbar(e),await this.#uiManager.updateMode(e.mode);let{offsetX:n,offsetY:r}=this.#getCenterPoint(),i=this.getNextId(),a=this.#createNewEditor({parent:this,id:i,x:n,y:r,uiManager:this.#uiManager,isCentered:!0,...t});a&&this.add(a)}async deserialize(t){return await e.#editorTypes.get(t.annotationType??t.annotationEditorType)?.deserialize(t,this,this.#uiManager)||null}createAndAddNewEditor(e,t,n={}){let r=this.getNextId(),i=this.#createNewEditor({parent:this,id:r,x:e.offsetX,y:e.offsetY,uiManager:this.#uiManager,isCentered:t,...n});return i&&this.add(i),i}get boundingClientRect(){return this.div.getBoundingClientRect()}#getCenterPoint(){let{x:e,y:t,width:n,height:r}=this.boundingClientRect,i=Math.max(0,e),a=Math.max(0,t),o=Math.min(window.innerWidth,e+n),s=Math.min(window.innerHeight,t+r),c=(i+o)/2-e,l=(a+s)/2-t,[u,d]=this.viewport.rotation%180==0?[c,l]:[l,c];return{offsetX:u,offsetY:d}}addNewEditor(e={}){this.createAndAddNewEditor(this.#getCenterPoint(),!0,e)}setSelected(e){this.#uiManager.setSelected(e)}toggleSelected(e){this.#uiManager.toggleSelected(e)}unselect(e){this.#uiManager.unselect(e)}pointerup(e){let{isMac:t}=R.platform;if(e.button!==0||e.ctrlKey&&t||e.target!==this.div||!this.#hadPointerDown||(this.#hadPointerDown=!1,this.#currentEditorType?.isDrawer&&this.#currentEditorType.supportMultipleDrawings))return;if(!this.#allowClick){this.#allowClick=!0;return}let n=this.#uiManager.getMode();if(n===D.STAMP||n===D.SIGNATURE){this.#uiManager.unselectAll();return}this.createAndAddNewEditor(e,!1)}pointerdown(e){if(this.#uiManager.getMode()===D.HIGHLIGHT&&this.enableTextSelection(),this.#hadPointerDown){this.#hadPointerDown=!1;return}let{isMac:t}=R.platform;if(e.button!==0||e.ctrlKey&&t||e.target!==this.div)return;if(this.#hadPointerDown=!0,this.#currentEditorType?.isDrawer){this.startDrawingSession(e);return}let n=this.#uiManager.getActive();this.#allowClick=!n||n.isEmpty()}startDrawingSession(e){if(this.div.focus({preventScroll:!0}),this.#drawingAC){this.#currentEditorType.startDrawing(this,this.#uiManager,!1,e);return}this.#uiManager.setCurrentDrawingSession(this),this.#drawingAC=new AbortController;let t=this.#uiManager.combinedSignal(this.#drawingAC);this.div.addEventListener(`blur`,({relatedTarget:e})=>{e&&!this.div.contains(e)&&(this.#focusedElement=null,this.commitOrRemove())},{signal:t}),this.#currentEditorType.startDrawing(this,this.#uiManager,!1,e)}pause(e){if(e){let{activeElement:e}=document;this.div.contains(e)&&(this.#focusedElement=e);return}this.#focusedElement&&setTimeout(()=>{this.#focusedElement?.focus(),this.#focusedElement=null},0)}endDrawingSession(e=!1){return this.#drawingAC?(this.#uiManager.setCurrentDrawingSession(null),this.#drawingAC.abort(),this.#drawingAC=null,this.#focusedElement=null,this.#currentEditorType.endDrawing(e)):null}findNewParent(e,t,n){let r=this.#uiManager.findParent(t,n);return r===null||r===this?!1:(r.changeParent(e),!0)}commitOrRemove(){return this.#drawingAC?(this.endDrawingSession(),!0):!1}onScaleChanging(){this.#drawingAC&&this.#currentEditorType.onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove(),this.#uiManager.getActive()?.parent===this&&(this.#uiManager.commitOrRemove(),this.#uiManager.setActiveEditor(null)),this.#editorFocusTimeoutId&&=(clearTimeout(this.#editorFocusTimeoutId),null);for(let e of this.#editors.values())this.#accessibilityManager?.removePointerInTextLayer(e.contentDiv),e.setParent(null),e.isAttachedToDOM=!1,e.div.remove();this.div=null,this.#editors.clear(),this.#uiManager.removeLayer(this)}#cleanup(){for(let e of this.#editors.values())e.isEmpty()&&e.remove()}render({viewport:e}){this.viewport=e,Ze(this.div,e);for(let e of this.#uiManager.getEditors(this.pageIndex))this.add(e),e.rebuild();this.updateMode()}update({viewport:e}){this.#uiManager.commitOrRemove(),this.#cleanup();let t=this.viewport.rotation,n=e.rotation;if(this.viewport=e,Ze(this.div,{rotation:n}),t!==n)for(let e of this.#editors.values())e.rotate(n)}get pageDimensions(){let{pageWidth:e,pageHeight:t}=this.viewport.rawDims;return[e,t]}get scale(){return this.#uiManager.viewParameters.realScale}},oa=class e{#parent=null;#mapping=new Map;#toUpdate=new Map;static#id=0;setParent(e){if(!this.#parent){this.#parent=e;return}if(this.#parent!==e){if(this.#mapping.size>0)for(let t of this.#mapping.values())t.remove(),e.append(t);this.#parent=e}}static get _svgFactory(){return L(this,`_svgFactory`,new ii)}static#setBox(e,[t,n,r,i]){let{style:a}=e;a.top=`${100*n}%`,a.left=`${100*t}%`,a.width=`${100*r}%`,a.height=`${100*i}%`}#createSVG(){let t=e._svgFactory.create(1,1,!0);return this.#parent.append(t),t.setAttribute(`aria-hidden`,!0),t}#createClipPath(t,n){let r=e._svgFactory.createElement(`clipPath`);t.append(r);let i=`clip_${n}`;r.setAttribute(`id`,i),r.setAttribute(`clipPathUnits`,`objectBoundingBox`);let a=e._svgFactory.createElement(`use`);return r.append(a),a.setAttribute(`href`,`#${n}`),a.classList.add(`clip`),i}#updateProperties(e,t){for(let[n,r]of Object.entries(t))r===null?e.removeAttribute(n):e.setAttribute(n,r)}draw(t,n=!1,r=!1){let i=e.#id++,a=this.#createSVG(),o=e._svgFactory.createElement(`defs`);a.append(o);let s=e._svgFactory.createElement(`path`);o.append(s);let c=`path_${i}`;s.setAttribute(`id`,c),s.setAttribute(`vector-effect`,`non-scaling-stroke`),n&&this.#toUpdate.set(i,s);let l=r?this.#createClipPath(o,c):null,u=e._svgFactory.createElement(`use`);return a.append(u),u.setAttribute(`href`,`#${c}`),this.updateProperties(a,t),this.#mapping.set(i,a),{id:i,clipPathId:`url(#${l})`}}drawOutline(t,n){let r=e.#id++,i=this.#createSVG(),a=e._svgFactory.createElement(`defs`);i.append(a);let o=e._svgFactory.createElement(`path`);a.append(o);let s=`path_${r}`;o.setAttribute(`id`,s),o.setAttribute(`vector-effect`,`non-scaling-stroke`);let c;if(n){let t=e._svgFactory.createElement(`mask`);a.append(t),c=`mask_${r}`,t.setAttribute(`id`,c),t.setAttribute(`maskUnits`,`objectBoundingBox`);let n=e._svgFactory.createElement(`rect`);t.append(n),n.setAttribute(`width`,`1`),n.setAttribute(`height`,`1`),n.setAttribute(`fill`,`white`);let i=e._svgFactory.createElement(`use`);t.append(i),i.setAttribute(`href`,`#${s}`),i.setAttribute(`stroke`,`none`),i.setAttribute(`fill`,`black`),i.setAttribute(`fill-rule`,`nonzero`),i.classList.add(`mask`)}let l=e._svgFactory.createElement(`use`);i.append(l),l.setAttribute(`href`,`#${s}`),c&&l.setAttribute(`mask`,`url(#${c})`);let u=l.cloneNode();return i.append(u),l.classList.add(`mainOutline`),u.classList.add(`secondaryOutline`),this.updateProperties(i,t),this.#mapping.set(r,i),r}finalizeDraw(e,t){this.#toUpdate.delete(e),this.updateProperties(e,t)}updateProperties(t,n){if(!n)return;let{root:r,bbox:i,rootClass:a,path:o}=n,s=typeof t==`number`?this.#mapping.get(t):t;if(s){if(r&&this.#updateProperties(s,r),i&&e.#setBox(s,i),a){let{classList:e}=s;for(let[t,n]of Object.entries(a))e.toggle(t,n)}if(o){let e=s.firstElementChild.firstElementChild;this.#updateProperties(e,o)}}}updateParent(e,t){if(t===this)return;let n=this.#mapping.get(e);n&&(t.#parent.append(n),this.#mapping.delete(e),t.#mapping.set(e,n))}remove(e){this.#toUpdate.delete(e),this.#parent!==null&&(this.#mapping.get(e).remove(),this.#mapping.delete(e))}destroy(){this.#parent=null;for(let e of this.#mapping.values())e.remove();this.#mapping.clear(),this.#toUpdate.clear()}};globalThis._pdfjsTestingUtils={HighlightOutliner:Bi},globalThis.pdfjsLib={AbortException:ve,AnnotationEditorLayer:aa,AnnotationEditorParamsType:O,AnnotationEditorType:D,AnnotationEditorUIManager:bt,AnnotationLayer:Fi,AnnotationMode:T,AnnotationType:N,applyOpacity:nt,build:Zr,ColorPicker:Qr,createValidAbsoluteUrl:ue,CSSConstants:tt,DOMSVGFactory:ii,DrawLayer:oa,FeatureTest:R,fetchData:Ie,findContrastColor:ct,getDocument:Vr,getFilenameFromUrl:Ve,getPdfFilenameFromUrl:He,getRGB:Je,getUuid:ke,getXfaPageViewport:qe,GlobalWorkerOptions:Zn,ImageKind:M,InvalidPDFException:he,isDataScheme:ze,isPdfFile:Be,isValidExplicitDest:Ut,MathClamp:B,noContextMenu:V,normalizeUnicode:Oe,OPS:ne,OutputScale:Qe,PagesMapper:dt,PasswordResponses:ie,PDFDataRangeTransport:Ur,PDFDateString:Ke,PDFWorker:Kr,PermissionFlag:k,PixelsPerInch:Fe,RenderingCancelledException:Re,renderRichText:lt,ResponseException:ge,setLayerDimensions:Ze,shadow:L,SignatureExtractor:ea,stopEvent:H,SupportedImageMimeTypes:$e,TextLayer:zr,TouchManager:Ct,updateUrlHash:de,Util:z,VerbosityLevel:te,version:Xr,XfaLayer:Ne};var sa=`/assets/pdf.worker.min-wgc6bjNh.mjs`,ca={class:`pdf-to-png`},la={class:`pdf-to-png-container`},ua={class:`pdf-to-png-main`},da={class:`upload-content`},fa={class:`upload-text`},pa={key:0,class:`error-message`},ma={key:1,class:`progress-section`},ha={class:`progress-header`},ga={class:`progress-status`},_a={key:0,class:`spinner`,width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},va={key:1,width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},ya={class:`status-text`},ba={class:`progress-badge`},xa={class:`progress-bar`},Sa={key:2,class:`download-all`},Ca={key:3,class:`preview-section`},wa={class:`preview-grid`},Ta={class:`preview-img-wrap`},Ea=[`src`,`alt`],Da={class:`preview-overlay`},Oa={class:`overlay-badge`},ka=[`onClick`],Aa={class:`preview-footer`},ja={class:`preview-filename`},Ma=v({__name:`index`,setup(e){Zn.workerSrc=sa;let p=d(null),v=d(!1),b=d(0),x=d([]),S=d(``),C=d(null),w=d(null),T=d(null);function E(){w.value?.click()}function D(e){let t=e.target.files[0];t&&t.type===`application/pdf`?A(t):k(`PDF 파일만 업로드할 수 있습니다.`)}function O(e){let t=e.dataTransfer.files[0];t&&t.type===`application/pdf`?A(t):k(`PDF 파일만 업로드할 수 있습니다.`)}function k(e){C.value=e,setTimeout(()=>{C.value=null},3e3)}async function A(e){if(!y){k(`라이브러리가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요.`);return}p.value=e,v.value=!0,b.value=0,x.value=[],C.value=null,S.value=`PDF 파일을 분석하는 중...`;try{let t=await e.arrayBuffer(),n=await Vr({data:t}).promise,r=n.numPages,i=[];for(let t=1;t<=r;t++){S.value=`${r}개 페이지 중 ${t}번째 변환 중...`;let a=await n.getPage(t),o=a.getViewport({scale:2}),s=T.value,c=s.getContext(`2d`);s.height=o.height,s.width=o.width,await a.render({canvasContext:c,viewport:o}).promise;let l=s.toDataURL(`image/png`);i.push({id:t,url:l,name:`${e.name.replace(`.pdf`,``)}_page_${t}.png`}),b.value=Math.round(t/r*100),x.value=[...i]}S.value=`변환 완료!`,v.value=!1}catch(e){console.error(e),k(`PDF 변환 중 오류가 발생했습니다.`),v.value=!1}}async function j(){for(let e of x.value){let t=document.createElement(`a`);t.href=e.url,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),await new Promise(e=>setTimeout(e,300))}}function M(e,t){let n=document.createElement(`a`);n.href=e,n.download=t,n.click()}return(e,d)=>{let y=a(`router-link`);return t(),c(`div`,ca,[_(y,{to:`/`,class:`home-button`},{default:n(()=>[...d[1]||=[f(`svg`,{width:`16`,height:`16`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[f(`path`,{d:`M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z`}),f(`polyline`,{points:`9,22 9,12 15,12 15,22`})],-1),h(` 앱 목록 `,-1)]]),_:1}),f(`div`,la,[d[10]||=o(`<header class="pdf-to-png-header" data-v-f71200db><div class="header-icon" data-v-f71200db><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f71200db><rect x="3" y="3" width="18" height="18" rx="2" data-v-f71200db></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-f71200db></circle><path d="M21 15l-5-5L5 21" data-v-f71200db></path></svg></div><h1 data-v-f71200db>PDF to PNG <span class="highlight" data-v-f71200db>Converter</span></h1><p class="subtitle" data-v-f71200db> 강력한 로컬 엔진을 사용하여 PDF의 모든 페이지를 고화질 PNG 이미지로 즉시 변환합니다. 모든 처리는 브라우저 내부에서 이루어지며 파일은 서버로 전송되지 않습니다. </p></header>`,1),f(`main`,ua,[f(`div`,{class:u([`upload-zone`,{"has-file":p.value}]),onClick:E,onDragover:d[0]||=m(()=>{},[`prevent`]),onDrop:m(O,[`prevent`])},[f(`input`,{ref_key:`fileInputRef`,ref:w,type:`file`,accept:`application/pdf`,class:`hidden-input`,onChange:D},null,544),f(`div`,da,[f(`div`,{class:u([`upload-icon`,{"has-file":p.value}])},[...d[2]||=[f(`svg`,{width:`40`,height:`40`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[f(`path`,{d:`M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4`}),f(`polyline`,{points:`17 8 12 3 7 8`}),f(`line`,{x1:`12`,y1:`3`,x2:`12`,y2:`15`})],-1)]],2),f(`div`,null,[f(`p`,fa,i(p.value?p.value.name:`PDF 파일을 여기에 드롭하거나 클릭하세요`),1),d[3]||=f(`p`,{class:`upload-hint`},`최대 50MB까지 지원 (로컬 처리)`,-1)])])],34),C.value?(t(),c(`div`,pa,[d[4]||=f(`svg`,{width:`20`,height:`20`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[f(`circle`,{cx:`12`,cy:`12`,r:`10`}),f(`line`,{x1:`12`,y1:`8`,x2:`12`,y2:`12`}),f(`line`,{x1:`12`,y1:`16`,x2:`12.01`,y2:`16`})],-1),f(`span`,null,i(C.value),1)])):l(``,!0),v.value||b.value>0?(t(),c(`div`,ma,[f(`div`,ha,[f(`div`,ga,[v.value?(t(),c(`svg`,_a,[...d[5]||=[f(`path`,{d:`M21 12a9 9 0 11-6.22-8.56`},null,-1)]])):(t(),c(`svg`,va,[...d[6]||=[f(`path`,{d:`M22 11.08V12a10 10 0 1 1-5.93-9.14`},null,-1),f(`polyline`,{points:`22 4 12 14.01 9 11.01`},null,-1)]])),f(`span`,ya,i(S.value),1)]),f(`span`,ba,i(b.value)+`%`,1)]),f(`div`,xa,[f(`div`,{class:`progress-fill`,style:r({width:b.value+`%`})},null,4)])])):l(``,!0),x.value.length>0&&!v.value?(t(),c(`div`,Sa,[f(`button`,{class:`download-btn`,onClick:j},[d[7]||=f(`svg`,{width:`24`,height:`24`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[f(`path`,{d:`M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4`}),f(`polyline`,{points:`7 10 12 15 17 10`}),f(`line`,{x1:`12`,y1:`15`,x2:`12`,y2:`3`})],-1),h(` 모든 페이지 저장하기 (`+i(x.value.length)+`) `,1)])])):l(``,!0),x.value.length>0?(t(),c(`div`,Ca,[d[9]||=o(`<div class="preview-header" data-v-f71200db><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-f71200db><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" data-v-f71200db></path><polyline points="14 2 14 8 20 8" data-v-f71200db></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-f71200db></line><line x1="16" y1="17" x2="8" y2="17" data-v-f71200db></line><polyline points="10 9 9 9 8 9" data-v-f71200db></polyline></svg><h3 data-v-f71200db>변환된 이미지 미리보기</h3></div>`,1),f(`div`,wa,[(t(!0),c(s,null,g(x.value,e=>(t(),c(`div`,{key:e.id,class:`preview-card`},[f(`div`,Ta,[f(`img`,{src:e.url,alt:`Page `+e.id,class:`preview-img`},null,8,Ea)]),f(`div`,Da,[f(`div`,Oa,`Page `+i(e.id),1),f(`button`,{class:`overlay-btn`,onClick:t=>M(e.url,e.name)},[...d[8]||=[f(`svg`,{width:`18`,height:`18`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[f(`path`,{d:`M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4`}),f(`polyline`,{points:`7 10 12 15 17 10`}),f(`line`,{x1:`12`,y1:`15`,x2:`12`,y2:`3`})],-1),h(` 다운로드 `,-1)]],8,ka)]),f(`div`,Aa,[f(`p`,ja,i(e.name),1)])]))),128))])])):l(``,!0)]),d[11]||=f(`footer`,{class:`pdf-to-png-footer`},[f(`p`,null,`© 2024 PDF to PNG Studio. 데이터 보안을 위해 모든 처리는 귀하의 장치에서 로컬로 수행됩니다.`)],-1)]),f(`canvas`,{ref_key:`canvasRef`,ref:T,class:`hidden-canvas`},null,512)])}}},[[`__scopeId`,`data-v-f71200db`]]);export{Ma as default};